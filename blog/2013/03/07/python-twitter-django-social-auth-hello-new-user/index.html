
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Python Twitter + django-social-auth == Hello New User</title>
  <meta name="author" content="Alexander Todorov">

  
  <meta name="description" content="I have been experimenting with the twitter
module for Python and decided to combine it with
django-social-auth to welcome new
users who join Difio. &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://atodorov.org/blog/2013/03/07/python-twitter-django-social-auth-hello-new-user/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/atodorov" rel="alternate" title="atodorov.org - you can logoff, but you can never leave" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Russo+One" rel="stylesheet" type="text/css" />
<meta name="google-site-verification" content="XynqZtldWNBbmsynVQZremIxaaO8Wgs6AGR8UZ7KIkM" />

  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37979549-1', 'atodorov.org');
  ga('send', 'pageview');

</script>


</head>

<body   >
  <header role="banner"><hgroup>
<div id="logo-container">
<div id="logo">atodorov.org</div>
<div id="logo-sub"><em>
you can logoff, but you can never leave
</em></div>
</div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/atodorov" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/give-away/">Give Away List</a></li>
  <li><a href="/projects/">Projects</a></li>
  <li><a href="/domains/">Domains</a></li>
  <li><a href="http://amzn.to/1wTPaLe">Previous: Traction</a></li>
  <li><a href="http://amzn.to/1lLi5NU">Previous: How to Win Friends</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Python Twitter + Django-social-auth == Hello New User</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-07T21:47:00+02:00" pubdate data-updated="true">Mar 7<span>th</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>I have been experimenting with the <a href="https://pypi.python.org/pypi/twitter">twitter</a>
module for Python and decided to combine it with
<a href="https://github.com/omab/django-social-auth">django-social-auth</a> to welcome new
users who join <a href="http://www.dif.io">Difio</a>. In this post I will show you how to
tweet on behalf of the user when they join your site and send them a welcome email.</p>

<h2>Configuration</h2>

<p>In django-social-auth the authentication workflow is handled by an operations
pipeline where custom functions can be added or default items can be removed to
provide custom behavior. This is how our pipeline looks:</p>

<figure class='code'><figcaption><span>settings.py  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">SOCIAL_AUTH_PIPELINE</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>    <span class="s">&#39;social_auth.backends.pipeline.social.social_auth_user&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="c">#&#39;social_auth.backends.pipeline.associate.associate_by_email&#39;,</span>
</span><span class='line'>    <span class="s">&#39;social_auth.backends.pipeline.user.get_username&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;social_auth.backends.pipeline.user.create_user&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;social_auth.backends.pipeline.social.associate_user&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;social_auth.backends.pipeline.social.load_extra_data&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;social_auth.backends.pipeline.user.update_user_details&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="s">&#39;myproject.tasks.welcome_new_user&#39;</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is the default plus an additional method at the end to welcome new users.</p>

<p>You also have to create and configure a Twitter application so that users
can login with Twitter OAuth to your site.
<a href="http://django-social-auth.readthedocs.org/en/latest/backends/index.html">RTFM</a>
for more information on how to do this.</p>

<h2>Custom pipeline actions</h2>

<p>This is how the custom pipeline action should look:</p>

<figure class='code'><figcaption><span>myproject/tasks.py  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">urlparse</span> <span class="kn">import</span> <span class="n">parse_qs</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">welcome_new_user</span><span class="p">(</span><span class="n">backend</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">social_user</span><span class="p">,</span> <span class="n">is_new</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">new_association</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">        Part of SOCIAL_AUTH_PIPELINE. Works with django-social-auth==0.7.21 or newer</span>
</span><span class='line'><span class="sd">        @backend - social_auth.backends.twitter.TwitterBackend (or other) object</span>
</span><span class='line'><span class="sd">        @user - User (if is_new) or django.utils.functional.SimpleLazyObject (if new_association)</span>
</span><span class='line'><span class="sd">        @social_user - UserSocialAuth object</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">is_new</span><span class="p">:</span>
</span><span class='line'>        <span class="n">send_welcome_email</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">first_name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">backend</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&#39;twitter&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="k">if</span> <span class="n">is_new</span> <span class="ow">or</span> <span class="n">new_association</span><span class="p">:</span>
</span><span class='line'>            <span class="n">access_token</span> <span class="o">=</span> <span class="n">social_user</span><span class="o">.</span><span class="n">extra_data</span><span class="p">[</span><span class="s">&#39;access_token&#39;</span><span class="p">]</span>
</span><span class='line'>            <span class="n">parsed_tokens</span> <span class="o">=</span> <span class="n">parse_qs</span><span class="p">(</span><span class="n">access_token</span><span class="p">)</span>
</span><span class='line'>            <span class="n">oauth_token</span> <span class="o">=</span> <span class="n">parsed_tokens</span><span class="p">[</span><span class="s">&#39;oauth_token&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>            <span class="n">oauth_secret</span> <span class="o">=</span> <span class="n">parsed_tokens</span><span class="p">[</span><span class="s">&#39;oauth_token_secret&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>            <span class="n">tweet_on_join</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">oauth_token</span><span class="p">,</span> <span class="n">oauth_secret</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="bp">None</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code works with django-social-auth==0.7.21 or newer. In older versions the
<code>new_association</code> parameter is missing as
<a href="https://groups.google.com/forum/?fromgroups=#!topic/django-social-auth/Nxf-0iRD27Y">I discovered</a>.
If you use an older version you won&#8217;t be able to distinguish between newly created
accounts and ones which have associated another OAuth backend. You are warned!</p>

<h2>Tweet &amp; email</h2>

<p>Sending the welcome email is out of the scope of this post. I am using
<a href="https://github.com/bradwhittington/django-templated-email">django-templated-email</a>
to define how emails look and sending them via Amazon SES. See
<a href="/blog/2013/02/28/email-logging-django-redhat-openshift-amazon-ses/">Email Logging for Django on RedHat OpenShift With Amazon SES</a>
for more information on how to configure emailing with SES.</p>

<p>Here is how the Twitter code looks:</p>

<figure class='code'><figcaption><span>myproject/tasks.py  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">twitter</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">celery.task</span> <span class="kn">import</span> <span class="n">task</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">settings</span> <span class="kn">import</span> <span class="n">TWITTER_CONSUMER_KEY</span><span class="p">,</span> <span class="n">TWITTER_CONSUMER_SECRET</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@task</span>
</span><span class='line'><span class="k">def</span> <span class="nf">tweet_on_join</span><span class="p">(</span><span class="n">oauth_token</span><span class="p">,</span> <span class="n">oauth_secret</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">        Tweet when the user is logged in for the first time or</span>
</span><span class='line'><span class="sd">        when new Twitter account is associated.</span>
</span><span class='line'>
</span><span class='line'><span class="sd">        @oauth_token - string</span>
</span><span class='line'><span class="sd">        @oauth_secret - string</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">t</span> <span class="o">=</span> <span class="n">twitter</span><span class="o">.</span><span class="n">Twitter</span><span class="p">(</span>
</span><span class='line'>            <span class="n">auth</span><span class="o">=</span><span class="n">twitter</span><span class="o">.</span><span class="n">OAuth</span><span class="p">(</span>
</span><span class='line'>                <span class="n">oauth_token</span><span class="p">,</span> <span class="n">oauth_secret</span><span class="p">,</span>
</span><span class='line'>                <span class="n">TWITTER_CONSUMER_KEY</span><span class="p">,</span> <span class="n">TWITTER_CONSUMER_SECRET</span>
</span><span class='line'>            <span class="p">)</span>
</span><span class='line'>        <span class="p">)</span>
</span><span class='line'>    <span class="n">t</span><span class="o">.</span><span class="n">statuses</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s">&#39;Started following open source changes at http://www.dif.io!&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This will post a new tweet on behalf of the user, telling everyone they joined
your website!</p>

<p><strong>NOTE:</strong>
<code>tweet_on_join</code> and <code>send_welcome_email</code> are Celery tasks, not ordinary Python
functions. This has the advantage of being able to execute these actions async
and not slow down the user interface.</p>

<p>Are you doing something special when a user joins your website? Please share
your comments below. Thanks!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Alexander Todorov</span></span>

      








  


<time datetime="2013-03-07T21:47:00+02:00" pubdate data-updated="true">Mar 7<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/django/'>Django</a>, <a class='category' href='/blog/categories/twitter/'>Twitter</a>, <a class='category' href='/blog/categories/django-social-auth/'>django-social-auth</a>, <a class='category' href='/blog/categories/tips/'>tips</a>
  
</span>


    </p>
    
      <div class="sharing">
<!-- AddThis Button BEGIN -->
<div class="addthis_toolbox addthis_default_style addthis_32x32_style">
<a class="addthis_button_preferred_1"></a>
<a class="addthis_button_preferred_2"></a>
<a class="addthis_button_preferred_3"></a>
<a class="addthis_button_preferred_4"></a>
<a class="addthis_button_preferred_5"></a>
<a class="addthis_button_preferred_6"></a>
<a class="addthis_button_preferred_7"></a>
<a class="addthis_button_preferred_8"></a>
<a class="addthis_button_preferred_9"></a>
<a class="addthis_button_compact"></a>
<a class="addthis_counter addthis_bubble_style"></a>
</div>
<script type="text/javascript" src="http://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5103cc5a2bc6ba17"></script>
<!-- AddThis Button END -->
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2013/03/06/tip-delete-user-profiles-django-social-auth/" title="Previous Post: Tip: Delete User Profiles with django-social-auth">&laquo; Tip: Delete User Profiles with django-social-auth</a>
      
      
        <a class="basic-alignment right" href="/blog/2013/03/14/django-social-auth-tip-reminder-of-login-provider/" title="Next Post: django-social-auth tip: Reminder of Login Provider">django-social-auth tip: Reminder of Login Provider &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <p>
    I am a QA contractor at Red Hat responsible for over
    <a href="/blog/2014/02/19/7-years-1400-bugs-red-hat-qa/">1400 bugs</a>,
    a general purpose open source developer, Red Hat Certified professional,
    cloud hacker and an <a href="/projects/">entrepreneur</a>.
  </p>

  <p>
    I'm living in the <a href="http://planet.sofiavalley.com">Sofia Valley</a>
    which is emerging as a busy place for start-up founders and tech enthusiasts
    in Eastern Europe! You can find more about me <a href="/about/">here</a>.
  </p>
</section>

<section>
  
    <a href="http://twitter.com/atodorov_" class="twitter-follow-button" data-show-count="true">Follow @atodorov_</a>
  
</section>


<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="atodorov.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<section>
    <h1>
        <a href="/blog/categories/books/">Book Reviews</a>
    </h1>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/01/compiling-twinkle-sip-phone-on-rhel-7/">Compiling Twinkle SIP Phone on RHEL 7</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/30/fixing-tilde-and-function-keys-mapping-for-macbook-air-on-linux/">Fixing Tilde and Function Keys Mapping for MacBook Air on Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/29/rhel-7-repository-for-macbook-air/">RHEL 7 Repository for MacBook Air</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/29/fixing-display-brightness-on-macbook-air-with-rhel-7/">Fixing Display Brightness on MacBook Air with RHEL 7</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/27/how-to-enable-backspace-key-to-navigate-back-in-firefox/">How to Enable backspace Key to Navigate Back in Firefox</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/27/disabling-macbook-startup-sound-in-linux/">Disabling MacBook Startup Sound in Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/27/compiling-broadcom-wl-kmod-wifi-driver-for-rhel-7/">Compiling Broadcom wl-kmod WiFi Driver for RHEL 7</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/26/installing-red-hat-enterprise-linux-7-on-macbook-air-2015/">Installing Red Hat Enterprise Linux 7 on MacBook Air 2015</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/20/videos-from-bulgaria-web-summit-2015/">Videos from Bulgaria Web Summit 2015</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/14/how-to-find-if-lvm-volume-is-thinly-provisioned/">How to Find if LVM Volume is Thinly Provisioned</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Disclaimer</h1>
  <p>
Some of the links contained within this site have my referral id (e.g., Amazon), which provides me with a small commission for each sale. Thank you for your support.
  </p>
</section>




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">CC-BY-SA</a>
  &amp;
  <a rel="license" href="http://opensource.org/licenses/MIT">MIT</a>
  2011-2015 &diams; Alexander Todorov
  &diams;
  <a href="/about/">About Me</a>
  &diams;
  Popular categories:
<a href="/blog/categories/rhel/">Red Hat</a>,
<a href="/blog/categories/cloud/">Cloud</a>,
<a href="/blog/categories/fedora/">Fedora</a>,
<a href="/blog/categories/qa/">QA</a>,
<a href="/blog/categories/start-up/">Start-up</a>

  <a href="http://planet.sofiavalley.com" style="float:right">SofiaValley Blog</a>
</p>

<script type="text/javascript">
var uri = window.location.toString();
if (uri.indexOf("?") > 0) {
    var clean_uri = uri.substring(0, uri.indexOf("?"));
    window.history.replaceState({}, document.title, clean_uri);
}
</script>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'atodorov';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://atodorov.org/blog/2013/03/07/python-twitter-django-social-auth-hello-new-user/';
        var disqus_url = 'http://atodorov.org/blog/2013/03/07/python-twitter-django-social-auth-hello-new-user/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
