
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>atodorov.org - you can logoff, but you can never leave</title>
  <meta name="author" content="Alexander Todorov">

  
  <meta name="description" content="Image CC-BY-SA, Michael Mandiberg I found two good blog posts about investigating MySQL internals:
Researching your MySQL table sizes and
Finding &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://atodorov.org/blog/page/9/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="http://feeds.feedburner.com/atodorov" rel="alternate" title="atodorov.org - you can logoff, but you can never leave" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=Russo+One" rel="stylesheet" type="text/css" />
<meta name="google-site-verification" content="XynqZtldWNBbmsynVQZremIxaaO8Wgs6AGR8UZ7KIkM" />

  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37979549-1', 'atodorov.org');
  ga('send', 'pageview');

</script>


</head>

<body   >
  <header role="banner"><hgroup>
<div id="logo-container">
<div id="logo">atodorov.org</div>
<div id="logo-sub"><em>
you can logoff, but you can never leave
</em></div>
</div>
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="http://feeds.feedburner.com/atodorov" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/give-away/">Give Away List</a></li>
  <li><a href="/projects/">Projects</a></li>
  <li><a href="/domains/">Domains</a></li>
  <li><a href="http://amzn.to/1wTPaLe">Previous: Traction</a></li>
  <li><a href="http://amzn.to/1lLi5NU">Previous: How to Win Friends</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/20/how-large-are-my-mysql-tables/">How Large Are My MySQL Tables</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-20T12:03:00+02:00" pubdate data-updated="true">Feb 20<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/02/20/how-large-are-my-mysql-tables/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/database.jpg" alt="database" style="display:block;clear:both;"/>
Image CC-BY-SA, <a href="http://www.flickr.com/photos/theredproject/3332644561/">Michael Mandiberg</a></p>

<p>I found two good blog posts about investigating MySQL internals:
<a href="http://www.mysqlperformanceblog.com/2008/03/17/researching-your-mysql-table-sizes/">Researching your MySQL table sizes</a> and
<a href="http://www.mysqlperformanceblog.com/2008/02/04/finding-out-largest-tables-on-mysql-server/">Finding out largest tables on MySQL Server</a>.
Using the queries against my site <a href="http://www.dif.io">Difio</a> showed:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="n">mysql</span><span class="o">&gt;</span> <span class="k">SELECT</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">table_schema</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="k">table_name</span><span class="p">),</span>
</span><span class='line'>    <span class="o">-&gt;</span>        <span class="n">CONCAT</span><span class="p">(</span><span class="n">ROUND</span><span class="p">(</span><span class="n">table_rows</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;M&#39;</span><span class="p">)</span>                                    <span class="k">rows</span><span class="p">,</span>
</span><span class='line'>    <span class="o">-&gt;</span>        <span class="n">CONCAT</span><span class="p">(</span><span class="n">ROUND</span><span class="p">(</span><span class="n">data_length</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;G&#39;</span><span class="p">)</span>                    <span class="k">DATA</span><span class="p">,</span>
</span><span class='line'>    <span class="o">-&gt;</span>        <span class="n">CONCAT</span><span class="p">(</span><span class="n">ROUND</span><span class="p">(</span><span class="n">index_length</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;G&#39;</span><span class="p">)</span>                   <span class="n">idx</span><span class="p">,</span>
</span><span class='line'>    <span class="o">-&gt;</span>        <span class="n">CONCAT</span><span class="p">(</span><span class="n">ROUND</span><span class="p">((</span> <span class="n">data_length</span> <span class="o">+</span> <span class="n">index_length</span> <span class="p">)</span> <span class="o">/</span> <span class="p">(</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="p">),</span> <span class="mi">2</span><span class="p">),</span> <span class="s1">&#39;G&#39;</span><span class="p">)</span> <span class="n">total_size</span><span class="p">,</span>
</span><span class='line'>    <span class="o">-&gt;</span>        <span class="n">ROUND</span><span class="p">(</span><span class="n">index_length</span> <span class="o">/</span> <span class="n">data_length</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>                                           <span class="n">idxfrac</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="k">FROM</span>   <span class="n">information_schema</span><span class="p">.</span><span class="n">TABLES</span>
</span><span class='line'>    <span class="o">-&gt;</span> <span class="k">ORDER</span>  <span class="k">BY</span> <span class="n">data_length</span> <span class="o">+</span> <span class="n">index_length</span> <span class="k">DESC</span><span class="p">;</span>
</span><span class='line'><span class="o">+</span><span class="c1">----------------------------------------+-------+-------+-------+------------+---------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">table_schema</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="k">table_name</span><span class="p">)</span>  <span class="o">|</span> <span class="k">rows</span>  <span class="o">|</span> <span class="k">DATA</span>  <span class="o">|</span> <span class="n">idx</span>   <span class="o">|</span> <span class="n">total_size</span> <span class="o">|</span> <span class="n">idxfrac</span> <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">----------------------------------------+-------+-------+-------+------------+---------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">difio</span><span class="p">.</span><span class="n">difio_advisory</span>                   <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">04</span><span class="n">M</span> <span class="o">|</span> <span class="mi">3</span><span class="p">.</span><span class="mi">17</span><span class="k">G</span> <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="k">G</span> <span class="o">|</span> <span class="mi">3</span><span class="p">.</span><span class="mi">17</span><span class="k">G</span>      <span class="o">|</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">00</span> <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">----------------------------------------+-------+-------+-------+------------+---------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>The table of interest is <code>difio_advisory</code> which had 5 <code>longtext</code> fields. Those fields were
not used for filtering or indexing the rest of the information.
They were just storage fields - a `nice&#8217; side effect of using Django&#8217;s ORM.</p>

<p>I have migrated the data to Amazon S3 and stored it in JSON format there. After dropping these
fields the table was considerably smaller:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="o">+</span><span class="c1">----------------------------------------+-------+-------+-------+------------+---------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">table_schema</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="k">table_name</span><span class="p">)</span>  <span class="o">|</span> <span class="k">rows</span>  <span class="o">|</span> <span class="k">DATA</span>  <span class="o">|</span> <span class="n">idx</span>   <span class="o">|</span> <span class="n">total_size</span> <span class="o">|</span> <span class="n">idxfrac</span> <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">----------------------------------------+-------+-------+-------+------------+---------+</span>
</span><span class='line'><span class="o">|</span> <span class="n">difio</span><span class="p">.</span><span class="n">difio_advisory</span>                   <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">01</span><span class="n">M</span> <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="k">G</span> <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="k">G</span> <span class="o">|</span> <span class="mi">0</span><span class="p">.</span><span class="mi">00</span><span class="k">G</span>      <span class="o">|</span>    <span class="mi">0</span><span class="p">.</span><span class="mi">90</span> <span class="o">|</span>
</span><span class='line'><span class="o">+</span><span class="c1">----------------------------------------+-------+-------+-------+------------+---------+</span>
</span></code></pre></td></tr></table></div></figure>


<p>For those interested I&#8217;m using <a href="https://github.com/e-loue/django-storages">django-storages</a>
on the back-end to save the data in S3 when generated. On the front-end I&#8217;m using
<a href="http://dojotoolkit.com">dojo.xhrGet</a> to load the information directly into the browser.</p>

<p>I&#8217;d love to hear your feedback in the comments section below. Let me know
what you found for your own databases. Were there any issues? How did you deal
with them?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/13/secure-vnc-installation-red-hat-enterprise-linux/">Secure VNC Installation of Red Hat Enterprise Linux 6</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-13T15:40:00+02:00" pubdate data-updated="true">Feb 13<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/02/13/secure-vnc-installation-red-hat-enterprise-linux/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img src="/images/rhel6_welcome.png" alt="RHEL 6 welcome screen" />
Image CC-BY-SA,
<a href="https://access.redhat.com/knowledge/docs/en-US/Red_Hat_Enterprise_Linux/6/html/Installation_Guide/sn-welcome-s390.html">Red Hat</a></p>

<p>From time to time I happen to remotely
<a href="http://otb.bg">install Red Hat Enterprise Linux</a>
servers via the Internet.
When the system configuration is not decided upfront you need
to use interactive mode. This means VNC in my case.</p>

<p>In this tutorial I will show you how to make VNC installations more secure
when using public networks to connect to the server.</p>

<h2>Meet your tools</h2>

<p>Starting with Red Hat Enterprise Linux 6 and all the latest Fedora releases, the
installer supports SSH connections during install.</p>

<blockquote><p>Note that by default, root has a blank password.</p><p>If you don&#8217;t want any user to be able to ssh in and have full access to your hardware, <br/>you must specify sshpw for username root. Also note that if Anaconda fails to parse the <br/>kickstart file, it will allow anyone to login as root and have full access to your hardware.</p><footer><strong>Fedora</strong> <cite><a href='https://fedoraproject.org/wiki/Anaconda/Kickstart#sshpw'>Kickstart Manual</a></cite></footer></blockquote>


<h2>Preparation</h2>

<p>We are going to use SSH port forwarding and tunnel VNC traffic through it.
Create a kickstart file as shown below:</p>

<figure class='code'><figcaption><span>ks.cfg </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='cfg'><span class='line'><span class="err">install</span>
</span><span class='line'><span class="err">url</span> <span class="err">--url</span> <span class="err">http://example.com/path/to/rhel6</span>
</span><span class='line'><span class="err">lang</span> <span class="err">en_US.UTF-8</span>
</span><span class='line'><span class="err">keyboard</span> <span class="err">us</span>
</span><span class='line'><span class="err">network</span> <span class="err">--onboot</span> <span class="err">yes</span> <span class="err">--device</span> <span class="err">eth0</span> <span class="err">--bootproto</span> <span class="err">dhcp</span>
</span><span class='line'><span class="na">vnc --password</span><span class="o">=</span><span class="s">s3cr3t</span>
</span><span class='line'><span class="na">sshpw --user</span><span class="o">=</span><span class="s">root s3cr3t</span>
</span></code></pre></td></tr></table></div></figure>


<p>The first 5 lines configure the loader portion of the installer. They will setup
networking and fetch the installer image called stage2. This is completely automated.
<strong>NB:</strong> If you miss some of the lines or have a syntax error the installer will prompt for
values. You either need a remote console access or somebody present at the server console!</p>

<p>The last 2 lines configure passwords for VNC and SSH respectively.</p>

<p>Make this file
<a href="https://fedoraproject.org/wiki/Anaconda/Kickstart#Chapter_6._Making_the_Kickstart_File_Available">available</a>
over HTTP(S), FTP or NFS.</p>

<p><strong>NB:</strong> Make sure that the file is available on the same network where your server is,
or use HTTPS if on public networks.</p>

<h2>Installation</h2>

<p>Now, using your favorite installation media start the
installation process like this:</p>

<pre><code>boot: linux sshd=1 ks=http://example.com/ks.cfg
</code></pre>

<p>After a minute or more the installer will load stage2, with the
interactive VNC session. You need to know the IP address or hostname
of the server. Either look into DHCP logs, have somebody look at the
server console and tell you that (it&#8217;s printed on tty1) or script it in
a <a href="https://fedoraproject.org/wiki/Anaconda/Kickstart#Chapter_4._Pre-installation_Script">%pre</a>
script which will send you an email for example.</p>

<p>When ready, redirect one of your local ports through SSH to the VNC port on the server:</p>

<pre><code>$ ssh -L 5902:localhost:5901 -N root@server.example.com
</code></pre>

<p>Now connect to DISPLAY :2 on your system to begin the installation:</p>

<pre><code>$ vncviewer localhost:2 &amp;
</code></pre>

<h2>Warning Bugs Present</h2>

<p>As it happens, I find bugs everywhere. This is no exception.
Depending on your network/DHCP configuration IP address during install may
change mid-air and cause VNC client connection to freeze.</p>

<p>The reason for this bug is evident from the code (rhel6-branch):</p>

<figure class='code'><figcaption><span>iw/timezone_gui.py  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">anaconda</span><span class="o">.</span><span class="n">isKickstart</span><span class="p">:</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">utcCheckbox</span><span class="o">.</span><span class="n">set_active</span><span class="p">(</span><span class="ow">not</span> <span class="n">hasWindows</span><span class="p">(</span><span class="n">anaconda</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">bootloader</span><span class="p">))</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>textw/timezone_text.py  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'>    <span class="k">if</span> <span class="ow">not</span> <span class="n">anaconda</span><span class="o">.</span><span class="n">isKickstart</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">hasWindows</span><span class="p">(</span><span class="n">anaconda</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">bootloader</span><span class="p">):</span>
</span><span class='line'>        <span class="n">asUtc</span> <span class="o">=</span> <span class="bp">True</span>
</span></code></pre></td></tr></table></div></figure>


<p>Because we are using a kickstart file Anaconda will assume the system clock <strong>DOES NOT</strong>
use UTC. If you forget to configure it manually you may see time on the server shifting
back or forward (depending on your timezone) while installing. If your DHCP is configured
for short lease time the address will expire before the installation completes. When new
address is requested from DHCP it may be different and this will cause your VNC connection
to freeze.</p>

<p>To workaround this issue select the appropriate value for the system clock settings during install
and possibly use static IP address during the installation.</p>

<h2>Feedback</h2>

<p>As always I&#8217;d love to hear your feedback in the comments section below. Let me know
your tips and tricks to perform secure remote installations using public networks.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/08/the-shoes-start-up/">The Shoes Start-up</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-08T23:50:00+02:00" pubdate data-updated="true">Feb 8<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/02/08/the-shoes-start-up/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Did you know there is a start-up company producing men&#8217;s shoes? Me neither,
and I love good quality shoes.</p>

<blockquote><p>Beckett Simonon launched in 2012, and slashed prices by working with local manufacturers and<br/>selling directly to customers online.</p><p>The company, which currently operates out of Bogota, Colombia, says it has <br/>generated $80,000 in revenue after two months in operation, and has five employees.</p><footer><strong>Julie Strickland</strong> <cite><a href='http://www.inc.com/julie-strickland/mens-fashion-startups.html'>Men&#8217;s Fashion: 5 Start-ups to Watch</a></cite></footer></blockquote>


<p><img src="/images/Bailey_Chukka_Boot.jpg" style="float: left; margin-right: 10px;"/></p>

<p>From what I can tell <a href="http://www.beckettsimonon.com">Beckett Simonon</a> produce nice shoes.
I would rate them between very good and high quality, just looking at the pictures.
All designs are very classy and stylish, which is rare these days. Leather looks
high quality, soles too.</p>

<p>The ones I loved right away are the Bailey Chukka Boot model, shown here.
So far my gut feeling about shoes has never been wrong, even on the Internet, so
I&#8217;m thinking to pre-order a pair.</p>

<p>Anybody wants to team up for a joint order?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/02/05/performance-test-md5-sha1-sha256-sha512/">Performance Test of MD5, SHA1, SHA256 and SHA512</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-05T10:33:00+02:00" pubdate data-updated="true">Feb 5<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/02/05/performance-test-md5-sha1-sha256-sha512/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A few months ago I wrote
<a href="https://github.com/atodorov/django-s3-cache">django-s3-cache</a>.
This is Amazon Simple Storage Service (S3) cache backend for Django
which uses hashed file names.
django-s3-cache uses <code>sha1</code> instead of <code>md5</code> which appeared to be
faster at the time. I recall that my testing wasn&#8217;t very robust so I did another
round.</p>

<h2>Test Data</h2>

<p>The file <a href="http://s3.amazonaws.com/atodorov/blog/urls.txt.gz">urls.txt</a>
contains 10000 unique paths from the <a href="http://www.dif.io">dif.io</a>
website and looks like this:</p>

<pre><code>/updates/Django-1.3.1/Django-1.3.4/7858/
/updates/delayed_paperclip-2.4.5.2 c23a537/delayed_paperclip-2.4.5.2/8085/
/updates/libv8-3.3.10.4 x86_64-darwin-10/libv8-3.3.10.4/8087/
/updates/Data::Compare-1.22/Data::Compare-Type/8313/
/updates/Fabric-1.4.0/Fabric-1.4.4/8652/
</code></pre>

<h2>Test Automation</h2>

<p>I used the standard <a href="http://docs.python.org/2/library/timeit.html">timeit</a>
module in Python.</p>

<figure class='code'><figcaption><span>test.py  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c">#!/usr/bin/python</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="nn">timeit</span>
</span><span class='line'>
</span><span class='line'><span class="n">t</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">import hashlib</span>
</span><span class='line'><span class="sd">for line in url_paths:</span>
</span><span class='line'><span class="sd">    h = hashlib.md5(line).hexdigest()</span>
</span><span class='line'><span class="sd">#    h = hashlib.sha1(line).hexdigest()</span>
</span><span class='line'><span class="sd">#    h = hashlib.sha256(line).hexdigest()</span>
</span><span class='line'><span class="sd">#    h = hashlib.sha512(line).hexdigest()</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="p">,</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">url_paths = []</span>
</span><span class='line'><span class="sd">f = open(&#39;urls.txt&#39;, &#39;r&#39;)</span>
</span><span class='line'><span class="sd">for l in f.readlines():</span>
</span><span class='line'><span class="sd">    url_paths.append(l)</span>
</span><span class='line'><span class="sd">f.close()</span>
</span><span class='line'><span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">t</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Test Results</h2>

<p>The main statement hashes all 10000 entries one by one. This statement is
executed 1000 times in a loop, which is repeated 3 times. I have Python 2.6.6
on my system. After every test run the system was rebooted.
Execution time in seconds is available below.</p>

<pre><code>MD5     10.275190830230713, 10.155328989028931, 10.250311136245728
SHA1    11.985718965530396, 11.976419925689697, 11.86873197555542
SHA256  16.662450075149536, 21.551337003707886, 17.016510963439941
SHA512  18.339390993118286, 18.11187481880188,  18.085782051086426
</code></pre>

<p>Looks like I was wrong the first time! MD5 is still faster but not that much.
I will stick with SHA1 for the time being.</p>

<p>As always Iâ€™d love to hear your thoughts and feedback. Please use the comment form below.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/31/tip-save-money-on-amazon-buy-used-books/">Tip: Save Money on Amazon - Buy Used Books</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-31T22:41:00+02:00" pubdate data-updated="true">Jan 31<span>st</span>, 2013</time>
        
         | <a href="/blog/2013/01/31/tip-save-money-on-amazon-buy-used-books/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I like to buy books, the real ones, printed on paper. This however comes at
a certain price when buying from Amazon. The book price itself is
usually bearable but many times shipping costs to Bulgaria
will double the price. Especially if you are making a single book order.</p>

<p>To save money I started buying used books when available. For books that are
not so popular I look for items that have been owned by a library.</p>

<p>This is how I got a hardcover 1984 edition of
<a href="http://www.amazon.com/gp/product/190676820X/ref=as_li_ss_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=190676820X&linkCode=as2&tag=atodorovorg-20">The Gentlemen&#8217;s Clubs of London</a><img src="http://www.assoc-amazon.com/e/ir?t=atodorovorg-20&l=as2&o=1&a=190676820X" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
by Anthony Lejeune for $10. This is my best deal so far.
The book was brand new I dare to say. There was no edge wear, no damaged pages,
with nice and vibrant colors. The second page had the library sign and no other marks.</p>

<p>Let me know if you had an experience buying used books online? Did you score a great
deal like I did?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/31/click-tracking-without-mailchimp/">Click Tracking Without MailChimp</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-31T21:23:00+02:00" pubdate data-updated="true">Jan 31<span>st</span>, 2013</time>
        
         | <a href="/blog/2013/01/31/click-tracking-without-mailchimp/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Here is a standard notification message that users at <a href="http://www.dif.io">Difio</a>
receive. It is plain text, no HTML crap, short and URLs are clean and
descriptive. As the project lead developer I wanted to track when people click on
these links and visit the website but also keep existing functionality.</p>

<p><img src="/images/email_w_links.png" title="Email with links" alt="&quot;Email with links&quot;" /></p>

<h2>Standard approach</h2>

<p>A pretty common approach when sending huge volumes of email is to use an external
service, such as MailChimp. This is one of many email
marketing services which comes with a lot of features. The most important to me
was analytics and reports.</p>

<p>The downside is that MailChimp (and I guess others) use HTML formatted emails
extensively. I don&#8217;t like that and I&#8217;m sure my users will not like it as well.
They are all developers. Not to mention that MailChimp is much more expensive
than <a href="http://aws.amazon.com/ses/">Amazon SES</a> which I use currently.
No MailChimp for me!</p>

<p>Another common approach, used by Feedburner by the way,
is to use shortened URLs which redirect to the original ones and measure clicks
in between. I also didn&#8217;t like this for two reasons: 1) the shortened URLs look
ugly and they are not at all descriptive and 2) I need to generate them automatically
and maintain all the mappings. Why bother ?</p>

<h2>How I did it? </h2>

<p>So I needed something which will do a redirect to a predefined URL, measure how many
redirects were there (essentially clicks on the link) and look nice. The solution is
very simple, if you have not recognized it by now from the picture above.</p>

<p>I opted for a custom redirect engine, which will add tracking information to the
destination URL so I can track it in Google Analytics.</p>

<p>Previous URLs were of the form <code>http://www.dif.io/updates/haml-3.1.2/haml-3.2.0.rc.3/11765/</code>.
I&#8217;ve added the humble <code>/daily/?</code> prefix before the URL path so it becomes
<code>http://www.dif.io/daily/?/updates/haml-3.1.2/haml-3.2.0.rc.3/11765/</code></p>

<p>Now <code>/updates/haml-3.1.2/haml-3.2.0.rc.3/11765/</code> becomes a query string parameter which
the <code>/daily/index.html</code> page uses as its destination. Before doing the redirect
a script adds tracking parameters so that Google Analytics will properly
report this visit. Here is the code:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;html&gt;</span>
</span><span class='line'><span class="nt">&lt;head&gt;</span>
</span><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">question</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">);</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">param</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">question</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">question</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="nx">param</span> <span class="o">+</span> <span class="s1">&#39;?utm_source=email&amp;utm_medium=email&amp;utm_campaign=Daily_Notification&#39;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span><span class='line'><span class="nt">&lt;/head&gt;</span>
</span><span class='line'><span class="nt">&lt;body&gt;&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Previously Google Analytics was reporting these visits as direct hits while now it lists them under
campaigns like so:</p>

<p><img src="/images/analytics_difio_campaigns.png" title="Difio Analytics" alt="&quot;Difio Analytics&quot;" /></p>

<p>Because all visitors of <a href="http://www.dif.io">Difio</a> use JavaScript enabled browsers
I combined this approach with another one, to
<a href="/blog/2013/01/28/remove-query-string-with-javascript-and-html5/">remove query string with JavaScript</a>
and present clean URLs to the visitor.</p>

<h2>Why JavaScript?</h2>

<p>You may be asking why the hell I am using JavaScript and not Apache&#8217;s wonderful mod_rewrite module?
This is because the destination URLs are hosted in <a href="http://aws.amazon.com/s3/">Amazon S3</a> and I&#8217;m
planning to integrate with <a href="http://aws.amazon.com/cloudfront/">Amazon CloudFront</a>. Both of them
don&#8217;t support .htaccess rules nor anything else similar to mod_rewrite.</p>

<p>As always I&#8217;d love to hear your thoughts and feedback. Please use the comment form below.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/30/startup-talk-5-book-list/">StartUP Talk#5 - Book List</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-30T16:14:00+02:00" pubdate data-updated="true">Jan 30<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/01/30/startup-talk-5-book-list/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Yesterday I have visited an interesting talk by
<a href="http://www.linkedin.com/in/tpanayotov">Teodor Panayotov</a> held at
<a href="http://www.betahaus.bg/">betahaus Sofia</a>. He was talking about his
path to success and all the companies he had worked in or founded.</p>

<p>I&#8217;m writing this post as a personal note to not forget all the good books
Teodor mentioned in his presentation.</p>

<p>I intend to read the these four as a start:</p>

<p><a href="http://www.amazon.com/gp/product/0307465357/ref=as_li_ss_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=0307465357&linkCode=as2&tag=atodorovorg-20">The 4-Hour Workweek: Escape 9-5, Live Anywhere, and Join the New Rich (Expanded and Updated)</a><img src="http://www.assoc-amazon.com/e/ir?t=atodorovorg-20&l=as2&o=1&a=0307465357" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

<p><a href="http://www.amazon.com/gp/product/0887307280/ref=as_li_ss_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=0887307280&linkCode=as2&tag=atodorovorg-20">The E-Myth Revisited: Why Most Small Businesses Don&#8217;t Work and What to Do About It</a><img src="http://www.assoc-amazon.com/e/ir?t=atodorovorg-20&l=as2&o=1&a=0887307280" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

<p><a href="http://www.amazon.com/gp/product/1422121100/ref=as_li_ss_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=1422121100&linkCode=as2&tag=atodorovorg-20">Mastering the Hype Cycle: How to Choose the Right Innovation at the Right Time (Gartner)</a><img src="http://www.assoc-amazon.com/e/ir?t=atodorovorg-20&l=as2&o=1&a=1422121100" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

<p><a href="http://www.amazon.com/gp/product/1599180413/ref=as_li_ss_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=1599180413&linkCode=as2&tag=atodorovorg-20">Business Models Made Easy</a><img src="http://www.assoc-amazon.com/e/ir?t=atodorovorg-20&l=as2&o=1&a=1599180413" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

<p>The rest he recommended are:</p>

<p><a href="http://www.amazon.com/gp/product/1591842719/ref=as_li_ss_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=1591842719&linkCode=as2&tag=atodorovorg-20">How to Get Rich: One of the World&#8217;s Greatest Entrepreneurs Shares His Secrets</a><img src="http://www.assoc-amazon.com/e/ir?t=atodorovorg-20&l=as2&o=1&a=1591842719" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

<p><a href="http://www.amazon.com/gp/product/1451614217/ref=as_li_ss_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=1451614217&linkCode=as2&tag=atodorovorg-20">Abundance: The Future Is Better Than You Think</a><img src="http://www.assoc-amazon.com/e/ir?t=atodorovorg-20&l=as2&o=1&a=1451614217" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

<p><a href="http://www.amazon.com/gp/product/0143037889/ref=as_li_ss_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=0143037889&linkCode=as2&tag=atodorovorg-20">The Singularity Is Near: When Humans Transcend Biology</a><img src="http://www.assoc-amazon.com/e/ir?t=atodorovorg-20&l=as2&o=1&a=0143037889" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

<p><a href="http://www.amazon.com/gp/product/1440428433/ref=as_li_ss_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=1440428433&linkCode=as2&tag=atodorovorg-20">The Law Of Success: Napoleon Hill</a><img src="http://www.assoc-amazon.com/e/ir?t=atodorovorg-20&l=as2&o=1&a=1440428433" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /></p>

<p>If you happen to read any of these <a href="http://www.goodreads.com/review/list/16191345-alexander-todorov?shelf=to-read">before me</a>,
please share your thoughts on the book.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/28/remove-query-string-with-javascript-and-html5/">Remove Query String With JavaScript and HTML5</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-28T15:52:00+02:00" pubdate data-updated="true">Jan 28<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/01/28/remove-query-string-with-javascript-and-html5/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A <a href="http://en.wikipedia.org/wiki/Query_string">query string</a> is the stuff after
the question mark in URLs.</p>

<p><img src="/images/url_w_qs.png" alt="&quot;URL with query string&quot;" /></p>

<h2>Why remove query strings?</h2>

<p>Two reasons: clean URLs and social media.</p>

<p>Clean URLs not only look better but they prevent users to see if you are tracking
where they came from. The picture above shows what the address bar
looks like after the user clicks a link in Feedburner. The high-lightened part is
what Google Analytics uses to distinguish Feedburner traffic from other types of
traffic. I don&#8217;t want my users to see this.</p>

<p>As you know, social media sites give URLs a score, whether it is based on number of
bookmarks, reviews, comments, likes or whatever. Higher scores usually result in
increased traffic to your site. Query strings mess things up because <a href="http://www.dif.io">http://www.dif.io</a>
and <a href="http://www.dif.io/?query">http://www.dif.io/?query</a> are usually considered two different URLs. So instead
of having a high number of likes for your page you get several scores and never
make it to the headlines.</p>

<h2>JavaScript and HTML5 to the rescue</h2>

<p>Place this JavaScript code in the <code>&lt;head&gt;</code> section of your pages. Preferably near the top.</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">uri</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">uri</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kd">var</span> <span class="nx">clean_uri</span> <span class="o">=</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">uri</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">));</span>
</span><span class='line'>    <span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">({},</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">clean_uri</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This code will clean the URL in the browser address bar without reloading the page.
It works for HTML5 enabled browsers.</p>

<p>This works for me with
Firefox 10.0.12, Opera 12.02.1578 and Chrome 24.0.1312.56 under Linux. In fact I&#8217;m
using this snippet on this very own blog as well.</p>

<p><strong>Updated on 2013-01-30</strong></p>

<p>Here is another approach proposed by reader Kamen Mazdrashki:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">clean_uri</span> <span class="o">=</span> <span class="nx">location</span><span class="p">.</span><span class="nx">protocol</span> <span class="o">+</span> <span class="s2">&quot;//&quot;</span> <span class="o">+</span> <span class="nx">location</span><span class="p">.</span><span class="nx">host</span> <span class="o">+</span> <span class="nx">location</span><span class="p">.</span><span class="nx">pathname</span><span class="p">;</span>
</span><span class='line'><span class="cm">/*</span>
</span><span class='line'><span class="cm">var hash_pos = location.href.indexOf(&quot;#&quot;);</span>
</span><span class='line'><span class="cm">if (hash_pos &gt; 0) {</span>
</span><span class='line'><span class="cm">    var hash = location.href.substring(hash_pos, location.href.length);</span>
</span><span class='line'><span class="cm">    clean_uri += hash;</span>
</span><span class='line'><span class="cm">}</span>
</span><span class='line'><span class="cm">*/</span>
</span><span class='line'><span class="nb">window</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">replaceState</span><span class="p">({},</span> <span class="nb">document</span><span class="p">.</span><span class="nx">title</span><span class="p">,</span> <span class="nx">clean_uri</span><span class="p">);</span>
</span><span class='line'><span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you&#8217;d like to keep the hash tag aka named anchor aka fragment identifier at the end of the URL
then uncomment the commented section.</p>

<p>I&#8217;ve tested removing the hashtag from the URL. Firefox doesn&#8217;t seem to scroll the page
to where I wanted but your experience may vary. I didn&#8217;t try hard enough to
verify the results.</p>

<p>One question still remains though: Why would someone point the users to an URL which contains
named anchors and then remove them? I don&#8217;t see a valid use case for this scenario. Do you?</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/01/28/hello-world/">Hello World</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-28T15:12:00+02:00" pubdate data-updated="true">Jan 28<span>th</span>, 2013</time>
        
         | <a href="/blog/2013/01/28/hello-world/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Hi everyone and welcome to my blog! My name is Alex and you can read more <a href="/about/">about me</a>
if you like.</p>

<p>After several years of rather unsuccessful blogging I decided to revamp my blog,
influenced by the book
<em>Technical Blogging: Turn Your Expertise into a Remarkable Online Presence</em>
(
<a href="http://www.amazon.com/gp/product/1934356883/ref=as_li_ss_tl?ie=UTF8&camp=1789&creative=390957&creativeASIN=1934356883&linkCode=as2&tag=atodorovorg-20">Amazon</a><img src="http://www.assoc-amazon.com/e/ir?t=atodorovorg-20&l=as2&o=1&a=1934356883" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
|
<a href="http://www.tkqlhce.com/click-7040110-11260198?url=http%3A%2F%2Fshop.oreilly.com%2Fproduct%2F9781934356883.do%3Fcmp%3Daf-npa-book-product_cj_9781934356883_%7BPID%7D&cjsku=9781934356883" target="_top">O&#8217;Reilly</a><img src="http://www.ftjcfx.com/image-7040110-11260198" width="0" height="0" border="0" style="margin:0;padding:0;display:none;"/>
).</p>

<p>I&#8217;m starting fresh with new domain name and a big list of topics to write about. This blog will
be the place to share my thoughts on open source software, QA and cloud. From time to time
I intend to write about start-ups and being a start-up owner as well.</p>

<p>All content is published under
<a href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">Creative Commons Attribution-ShareAlike 3.0</a>
license and all source code is under the <a href="http://opensource.org/licenses/MIT">MIT</a> license if not stated
otherwise.</p>

<p>I hope you find it interesting and helpful.</p>

<p><strong>Update 2013-09-22:</strong>
I have migrated some older blog posts and materials scattered around various places
to this site as well. So this isn&#8217;t the very first post anymore!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/13/mission-impossible-abrt-bugzilla-plugin-on-rhel6/">Mission Impossible - ABRT Bugzilla Plugin on RHEL6</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-13T13:21:00+03:00" pubdate data-updated="true">Jul 13<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/07/13/mission-impossible-abrt-bugzilla-plugin-on-rhel6/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Some time ago Red Hat introduced Automatic Bug Reporting Tool to their Red Hat Enterprise Linux
platform. This is a nice tool which lets users report bugs easily to Red Hat.
However one of the plugins in the latest version doesn&#8217;t seem usable at all.</p>

<p>First make sure you have <code>libreport-plugin-bugzilla</code> package installed. This is the plugin to
report bugs directly to <a href="https://bugzilla.redhat.com">Bugzilla</a>. It may not be installed by default
because customers are supposed to report issues to Support first - this is why they pay anyway.
If you are a tech savvy user though, you may want to skip Support and go straight to the developers.</p>

<p>To enable Bugzilla plugin:</p>

<ul>
<li><p>Edit the file <code>/etc/libreport/events.d/bugzilla_event.conf</code> change the line</p>

<pre><code>  EVENT=report_Bugzilla analyzer=libreport reporter-bugzilla -b
</code></pre></li>
</ul>


<p>to</p>

<pre><code>    EVENT=report_Bugzilla reporter-bugzilla -b
</code></pre>

<ul>
<li><p>Make sure ABRT will collect meaningful backtrace. If debuginfo is missing it will not let you continue.
Edit the file <code>/etc/libreport/events.d/ccpp_event.conf</code>. There should be something like this:</p>

<pre><code>  EVENT=analyze_LocalGDB analyzer=CCpp
          abrt-action-analyze-core --core=coredump -o build_ids &amp;&amp;
          abrt-action-generate-backtrace &amp;&amp;
          abrt-action-analyze-backtrace
          (
              bug_id=$(reporter-bugzilla -h `cat duphash`) &amp;&amp;
              if test -n "$bug_id"; then
                  abrt-bodhi -r -b $bug_id
              fi
          )
</code></pre></li>
<li><p>Change it to look like this - i.e. add the missing <code>/usr/libexec/</code> line:</p>

<pre><code>  EVENT=analyze_LocalGDB analyzer=CCpp
          abrt-action-analyze-core --core=coredump -o build_ids &amp;&amp;
          /usr/libexec/abrt-action-install-debuginfo-to-abrt-cache --size_mb=4096 &amp;&amp;
          abrt-action-generate-backtrace &amp;&amp;
          abrt-action-analyze-backtrace &amp;&amp;
          (
              bug_id=$(reporter-bugzilla -h `cat duphash`) &amp;&amp;
              if test -n "$bug_id"; then
                  abrt-bodhi -r -b $bug_id
              fi
          )
</code></pre></li>
</ul>


<p>Supposedly after everything is configured properly ABRT will install missing debuginfo packages,
generate the backtrace and let you report it to Bugzilla. Because of
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=759443">bug 759443</a> this will not happen.</p>

<p>To work around the problem you can try to manually install the missing debuginfo packages.
Go to your system profile in RHN and subscribe the system to all appropriate debuginfo channels.
Then install the packages. In my case:</p>

<pre><code>    # debuginfo-install firefox
</code></pre>

<p>And finally - <a href="https://bugzilla.redhat.com/show_bug.cgi?id=800754">bug 800754</a> which was already reported!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/07/12/combining-pdf-files-on-the-command-line/">Combining PDF Files on the Command Line</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-12T11:06:00+03:00" pubdate data-updated="true">Jul 12<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/07/12/combining-pdf-files-on-the-command-line/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>VERSION</strong></p>

<p>Red Hat Enterprise Linux 6</p>

<p><strong>PROBLEM</strong></p>

<p>You have to create a single PDF file by combining multiple files -
for example individually scanned pages.</p>

<p><strong>ASSUMPTIONS</strong></p>

<p>You know how to start a shell and havigate to the directory containing the files.</p>

<p><strong>SOLUTION</strong></p>

<p>If individual PDF files are named, for example, <code>doc_01.pdf</code>, <code>doc_02.pdf</code>, <code>doc_03.pdf</code>,
<code>doc_04.pdf</code>, then you can combine them with the <code>gs</code> command:</p>

<pre><code>    $ gs -dBATCH -dNOPAUSE -sDEVICE=pdfwrite -sOutputFile=mydocument.pdf doc_*.pdf
</code></pre>

<p>The resulting PDF file will contain all pages from the individual files.</p>

<p><strong>MORE INFO</strong></p>

<p>The <code>gs</code> command is part of the <a href="http://www.ghostscript.com/">ghostscript</a> rpm package.
You can find more about it using <code>man gs</code>, the documentation file <code>/usr/share/doc/ghostscript-*/index.html</code>
or <a href="http://www.ghostscript.com">http://www.ghostscript.com</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/05/19/cross-domain-ajax-served-from-cdn/">Cross-domain AJAX Served From CDN</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-05-19T16:58:00+03:00" pubdate data-updated="true">May 19<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/05/19/cross-domain-ajax-served-from-cdn/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This week Amazon <a href="http://aws.typepad.com/aws/2012/05/amazon-cloudfront-support-for-dynamic-content.html">announced</a>
support for dynamic content in their CDN solution <a href="http://aws.amazon.com/cloudfront/"><em>Amazon CloudFront</em></a>.
The announce coincided with my efforts to migrate more pieces of <em>Difio</em>&#8217;s <a href="http://www.dif.io">website</a> to <em>CloudFront</em>.</p>

<p>In this article I will not talk about hosting static files on CDN. This is easy and I&#8217;ve already written
about it <a href="/blog/2012/04/17/using-openshift-as-amazon-cloudfront-origin-server/">here</a>. I will show how to
cache AJAX(JSONP actually) responses and serve them directly from <em>Amazon CloudFront</em>.</p>

<h2>Background</h2>

<p>For those of you who may not be familiar (are there any) CDN stands for
<a href="https://en.wikipedia.org/wiki/Content_delivery_network">Content Delivery Network</a>. In short
this employs numerous servers with identical content. The requests from the browser are served
from the location which gives best performance for the user. This is used by all major websites
to speed-up static content like images, video, CSS and JavaScript files.</p>

<p>AJAX means <a href="https://en.wikipedia.org/wiki/Ajax_%28programming%29">Asynchronous JavaScript and XML</a>.
This is what Google uses to create dynamic user interface which doesn&#8217;t require to reload the page.</p>

<h2>Architecture</h2>

<p><em>Difio</em> has two web interfaces. The primary one is a static HTML website
which employs JavaScript for the dynamic areas. It is hosted on the dif.io domain.
The other one is powered by Django and provides the same interface plus the
<a href="https://difio-otb.rhcloud.com/dashboard/">applications dashboard</a> and several API functions
which don&#8217;t have a visible user interface. This is under the *.rhcloud.com domain b/c it is hosted on
<a href="http://openshift.redhat.com"><em>OpenShift</em></a>.</p>

<p>The present state of the website is the result of rapid development using conventional methods -
HTML templates and server-side processing. This is migrating to modern web technology like static HTML
and JavaScript while the server side will remain pure API service.</p>

<p>For this migration to happen I need the HTML pages at dif.io to execute JavaScript and load information
which comes from the rhcloud.com domain. Unfortunately this is not easily doable with AJAX because
of the <a href="https://en.wikipedia.org/wiki/Same_origin_policy">Same origin policy</a> in browsers.</p>

<p>I&#8217;m using the <a href="http://dojotoolkit.org/"><em>Dojo Toolkit</em></a> JavaScript framework which has a solution.
It&#8217;s called <a href="https://en.wikipedia.org/wiki/JSONP">JSONP</a>. Here&#8217;s how it works:</p>

<pre><code>     dif.io ------ JSONP request --&gt; abc.rhcloud.com --v
        ^                                              |
        |                                              |
    JavaScript processing                              |
        |                                              |
        +------------------ JSONP response ------------+
</code></pre>

<p>This is pretty standard configuration for a web service.</p>

<h2>Going to the clouds</h2>

<p>The way <em>Dojo</em> implements JSONP is through the
<a href="http://dojotoolkit.org/reference-guide/1.7/dojo/io/script.html">dojo.io.script</a> module.
It works by appending a query string parameter of the form <em>?callback=funcName</em> which the server uses
to generate the JSONP response. This callback name is dynamically generated by <em>Dojo</em> based on the order
in which your call to <em>dojo.io.script</em> is executed.</p>

<p>Until recently <em>Amazon CloudFront</em> ignored all query string parameters when requesting the content from
the origin server. Without the query string it was not possible to generate the JSONP response.
Luckily Amazon resolved the issue only one day after I asked about it on their forums.</p>

<p>Now <em>Amazon CloudFront</em> will use the URL path and the query string parameters to identify the objects in cache.
To enable this edit the CloudFront distribution <em>behavior(s)</em> and set <em>Forward Query Strings</em> to Yes.</p>

<p>When a visitor of the website requests the data <em>Amazon CloudFront</em> will use exactly the same url path and query strings
to fetch the content from the origin server. All that I had to do is switch the domain of the JSONP service
to point to the cloudfront.net domain. It became like this:</p>

<pre><code>                                                        | Everything on this side is handled by Amazon.
                                                        | No code required!
                                                        |
     dif.io ------ JSONP request --&gt; xyz.cloudfront.net -- JSONP request if cache miss --&gt; abc.rhcloud.com --v
        ^                              |                ^                                                    |
        |                              |                |                                                    |
    JavaScript processing              |                +---------- JSONP response --------------------------+
        |                              |
        +---- cached JSONP response ---+
</code></pre>

<p>As you can see the website structure and code didn&#8217;t change at all. All that changed was a single domain name.</p>

<h2>Controlling the cache</h2>

<p><em>Amazon CloudFront</em> will keep the contents in cache based on the origin headers if present or the manual configuration
from the AWS Console. To work around frequent requests to the origin server it is considered best practice to set the
Expires header to a value far in the future, like 1 year.
However if the content changes you need some way to tell <em>CloudFront</em> about it. The most commonly used method is through
using different URLs to access the same content. This will cause <em>CloudFront</em> to cache the content under the new location
while keeping the old content until it expires.</p>

<p><em>Dojo</em> makes this very easy:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="nx">require</span><span class="p">([</span><span class="s2">&quot;dojo/io/script&quot;</span><span class="p">],</span>
</span><span class='line'>    <span class="kd">function</span><span class="p">(</span><span class="nx">script</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>            <span class="nx">script</span><span class="p">.</span><span class="nx">get</span><span class="p">({</span>
</span><span class='line'>                <span class="nx">url</span><span class="o">:</span> <span class="s2">&quot;https://xyz.cloudfront.net/api/json/updates/1234&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">callbackParamName</span><span class="o">:</span> <span class="s2">&quot;callback&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="nx">content</span><span class="o">:</span> <span class="p">{</span><span class="nx">t</span><span class="o">:</span> <span class="nx">timeStamp</span><span class="p">},</span>
</span><span class='line'>                <span class="nx">load</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jsonData</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>                    <span class="p">....</span>
</span><span class='line'>                <span class="p">},</span>
</span><span class='line'><span class="p">....</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <em>content</em> property allows additional key/value pairs to be sent in the query string. The
<em>timeStamp</em> parameter serves only to control <em>Amazon CloudFront</em> cache. It&#8217;s not processed server side.</p>

<p>On the server-side we have:</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">response</span><span class="p">[</span><span class="s">&#39;Cache-Control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;max-age=31536000&#39;</span>
</span><span class='line'><span class="n">response</span><span class="p">[</span><span class="s">&#39;Expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">+</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">31536000</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S GMT&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Benefits</h2>

<p>There were two immediate benefits:</p>

<ul>
<li>Reduced page load time. Combined with serving static files from CDN this greatly improves the user experience;</li>
<li>Reduced server load. Content is requested only once if it is missing from the cache and then served from CloudFront.
The server isn&#8217;t so busy serving content so it can be used to do more computations or simply reduce the bill.</li>
</ul>


<p>The presented method works well for <em>Difio</em> because of two things:</p>

<ul>
<li>The content which <em>Difio</em> serves usually doesn&#8217;t change at all once made public. In rare occasions, for example an error
has been published, we have to regenerate new content and publish it under the same URL.</li>
<li>Before content is made public it is inspected for errors and this also preseeds the cache.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/04/17/using-openshift-as-amazon-cloudfront-origin-server/">Using OpenShift as Amazon CloudFront Origin Server</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-04-17T17:30:00+03:00" pubdate data-updated="true">Apr 17<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/04/17/using-openshift-as-amazon-cloudfront-origin-server/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&#8217;s been several months after the start of <a href="http://www.dif.io"><em>Difio</em></a> and I started
migrating various parts of the platform to CDN. The first to go are static files like
CSS, JavaScript, images and such. In this article I will show you how to get started with
<em>Amazon CloudFront</em> and <em>OpenShift</em>. It is very easy once you understand how it works.</p>

<h2>Why CloudFront and OpenShift</h2>

<p><em>Amazon CloudFront</em> is cheap and easy to setup with virtually no maintenance.
The most important feature is that it can fetch content from any public website.
Integrating it together with <em>OpenShift</em> gives some nice benefits:</p>

<ul>
<li>All static assets are managed with Git and stored in the same place where the application
code and HTML is - easy to develop and deploy;</li>
<li>No need for external service to host the static files;</li>
<li><em>CloudFront</em> will be serving the files so network load on <em>OpenShift</em> is minimal;</li>
<li>Easy to manage versioned URLs because HTML and static assets are in the same repo - more on this later;</li>
</ul>


<h2>Object expiration</h2>

<p><em>CloudFront</em> will cache your objects for a certain period and then expire them. Frequently
used objects are expired less often. Depending on the content you may want to update the cache
more or less frequently. In my case CSS and JavaScript files change rarely so I wanted to tell
CloudFront to not expire the files quickly. I did this by telling <em>Apache</em> to send a custom value for
the Expires header.</p>

<pre><code>    $ curl http://d71ktrt2emu2j.cloudfront.net/static/v1/css/style.css -D headers.txt
    $ cat headers.txt 
    HTTP/1.0 200 OK
    Date: Mon, 16 Apr 2012 19:02:16 GMT
    Server: Apache/2.2.15 (Red Hat)
    Last-Modified: Mon, 16 Apr 2012 19:00:33 GMT
    ETag: "120577-1b2d-4bdd06fc6f640"
    Accept-Ranges: bytes
    Content-Length: 6957
    Cache-Control: max-age=31536000
    Expires: Tue, 16 Apr 2013 19:02:16 GMT
    Content-Type: text/css
    Strict-Transport-Security: max-age=15768000, includeSubDomains
    Age: 73090
    X-Cache: Hit from cloudfront
    X-Amz-Cf-Id: X558vcEOsQkVQn5V9fbrWNTdo543v8VStxdb7LXIcUWAIbLKuIvp-w==,e8Dipk5FSNej3e0Y7c5ro-9mmn7OK8kWfbaRGwi1ww8ihwVzSab24A==
    Via: 1.0 d6343f267c91f2f0e78ef0a7d0b7921d.cloudfront.net (CloudFront)
    Connection: close
</code></pre>

<p>All headers before Strict-Transport-Security come from the origin server.</p>

<h2>Versioning</h2>

<p>Sometimes however you need to update the files and force <em>CloudFront</em> to update the content.
The recommended way to do this is to use URL versioning and update the path to the files
which changed. This will force <em>CloudFront</em> to cache and serve the content under the new path
while keeping the old content available until it expires. This way your visitors will not be
viewing your site with the new CSS and old JavaScript.</p>

<p>There are many ways to do this and there are some nice frameworks as well. For Python there is <em>webassets</em>.
I don&#8217;t have many static files so I opted for no additional dependencies. Instead I will be updating the
versions by hand.</p>

<p>What comes to mind is using <em>mod_rewrite</em> to redirect the versioned URLs back to non versioned ones.
However there&#8217;s a catch. If you do this <em>CloudFront</em> will cache the redirect itself, not the content.
The next time visitors hit <em>CloudFront</em> they will receive the cached redirect and follow it back to your
origin server, which is defeating the purpose of having CDN.</p>

<p>To do it properly you have to rewrite the URLs but still return a 200 response code and the
content which needs to be cached. This is done with <em>mod_proxy</em>:</p>

<pre><code>    RewriteEngine on
    RewriteRule ^VERSION-(\d+)/(.*)$ http://%{ENV:OPENSHIFT_INTERNAL_IP}:%{ENV:OPENSHIFT_INTERNAL_PORT}/static/$2 [P,L]
</code></pre>

<p>This .htaccess trick doesn&#8217;t work on <em>OpenShift</em> though. <em>mod_proxy</em> is not enabled at the moment.
See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=812389">bug 812389</a> for more info.</p>

<p>Luckily I was able to use symlinks to point to the content. Here&#8217;s how it looks:</p>

<pre><code>    $ pwd
    /home/atodorov/difio/wsgi/static

    $ cat .htaccess
    ExpiresActive On
    ExpiresDefault "access plus 1 year"

    $ ls -l
    drwxrwxr-x. 6 atodorov atodorov 4096 16 Apr 21,31 o
    lrwxrwxrwx. 1 atodorov atodorov    1 16 Apr 21,47 v1 -&gt; o

    settings.py:
    STATIC_URL = '//d71ktrt2emu2j.cloudfront.net/static/v1/'

    HTML template:
    &lt;link type="text/css" rel="stylesheet" media="screen" href="{{ STATIC_URL }}css/style.css" /&gt;
</code></pre>

<h2>How to implement it</h2>

<p>First you need to split all CSS and JavaScript from your HTML if you haven&#8217;t done so already.</p>

<p>Then place everything under your git repo so that <em>OpenShift</em> will serve the files. For Python applications
place the files under wsgi/static/ directory in your git repo.</p>

<p>Point all of your HTML templates to the static location on <em>OpenShift</em> and test if everything works as expected.
This is best done if you&#8217;re using some sort of template language and store the location
in a single variable which you can change later.
<em>Difio</em> uses <em>Django</em> and the <em>STATIC_URL</em> variable of course.</p>

<p>Create your <em>CloudFront</em> distribution - don&#8217;t use <em>Amazon S3</em>, instead configure a custom origin server. Write down
your <em>CloudFront</em> URL. It will be something like <strong>1234xyz.cludfront.net</strong>.</p>

<p>Every time a request hits <em>CloudFront</em> it will check if the object is present in the cache. If not present
<em>CloudFront</em> will fetch the object from the origin server and populate the cache. Then the object is sent
to the user.</p>

<p>Update your templates to point to the new cloudfront.net URL and redeploy your website!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/14/openshift-cron-takes-over-celerybeat/">OpenShift Cron Takes Over Celerybeat</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-14T20:48:00+02:00" pubdate data-updated="true">Mar 14<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/03/14/openshift-cron-takes-over-celerybeat/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://celeryproject.org/"><em>Celery</em></a> is an asynchronous task queue/job queue
based on distributed message passing. You can define tasks as Python functions,
execute them in the background and in a periodic fashion.
<a href="http://www.dif.io"><em>Difio</em></a> uses <em>Celery</em> for virtually everything.
Some of the tasks are scheduled after some event takes place (like user pressed a button)
or scheduled periodically.</p>

<p><em>Celery</em> provides several components of which <em>celerybeat</em> is the periodic task scheduler.
When combined with <a href="http://djangoproject.com"><em>Django</em></a> it gives you a very nice admin interface
which allows periodic tasks to be added to the scheduler.</p>

<h2>Why change</h2>

<p><em>Difio</em> has relied on <em>celerybeat</em> for a couple of months. Back then, when <em>Difio</em> launched,
there was no cron support for OpenShift so running <em>celerybeat</em> sounded reasonable.
It used to run on a dedicated virtual server and for most of the time that was fine.</p>

<p>There were a number of issues which <em>Difio</em> faced during its first months:</p>

<ul>
<li><p><em>celerybeat</em> would sometime die due to no free memory on the virtual instance.
When that happened no new tasks were scheduled and data was left unprocessed.
Let alone that higher memory instance and the processing power which comes with it
cost extra money.</p></li>
<li><p><em>Difio</em> is split into several components which need to have the same code base
locally - the most important are database settings and the periodic tasks
code. At least in one occasion <em>celerybeat</em> failed to start because of a buggy
task code. The offending code was fixed in the application server on OpenShift but
not properly synced to the <em>celerybeat</em> instance. Keeping code in sync is a priority
for distributed projects which rely on <em>Celery</em>.</p></li>
<li><p><em>Celery</em> and <em>django-celery</em> seem to be updated quite often. This poses a significant risk
of ending up with different versions on the scheduler, worker nodes and the app server. This will
bring the whole application to a halt if at some point a backward incompatible change is introduced
and not properly tested and updated. Keeping infrastructure components in sync can be a big challenge
and I try to minimize this effort as much as possible.</p></li>
<li><p>Having to navigate to the admin pages every time I add a new task or want to change the execution
frequency doesn&#8217;t feel very natural for a console user like myself and IMHO is less productive.
For the record I primarily use <em>mcedit</em>. I wanted to have something more close to the
write, commit and push work-flow.</p></li>
</ul>


<h2>The take over</h2>

<p>It&#8217;s been some time since OpenShift
<a href="https://www.redhat.com/openshift/community/blogs/getting-started-with-cron-jobs-on-openshift">introduced</a>
the cron cartridge and I decided to give it a try.</p>

<p>The first thing I did is to write a simple script which can execute any task from the difio.tasks module
by piping it to the Django shell (a Python shell actually).</p>

<figure class='code'><figcaption><span>run_celery_task </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># Copyright (c) 2012, Alexander Todorov &lt;atodorov@nospam.otb.bg&gt;</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This script is symlinked to from the hourly/minutely, etc. directories</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># SYNOPSIS</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># ./run_celery_task cron_search_dates</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># OR</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># ln -s run_celery_task cron_search_dates</span>
</span><span class='line'><span class="c"># ./cron_search_dates</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'>
</span><span class='line'><span class="nv">TASK_NAME</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="o">[</span> -z <span class="s2">&quot;$TASK_NAME&quot;</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="nv">TASK_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$0</span><span class="k">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$OPENSHIFT_APP_DIR&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">source</span> <span class="nv">$OPENSHIFT_APP_DIR</span>/virtenv/bin/activate
</span><span class='line'>    <span class="nb">export </span><span class="nv">PYTHON_EGG_CACHE</span><span class="o">=</span><span class="nv">$OPENSHIFT_DATA_DIR</span>/.python-eggs
</span><span class='line'>    <span class="nv">REPO_DIR</span><span class="o">=</span><span class="nv">$OPENSHIFT_REPO_DIR</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nv">REPO_DIR</span><span class="o">=</span><span class="k">$(</span>dirname <span class="nv">$0</span><span class="k">)</span><span class="s2">&quot;/../../..&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;import difio.tasks; difio.tasks.$TASK_NAME.delay()&quot;</span> | <span class="nv">$REPO_DIR</span>/wsgi/difio/manage.py shell
</span></code></pre></td></tr></table></div></figure>


<p>This is a multicall script which allows symlinks with different names to point to it.
Thus to add a new task to cron I just need to make a symlink to the script from one of the
hourly/, minutely/, daily/, etc. directories under cron/.</p>

<p>The script accepts a parameter as well which allows me to execute it locally for debugging purposes
or to schedule some tasks out of band.
This is how it looks like on the file system:</p>

<pre><code>$ ls -l .openshift/cron/hourly/
some_task_name -&gt; ../tasks/run_celery_task
another_task -&gt; ../tasks/run_celery_task
</code></pre>

<p>After having done these preparations I only had to embed the cron cartridge and git push to OpenShift:</p>

<pre><code>rhc-ctl-app -a difio -e add-cron-1.4 &amp;&amp; git push
</code></pre>

<h2>What&#8217;s next</h2>

<p>At present OpenShift can schedule your jobs every minute, hour, day, week or month and does so using the
<em>run-parts</em> script. You can&#8217;t schedule a script to execute at 4:30 every Monday or every 45 minutes for example.
See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=803485">rhbz #803485</a> if you want to follow the
progress. Luckily <em>Difio</em> doesn&#8217;t use this sort of job scheduling for the moment.</p>

<p><em>Difio</em> is scheduling periodic tasks from OpenShift cron for a few days already.
It seems to work reliably and with no issues. One less component to maintain and worry about.
More time to write code.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/03/09/how-to-get-to-the-openshift-shell/">Tip: How to Get to the OpenShift Shell</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-03-09T21:43:00+02:00" pubdate data-updated="true">Mar 9<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/03/09/how-to-get-to-the-openshift-shell/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I wanted to examine the Perl environment on OpenShift and got tired of making snapshots,
unzipping the archive and poking through the files. I wanted a shell. Here&#8217;s how to get one.</p>

<ol>
<li><p>Get the application info first</p>

<pre><code> $ rhc-domain-info 
 Password: 
 Application Info
 ================
 myapp
     Framework: perl-5.10
      Creation: 2012-03-08T13:34:46-04:00
          UUID: 8946b976ad284cf5b2401caf736186bd
       Git URL: ssh://8946b976ad284cf5b2401caf736186bd@myapp-mydomain.rhcloud.com/~/git/myapp.git/
    Public URL: http://myapp-mydomain.rhcloud.com/

  Embedded: 
       None
</code></pre></li>
<li><p>The Git URL has your username and host</p></li>
<li><p>Now just ssh into the application</p>

<pre><code> $ ssh 8946b976ad284cf5b2401caf736186bd@myapp-mydomain.rhcloud.com

     Welcome to OpenShift shell

     This shell will assist you in managing OpenShift applications.

     !!! IMPORTANT !!! IMPORTANT !!! IMPORTANT !!!
     Shell access is quite powerful and it is possible for you to
     accidentally damage your application.  Proceed with care!
     If worse comes to worst, destroy your application with 'rhc app destroy'
     and recreate it
     !!! IMPORTANT !!! IMPORTANT !!! IMPORTANT !!!

     Type "help" for more info.

 [myapp-mydomain.rhcloud.com ~]\&gt; 
</code></pre></li>
</ol>


<p><strong>Voila!</strong></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/18/how-to-update-dependencies-on-openshift/">How to Update Dependencies on OpenShift</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-18T01:00:00+02:00" pubdate data-updated="true">Feb 18<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/02/18/how-to-update-dependencies-on-openshift/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you are already running some cool application on <a href="http://openshift.redhat.com">OpenShift</a>
it could be the case that you have to update some of the packages installed as dependencies.
Here is an example for an application using the python-2.6 cartridge.</p>

<h2>Pull latest upstream packages</h2>

<p>The most simple method is to update everything to the latest upstream versions.</p>

<ol>
<li><p>Backup! Backup! Backup!</p>

<pre><code> rhc-snapshot -a mycoolapp
 mv mycoolapp.tar.gz mycoolapp-backup-before-update.tar.gz
</code></pre></li>
<li><p>If you haven&#8217;t specified any particular version in <code>setup.py</code> it will
look like this:</p></li>
</ol>


<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">...</span>
</span><span class='line'><span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
</span><span class='line'>                <span class="s">&#39;difio-openshift-python&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&#39;MySQL-python&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s">&#39;Markdown&#39;</span><span class="p">,</span>
</span><span class='line'>               <span class="p">],</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>To update simply push to OpenShift instructing it to rebuild your virtualenv:</p>

<pre><code> cd mycoolapp/
 touch .openshift/markers/force_clean_build
 git add .openshift/markers/force_clean_build
 git commit -m "update to latest upstream"
 git push
</code></pre></li>
</ol>


<p>Voila! The environment hosting your application is rebuilt from scratch.</p>

<h2>Keeping some packages unchanged</h2>

<p>Suppose that before the update you have <code>Markdown-2.0.1</code> and you want to keep it!
This is easily solved by adding versioned dependency to <code>setup.py</code></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">-       &#39;Markdown&#39;,</span>
</span><span class='line'><span class="gi">+       &#39;Markdown==2.0.1&#39;,</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you do that OpenShift will install the same <code>Markdown</code> version when rebuilding your
application. Everything else will use the latest available versions.</p>

<p><strong>Note:</strong> after the update it&#8217;s recommended that you remove the
<code>.openshift/markers/force_clean_build</code> file. This will speed up the push/build process
and will not surprise you with unwanted changes.</p>

<h2>Update only selected packages</h2>

<p>Unless your application is really simple or you have tested the updates, I suspect that
you want to update only selected packages. This can be done without rebuilding the whole
virtualenv. Use versioned dependencies in <code>setup.py</code> :</p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">-       &#39;Markdown==2.0.1&#39;,</span>
</span><span class='line'><span class="gd">-       &#39;django-countries&#39;,</span>
</span><span class='line'><span class="gi">+       &#39;Markdown&gt;=2.1&#39;,</span>
</span><span class='line'><span class="gi">+       &#39;django-countries&gt;=1.1.2&#39;,</span>
</span></code></pre></td></tr></table></div></figure>


<p>No need for <code>force_clean_build</code> this time. Just</p>

<pre><code>    git commit &amp;&amp; git push
</code></pre>

<p>At the time of writing my application was using <code>Markdown-2.0.1</code> and <code>django-countries-1.0.5</code>.
Then it updated to <code>Markdown-2.1.1</code> and <code>django-countires-1.1.2</code> which also happened to be
the latest versions.</p>

<p><strong>Note:</strong> this will not work without <code>force_clean_build</code></p>

<figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gd">-       &#39;django-countries==1.0.5&#39;,</span>
</span><span class='line'><span class="gi">+       &#39;django-countries&#39;,</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Warning</h2>

<p>OpenShift uses a local mirror of <a href="http://pypi.python.org">Python Package Index</a>.
It seems to be updated every 24 hours or so. Have this in mind if you want to update
to a package that was just released. It will not work! See
<a href="/blog/2013/04/24/how-to-deploy-python-hotfix-on-redhat-openshift-cloud/">How to Deploy Python Hotfix on OpenShift</a>
if you wish to work around this limitation.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2012/02/10/spinning-up-a-development-instance-on-openshift/">Spinning-up a Development Instance on OpenShift</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-02-10T21:19:00+02:00" pubdate data-updated="true">Feb 10<span>th</span>, 2012</time>
        
         | <a href="/blog/2012/02/10/spinning-up-a-development-instance-on-openshift/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p><a href="http://www.dif.io">Difio</a> is hosted on <a href="http://openshift.redhat.com">OpenShift</a>.
During development I often need to spin-up another copy of Difio to use for testing and development.
With OpenShift this is easy and fast. Here&#8217;s how:</p>

<ol>
<li><p>Create another application on OpenShift. This will be your development instance.</p>

<pre><code> rhc-create-app -a myappdevel -t python-2.6
</code></pre></li>
<li><p>Find out the git URL for the production application:</p>

<pre><code> $ rhc-user-info
 Application Info
 ================
 myapp
     Framework: python-2.6
      Creation: 2012-02-10T12:39:53-05:00
          UUID: 723f0331e17041e8b34228f87a6cf1f5
       Git URL: ssh://723f0331e17041e8b34228f87a6cf1f5@myapp-mydomain.rhcloud.com/~/git/myapp.git/
    Public URL: http://myapp-mydomain.rhcloud.com/
</code></pre></li>
<li><p>Push the current code base from the production instance to devel instance:</p>

<pre><code> cd myappdevel
 git remote add production -m master ssh://723f0331e17041e8b34228f87a6cf1f5@myapp-mydomain.rhcloud.com/~/git/myapp.git/
 git pull -s recursive -X theirs production master
 git push
</code></pre></li>
<li><p>Now your <code>myappdevel</code> is the same as your production instance. You will probably want to
modify your database connection settings at this point and start adding new features.</p></li>
</ol>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/09/15/protected-rpm-repositories-with-yum-and-ssl/">Protected RPM Repositories With Yum and SSL</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-09-15T19:40:00+03:00" pubdate data-updated="true">Sep 15<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/09/15/protected-rpm-repositories-with-yum-and-ssl/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this article I&#8217;m going to describe a simple way to set-up RPM repositories with access control using only standard tools such as yum, SSL and Apache.
I&#8217;ve been talking about this at one of the monthly conferences of Linux for Bulgarians!</p>

<p><strong>Objective:</strong><br />
Create RPM repository with access control. Access is allowed only for some systems and forbidden for the rest. This is a similar to what Red Hat Network does.</p>

<p><strong>Solution:</strong><br />
We&#8217;re going to use yum and Apache capabilities to work with SSL certificates. The client side (yum) will identify itself using SSL certificate and the server (Apache) will use this information to control the access.</p>

<p><strong>Client side set-up:</strong><br /></p>

<ol>
  <li>
Yum version 3.2.27 or newer supports SSL certificates for client authentication. This version is available in Red Hat Enterprise Linux 6. 
  </li>

  <li>
First you need to generate a private key and certificate using OpenSSL:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># openssl genrsa -out /var/lib/yum/client.key 1024
</span><span class='line'>Generating RSA private key, 1024 bit long modulus
</span><span class='line'>....++++++
</span><span class='line'>.......++++++
</span><span class='line'>e is 65537 (0x10001)
</span><span class='line'>
</span><span class='line'># openssl req -new -x509 -text -key /var/lib/yum/client.key -out /var/lib/yum/client.cert
</span><span class='line'>You are about to be asked to enter information that will be incorporated
</span><span class='line'>into your certificate request.
</span><span class='line'>What you are about to enter is what is called a Distinguished Name or a DN.
</span><span class='line'>There are quite a few fields but you can leave some blank
</span><span class='line'>For some fields there will be a default value,
</span><span class='line'>If you enter '.', the field will be left blank.
</span><span class='line'>-----
</span><span class='line'>Country Name (2 letter code) [XX]:BG
</span><span class='line'>State or Province Name (full name) []:Sofia
</span><span class='line'>Locality Name (eg, city) [Default City]:Sofia
</span><span class='line'>Organization Name (eg, company) [Default Company Ltd]:Open Technologies Bulgaria
</span><span class='line'>Organizational Unit Name (eg, section) []:IT
</span><span class='line'>Common Name (eg, your name or your server's hostname) []:
</span><span class='line'>Email Address []:no-spam@otb.bg</span></code></pre></td></tr></table></div></figure>
  </li>

  <li>
For better security you can change file permissions of <em>client.key</em>:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># chmod 600 /var/lib/yum/client.key</span></code></pre></td></tr></table></div></figure>
  </li>

  <li>
You need to define the protected repository in a .repo file. It needs to look something like this:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># cat /etc/yum.repos.d/protected.repo
</span><span class='line'>[protected]
</span><span class='line'>name=SSL protected repository
</span><span class='line'>baseurl=https://repos.example.com/protected
</span><span class='line'>enabled=1
</span><span class='line'>gpgcheck=1
</span><span class='line'>gpgkey=https://repos.example.com/RPM-GPG-KEY
</span><span class='line'>
</span><span class='line'>sslverify=1
</span><span class='line'>sslclientcert=/var/lib/yum/client.cert
</span><span class='line'>sslclientkey=/var/lib/yum/client.key</span></code></pre></td></tr></table></div></figure>
  </li>

  <li>
If you use self-signed server certificate you can specify  <em>sslverify=0</em>, but this is not recommended.
  </li>
</ol>


<p>Whenever yum tries to reach the URL of the repository it will identify itself using the specified certificate.</p>

<p><strong>Server side set-up:</strong><br /></p>

<ol>
  <li>
Install and configure the <em>mod_ssl</em> module for Apache.
  </li>

  <li>
Create a directory for the repository which will be available over HTTPS.
  </li>

  <li>
In the repository directory add <em>.htaccess</em>, which looks something like this:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Action rpm-protected /cgi-bin/rpm.cgi
</span><span class='line'>AddHandler rpm-protected .rpm .drpm
</span><span class='line'>SSLVerifyClient optional_no_ca</span></code></pre></td></tr></table></div></figure>
  </li>

  <li>
The <em>Action</em> and <em>AddHandler</em> directives instruct Apache to run the <em>rpm.cgi</em> CGI script every time someone tries to access files with extension .rpm and .drpm.
  </li>

  <li>
The <em>SSLVerifyClient</em> directive tells Apache that the http client may present a valid certificate but it has not to be (successfully) verifyable.
For more information on this configuration please see
<a href="http://www.modssl.org/docs/2.1/ssl_reference.html#ToC13">http://www.modssl.org/docs/2.1/ssl_reference.html#ToC13</a>.
  </li>

  <li>
The simplest form of <em>rpm.cgi</em> script may look like this:
<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>#!/bin/bash
</span><span class='line'>
</span><span class='line'>if [ "$SSL_CLIENT_M_SERIAL" == "9F938211B53B4F44" ]; then
</span><span class='line'>    echo "Content-type: application/x-rpm"
</span><span class='line'>    echo "Content-length: $(stat --printf='%s' $PATH_TRANSLATED)"
</span><span class='line'>    echo
</span><span class='line'>
</span><span class='line'>    cat $PATH_TRANSLATED
</span><span class='line'>else
</span><span class='line'>    echo "Status: 403"
</span><span class='line'>    echo
</span><span class='line'>fi</span></code></pre></td></tr></table></div></figure>
  </li>

  <li>
The script will allow access to a client which uses a certificate with serial number <em>9F938211B53B4F44</em>. Other clients will be denied access and the server will return standard 403 error code.
  </li>
</ol>


<p><strong>In practice:</strong><br />
The above set-up is very basic and only demonstrates the technology behind this. In a real world configuration you will need some more tools to make this really usable.</p>

<p>My company <a href="http://otb.bg">Open Technologies Bulgaria, Ltd.</a> has developed a custom solution for our customers based on the above example called Voyager. It features a Drupal module, a CGI script and a client side yum plugin.</p>

<p>The Drupal module acts as web interface to the system and allows some basic tasks. Administrators can define software channels and subscription expiration. Customers can register and entitle their systems to particular channels. The functionality is similar to Red Hat Network but without all the extra features which we don&#8217;t need.</p>

<p>The CGI script acts as a glue between the client side and the Drupal backend. It will read information about client credentials and act as first line of defence against non-authorized access. Then it will communicate with the Drupal database and get more information about this customer. If everything is OK then access will be allowed.</p>

<p>The yum plugin has the task to communicate with the Drupal backend and dynamically update repository definitions based on available subscriptions. Then it will send a request for the RPM file back to the Apache server where the CGI script will handle it.</p>

<p>The client side also features a tool to generate the client certificate and register the system to the server.</p>

<p>All communications are entirely over HTTPS.</p>

<p>This custom solution has the advantage that it is simple and easy to maintain as well as easy to use. It integrates well with other plugins (e.g. yum-presto for delta rpm support and yum-rhnplugin) and can be used via yum or PackageKit which are the standard package management tools on Red Hat Enterprise Linux 6.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2011/03/14/usb-multi-seat-on-red-hat-enterprise-linux-6/">USB Multi-seat on Red Hat Enterprise Linux 6</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-03-14T20:10:00+02:00" pubdate data-updated="true">Mar 14<span>th</span>, 2011</time>
        
         | <a href="/blog/2011/03/14/usb-multi-seat-on-red-hat-enterprise-linux-6/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Multiseat configurations are well known in the Linux community and have been used for a number of years now. In the last few years USB docking stations emerged on the market and are becoming popular among multiseat enthusiasts.</p>

<p>My company <a href="http://otb.bg">Open Technologies Bulgaria, Ltd.</a> offers full support of USB multiseat for Red Hat Enterprise Linux 6 as a downstream vendor. We use the name SUMU (simple usb multi user) to refer to the entire multiseat bundle and in this article I&#8217;m going to describe the current state of technologies surrounding multiseat, how that works on RHEL 6 and some practical observations.</p>

<h2>COMPONENTS</h2>

<p>To build a multiseat system you need a number of individual components:</p>

<p><img src="/images/plugable_docking_station.png" alt="UD-160-A" style="float: right;"/></p>

<ul>
  <li>
    USB docking station like Plugable&#8217;s <a href="http://plugable.com/products/UD-160-A">UD-160-A</a> or a combination of <a href="http://plugable.com/products/">USB video card</a> and stand alone USB hub. It is also possible to use USB docking stations from other vendors but I&#8217;m not aware of anyone who did it.
  </li>

  <li>
<em>udlfb</em> - a kernel driver for USB graphics adapters which use DisplayLink based chips. As of January 2011 udlfb.c is part of the mainline kernel tree and is on track for 2.6.38. On RHEL6 this can easily be built as a stand alone module. There are no issues with this package.

We also use a custom patch that will draw the string &#8220;fbX&#8221; onto the green screen. This is useful for easier identification of the display. The patch can be found <a href="http://otb-sources.googlecode.com/svn/trunk/sumu/udlfb-kmod/fbX-numbering.patch">here</a>.
  </li>

  <li>
<em>Xorg</em> - this is the standard graphics server on Linux. In RHEL 6 we have xorg-x11-server-Xorg-1.7.7-26 which works perfectly in a multiseat environment.
  </li>

  <li>
<em>xorg-x11-drv-fbdev</em> with extensions - Xorg driver based on the <em>fbdev</em> driver. The extensions add support for the X DAMAGE protocol. This is a temporary solution until Xorg adds support for the damage protocol. Our package is called <em>xorg-x11-drv-fbdev-displaylink</em> to avoid conflict with the stock package provided by the distribution and it installs the files in <em>/usr/local</em>. You can also change the compiler flags and produce a binary under a different name (say <em>displaylink_drv.so</em> instead of <em>fbdev_drv.so</em>).
  </li>

  <li>
<em>GDM</em> with multiseat support - GDM will manage multiple local displays and has the ability to add/remove displays dynamically. This functionality is present in versions up to 2.20 and since RHEL6 includes gdm-2.30.4-21.el6 this is a tough choice. There are several possibilities:
<ol>
  <li>
Use older <em>GDM</em>, preferably from a previous RHEL release. This gives you a tested piece of software and as long as the previous release is maintained you have (at least some) opportunity of fixing bugs in this code base. However this conflicts with current <em>GDM</em> in the distro which is also integrated with <em>ConsoleKit</em>, <em>Plymouth</em> and <em>PulseAudio</em>.
  </li>

  <li>
Use <em>GDM</em> and <em>ConsoleKit</em> that are available in RHEL6 and apply the multiseat patches available at
https://bugs.freedesktop.org/show_bug.cgi?id=19333 and http://bugzilla.gnome.org/show_bug.cgi?id=536355.

Those patches are quite big (around 3000 lines each) and are not yet fully integrated upstream. They also conflict with custom patches that Red Hat is shipping into these packages. Your patched packages will also conflict with the stock distro packages and you will not receive any support for that. Since <em>ConsoleKit</em> seems like fairly important application I&#8217;d not recommend modifying it.
  </li>

  <li>
Use another display manager that can handle multiple displays. https://help.ubuntu.com/community/MultiseatX suggests to use <em>KDM</em> instead of <em>GDM</em>. As far as I can tell the configuration is only static and this can break any time due to the fact that USB device discovery is unpredictable and unreliable. It also lacks an alternative for <em>gdmdynamic</em> according to http://lists.kde.org/?l=kde-devel&m=129898381127854&w=2 which makes it a no-go for plug-and-play multiseat support.

There are other less popular display managers but I haven&#8217;t spend much time in research.
  </li>

  <li>
Just for the record it is also possible that one writes a custom display manager for multiseat operations. This sounds like an overkill and there are many factors which need to be taken into account. If you have enough resources and knowledge to write a display manager you&#8217;d better give upstream a hand instead of reinventing the wheel. 
  </li>
</ol>

We&#8217;ve decided to use <em>GDM 2.16</em> from RHEL5 due to the above factors. In practice it turns out that there aren&#8217;t many issues with this version.
  </li>

  <li>
<em>A GDM theme</em> - since the GDM version we&#8217;re using requires a theme which is missing in RHEL6 this is also provided as a separate package. A GDM theme is an XML file plus some images.
  </li>

  <li>
<em>udev rules, scripts and config files</em> - this is the glue between all the other components. Their primary job is to group the display-mouse-keyboard pairs for a given seat and start the display with the appropriate configuration settings. We also have support for <em>PulseAudio</em>.
  </li>
</ul>


<h2>RHEL6 SPECIFICS</h2>

<p>For detailed description of multiseat configuration take a look at http://plugable.com/2009/11/16/setting-up-usb-multiseat-with-displaylink-on-linux-gdm-up-to-2-20/ or at our <a href="http://otb-sources.googlecode.com/svn/trunk/sumu/">source code</a>. I&#8217;m going to describe only the differences in RHEL6.</p>

<p><em>GDM</em>, <em>udlfb</em> and <em>xorg-x11-drv-fbdev-displaylink</em> need to be compiled and installed on the system.</p>

<p>To build an older <em>GDM</em> on RHEL6 you will need to adjust some of the patches in the src.rpm package to apply cleanly and tweak the .spec file to your needs. This also includes using the appropriate version of <em>ltmain.sh</em> from the distro.</p>

<p>The udev rules and scripts are slightly different due to the different device paths in RHEL6:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>SYSFS<span class="o">{</span>idVendor<span class="o">}==</span><span class="s2">&quot;17e9&quot;</span>, SYSFS<span class="o">{</span>bConfigurationValue<span class="o">}==</span><span class="s2">&quot;2&quot;</span>, <span class="nv">RUN</span><span class="o">=</span><span class="s2">&quot;/bin/echo 1 &gt; /sys%p/bConfigurationValue&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">ACTION</span><span class="o">==</span><span class="s2">&quot;add&quot;</span>,    <span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;fb*&quot;</span>, <span class="nv">SUBSYSTEM</span><span class="o">==</span><span class="s2">&quot;graphics&quot;</span>, <span class="nv">SUBSYSTEMS</span><span class="o">==</span><span class="s2">&quot;usb&quot;</span>, <span class="nv">PROGRAM</span><span class="o">=</span><span class="s2">&quot;/usr/bin/sumu-hub-id /sys/%p/device/../&quot;</span>, SYMLINK+<span class="o">=</span><span class="s2">&quot;usbseat/%c/display&quot;</span>,  RUN+<span class="o">=</span><span class="s2">&quot;/etc/udev/scripts/start-seat %c&quot;</span>
</span><span class='line'><span class="nv">ACTION</span><span class="o">==</span><span class="s2">&quot;remove&quot;</span>, <span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;fb*&quot;</span>, <span class="nv">SUBSYSTEM</span><span class="o">==</span><span class="s2">&quot;graphics&quot;</span>, RUN+<span class="o">=</span><span class="s2">&quot;/etc/udev/scripts/stop-seat %k&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;control*&quot;</span>, <span class="nv">SUBSYSTEM</span><span class="o">==</span><span class="s2">&quot;sound&quot;</span>, <span class="nv">BUS</span><span class="o">==</span><span class="s2">&quot;usb&quot;</span>, <span class="nv">PROGRAM</span><span class="o">=</span><span class="s2">&quot;/usr/bin/sumu-hub-id /sys/%p/device/../../../../&quot;</span>, SYMLINK+<span class="o">=</span><span class="s2">&quot;usbseat/%c/sound&quot;</span>
</span><span class='line'><span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;event*&quot;</span>, <span class="nv">SUBSYSTEM</span><span class="o">==</span><span class="s2">&quot;input&quot;</span>, <span class="nv">BUS</span><span class="o">==</span><span class="s2">&quot;usb&quot;</span>, SYSFS<span class="o">{</span>bInterfaceClass<span class="o">}==</span><span class="s2">&quot;03&quot;</span>, SYSFS<span class="o">{</span>bInterfaceProtocol<span class="o">}==</span><span class="s2">&quot;01&quot;</span>, <span class="nv">PROGRAM</span><span class="o">=</span><span class="s2">&quot;/usr/bin/sumu-hub-id /sys/%p/device/../../../../&quot;</span>, SYMLINK+<span class="o">=</span><span class="s2">&quot;usbseat/%c/keyboard&quot;</span>, RUN+<span class="o">=</span><span class="s2">&quot;/etc/udev/scripts/start-seat %c&quot;</span>
</span><span class='line'><span class="nv">KERNEL</span><span class="o">==</span><span class="s2">&quot;event*&quot;</span>, <span class="nv">SUBSYSTEM</span><span class="o">==</span><span class="s2">&quot;input&quot;</span>, <span class="nv">BUS</span><span class="o">==</span><span class="s2">&quot;usb&quot;</span>, SYSFS<span class="o">{</span>bInterfaceClass<span class="o">}==</span><span class="s2">&quot;03&quot;</span>, SYSFS<span class="o">{</span>bInterfaceProtocol<span class="o">}==</span><span class="s2">&quot;02&quot;</span>, <span class="nv">PROGRAM</span><span class="o">=</span><span class="s2">&quot;/usr/bin/sumu-hub-id /sys/%p/device/../../../../&quot;</span>, SYMLINK+<span class="o">=</span><span class="s2">&quot;usbseat/%c/mouse&quot;</span>,    RUN+<span class="o">=</span><span class="s2">&quot;/etc/udev/scripts/start-seat %c&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>We also use only <em>/dev/event*</em> devices for both mouse and keyboard.</p>

<p>The <em>sumu-hub-id</em> script returns the string busX-devY indicating the location of the device:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -d <span class="s2">&quot;$1&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;bus$(cat $1/busnum)-dev$(cat $1/devnum)&quot;</span>
</span><span class='line'>    <span class="nb">exit </span>0
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>USB device numbering is unique per bus and there isn&#8217;t a global device identifier as far as I know. On systems with 2 or more USB buses this can lead to mismatch between devices/seats.</p>

<p>For seat/display numbering we use the number of the framebuffer device associated with the seat. This is unique, numbers start from 1 (<em>fb0</em> is the text console) and are sequential unlike USB device numbers. This also ensures easy match between <em>$DISPLAY</em> and <em>/dev/fbX</em> for debugging purposes.</p>

<p>Our <em>xorg.conf.sed</em> template uses evdev as the input driver. This driver is the default in RHEL6:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>Section <span class="s2">&quot;InputDevice&quot;</span>
</span><span class='line'>    Identifier <span class="s2">&quot;keyboard&quot;</span>
</span><span class='line'>    Driver      <span class="s2">&quot;evdev&quot;</span>
</span><span class='line'>    Option      <span class="s2">&quot;CoreKeyboard&quot;</span>
</span><span class='line'>    Option      <span class="s2">&quot;Device&quot;</span>        <span class="s2">&quot;/dev/usbseat/%SEAT_PATH%/keyboard&quot;</span>
</span><span class='line'>    Option      <span class="s2">&quot;XkbModel&quot;</span>      <span class="s2">&quot;evdev&quot;</span>
</span><span class='line'>EndSection
</span><span class='line'>
</span><span class='line'>Section <span class="s2">&quot;InputDevice&quot;</span>
</span><span class='line'>    Identifier <span class="s2">&quot;mouse&quot;</span>
</span><span class='line'>    Driver      <span class="s2">&quot;evdev&quot;</span>
</span><span class='line'>    Option      <span class="s2">&quot;CorePointer&quot;</span>
</span><span class='line'>    Option      <span class="s2">&quot;Protocol&quot;</span> <span class="s2">&quot;auto&quot;</span>
</span><span class='line'>    Option      <span class="s2">&quot;Device&quot;</span>   <span class="s2">&quot;/dev/usbseat/%SEAT_PATH%/mouse&quot;</span>
</span><span class='line'>    Option      <span class="s2">&quot;Buttons&quot;</span> <span class="s2">&quot;5&quot;</span>
</span><span class='line'>    Option      <span class="s2">&quot;ZAxisMapping&quot;</span> <span class="s2">&quot;4 5&quot;</span>
</span><span class='line'>EndSection
</span></code></pre></td></tr></table></div></figure>


<p>We also use a custom <em>gdm.conf</em> file to avoid conflicts with stock packages. Only the important settings are shown:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>daemon<span class="o">]</span>
</span><span class='line'><span class="nv">AlwaysRestartServer</span><span class="o">=</span><span class="nb">false</span>
</span><span class='line'><span class="nv">DynamicXServers</span><span class="o">=</span><span class="nb">true</span>
</span><span class='line'><span class="nv">FlexibleXServers</span><span class="o">=</span>0
</span><span class='line'><span class="nv">VTAllocation</span><span class="o">=</span><span class="nb">false</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>servers<span class="o">]</span>
</span><span class='line'><span class="nv">0</span><span class="o">=</span>inactive
</span></code></pre></td></tr></table></div></figure>


<p>AlwaysRestartServer=false is necessary to avoid a bug in <em>Xorg</em>. See below for issues description.</p>

<p>Audio is supported by setting $PULSE_SINK/$PULSE_SOURCE environment variables using a script in <em>/etc/profile.d</em> which executes after login.</p>

<h2>SCALABILITY AND PERFORMANCE</h2>

<p><strong>Maximum seats</strong>:<br />
The USB standard specifies a maximum of 127 USB devices connected to a single host controller. This means around 30 seats per USB controller depending on the number of devices connected to a USB hub. In practice you will have hard time finding a system which has that many port available. I&#8217;ve used Fujitsu&#8217;s <a href="http://ts.fujitsu.com/products/standard_servers/tower/primergy_tx100s1.html">TX100 S1</a> and <a href="http://ts.fujitsu.com/products/standard_servers/tower/primergy_tx100s2.html">TX100 S2</a> which can be expanded to 15 or 16 USB ports using all external and internal ports and additional PCI-USB extension card.</p>

<p>While larger configuration are possible by using more PCI cards or intermediate hubs those are limited by the USB 2.0 transfer speed (more devices on a single hub, slower graphics) and a <a href="https://bugzilla.kernel.org/show_bug.cgi?id=28682">bug</a> in the Linux kernel.</p>

<p><strong>Space and cable length</strong>:<br />
USB 2.0 limits the cable length to 5 meters. On the market I&#8217;ve found good quality cables running 4.5 meters. This means that your multiseat system needs to be confined is small physical space due to these limitations. In practice using medium sized multiseat system in a 30 square meters space is doable and fits into these limits. This is roughly the size of a class-room in a school.</p>

<p>You can of course use daisy chaining (up to 5 hubs) and active USB extension cords (11 meters) or USB over CAT5 cables (up to 45 meters) but all of these interfere with USB signal strength and can lead to unpredictable behavior. For example I&#8217;ve see errors opening USB devices when power is not sufficient or too high. Modern computer systems have built in hardware protection and shut off USB ports or randomly reboot when the current on the wire is too strong. I&#8217;ve seen this on a number of occasions and the fix was to completely power off and unplug the system then power it on again.</p>

<p>Also don&#8217;t forget that USB video consumes a great deal of the limited USB 2.0 bandwidth. Depending on the workload of the system (e.g. office applications vs. multimedia) you could experience slow graphical response if using extension cords and daisy chaining.</p>

<p><strong>Performance</strong>:<br />
For regular desktop use (i.e. nothing in particular) I&#8217;d recommend using 32bit operating system. On 64bit systems objects take a lot more memory and you&#8217;ll need 3-4 times more for the same workload as on 32bit. For example 16 users running Eclipse, gnome-terminal and Firefox will need less that 8GB of memory on 32bit and more than 16GB on 64bit. Python and Java are particularly known to use much more memory on 64bit.</p>

<p>Regular desktop usage is not CPU intensive and a modern Xeon CPU has no issues with it. One exception is Flash which always causes your CPU to choke. On multiseat that becomes even a bigger problem. If possible disable/remove Flash from the system.</p>

<p>Multiseat doesn&#8217;t make any difference when browsing, sending e-mail, etc. You shouldn&#8217;t experience issues with networking unless your workload doesn&#8217;t require hi-speed connection or your bandwidth is too low. If this is the case you&#8217;d better use the USB NICs available in the docking stations and bond them together, add external PCI NICs or upgrade your networking infrastructure.</p>

<p>Disk performance is critical in multiseat especially because it affects the look and feel of the system and is visible by the end users. It is usually good practice to place /home on a separate partition and even on a separate disk. Also consider disabling unnecessary caching in user space applications such as Firefox and Nautilus (thumbnails and cache).</p>

<p>On a system with 2 x 7,2K RPM disks in BIOS RAID1 configuration and a standard RHEL6 installation (i.e. no optimizations configured) where /, swap and /home are on the same RAID array we have 15 users using GNOME, gedit, Firefox, gnome-terminal and gcc. The performance is comparable to stand alone desktop with occasional spikes which cause GNOME to freeze for a second or two. It is expected that disabling unnecessary caching will make things better.</p>

<p>Depending on the workload (reads vs. writes) you should consider different RAID levels, file system types and settings and changing disk parameters. A good place to start is the &#8220;Storage Administration Guide&#8221; and &#8220;I/O Tuning Guide&#8221; at http://docs.redhat.com.</p>

<h2>KNOWN ISSUES</h2>

<ul>
 <li>
<a href="https://bugzilla.kernel.org/show_bug.cgi?id=28682">Bug 28682 - input drivers support limited device numbers (EVDEV_MINORS is 32)</a> - this bug will block you from adding more than 32 input devices of the same type. For multiseat that means 32 devices which are handled by the event driver which includes mice, keyboards, joystick and special platform events such as the Reboot/Poweroff buttons. This limits the available seats to around 15.
 </li>

 <li>
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=679122">Bug 679122 - gnome-volume-control: Sound at 100% and no sound output</a> - upon first login the user will not hear any sound regardless of the fact that the volume control application shows volume is at 100%.
 </li>

 <li>
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=682562">Bug 682562 - gnome-volume-control doesn&#8217;t respect PULSE_SINK/PULSE_SOURCE</a> - the volume control application will not behave correctly and may confuse users.
 </li>

 <li>
Xorg will cause 100% CPU usage after logout - this is due to several factors. The <a href="http://plugable.com/2009/11/16/setting-up-usb-multiseat-with-displaylink-on-linux-gdm-up-to-2-20/">initial multiseat configuration</a> had a problem with input duplication. This was fixed by removing &#8220;-sharevts -novtswitch&#8221; from the X start line and substituting a specific VT - &#8220;vt07&#8221;. 

This works fine unless one of the users logs out of their GNOME session. After that GDM will kill and restart it&#8217;s process and new Xorg process will be spawned. The restarted instance will loop endlessly executing the following code:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">ioctl</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">TCFLSH</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">)</span>                   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">EIO</span> <span class="p">(</span><span class="n">Input</span><span class="o">/</span><span class="n">output</span> <span class="n">error</span><span class="p">)</span>
</span><span class='line'><span class="n">setitimer</span><span class="p">(</span><span class="n">ITIMER_REAL</span><span class="p">,</span> <span class="p">{</span><span class="n">it_interval</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20000</span><span class="p">},</span> <span class="n">it_value</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20000</span><span class="p">}},</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="p">{</span><span class="mi">247</span><span class="p">,</span> <span class="mi">684817842</span><span class="p">})</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">clock_gettime</span><span class="p">(</span><span class="n">CLOCK_MONOTONIC</span><span class="p">,</span> <span class="p">{</span><span class="mi">247</span><span class="p">,</span> <span class="mi">684921278</span><span class="p">})</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">setitimer</span><span class="p">(</span><span class="n">ITIMER_REAL</span><span class="p">,</span> <span class="p">{</span><span class="n">it_interval</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span> <span class="n">it_value</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">}},</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">select</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="mi">3</span> <span class="mi">5</span> <span class="mi">13</span> <span class="mi">14</span> <span class="mi">15</span> <span class="mi">16</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="p">{</span><span class="mi">409</span><span class="p">,</span> <span class="mi">254000</span><span class="p">})</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">(</span><span class="n">in</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">left</span> <span class="p">{</span><span class="mi">409</span><span class="p">,</span> <span class="mi">253990</span><span class="p">})</span>
</span><span class='line'><span class="n">ioctl</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">TCFLSH</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">)</span>                   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="n">EIO</span> <span class="p">(</span><span class="n">Input</span><span class="o">/</span><span class="n">output</span> <span class="n">error</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>

If you search on the Internet you will find plenty of bug reports related to this code block. The problem is in <em>Xorg</em> which doesn&#8217;t properly handle the situation where it can&#8217;t take control over the terminal. The solution is to not restart <em>Xorg</em> after user session ends. This is done by setting AlwaysRestartServer=false in <em>gdm.conf</em>.
 </li>

 <li>
No integration with <em>SELinux</em> and <em>ConsoleKit</em> - while configuring <em>SELinux</em> in Permissive mode is easy workaround there&#8217;s no easy workaround for <em>ConsoleKit</em>. 

Newer <em>GDM</em> versions register the user session with <em>ConsoleKit</em> and integrate that into the desktop. Missing integration means that some things will fail. For example <em>NetworkManager</em> will not allow the user to connect to a VPN connection because it thinks this user is not logged in:

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">**</span> <span class="p">(</span><span class="n">nm</span><span class="o">-</span><span class="n">applet</span><span class="o">:</span><span class="mi">1168</span><span class="p">)</span><span class="o">:</span> <span class="n">WARNING</span> <span class="o">**:</span> <span class="o">&amp;</span><span class="n">lt</span><span class="p">;</span><span class="n">WARN</span><span class="o">&amp;</span><span class="n">gt</span><span class="p">;</span>  <span class="n">activate_vpn_cb</span><span class="p">()</span><span class="o">:</span> <span class="n">VPN</span> <span class="n">Connection</span> <span class="n">activation</span> <span class="n">failed</span><span class="o">:</span>
</span><span class='line'><span class="p">(</span><span class="n">org</span><span class="p">.</span><span class="n">freedesktop</span><span class="p">.</span><span class="n">NetworkManager</span><span class="p">.</span><span class="n">PermissionDenied</span><span class="p">)</span> <span class="n">No</span> <span class="n">user</span> <span class="n">settings</span> <span class="n">service</span> <span class="n">available</span>
</span></code></pre></td></tr></table></div></figure>
</li>

 <li>
No ACLs for external USB flash drives - this is missing upstream and is supposed to land in <em>ConsoleKit</em>. When a user plugs their USB flash drive on a multiseat system GNOME will try to mount it automatically. If there are multiple users logged in this will either fail or all of them will be able to access the flash drive. 
 </li>
</ul>


<h2>PICTURES AND VIDEO</h2>

<p>Pictures from one of our deployments can be found on Facebook (no login required):
<a href="http://www.facebook.com/album.php?aid=54571&amp;id=180150925328433">http://www.facebook.com/album.php?aid=54571&amp;id=180150925328433</a>.
A demonstration video from the same deployment can be found at <a href="http://www.youtube.com/watch?v=7GYbCDGTz-4">http://www.youtube.com/watch?v=7GYbCDGTz-4</a></p>

<p>If you are interested in commercial support please contact me!</p>

<h2>FUTURE</h2>

<p>In the open source world everything is changing and multiseat is no exception. While <em>GDM</em> and <em>ConsoleKit</em> patches are not yet integrated upstream there&#8217;s a new project called <a href="http://www.freedesktop.org/wiki/Software/systemd">systemd</a> which aims at replacing the SysV init scripts system. It already has several configuration files for multiseat and I expect it will influence multiseat deployments in the future. Systemd will be available in Fedora 15.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/blog/page/8/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <p>
    I am a QA contractor at Red Hat responsible for over
    <a href="/blog/2014/02/19/7-years-1400-bugs-red-hat-qa/">1400 bugs</a>,
    a general purpose open source developer, Red Hat Certified professional,
    cloud hacker and an <a href="/projects/">entrepreneur</a>.
  </p>

  <p>
    I&#8217;m living in the <a href="http://planet.sofiavalley.com">Sofia Valley</a>
    which is emerging as a busy place for start-up founders and tech enthusiasts
    in Eastern Europe! You can find more about me <a href="/about/">here</a>.
  </p>
</section>

<section>
  
    <a href="http://twitter.com/atodorov_" class="twitter-follow-button" data-show-count="true">Follow @atodorov_</a>
  
</section>


<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="sitesearch" value="atodorov.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>

<section>
    <h1>
        <a href="/blog/categories/books/">Book Reviews</a>
    </h1>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/05/01/compiling-twinkle-sip-phone-on-rhel-7/">Compiling Twinkle SIP Phone on RHEL 7</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/30/fixing-tilde-and-function-keys-mapping-for-macbook-air-on-linux/">Fixing Tilde and Function Keys Mapping for MacBook Air on Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/29/rhel-7-repository-for-macbook-air/">RHEL 7 Repository for MacBook Air</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/29/fixing-display-brightness-on-macbook-air-with-rhel-7/">Fixing Display Brightness on MacBook Air with RHEL 7</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/27/how-to-enable-backspace-key-to-navigate-back-in-firefox/">How to Enable backspace Key to Navigate Back in Firefox</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/27/disabling-macbook-startup-sound-in-linux/">Disabling MacBook Startup Sound in Linux</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/27/compiling-broadcom-wl-kmod-wifi-driver-for-rhel-7/">Compiling Broadcom wl-kmod WiFi Driver for RHEL 7</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/26/installing-red-hat-enterprise-linux-7-on-macbook-air-2015/">Installing Red Hat Enterprise Linux 7 on MacBook Air 2015</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/20/videos-from-bulgaria-web-summit-2015/">Videos from Bulgaria Web Summit 2015</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/14/how-to-find-if-lvm-volume-is-thinly-provisioned/">How to Find if LVM Volume is Thinly Provisioned</a>
      </li>
    
  </ul>
</section>
<section>
  <h1>Disclaimer</h1>
  <p>
Some of the links contained within this site have my referral id (e.g., Amazon), which provides me with a small commission for each sale. Thank you for your support.
  </p>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">CC-BY-SA</a>
  &amp;
  <a rel="license" href="http://opensource.org/licenses/MIT">MIT</a>
  2011-2015 &diams; Alexander Todorov
  &diams;
  <a href="/about/">About Me</a>
  &diams;
  Popular categories:
<a href="/blog/categories/rhel/">Red Hat</a>,
<a href="/blog/categories/cloud/">Cloud</a>,
<a href="/blog/categories/fedora/">Fedora</a>,
<a href="/blog/categories/qa/">QA</a>,
<a href="/blog/categories/start-up/">Start-up</a>

  <a href="http://planet.sofiavalley.com" style="float:right">SofiaValley Blog</a>
</p>

<script type="text/javascript">
var uri = window.location.toString();
if (uri.indexOf("?") > 0) {
    var clean_uri = uri.substring(0, uri.indexOf("?"));
    window.history.replaceState({}, document.title, clean_uri);
}
</script>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'atodorov';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
