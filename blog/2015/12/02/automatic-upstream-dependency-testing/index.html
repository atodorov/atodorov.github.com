<!DOCTYPE html>
<html lang="en">

<head>
            <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="">

            <meta name="google-site-verification" content="XynqZtldWNBbmsynVQZremIxaaO8Wgs6AGR8UZ7KIkM">

        <title> Automatic Upstream Dependency Testing</title>

            <link href="http://feeds.feedburner.com/atodorov" type="application/atom+xml" rel="alternate" title="atodorov.org Full Atom Feed" />

        <!-- Bootstrap Core CSS -->
        <link href="http://atodorov.org/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://atodorov.org/theme/css/clean-blog.min.css" rel="stylesheet">
        <link href="http://atodorov.org/override.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://atodorov.org/theme/css/code_blocks/github.css" rel="stylesheet">

        <!-- Custom Fonts -->
        <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->




        <meta name="tags" content="fedora.planet" >
        <meta name="tags" content="Python" >
        <meta name="tags" content="OpenShift" >
        <meta name="tags" content="Django" >
        <meta name="tags" content="QA" >


			<meta property="og:locale" content="en">
		<meta property="og:site_name" content="atodorov.org">

	<meta property="og:type" content="article">
	<meta property="article:author" content="">
	<meta property="og:url" content="http://atodorov.org/blog/2015/12/02/automatic-upstream-dependency-testing/">
	<meta property="og:title" content="Automatic Upstream Dependency Testing">
	<meta property="og:description" content="with Travis-CI, GitHub and Python">
	<meta property="og:image" content="http://atodorov.org/">
	<meta property="article:published_time" content="2015-12-02 10:34:00+02:00">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://atodorov.org/">atodorov.org</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/images/header_02.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Automatic Upstream Dependency Testing</h1>
                            <h3 class="subheading">with Travis-CI, GitHub and Python</h3>
                        <span class="meta">Posted by
                                <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                             on Wed 02 December 2015
                        </span>
                        
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
    <!-- Post Content -->
    <article>
        <p>Ever since
<a href="http://atodorov.org/blog/2015/11/24/python-libs-in-rhel-7.2-broke-ssl-verification-in-s3cmd/">RHEL 7.2 python-libs broke s3cmd</a>
I've been pondering an age old problem: <em>How do I know if my software works with the
latest upstream dependencies ? How can I pro-actively monitor for new versions
and add them to my test matrix ?</em></p>
<p>Mixing together my previous experience with
<a href="http://atodorov.org/blog/2014/05/06/opensource-dot-com-article-10-steps-to-migrate-your-closed-software-to-open-source/">Difio</a>
and monitoring upstream sources,
and <a href="https://twitter.com/ForbesLindesay">Forbes Lindesay's</a> <em>GitHub Automation</em> talk
at <a href="http://atodorov.org/blog/2015/05/22/devit-conf-2015-impressions/">DEVit Conf</a> I came
together with a plan:</p>
<ul>
<li>Make an application which will execute when new upstream version is available;</li>
<li><a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/">Automatically update <code>.travis.yml</code></a>
for the projects I'm interested in;</li>
<li>Let Travis-CI execute my test suite for all available upstream versions;</li>
<li>Profit!</li>
</ul>
<h2>How Does It Work</h2>
<p>First we need to monitor upstream! RubyGems.org has nice
<a href="http://guides.rubygems.org/rubygems-org-api/#webhook-methods">webhooks interface</a>,
you can even trigger on individual packages. PyPI however doesn't have anything
like this :(. My solution is to run a cron job every hour and parse their RSS
stream for newly released packages. This has been working previously for Difio
so I re-used one function from the code.</p>
<p>After finding anything we're interested in comes the hard part - automatically
updating <code>.travis.yml</code> using the GitHub API. I've described this in more detail
<a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/">here</a>. This time
I've slightly modified the code to update only when needed and accept more
parameters so it can be reused.</p>
<p>Travis-CI has a clean interface to specify environment variables and
<a href="https://docs.travis-ci.com/user/environment-variables/#Defining-Multiple-Variables-per-Item">defining several</a>
of them crates a test matrix. This is exactly what I'm doing.
<code>.travis.yml</code> is updated with a new ENV setting, which determines the upstream
package version. After commit new build is triggered which includes the expanded
test matrix.</p>
<h2>Example</h2>
<p><img alt="Travis-CI build log" src="http://atodorov.org/images/travisci_matrix.png" title="Travis-CI build log" /></p>
<p>Imagine that our <em>Project 2501</em> depends on FOO version <em>0.3.1</em>. The
<a href="https://travis-ci.org/atodorov/bztest/builds">build log</a> illustrates what
happened:</p>
<ul>
<li>Build #9 is what we've tested with <em>FOO-0.3.1</em> and released to production.
Test result is PASS!</li>
<li>Build #10 - meanwhile upstream releases <em>FOO-0.3.2</em> which causes our project
to break. We're not aware of this and continue developing new features
while all test results still PASS! When our customers upgrade their systems
<em>Project 2501</em> will break ! Tests didn't catch it because test matrix wasn't
updated. Please
ignore the actual commit message in the example! I've used the same repository
for the dummy dependency package.</li>
<li>Build #11 - the monitoring solution finds <em>FOO-0.3.2</em> and updates the test
matrix automatically. The build immediately breaks! More precisely the
<a href="https://travis-ci.org/atodorov/bztest/builds/94263181">test with version <em>0.3.2</em> fails</a>!</li>
<li>Build #12 - we've alerted FOO.org about their problem and they've released
<em>FOO-0.3.3</em>. Our monitor has found that and updated the test matrix.
However <a href="https://travis-ci.org/atodorov/bztest/builds/94270592">the 0.3.2 test job still fails</a>!</li>
<li>Build #13 - we decide to workaround the 0.3.2 failure or simply handle the
error gracefully. In this example I've removed version 0.3.2 from the test
matrix to simulate that. In reality I wouldn't touch <code>.travis.yml</code> but instead
update my application and tests to check for that particular version.
All test results are PASS again!</li>
</ul>
<p>Btw Build #11 above was triggered manually (./monitor.py) while Build #12
came from OpenShit, my hosting environment.</p>
<p>At present I have this monitoring enabled for my
<a href="http://atodorov.org/blog/2015/11/26/3-new-python-markdown-extensions/">new Markdown extensions</a>
and will also add it to <a href="https://github.com/atodorov/django-s3-cache">django-s3-cache</a>
once it migrates to Travis-CI (it uses drone.io now).</p>
<h2>Enough Talk, Show me the Code</h2>
<div class="highlight"><span class="filename">monitor.py</span><pre><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">httplib</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">xml.dom.minidom</span> <span class="kn">import</span> <span class="n">parseString</span>

<span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">post_data</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="c"># GitHub requires a valid UA string</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;User-Agent&#39;</span> <span class="p">:</span> <span class="s">&#39;Mozilla/5.0 (X11; Linux x86_64; rv:10.0.5) Gecko/20120601 Firefox/10.0.5&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c"># shortcut for GitHub API calls</span>
    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;://&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://api.github.com</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">url</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;api.github.com&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;GITHUB_TOKEN&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Set the GITHUB_TOKEN variable&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s">&#39;token </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;GITHUB_TOKEN&#39;</span><span class="p">]</span>
            <span class="p">})</span>

    <span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">host_path</span><span class="p">)</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">host_port</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">=</span> <span class="n">host_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;https&#39;</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPSConnection</span><span class="p">(</span><span class="n">host_port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="n">host_port</span><span class="p">)</span>


    <span class="n">method</span> <span class="o">=</span> <span class="s">&#39;GET&#39;</span>
    <span class="k">if</span> <span class="n">post_data</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s">&#39;POST&#39;</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_data</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">post_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;404 - </span><span class="si">%s</span><span class="s"> not found&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="s">&#39;replace&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c"># not a JSON response</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">post_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">get_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">monitor_rss</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan the PyPI RSS feeds to look for new packages.</span>
<span class="sd">        If name is found in config then execute the specified callback.</span>

<span class="sd">        @config is a dict with keys matching package names and values</span>
<span class="sd">        are lists of dicts</span>
<span class="sd">            {</span>
<span class="sd">                &#39;cb&#39; : a_callback,</span>
<span class="sd">                &#39;args&#39; : dict</span>
<span class="sd">            }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="s">&quot;https://pypi.python.org/pypi?:action=rss&quot;</span><span class="p">)</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">parseString</span><span class="p">(</span><span class="n">rss</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&quot;item&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pub_date</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&quot;pubDate&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">firstChild</span><span class="o">.</span><span class="n">wholeText</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
            <span class="n">released_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">pub_date</span><span class="o">.</span><span class="n">firstChild</span><span class="o">.</span><span class="n">wholeText</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S GMT&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">print</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="s">&quot;found in config&quot;</span>
                <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;args&#39;</span><span class="p">]</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                            <span class="s">&#39;name&#39;</span> <span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                            <span class="s">&#39;version&#39;</span> <span class="p">:</span> <span class="n">version</span><span class="p">,</span>
                            <span class="s">&#39;released_on&#39;</span> <span class="p">:</span> <span class="n">released_on</span>
                        <span class="p">})</span>

                        <span class="c"># execute the call back</span>
                        <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;cb&#39;</span><span class="p">](</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">print</span> <span class="n">e</span>
                        <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="k">continue</span>

<span class="k">def</span> <span class="nf">update_travis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">new_version</span><span class="p">):</span>
    <span class="n">travis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="n">new_ver_line</span> <span class="o">=</span> <span class="s">&quot;  - VERSION=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">new_version</span>
    <span class="k">if</span> <span class="n">travis</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">new_ver_line</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">travis</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">new_ver_line</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">return</span> <span class="n">travis</span>


<span class="k">def</span> <span class="nf">update_github</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update GitHub via API</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">GITHUB_REPO</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;GITHUB_REPO&#39;</span><span class="p">)</span>
    <span class="n">GITHUB_BRANCH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;GITHUB_BRANCH&#39;</span><span class="p">)</span>
    <span class="n">GITHUB_FILE</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;GITHUB_FILE&#39;</span><span class="p">)</span>

    <span class="c"># step 1: Get a reference to HEAD</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="s">&quot;/repos/</span><span class="si">%s</span><span class="s">/git/refs/heads/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GITHUB_REPO</span><span class="p">,</span> <span class="n">GITHUB_BRANCH</span><span class="p">))</span>
    <span class="n">HEAD</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">],</span>
        <span class="s">&#39;url&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">][</span><span class="s">&#39;url&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="c"># step 2: Grab the commit that HEAD points to</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">])</span>
    <span class="c"># remove what we don&#39;t need for clarity</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;sha&#39;</span><span class="p">,</span> <span class="s">&#39;tree&#39;</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;commit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

    <span class="c"># step 4: Get a hold of the tree that the commit points to</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;commit&#39;</span><span class="p">][</span><span class="s">&#39;tree&#39;</span><span class="p">][</span><span class="s">&#39;url&#39;</span><span class="p">])</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c"># intermediate step: get the latest content from GitHub and make an updated version</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;tree&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">GITHUB_FILE</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">])</span> <span class="c"># get the blob from the tree</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">])</span>
            <span class="k">break</span>

    <span class="n">old_travis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="n">new_travis</span> <span class="o">=</span> <span class="n">update_travis</span><span class="p">(</span><span class="n">old_travis</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">))</span>

    <span class="c"># bail out if nothing changed</span>
    <span class="k">if</span> <span class="n">new_travis</span> <span class="o">==</span> <span class="n">old_travis</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;new == old, bailing out&quot;</span><span class="p">,</span> <span class="n">kwargs</span>
        <span class="k">return</span>

    <span class="c">####</span>
    <span class="c">#### WARNING WRITE OPERATIONS BELOW</span>
    <span class="c">####</span>

    <span class="c"># step 3: Post your new file to the server</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s">&quot;/repos/</span><span class="si">%s</span><span class="s">/git/blobs&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s">&#39;content&#39;</span> <span class="p">:</span> <span class="n">new_travis</span><span class="p">,</span>
                    <span class="s">&#39;encoding&#39;</span> <span class="p">:</span> <span class="s">&#39;utf-8&#39;</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c"># step 5: Create a tree containing your new file</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s">&quot;/repos/</span><span class="si">%s</span><span class="s">/git/trees&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s">&quot;base_tree&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;tree&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">],</span>
                    <span class="s">&quot;tree&quot;</span><span class="p">:</span> <span class="p">[{</span>
                        <span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">GITHUB_FILE</span><span class="p">,</span>
                        <span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;100644&quot;</span><span class="p">,</span>
                        <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;blob&quot;</span><span class="p">,</span>
                        <span class="s">&quot;sha&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">]</span>
                    <span class="p">}]</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c"># step 6: Create a new commit</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s">&quot;/repos/</span><span class="si">%s</span><span class="s">/git/commits&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;New upstream dependency found! Auto update .travis.yml&quot;</span><span class="p">,</span>
                    <span class="s">&quot;parents&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;commit&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">]],</span>
                    <span class="s">&quot;tree&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s">&#39;tree&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s">&#39;commit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c"># step 7: Update HEAD, but don&#39;t force it!</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s">&quot;/repos/</span><span class="si">%s</span><span class="s">/git/refs/heads/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GITHUB_REPO</span><span class="p">,</span> <span class="n">GITHUB_BRANCH</span><span class="p">),</span>
                <span class="p">{</span>
                    <span class="s">&quot;sha&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s">&#39;commit&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">):</span> <span class="c"># PASS</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span> <span class="c"># FAIL</span>
        <span class="k">print</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;atodorov-test&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span> <span class="s">&#39;atodorov/bztest&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s">&quot;Markdown&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span> <span class="s">&#39;atodorov/Markdown-Bugzilla-Extension&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span>  <span class="s">&#39;atodorov/Markdown-No-Lazy-Code-Extension&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span>  <span class="s">&#39;atodorov/Markdown-No-Lazy-BlockQuote-Extension&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="c"># check the RSS to see if we have something new</span>
    <span class="n">monitor_rss</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
    </article>

        <div class="tags">
            <p>Tags: <a href="http://atodorov.org/blog/categories/fedoraplanet/">fedora.planet</a>, <a href="http://atodorov.org/blog/categories/python/">Python</a>, <a href="http://atodorov.org/blog/categories/openshift/">OpenShift</a>, <a href="http://atodorov.org/blog/categories/django/">Django</a>, <a href="http://atodorov.org/blog/categories/qa/">QA</a>, </p>
        </div>

    <div>
        <span>
            <small>
                <em>
                    Please support this blog by 
                    <a target="_blank" href="http://www.amazon.com/ref=as_li_ss_tl?_encoding=UTF8&camp=1789&creative=390957&linkCode=ur2&tag=atodorovorg-20&linkId=L6Q34XAXQS5RDMOY">
                    buying something from Amazon with my referral id
                    </a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=atodorovorg-20&l=ur2&o=1" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />
                    .
                </em>
            </small>
        </span>
    </div>

        <hr>
        <div class="sharing">
            <!-- AddThis Button BEGIN -->
            <div class="addthis_toolbox addthis_default_style addthis_32x32_style">
                <a class="addthis_button_preferred_1"></a>
                <a class="addthis_button_preferred_2"></a>
                <a class="addthis_button_preferred_3"></a>
                <a class="addthis_button_preferred_4"></a>
                <a class="addthis_button_preferred_5"></a>
                <a class="addthis_button_preferred_6"></a>
                <a class="addthis_button_preferred_7"></a>
                <a class="addthis_button_preferred_8"></a>
                <a class="addthis_button_preferred_9"></a>
                <a class="addthis_button_compact"></a>
                <a class="addthis_counter addthis_bubble_style"></a>
            </div>
            <script type="text/javascript" src="http://s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5103cc5a2bc6ba17"></script>
            <!-- AddThis Button END -->
        </div>

        <hr>
        <div class="comments">
            <h2>Comments !</h2>
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'atodorov';
                var disqus_identifier = 'blog/2015/12/02/automatic-upstream-dependency-testing/';
                var disqus_url = 'http://atodorov.org/blog/2015/12/02/automatic-upstream-dependency-testing/';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//atodorov.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the comments.</noscript>
        </div>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                        <li>
                            <a href="https://twitter.com/atodorov_">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                        <li>
                            <a href="https://github.com/atodorov">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>

                        <li>
                            <a href="https://bg.linkedin.com/in/alextodorov">
                                <span class="fa-stack fa-lg">
                                    <i class="fa fa-circle fa-stack-2x"></i>
                                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                </span>
                            </a>
                        </li>
                    </ul>


                    <section>
                        <p>
                            I am a QA contractor at Red Hat responsible for over
                            <a href="/blog/2014/02/19/7-years-1400-bugs-red-hat-qa/">1500 bugs</a>,
                            a general purpose open source developer, Red Hat Certified professional,
                            cloud hacker and an entrepreneur!
                        </p>

                        <p>
                            I am living in the <a href="http://planet.sofiavalley.com">Sofia Valley</a>
                            which is emerging as a busy place for start-up founders and tech enthusiasts
                            in Eastern Europe! You can find more about me <a href="/blog/2013/01/25/about-me/">here</a>.
                        </p>

                        <p>
                            <small>
                                <em>
                                    Some of the links contained within this site have my referral id (e.g.,
                                    <a target="_blank" href="http://www.amazon.com/ref=as_li_ss_tl?_encoding=UTF8&camp=1789&creative=390957&linkCode=ur2&tag=atodorovorg-20&linkId=L6Q34XAXQS5RDMOY">Amazon</a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=atodorovorg-20&l=ur2&o=1" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />),
                                    which provides me with a small commission for each sale. Thank you for your support.
                                </em>
                            </small>
                        </p>
                    </section>

                    <form action="http://google.com/search" method="get" style="width:300px;margin:0 auto;">
                        <fieldset role="search">
                            <input type="hidden" name="sitesearch" value="http://atodorov.org" />
                            <input class="search" type="text" name="q" results="0" placeholder="Search" style="width:100%"/>
                        </fieldset>
                    </form>

                    <p class="copyright text-muted">
                        <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">CC-BY-SA</a> &amp;
                        <a rel="license" href="http://opensource.org/licenses/MIT">MIT</a>
                        2011-2015 &diams; Alexander Todorov &diams;
                        <a href="http://planet.sofiavalley.com">SofiaValley Blog</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://atodorov.org/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://atodorov.org/theme/js/bootstrap.min.js"></script>


    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37979549-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'atodorov';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>