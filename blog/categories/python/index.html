<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

            <meta name="google-site-verification" content="XynqZtldWNBbmsynVQZremIxaaO8Wgs6AGR8UZ7KIkM">

        <title>atodorov.org - Tag Python</title>

        <link href="http://feeds.feedburner.com/atodorov" type="application/atom+xml" rel="alternate" title="atodorov.org Full Atom Feed" />
        <!-- Bootstrap Core CSS -->
        <link href="http://atodorov.org/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://atodorov.org/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://atodorov.org/theme/css/code_blocks/github.css" rel="stylesheet">

            <!-- CSS specified by the user -->
            <link href="http://atodorov.org/override.css" rel="stylesheet">

        <!-- Custom Fonts -->
        <link href="http://atodorov.org/theme/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

                <meta property="fb:admins" content="1616937247" >
                <meta property="og:locale" content="en_US">
		<meta property="og:site_name" content="atodorov.org">
            <meta name="twitter:card" content="summary_large_image">
            <meta name="twitter:site" content="@atodorov_">
            <meta name="twitter:title" content="atodorov.org">
            <meta name="twitter:description" content="you can logoff, but you can never leave">
                <meta name="twitter:image" content="http://atodorov.org//images/header_02.jpg">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://atodorov.org/">atodorov.org</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                        <li><a href="http://mrsenko.com/pylint-workshop/">Pylint Workshop</a></li>

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

        <header class="intro-header" style="background-image: url('/images/header_02.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="page-heading">
                        <h1>Tag Python</h1>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2019/12/06/comparing-equivalent-python-statements/" rel="bookmark" title="Permalink to Comparing equivalent Python statements">
                <h2 class="post-title">
                    Comparing equivalent Python statements
                </h2>
            </a>
                <p><img alt="Equivalent Python statements" src="/images/equivalent_python_statements.jpg" title="Equivalent Python statements"></p>
<p>While teaching one of my Python classes yesterday I noticed a conditional expression
which can be written in several ways. All of these are equivalent in their behavior:</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="k">pass</span>
</code></pre></div>

<p>My preferred style of writing is the last one (<code>not os.path.isdir()</code>) because it
looks the most pythonic of all. However the 5 expressions are slightly different
behind the scenes so they must also have different speed of execution
(click operator for link to documentation):</p>
<ul>
<li><a href="https://docs.python.org/3/reference/expressions.html#is"><code>is</code></a> - identity operator,
  e.g. both arguments are the same object as determined by the
  <a href="https://docs.python.org/3/library/functions.html#id"><code>id()</code></a> function. In CPython
  that means both arguments point to the same address in memory</li>
<li><a href="https://docs.python.org/3/reference/expressions.html#is"><code>is not</code></a> -
  yields the inverse truth value of <code>is</code>, e.g. both arguments are not the same
  object (address) in memory</li>
<li><a href="https://docs.python.org/3/library/stdtypes.html#comparisons"><code>==</code></a> - equality
  operator, e.g. both arguments have the same value</li>
<li><a href="https://docs.python.org/3/library/stdtypes.html#comparisons"><code>!=</code></a> - non-equality
  operator, e.g. both arguments have different values</li>
<li><a href="https://docs.python.org/3/library/stdtypes.html#boolean-operations-and-or-not"><code>not</code></a> -
  boolean operator</li>
</ul>
<p>In my <a href="https://twitter.com/atodorov_/status/1202504284400750592">initial tweet</a> I mentioned
that I think <code>is False</code> should be the fastest. <a href="http://kiwitcms.org">Kiwi TCMS</a> team
member <a href="https://twitter.com/real_zahari">Zahari</a> countered with <code>not</code> to be the fastest
but didn't provide any reasoning!</p>
<p>My initial reasoning was as follows:</p>
<ul>
<li><code>is</code> is essentially comparing addresses in memory so it should be as fast as it gets</li>
<li><code>==</code> and <code>!=</code> should be roughly the same but they do need to "read" values
  from memory which would take additional time before the actual comparison of
  these values</li>
<li><code>not</code> is a boolean operator but honestly I have no idea how it is implemented
  so I don't have any opinion as to its performance</li>
</ul>
<p>Using the following performance test script we get the average of 100 repetitions
from executing the conditional statement 1 million times:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">statistics</span>
<span class="kn">import</span> <span class="nn">timeit</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">if False:</span>
<span class="sd">#if not result:</span>
<span class="sd">#if result is False:</span>
<span class="sd">#if result is not True:</span>
<span class="sd">#if result != True:</span>
<span class="sd">#if result == False:</span>
<span class="sd">    pass</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">,</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">import os</span>
<span class="sd">result = os.path.isdir(&#39;/tmp&#39;)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>

<span class="n">execution_times</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">repeat</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">number</span><span class="o">=</span><span class="mi">1000000</span><span class="p">)</span>
<span class="n">average_time</span> <span class="o">=</span> <span class="n">statistics</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">execution_times</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">average_time</span><span class="p">)</span>
</code></pre></div>

<p><strong>Note:</strong> in none of these variants the body of the if statement is executed so
the results must be pretty close to how long it takes to calculate the
conditional expression itself!</p>
<p>Results (ordered by speed of execution):</p>
<ul>
<li><code>False _______ 0.009309015863109380</code> - baseline</li>
<li><code>not result __ 0.011714859132189304</code> - +25.84%</li>
<li><code>is False ____ 0.018575656899483876</code> - +99.54%</li>
<li><code>is not True _ 0.018815848254598680</code> - +102.1%</li>
<li><code>!= True _____ 0.024881873669801280</code> - +167.2%</li>
<li><code>== False ____ 0.026119318689452484</code> - +180.5%</li>
</ul>
<p>Now these results weren't exactly what I was expecting. I thought <code>not</code> will come in
last but instead it came in first! Although <code>is False</code> came in second it is almost
twice as slow compared to baseline. Why is that ?</p>
<p>After digging around in
<a href="https://github.com/python/cpython">CPython</a> I found the following definition
for comparison operators:</p>
<div class="highlight"><pre><span></span><code><span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">cmp_outcome</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">op</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PyCmp_IS</span><span class="p">:</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">w</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">PyCmp_IS_NOT</span><span class="p">:</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">w</span><span class="p">);</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* ... skip PyCmp_IN, PyCmp_NOT_IN, PyCmp_EXC_MATCH ... */</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">PyObject_RichCompare</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Py_True</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Py_False</span><span class="p">;</span>
<span class="w">    </span><span class="n">Py_INCREF</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>where <code>PyObject_RichCompare</code> is defined as follows (definition order reversed
in actual sources):</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* Perform a rich comparison with object result.  This wraps do_richcompare()</span>
<span class="cm">   with a check for NULL arguments and a recursion check. */</span>
<span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">PyObject_RichCompare</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="p">;</span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">Py_LT</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">op</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">Py_GE</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">w</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">PyErr_Occurred</span><span class="p">())</span>
<span class="w">            </span><span class="n">PyErr_BadInternalCall</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Py_EnterRecursiveCall</span><span class="p">(</span><span class="s">&quot; in comparison&quot;</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">do_richcompare</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span>
<span class="w">    </span><span class="n">Py_LeaveRecursiveCall</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Perform a rich comparison, raising TypeError when the requested comparison</span>
<span class="cm">   operator is not supported. */</span>
<span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">do_richcompare</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">op</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">richcmpfunc</span><span class="w"> </span><span class="n">f</span><span class="p">;</span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">checked_reverse_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">w</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="n">PyType_IsSubtype</span><span class="p">(</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">        </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="o">-&gt;</span><span class="n">tp_richcompare</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">checked_reverse_op</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)(</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">_Py_SwappedOp</span><span class="p">[</span><span class="n">op</span><span class="p">]);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Py_NotImplemented</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">        </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="o">-&gt;</span><span class="n">tp_richcompare</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Py_NotImplemented</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">        </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">checked_reverse_op</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">w</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="o">-&gt;</span><span class="n">tp_richcompare</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)(</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">_Py_SwappedOp</span><span class="p">[</span><span class="n">op</span><span class="p">]);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Py_NotImplemented</span><span class="p">)</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">        </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/**********************************************************************</span>

<span class="cm">        IMPORTANT: actual execution enters the next block because the bool</span>
<span class="cm">        type doesn&#39;t implement it&#39;s own `tp_richcompare` function, see:</span>
<span class="cm">        Objects/boolobject.c PyBool_Type (near the bottom of that file)</span>

<span class="cm">    ***********************************************************************/</span>

<span class="w">    </span><span class="cm">/* If neither object implements it, provide a sensible default</span>
<span class="cm">       for == and !=, but raise an exception for ordering. */</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">op</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">Py_EQ</span><span class="p">:</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Py_True</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Py_False</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">Py_NE</span><span class="p">:</span>
<span class="w">        </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">w</span><span class="p">)</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">Py_True</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Py_False</span><span class="p">;</span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="n">PyErr_Format</span><span class="p">(</span><span class="n">PyExc_TypeError</span><span class="p">,</span>
<span class="w">                     </span><span class="s">&quot;&#39;%s&#39; not supported between instances of &#39;%.100s&#39; and &#39;%.100s&#39;&quot;</span><span class="p">,</span>
<span class="w">                     </span><span class="n">opstrings</span><span class="p">[</span><span class="n">op</span><span class="p">],</span>
<span class="w">                     </span><span class="n">v</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="o">-&gt;</span><span class="n">tp_name</span><span class="p">,</span>
<span class="w">                     </span><span class="n">w</span><span class="o">-&gt;</span><span class="n">ob_type</span><span class="o">-&gt;</span><span class="n">tp_name</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">Py_INCREF</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>The <code>not</code> operator is defined in <code>Objects/object.c</code> as follows (definition order
reverse in actual sources):</p>
<div class="highlight"><pre><span></span><code><span class="cm">/* equivalent of &#39;not v&#39;</span>
<span class="cm">   Return -1 if an error occurred */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">PyObject_Not</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="n">res</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyObject_IsTrue</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">res</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">res</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Test a value used as condition, e.g., in a for or if statement.</span>
<span class="cm">   Return -1 if an error occurred */</span>
<span class="kt">int</span><span class="w"> </span><span class="nf">PyObject_IsTrue</span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Py_ssize_t</span><span class="w"> </span><span class="n">res</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Py_True</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Py_False</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">v</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Py_None</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/*</span>
<span class="cm">        IMPORTANT: skip the rest because we are working with bool so this</span>
<span class="cm">        function will return after the first or the second if statement!</span>
<span class="cm">    */</span>
<span class="p">}</span>
</code></pre></div>

<p>So a rough overview of calculating the above expressions is:</p>
<ul>
<li><code>not</code> - call 1 function which compares the argument with <code>Py_True/Py_False</code>,
  compare its result with 0</li>
<li><code>is/is not</code> - do a switch/case/break, compare the result to <code>Py_True/Py_False</code>,
   call 1 function (<code>Py_INCREF</code>)</li>
<li><code>==/!=</code> - switch/default (that is evaluate all case conditions before that),
   call 1 function (<code>PyObject_RichCompare</code>), which performs couple of
   checks and calls another function (<code>do_richcompare</code>), which does a few more checks
   before executing switch/case/compare to <code>Py_True/Py_False</code>, call <code>Py_INCREF</code>
   and return the result.</li>
</ul>
<p>Obviously <code>not</code> has the shortest code which needs to be executed.</p>
<p>We can also invoke the <code>dis</code> module, aka disassembler of Python byte code into mnemonics
like so (it needs a function to dissasemble):</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">dis</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
    <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">pass</span>
<span class="nb">print</span><span class="p">(</span><span class="n">dis</span><span class="o">.</span><span class="n">dis</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</code></pre></div>

<p>From the results below you can see that all expression variants are very similar:</p>
<div class="highlight"><pre><span></span><code>--------------- if False -------------------------

              0 LOAD_GLOBAL              0 (False)
              3 POP_JUMP_IF_FALSE        9

              6 JUMP_FORWARD             0 (to 9)
        &gt;&gt;    9 LOAD_CONST               0 (None)
             12 RETURN_VALUE            None
--------------- if not result --------------------
              0 LOAD_FAST                0 (result)
              3 POP_JUMP_IF_TRUE         9

              6 JUMP_FORWARD             0 (to 9)
        &gt;&gt;    9 LOAD_CONST               0 (None)
             12 RETURN_VALUE            None
--------------- if result is False ---------------
              0 LOAD_FAST                0 (result)
              3 LOAD_GLOBAL              0 (False)
              6 COMPARE_OP               8 (is)
              9 POP_JUMP_IF_FALSE       15

             12 JUMP_FORWARD             0 (to 15)
        &gt;&gt;   15 LOAD_CONST               0 (None)
             18 RETURN_VALUE            None
--------------- if result is not True ------------
              0 LOAD_FAST                0 (result)
              3 LOAD_GLOBAL              0 (True)
              6 COMPARE_OP               9 (is not)
              9 POP_JUMP_IF_FALSE       15

             12 JUMP_FORWARD             0 (to 15)
        &gt;&gt;   15 LOAD_CONST               0 (None)
             18 RETURN_VALUE            None
--------------- if result != True ----------------
              0 LOAD_FAST                0 (result)
              3 LOAD_GLOBAL              0 (True)
              6 COMPARE_OP               3 (!=)
              9 POP_JUMP_IF_FALSE       15

             12 JUMP_FORWARD             0 (to 15)
        &gt;&gt;   15 LOAD_CONST               0 (None)
             18 RETURN_VALUE            None
--------------- if result == False ---------------
              0 LOAD_FAST                0 (result)
              3 LOAD_GLOBAL              0 (False)
              6 COMPARE_OP               2 (==)
              9 POP_JUMP_IF_FALSE       15

             12 JUMP_FORWARD             0 (to 15)
        &gt;&gt;   15 LOAD_CONST               0 (None)
             18 RETURN_VALUE            None
--------------------------------------------------
</code></pre></div>

<p>The last 3 instructions are the same (that is the implicit <code>return None</code> of the function).
<code>LOAD_GLOBAL</code> is to "read" the <code>True</code> or <code>False</code> boolean constants and
<code>LOAD_FAST</code> is to "read" the function parameter in this example.
All of them <code>_JUMP_</code> outside the if statement and the only difference is
which comparison operator is executed (if any in the case of <code>not</code>).</p>
<p><strong>UPDATE 1:</strong>
as I was publishing this blog post I read the following comments from
Ammar Askar who also gave me a few pointers on IRC:</p>
<blockquote class="twitter-tweet"><p lang="en" dir="ltr">Note that this code path also has a direct inlined check for booleans, which should help too: <a href="https://t.co/YJ0az3q3qu">https://t.co/YJ0az3q3qu</a></p>&mdash; Ammar Askar (@__ammar2__) <a href="https://twitter.com/__ammar2__/status/1203012870386139137?ref_src=twsrc%5Etfw">December 6, 2019</a></blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

<p>So go ahead and take a look at
<a href="https://github.com/python/cpython/blob/e76ee1a72b9e3f5da287663ea3daec4bb3f67612/Python/ceval.c#L2989-L3001"><code>case TARGET(POP_JUMP_IF_TRUE)</code></a>.</p>
<p><strong>UPDATE 2:</strong></p>
<p>After the above comments from Ammar Askar on Twitter and from
Kevin Kofler below I decided to try and change one of the expressions a bit:</p>
<div class="highlight"><pre><span></span><code><span class="n">t</span> <span class="o">=</span> <span class="n">timeit</span><span class="o">.</span><span class="n">Timer</span><span class="p">(</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">result = not result</span>
<span class="sd">if result:</span>
<span class="sd">    pass</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">,</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">import os</span>
<span class="sd">result = os.path.isdir(&#39;/tmp&#39;)</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="p">)</span>
</code></pre></div>

<p>that is, calculate the <code>not operation</code>, assign to variable and then evaluate the
conditional statement in an attempt to bypass the built-in compiler optimization.
The dissasembled code looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="mf">0</span><span class="w"> </span><span class="kr">LOAD</span><span class="n">_FAST</span><span class="w">                </span><span class="mf">0</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="mf">2</span><span class="w"> </span><span class="n">UNARY_NOT</span>
<span class="mf">4</span><span class="w"> </span><span class="n">STORE_FAST</span><span class="w">               </span><span class="mf">0</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

<span class="mf">6</span><span class="w"> </span><span class="kr">LOAD</span><span class="n">_FAST</span><span class="w">                </span><span class="mf">0</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="mf">8</span><span class="w"> </span><span class="n">POP_JUMP_IF_FALSE</span><span class="w">       </span><span class="mf">10</span>
<span class="mf">10</span><span class="w"> </span><span class="kr">LOAD</span><span class="n">_CONST</span><span class="w">              </span><span class="mf">0</span><span class="w"> </span><span class="p">(</span><span class="n">None</span><span class="p">)</span>
<span class="mf">12</span><span class="w"> </span><span class="kr">RETURN</span><span class="n">_VALUE</span><span class="w">            </span><span class="n">None</span>
</code></pre></div>

<p>The execution time was around <code>0.022</code> which is between <code>is</code> and <code>==</code>. However the
<code>not result</code> operation itself (without assignment) appears to execute for <code>0.017</code>
which still makes the <code>not</code> operator faster than the <code>is</code> operator, but only just!</p>
<p>Like already pointed out this is a fairly complex topic and it is evident
that not everything can be compared directly in the same context (expression).</p>
<h2>P.S.</h2>
<p>When I teach Python I try to explain what is going on under the hood. Sometimes
I draw squares on the whiteboard to represent various cells in memory and visualize
things. One of my students asked me how do I know all of this? The essentials
(for any programming language) are always documented in its official documentation.
The rest is hacking around in its source code and learning how it works. This is
also what I expect people working with/for me to be doing!</p>
<p>See you soon and Happy learning!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Fri 06 December 2019
            </p>
<p>There are <a href="http://atodorov.org/blog/2019/12/06/comparing-equivalent-python-statements/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2018/07/24/introducing-pylint-django-20/" rel="bookmark" title="Permalink to Introducing pylint-django 2.0">
                <h2 class="post-title">
                    Introducing pylint-django 2.0
                </h2>
            </a>
                <p>Today I have released pylint-django version 2.0 on PyPI.
The changes are centered around compatibility with the latest pylint 2.0 and
astroid 2.0 versions. I've also bumped pylint-django's version number to reflact
that.</p>
<p>A major component, class transformations, was updated so don't be surprised if
there are bugs. All the existing test cases pass but you never know what sort
of edge case there could be.</p>
<p>I'm also hosting a workshop/corporate training about writing pylint plugins.
If you are interested see this <a href="http://MrSenko.com/pylint-workshop/">page</a>!</p>
<p>Thanks for reading and happy testing!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 24 July 2018
            </p>
<p>There are <a href="http://atodorov.org/blog/2018/07/24/introducing-pylint-django-20/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2018/01/22/introducing-pylint-django-080/" rel="bookmark" title="Permalink to Introducing pylint-django 0.8.0">
                <h2 class="post-title">
                    Introducing pylint-django 0.8.0
                </h2>
            </a>
                <p>Since my previous post was about
<a href="http://atodorov.org/blog/2018/01/05/how-to-write-pylint-checker-plugins/">writing pylint plugins</a>
I figured I'd let you know that I've released
<a href="https://github.com/landscapeio/pylint-django">pylint-django</a> version 0.8.0
over the weekend. This release merges all pull requests which were
pending till now so make sure to read the change log.</p>
<p>Starting with this release Colin Howe and myself are the new
maintainers of this package. My immediate goal is to triage all of the
open issue and figure out if they still reproduce. If yes try to
come up with fixes for them or at least get the conversation going again.</p>
<p>My next goal is to integrate pylint-django with
<a href="http://kiwitcms.org">Kiwi TCMS</a> and start resolving all the 4000+
errors and warnings that it produces.</p>
<p>You are welcome to contribute of course. I'm also interested in hosting a
workshop on the topic of pylint plugins.</p>
<p>Thanks for reading and happy testing!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Mon 22 January 2018
            </p>
<p>There are <a href="http://atodorov.org/blog/2018/01/22/introducing-pylint-django-080/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2018/01/05/how-to-write-pylint-checker-plugins/" rel="bookmark" title="Permalink to How to write pylint checker plugins">
                <h2 class="post-title">
                    How to write pylint checker plugins
                </h2>
            </a>
                <p>In this post I will walk you through the process of learning how to write
additional checkers for pylint!</p>
<h2>Prerequisites</h2>
<ol>
<li>
<p>Read
   <a href="https://pylint.readthedocs.io/en/latest/development_guide/contribute.html">Contributing to pylint</a>
   to get basic knowledge of how to execute the test suite and how it is structured.
   Basically call <code>tox -e py36</code>. Verify that all tests <strong>PASS</strong> locally!</p>
</li>
<li>
<p>Read pylint's
   <a href="https://pylint.readthedocs.io/en/latest/how_tos/index.html">How To Guides</a>,
   in particular the section about writing a new checker. A plugin is usually
   a Python module that registers a new checker.</p>
</li>
<li>
<p>Most of pylint checkers are AST based, meaning they operate on the
   abstract syntax tree of the source code. You will have to familiarize
   yourself with the AST node reference for the <code>astroid</code> and <code>ast</code> modules.
   Pylint uses Astroid for parsing and augmenting the AST.</p>
<p><strong>NOTE:</strong> there is compact and excellent documentation provided by the
   <em>Green Tree Snakes</em> project. I would recommend the
   <a href="http://greentreesnakes.readthedocs.io/en/latest/nodes.html">Meet the Nodes</a>
   chapter.</p>
<p>Astroid also provides exhaustive documentation and
   <a href="http://astroid.readthedocs.io/en/latest/api/astroid.nodes.html">node API reference</a>.  </p>
<p><strong>WARNING:</strong> sometimes Astroid node class names don't match the ones from ast!</p>
</li>
<li>
<p>Your interactive shell weapons are <code>ast.dump()</code>, <code>ast.parse()</code>, <code>astroid.parse()</code> and
   <code>astroid.extract_node()</code>. I use them inside an interactive Python shell to
   figure out how a piece of source code is parsed and converted back to AST nodes!
   You can also try this
   <a href="https://bitbucket.org/takluyver/greentreesnakes/src/default/astpp.py?fileviewer=file-view-default">ast node pretty printer</a>!
   I personally haven't used it.</p>
</li>
</ol>
<h2>How pylint processes the AST tree</h2>
<p>Every checker class may include special methods with names
<code>visit_xxx(self, node)</code> and <code>leave_xxx(self, node)</code> where xxx is the lowercase
name of the node class (as defined by astroid). These methods are executed
automatically when the parser iterates over nodes of the respective type.</p>
<p>All of the magic happens inside such methods. They are responsible for collecting
information about the context of specific statements or patterns that you wish to
detect. The hard part is figuring out how to collect all the information you need
because sometimes it can be spread across nodes of several different types (e.g.
more complex code patterns).</p>
<p>There is a special decorator called <code>@utils.check_messages</code>. You have to list
all message ids that your <code>visit_</code> or <code>leave_</code> method will generate!</p>
<h2>How to select message codes and IDs</h2>
<p>One of the most unclear things for me is message codes. pylint
<a href="https://pylint.readthedocs.io/en/latest/how_tos/custom_checkers.html">docs</a> say</p>
<blockquote>
<blockquote>
<p>The message-id should be a 5-digit number, prefixed with a message category.
There are multiple message categories, these being <code>C</code>, <code>W</code>, <code>E</code>, <code>F</code>, <code>R</code>,
standing for <code>Convention</code>, <code>Warning</code>, <code>Error</code>, <code>Fatal</code> and <code>Refactoring</code>.
The rest of the 5 digits should not conflict with existing checkers and they
should be consistent across the checker. For instance, the first two digits should
not be different across the checker.</p>
</blockquote>
</blockquote>
<p>I'm usually having troubles with the numbering part so you will have to get creative
or look at existing checker codes.</p>
<h2>Practical example</h2>
<p>In <a href="http://kiwitcms.org">Kiwi TCMS</a> there's legacy code that looks like this:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">add_cases</span><span class="p">(</span><span class="n">run_ids</span><span class="p">,</span> <span class="n">case_ids</span><span class="p">):</span>
    <span class="n">trs</span> <span class="o">=</span> <span class="n">TestRun</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">run_id__in</span><span class="o">=</span><span class="n">pre_process_ids</span><span class="p">(</span><span class="n">run_ids</span><span class="p">))</span>
    <span class="n">tcs</span> <span class="o">=</span> <span class="n">TestCase</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">case_id__in</span><span class="o">=</span><span class="n">pre_process_ids</span><span class="p">(</span><span class="n">case_ids</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">tr</span> <span class="ow">in</span> <span class="n">trs</span><span class="o">.</span><span class="n">iterator</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">tcs</span><span class="o">.</span><span class="n">iterator</span><span class="p">():</span>
            <span class="n">tr</span><span class="o">.</span><span class="n">add_case_run</span><span class="p">(</span><span class="n">case</span><span class="o">=</span><span class="n">tc</span><span class="p">)</span>

    <span class="k">return</span>
</code></pre></div>

<p>Notice the dangling <code>return</code> statement at the end! It is useless because when missing
the default return value of this function will still be <code>None</code>. So I've decided to
create a plugin for that.</p>
<p>Armed with the knowledge above I first try the ast parser in the console:</p>
<div class="highlight"><pre><span></span><code><span class="n">Python</span> <span class="mf">3.6.3</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Oct</span>  <span class="mi">5</span> <span class="mi">2017</span><span class="p">,</span> <span class="mi">20</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">50</span><span class="p">)</span> 
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.8.5</span> <span class="mi">20150623</span> <span class="p">(</span><span class="n">Red</span> <span class="n">Hat</span> <span class="mf">4.8.5</span><span class="o">-</span><span class="mi">11</span><span class="p">)]</span> <span class="n">on</span> <span class="n">linux</span>
<span class="n">Type</span> <span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="s2">&quot;copyright&quot;</span><span class="p">,</span> <span class="s2">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s2">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">ast</span>
<span class="o">&gt;&gt;&gt;</span> <span class="kn">import</span> <span class="nn">astroid</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">ast</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;def func():</span><span class="se">\n</span><span class="s1">    return&#39;</span><span class="p">))</span>
<span class="s2">&quot;Module(body=[FunctionDef(name=&#39;func&#39;, args=arguments(args=[], vararg=None, kwonlyargs=[], kw_defaults=[], kwarg=None, defaults=[]), body=[Return(value=None)], decorator_list=[], returns=None)])&quot;</span>
<span class="o">&gt;&gt;&gt;</span> 
<span class="o">&gt;&gt;&gt;</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="n">node</span> <span class="o">=</span> <span class="n">astroid</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s1">&#39;def func():</span><span class="se">\n</span><span class="s1">    return&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">node</span>
<span class="o">&lt;</span><span class="n">Module</span> <span class="n">l</span><span class="mf">.0</span> <span class="n">at</span> <span class="mh">0x7f5b04621b38</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">FunctionDef</span><span class="o">.</span><span class="n">func</span> <span class="n">l</span><span class="mf">.1</span> <span class="n">at</span> <span class="mh">0x7f5b046219e8</span><span class="o">&gt;</span><span class="p">]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">FunctionDef</span><span class="o">.</span><span class="n">func</span> <span class="n">l</span><span class="mf">.1</span> <span class="n">at</span> <span class="mh">0x7f5b046219e8</span><span class="o">&gt;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">body</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Return</span> <span class="n">l</span><span class="mf">.2</span> <span class="n">at</span> <span class="mh">0x7f5b04621c18</span><span class="o">&gt;</span><span class="p">]</span>
</code></pre></div>

<p>As you can see there is a <code>FunctionDef</code> node representing the function and it has
a <code>body</code> attribute which is a list of all statements inside the function. The last
element is <code>.body[-1]</code> and it is of type <code>Return</code>! The <code>Return</code> node also has an
attribute called <code>.value</code> which is the return value! The complete code will look
like this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">astroid</span>

<span class="kn">from</span> <span class="nn">pylint</span> <span class="kn">import</span> <span class="n">checkers</span>
<span class="kn">from</span> <span class="nn">pylint</span> <span class="kn">import</span> <span class="n">interfaces</span>
<span class="kn">from</span> <span class="nn">pylint.checkers</span> <span class="kn">import</span> <span class="n">utils</span>


<span class="k">class</span> <span class="nc">UselessReturnChecker</span><span class="p">(</span><span class="n">checkers</span><span class="o">.</span><span class="n">BaseChecker</span><span class="p">):</span>
    <span class="n">__implements__</span> <span class="o">=</span> <span class="n">interfaces</span><span class="o">.</span><span class="n">IAstroidChecker</span>

    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;useless-return&#39;</span>

    <span class="n">msgs</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;R2119&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Useless return at end of function or method&quot;</span><span class="p">,</span>
                  <span class="s1">&#39;useless-return&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Emitted when a bare return statement is found at the end of &#39;</span>
                  <span class="s1">&#39;function or method definition&#39;</span>
                  <span class="p">),</span>
        <span class="p">}</span>


    <span class="nd">@utils</span><span class="o">.</span><span class="n">check_messages</span><span class="p">(</span><span class="s1">&#39;useless-return&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">visit_functiondef</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Checks for presence of return statement at the end of a function</span>
<span class="sd">            &quot;return&quot; or &quot;return None&quot; are useless because None is the default</span>
<span class="sd">            return type if they are missing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># if the function has empty body then return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">last</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">body</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="n">astroid</span><span class="o">.</span><span class="n">Return</span><span class="p">):</span>
            <span class="c1"># e.g. &quot;return&quot;</span>
            <span class="k">if</span> <span class="n">last</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s1">&#39;useless-return&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">)</span>
            <span class="c1"># e.g. &quot;return None&quot;</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">astroid</span><span class="o">.</span><span class="n">Const</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">last</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s1">&#39;useless-return&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">register</span><span class="p">(</span><span class="n">linter</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;required method to auto register this checker&quot;&quot;&quot;</span>
    <span class="n">linter</span><span class="o">.</span><span class="n">register_checker</span><span class="p">(</span><span class="n">UselessReturnChecker</span><span class="p">(</span><span class="n">linter</span><span class="p">))</span>
</code></pre></div>

<p>Here's how to execute the new plugin:</p>
<div class="highlight"><pre><span></span><code><span class="o">$</span><span class="w"> </span><span class="n">PYTHONPATH</span><span class="o">=./</span><span class="n">myplugins</span><span class="w"> </span><span class="n">pylint</span><span class="w"> </span><span class="o">--</span><span class="nb">load</span><span class="o">-</span><span class="n">plugins</span><span class="o">=</span><span class="n">uselessreturn</span><span class="w"> </span><span class="n">tcms</span><span class="o">/</span><span class="n">xmlrpc</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">testrun</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">useless</span><span class="o">-</span><span class="k">return</span>
<span class="n">W</span><span class="p">:</span><span class="w"> </span><span class="mi">40</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">Useless</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="p">(</span><span class="n">useless</span><span class="o">-</span><span class="k">return</span><span class="p">)</span>
<span class="n">W</span><span class="p">:</span><span class="mi">117</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">Useless</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="p">(</span><span class="n">useless</span><span class="o">-</span><span class="k">return</span><span class="p">)</span>
<span class="n">W</span><span class="p">:</span><span class="mi">242</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">Useless</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="p">(</span><span class="n">useless</span><span class="o">-</span><span class="k">return</span><span class="p">)</span>
<span class="n">W</span><span class="p">:</span><span class="mi">495</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">Useless</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">method</span><span class="w"> </span><span class="p">(</span><span class="n">useless</span><span class="o">-</span><span class="k">return</span><span class="p">)</span>
</code></pre></div>

<p><strong>NOTES:</strong></p>
<ul>
<li>
<p>If you contribute this code upstream and pylint releases it you will get a traceback:</p>
<div class="highlight"><pre><span></span><code><span class="nv">pylint</span>.<span class="nv">exceptions</span>.<span class="nv">InvalidMessageError</span>:<span class="w"> </span><span class="nv">Message</span><span class="w"> </span><span class="nv">symbol</span><span class="w"> </span><span class="s1">&#39;useless-return&#39;</span><span class="w"> </span><span class="nv">is</span><span class="w"> </span><span class="nv">already</span><span class="w"> </span><span class="nv">defined</span>
</code></pre></div>

<p>this means your checker has been released in the latest version and you can drop the custom
plugin!</p>
</li>
<li>
<p>This is example is fairly simple because the AST tree provides the information we
  need in a very handy way. Take a look at some of
  <a href="https://github.com/PyCQA/pylint/pulls/atodorov">my other checkers</a> to get a feeling
  of what a more complex checker looks like!</p>
</li>
<li>
<p>Write and run tests for your new checkers, especially if contributing upstream.
  Have in mind that the new checker will be executed against existing code and in
  combination with other checkers which could lead to some interesting results.
  I will leave the testing to yourself, all is written in the documentation.</p>
</li>
</ul>
<p>This particular example I've contributed as
<a href="https://github.com/PyCQA/pylint/pull/1821">PR #1821</a> which happened to contradict
an existing checker. The update, raising warnings only when there's a single return
statement in the function body, is <a href="https://github.com/PyCQA/pylint/pull/1823">PR #1823</a>.</p>
<h2>Workshop around the corner</h2>
<p>I will be working together with <a href="http://hacksoft.io">HackSoft</a> on an in-house
workshop/training for writing pylint plugins. I'm also looking at reviving
<a href="https://github.com/landscapeio/pylint-django/">pylint-django</a> so we can
write more plugins specifically for Django based projects.</p>
<p>If you are interested in workshop and training on the topic let me know!</p>
<p>Thanks for reading and happy testing!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Fri 05 January 2018
            </p>
<p>There are <a href="http://atodorov.org/blog/2018/01/05/how-to-write-pylint-checker-plugins/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2017/06/11/can-a-nested-function-assign-to-variables-from-the-parent-function/" rel="bookmark" title="Permalink to Can a nested function assign to variables from the parent function">
                <h2 class="post-title">
                    Can a nested function assign to variables from the parent function
                </h2>
            </a>
                <p>While working on a
<a href="https://github.com/getpelican/pelican/pull/1909">new feature for Pelican</a>
I've put myself in a situation where I have two functions, one nested inside
the other and I want the nested function to assign to variable from the
parent function. Turns out this isn't so easy in Python!</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">who</span><span class="p">):</span>
    <span class="n">greeting</span> <span class="o">=</span> <span class="s1">&#39;Hello&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">do_print</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nb">print</span> <span class="n">i</span><span class="p">,</span> <span class="n">greeting</span><span class="p">,</span> <span class="n">who</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">do_print</span><span class="p">()</span>

    <span class="n">do_print</span><span class="p">()</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">hello</span><span class="p">(</span><span class="s1">&#39;World&#39;</span><span class="p">)</span>
</code></pre></div>

<p>The example above is a recursive <em>Hello World</em>. Notice the <code>i += 1</code> line!
This line causes <code>i</code> to be considered local to <code>do_print()</code> and the result
is that we get the following failure on Python 2.7:</p>
<div class="highlight"><pre><span></span><code><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;./test.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">16</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
    <span class="n">hello</span><span class="p">(</span><span class="s1">&#39;World&#39;</span><span class="p">)</span>
  <span class="n">File</span> <span class="s2">&quot;./test.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">13</span><span class="p">,</span> <span class="ow">in</span> <span class="n">hello</span>
    <span class="n">do_print</span><span class="p">()</span>
  <span class="n">File</span> <span class="s2">&quot;./test.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">6</span><span class="p">,</span> <span class="ow">in</span> <span class="n">do_print</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
<span class="ne">UnboundLocalError</span><span class="p">:</span> <span class="n">local</span> <span class="n">variable</span> <span class="s1">&#39;i&#39;</span> <span class="n">referenced</span> <span class="n">before</span> <span class="n">assignment</span>
</code></pre></div>

<p>We can workaround by using a global variable like so:</p>
<div class="highlight"><pre><span></span><code><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">who</span><span class="p">):</span>
    <span class="n">greeting</span> <span class="o">=</span> <span class="s1">&#39;Hello&#39;</span>

    <span class="k">def</span> <span class="nf">do_print</span><span class="p">():</span>
        <span class="k">global</span> <span class="n">i</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nb">print</span> <span class="n">i</span><span class="p">,</span> <span class="n">greeting</span><span class="p">,</span> <span class="n">who</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">do_print</span><span class="p">()</span>

    <span class="n">do_print</span><span class="p">()</span>
</code></pre></div>

<p>However I prefer not to expose internal state outside the <code>hello()</code>
function. Only if there was a keyword similar to <strong>global</strong>. In Python 3
there is <strong>nonlocal</strong>!</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">who</span><span class="p">):</span>
    <span class="n">greeting</span> <span class="o">=</span> <span class="s1">&#39;Hello&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">do_print</span><span class="p">():</span>
        <span class="k">nonlocal</span> <span class="n">i</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">greeting</span><span class="p">,</span> <span class="n">who</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">do_print</span><span class="p">()</span>

    <span class="n">do_print</span><span class="p">()</span>
</code></pre></div>

<p><strong>nonlocal</strong> is nice but it doesn't exist in Python 2! The workaround is to
not assign state to the variable itself, but instead use a mutable container.
That is instead of a scalar use a list or a dictionary like so:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">who</span><span class="p">):</span>
    <span class="n">greeting</span> <span class="o">=</span> <span class="s1">&#39;Hello&#39;</span>
    <span class="n">i</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">do_print</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="nb">print</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">greeting</span><span class="p">,</span> <span class="n">who</span>
        <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">do_print</span><span class="p">()</span>

    <span class="n">do_print</span><span class="p">()</span>
</code></pre></div>

<p>Thanks for reading and happy coding!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Sun 11 June 2017
            </p>
<p>There are <a href="http://atodorov.org/blog/2017/06/11/can-a-nested-function-assign-to-variables-from-the-parent-function/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2016/08/05/python-2-vs-python-3-list-sort-causes-bugs/" rel="bookmark" title="Permalink to Python 2 vs. Python 3 List Sort Causes Bugs">
                <h2 class="post-title">
                    Python 2 vs. Python 3 List Sort Causes Bugs
                </h2>
            </a>
                <p>Can sorting a list of values crash your software? Apparently it can and is
another example of my
<a href="http://atodorov.org/blog/2016/03/25/hello-world-qa-challenge/">Hello World Bugs</a>.
Python 3 has simplified the
<a href="https://docs.python.org/3/whatsnew/3.0.html#ordering-comparisons">rules for ordering comparisons</a>
which changes the behavior of sorting lists when their contents are dictionaries.
For example:</p>
<div class="highlight"><pre><span></span><code><span class="n">Python</span> <span class="mf">2.7.5</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Oct</span> <span class="mi">11</span> <span class="mi">2015</span><span class="p">,</span> <span class="mi">17</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span><span class="mi">16</span><span class="p">)</span> 
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.8.3</span> <span class="mi">20140911</span> <span class="p">(</span><span class="n">Red</span> <span class="n">Hat</span> <span class="mf">4.8.3</span><span class="o">-</span><span class="mi">9</span><span class="p">)]</span> <span class="n">on</span> <span class="n">linux2</span>
<span class="o">&gt;&gt;&gt;</span> 
<span class="o">&gt;&gt;&gt;</span> <span class="p">[{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">}]</span> <span class="o">&lt;</span> <span class="p">[{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">}]</span>
<span class="kc">True</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="n">Python</span> <span class="mf">3.5.1</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Apr</span> <span class="mi">27</span> <span class="mi">2016</span><span class="p">,</span> <span class="mi">04</span><span class="p">:</span><span class="mi">21</span><span class="p">:</span><span class="mi">56</span><span class="p">)</span> 
<span class="p">[</span><span class="n">GCC</span> <span class="mf">4.8.3</span> <span class="mi">20140911</span> <span class="p">(</span><span class="n">Red</span> <span class="n">Hat</span> <span class="mf">4.8.3</span><span class="o">-</span><span class="mi">9</span><span class="p">)]</span> <span class="n">on</span> <span class="n">linux</span>
<span class="o">&gt;&gt;&gt;</span> <span class="p">[{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">}]</span> <span class="o">&lt;</span> <span class="p">[{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">}]</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;&lt;stdin&gt;&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">1</span><span class="p">,</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">TypeError</span><span class="p">:</span> <span class="n">unorderable</span> <span class="n">types</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()</span> <span class="o">&lt;</span> <span class="nb">dict</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span>
</code></pre></div>

<p>The problem is that the second elements in both lists have different keys
and Python doesn't know how to compare them. In earlier Python versions
this has been special cased as
<a href="http://stackoverflow.com/questions/3484293/is-there-a-description-of-how-cmp-works-for-dict-objects-in-python-2/3484456#3484456">described here</a>
by Ned Batchelder (the author of Python's coverage tool) but in Python 3
dictionaries have no natural sort order.</p>
<p>In the case of <em>django-chartit</em> (of which I'm now the official maintainer) this
bug triggers when you want to plot data from multiple sources (models) on the same
chart. In this case the fields coming from each data series are different and the
above error is triggered.</p>
<p>I have worked around this in
<a href="https://github.com/chartit/django-chartit/commit/9d9033ecd5a8592a12872293cdf6d710cebf894f">commit 9d9033e</a>
by simply disabling an iterator sort but this is sub-optimal and I'm not quite certain
what the side effect might be. I suspect you may end up with a chart where the order
of values on the X axis isn't the same for the different models, e.g. one graph plotting
the data in ascending order the other one in descending.</p>
<p>The trouble also comes from the fact that we're sorting an iterator (a list of fields) by
telling Python to use a list of dicts to determine the sort order. In this arrangement
there is no way to tell Python how we want to compare our dicts. The only solution I
can think about is creating a custom class and implementing a custom <code>__cmp__()</code> method
for this data structure!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Fri 05 August 2016
            </p>
<p>There are <a href="http://atodorov.org/blog/2016/08/05/python-2-vs-python-3-list-sort-causes-bugs/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2016/07/15/on-python-infinite-loops/" rel="bookmark" title="Permalink to On Python Infinite Loops">
                <h2 class="post-title">
                    On Python Infinite Loops
                </h2>
            </a>
                <p>How do you write an endless loop without using <code>True</code>, <code>False</code>, number constants
and comparison operators in Python ?</p>
<p>I've been working on the mutation test tool
<a href="https://github.com/sixty-north/cosmic-ray">Cosmic Ray</a> and discovered that it
was missing a boolean replacement operator, that is an operator which will switch
<code>True</code> to <code>False</code> and vice versa, so I wrote one. I've also added some tests to
Cosmic Ray's test suite and then I hit the infinite loop problem.
CR's test suite contains the following code inside a module called <code>adam.py</code></p>
<div class="highlight"><pre><span></span><code><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
    <span class="k">break</span>
</code></pre></div>

<p>The test suite executes mutations on <code>adam.py</code> and then runs some tests which
it expects to fail. During execution one of the mutations is
<code>replace break with continue</code> which makes the above loop infinite. The test suite
times out after a while and kills the mutation. Everything fails as expected and
we're good.</p>
<p>Adding my boolean replacement operator broke this function. All of the other mutations
work as expected but then the loop becomes</p>
<div class="highlight"><pre><span></span><code><span class="k">while</span> <span class="kc">False</span><span class="p">:</span>
    <span class="k">break</span>
</code></pre></div>

<p>When we test this particular mutation there is no infinite loop so Cosmic Ray's
test suite doesn't time out like it should and an error is reported.</p>
<div class="highlight"><pre><span></span><code>job ID 25:Outcome.SURVIVED:adam
command: cosmic-ray worker adam boolean_replacer 2 unittest -- tests
<span class="gd">--- mutation diff ---</span>
<span class="gd">--- a/home/travis/build/MrSenko/cosmic-ray/test_project/adam.py</span>
<span class="gi">+++ b/home/travis/build/MrSenko/cosmic-ray/test_project/adam.py</span>
<span class="gu">@@ -32,6 +32,6 @@</span>
<span class="w"> </span>    return x
<span class="w"> </span>
<span class="w"> </span>def trigger_infinite_loop():
<span class="gd">-    while True:</span>
<span class="gi">+    while False:</span>
<span class="w"> </span>        break
</code></pre></div>

<p>So the question becomes how to write the loop condition in such a way that nothing
will mutate it but it will still remain true so that when <code>break</code> becomes <code>continue</code>
this piece of code will become an infinite loop ? Using <code>True</code> or <code>False</code> constants
obviously is a no go. Same goes for numeric constants, e.g. <code>1</code> or comparison
operators like <code>&gt;</code>, <code>&lt;</code>, <code>is</code>, <code>not</code>, etc. - all of them will be mutated and will
break the loop condition.</p>
<p>So I took a look at the docs for
<a href="https://docs.python.org/2.4/lib/truth.html">truth value testing</a> and discovered
<a href="https://github.com/sixty-north/cosmic-ray/pull/155">my solution</a>:</p>
<div class="highlight"><pre><span></span><code><span class="k">while</span> <span class="nb">object</span><span class="p">():</span>
    <span class="k">break</span>
</code></pre></div>

<p>I'm creating an object instance here which will not be mutated by any of the
existing mutation operators.</p>
<p>Thanks for reading and happy testing!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Fri 15 July 2016
            </p>
<p>There are <a href="http://atodorov.org/blog/2016/07/15/on-python-infinite-loops/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2016/04/26/mismatch-in-pyparted-interfaces/" rel="bookmark" title="Permalink to Mismatch in Pyparted Interfaces">
                <h2 class="post-title">
                    Mismatch in Pyparted Interfaces
                </h2>
            </a>
                <p>Last week my co-worker Marek Hruscak, from Red Hat, found an interesting case of
mismatch between the two interfaces provided by pyparted. In this article
I'm going to give an example, using simplified code and explain what is
happening. From pyparted's documentation we learn the following</p>
<blockquote>
<p>pyparted is a set of native Python bindings for libparted.  libparted is the
library portion of the GNU parted project.  With pyparted, you can write
applications that interact with disk partition tables and filesystems.</p>
<p>The Python bindings are implemented in two layers.  Since libparted itself
is written in C without any real implementation of objects, a simple 1:1
mapping of externally accessible libparted functions was written.  This
mapping is provided in the _ped Python module.  You can use that module if
you want to, but it's really just meant for the larger parted module.</p>
<div class="highlight"><pre><span></span><code>_ped       libparted Python bindings, direct 1:1: function mapping
parted     Native Python code building on _ped, complete with classes,
           exceptions, and advanced functionality.
</code></pre></div>

</blockquote>
<p>The two interfaces are the <code>_ped</code> and <code>parted</code> modules. As a user I expect them
to behave exactly the same but they don't. For example some partition properties
are read-only in libparted and <code>_ped</code> but not in <code>parted</code>. This is the mismatch
I'm talking about.</p>
<p>Consider the following tests (also available on
<a href="https://github.com/atodorov/pyparted/tree/not_read_only_demo">GitHub</a>)</p>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/tests/baseclass.py b/tests/baseclass.py</span>
<span class="gh">index 4f48b87..30ffc11 100644</span>
<span class="gd">--- a/tests/baseclass.py</span>
<span class="gi">+++ b/tests/baseclass.py</span>
<span class="gu">@@ -168,6 +168,12 @@ class RequiresPartition(RequiresDisk):</span>
<span class="w"> </span>        self._part = _ped.Partition(disk=self._disk, type=_ped.PARTITION_NORMAL,
<span class="w"> </span>        self._part = _ped.Partition(disk=self._disk, type=_ped.PARTITION_NORMAL,
<span class="w"> </span>                                    start=0, end=100, fs_type=_ped.file_system_type_get(&quot;ext2&quot;))
<span class="w"> </span>
<span class="gi">+        geom = parted.Geometry(self.device, start=100, length=100)</span>
<span class="gi">+        fs = parted.FileSystem(type=&#39;ext2&#39;, geometry=geom)</span>
<span class="gi">+        self.part = parted.Partition(disk=self.disk, type=parted.PARTITION_NORMAL,</span>
<span class="gi">+                                    geometry=geom, fs=fs)</span>
<span class="gi">+</span>
<span class="gi">+</span>
<span class="w"> </span># Base class for any test case that requires a hash table of all
<span class="w"> </span># _ped.DiskType objects available
<span class="w"> </span>class RequiresDiskTypes(unittest.TestCase):
<span class="gh">diff --git a/tests/test__ped_partition.py b/tests/test__ped_partition.py</span>
<span class="gh">index 7ef049a..26449b4 100755</span>
<span class="gd">--- a/tests/test__ped_partition.py</span>
<span class="gi">+++ b/tests/test__ped_partition.py</span>
<span class="gu">@@ -62,8 +62,10 @@ class PartitionGetSetTestCase(RequiresPartition):</span>
<span class="w"> </span>        self.assertRaises(exn, setattr, self._part, &quot;num&quot;, 1)
<span class="w"> </span>        self.assertRaises(exn, setattr, self._part, &quot;fs_type&quot;,
<span class="w"> </span>            _ped.file_system_type_get(&quot;fat32&quot;))
<span class="gd">-        self.assertRaises(exn, setattr, self._part, &quot;geom&quot;,</span>
<span class="gd">-                                     _ped.Geometry(self._device, 10, 20))</span>
<span class="gi">+        with self.assertRaises((AttributeError, TypeError)):</span>
<span class="gi">+#            setattr(self._part, &quot;geom&quot;, _ped.Geometry(self._device, 10, 20))</span>
<span class="gi">+            self._part.geom = _ped.Geometry(self._device, 10, 20)</span>
<span class="gi">+</span>
<span class="w"> </span>        self.assertRaises(exn, setattr, self._part, &quot;disk&quot;, self._disk)
<span class="w"> </span>
<span class="w"> </span>        # Check that values have the right type.
<span class="gh">diff --git a/tests/test_parted_partition.py b/tests/test_parted_partition.py</span>
<span class="gh">index 0a406a0..8d8d0fd 100755</span>
<span class="gd">--- a/tests/test_parted_partition.py</span>
<span class="gi">+++ b/tests/test_parted_partition.py</span>
<span class="gu">@@ -23,7 +23,7 @@</span>
<span class="w"> </span>import parted
<span class="w"> </span>import unittest
<span class="w"> </span>
<span class="gd">-from tests.baseclass import RequiresDisk</span>
<span class="gi">+from tests.baseclass import RequiresDisk, RequiresPartition</span>
<span class="w"> </span>
<span class="w"> </span># One class per method, multiple tests per class.  For these simple methods,
<span class="w"> </span># that seems like good organization.  More complicated methods may require
<span class="gu">@@ -34,11 +34,11 @@ class PartitionNewTestCase(unittest.TestCase):</span>
<span class="w"> </span>        # TODO
<span class="w"> </span>        self.fail(&quot;Unimplemented test case.&quot;)
<span class="w"> </span>
<span class="gd">-@unittest.skip(&quot;Unimplemented test case.&quot;)</span>
<span class="gd">-class PartitionGetSetTestCase(unittest.TestCase):</span>
<span class="gi">+class PartitionGetSetTestCase(RequiresPartition):</span>
<span class="w"> </span>    def runTest(self):
<span class="gd">-        # TODO</span>
<span class="gd">-        self.fail(&quot;Unimplemented test case.&quot;)</span>
<span class="gi">+        with self.assertRaises((AttributeError, TypeError)):</span>
<span class="gi">+            #setattr(self.part, &quot;geometry&quot;, parted.Geometry(self.device, start=10, length=20))</span>
<span class="gi">+            self.part.geometry = parted.Geometry(self.device, start=10, length=20)</span>
<span class="w"> </span>
<span class="w"> </span>@unittest.skip(&quot;Unimplemented test case.&quot;)
<span class="w"> </span>class PartitionGetFlagTestCase(unittest.TestCase):
</code></pre></div>

<p>The test in <code>test__ped_partition.py</code> works without problems, I've modified it for
visual reference only. This was also the inspiration behind the test in
<code>test_parted_partition.py</code>. However the second test fails with</p>
<div class="highlight"><pre><span></span><code><span class="o">======================================================================</span>
<span class="nx">FAIL</span><span class="p">:</span><span class="w"> </span><span class="nx">runTest</span><span class="w"> </span><span class="p">(</span><span class="nx">tests</span><span class="p">.</span><span class="nx">test_parted_partition</span><span class="p">.</span><span class="nx">PartitionGetSetTestCase</span><span class="p">)</span>
<span class="o">----------------------------------------------------------------------</span>
<span class="nx">Traceback</span><span class="w"> </span><span class="p">(</span><span class="nx">most</span><span class="w"> </span><span class="nx">recent</span><span class="w"> </span><span class="nx">call</span><span class="w"> </span><span class="nx">last</span><span class="p">):</span>
<span class="w">  </span><span class="nx">File</span><span class="w"> </span><span class="s">&quot;/tmp/pyparted/tests/test_parted_partition.py&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="mi">41</span><span class="p">,</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="nx">runTest</span>
<span class="w">    </span><span class="kp">self</span><span class="p">.</span><span class="nx">part</span><span class="p">.</span><span class="nx">geometry</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">parted</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">(</span><span class="kp">self</span><span class="p">.</span><span class="nx">device</span><span class="p">,</span><span class="w"> </span><span class="nx">start</span><span class="p">=</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="nx">length</span><span class="p">=</span><span class="mi">20</span><span class="p">)</span>
<span class="nx">AssertionError</span><span class="p">:</span><span class="w"> </span><span class="p">(&lt;</span><span class="k">type</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">exceptions</span><span class="p">.</span><span class="nx">AttributeError</span><span class="err">&#39;</span><span class="p">&gt;,</span><span class="w"> </span><span class="p">&lt;</span><span class="k">type</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">exceptions</span><span class="p">.</span><span class="nx">TypeError</span><span class="err">&#39;</span><span class="p">&gt;)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">raised</span>

<span class="o">----------------------------------------------------------------------</span>
</code></pre></div>

<p>Now it's clear that something isn't quite the same between the two interfaces.
If we look at <code>src/parted/partition.py</code> we see the following snippet</p>
<div class="highlight"><pre><span></span><code><span class="mf">137</span><span class="w">     </span><span class="n">fileSystem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">property</span><span class="p">(</span><span class="n">lambda</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">s</span><span class="mf">.</span><span class="n">_fileSystem</span><span class="p">,</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">:</span><span class="w"> </span><span class="n">setattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_fileSystem&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">))</span>
<span class="mf">138</span><span class="w">     </span><span class="n">geometry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">property</span><span class="p">(</span><span class="n">lambda</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">s</span><span class="mf">.</span><span class="n">_geometry</span><span class="p">,</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">:</span><span class="w"> </span><span class="n">setattr</span><span class="p">(</span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;_geometry&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">))</span>
<span class="mf">139</span><span class="w">     </span><span class="kr">sys</span><span class="n">tem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">property</span><span class="p">(</span><span class="n">lambda</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">s</span><span class="mf">.</span><span class="n">__writeOnly</span><span class="p">(</span><span class="s">&quot;system&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">:</span><span class="w"> </span><span class="n">s</span><span class="mf">.</span><span class="n">__partition</span><span class="mf">.</span><span class="n">set_system</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="mf">140</span><span class="w">     </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">property</span><span class="p">(</span><span class="n">lambda</span><span class="w"> </span><span class="n">s</span><span class="p">:</span><span class="w"> </span><span class="n">s</span><span class="mf">.</span><span class="n">__partition</span><span class="mf">.</span><span class="n">type</span><span class="p">,</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="n">s</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">:</span><span class="w"> </span><span class="n">setattr</span><span class="p">(</span><span class="n">s</span><span class="mf">.</span><span class="n">__partition</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">))</span>
</code></pre></div>

<p>The geometry property is indeed read-write but the system property is write-only.
<code>git blame</code> leads us to the interesting
<a href="https://github.com/rhinstaller/pyparted/commit/2fc0ee2b">commit 2fc0ee2b</a>, which changes
definitions for quite a few properties and removes the <code>_readOnly</code> method which raises
an exception. Even more interesting is the fact that the <code>Partition.geometry</code> property
hasn't been changed. If you look closer you will notice that the deleted definition and
the new one are exactly the same. Looks like the problem existed even before this change.</p>
<p>Digging down even further we find
<a href="https://github.com/rhinstaller/pyparted/commit/7599aa1ae505f3784ca4936b58b38b8dffb752ff">commit 7599aa1</a>
which is the very first implementation of the <code>parted</code> module. There you can see the
<code>_readOnly</code> method and some properties like <code>path</code> and <code>disk</code> correctly marked as such
but <code>geometry</code> isn't.</p>
<p>Shortly after this commit the first test was added (4b9de0e) and a bit
later the second, empty test class, was added (c85a5e6). This only goes
to show that every piece of software needs appropriate QA coverage, which
pyparted was kind of lacking (and I'm trying to change that).</p>
<p>The reason this bug went unnoticed for so long
is the limited exposure of pyparted. To my knowledge anaconda, the Fedora installer
is its biggest (if not single) consumer and maybe it uses only the <code>_ped</code>
interface (I didn't check) or it doesn't try to do silly things like setting
a value to a read-only property.</p>
<p>**
The lesson from this story is to test all of your interfaces and also
make sure they are behaving in exactly the same manner!
**</p>
<p>Thanks for reading and happy testing!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 26 April 2016
            </p>
<p>There are <a href="http://atodorov.org/blog/2016/04/26/mismatch-in-pyparted-interfaces/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/02/automatic-upstream-dependency-testing/" rel="bookmark" title="Permalink to Automatic Upstream Dependency Testing">
                <h2 class="post-title">
                    Automatic Upstream Dependency Testing
                </h2>
            </a>
                <p>Ever since
<a href="http://atodorov.org/blog/2015/11/24/python-libs-in-rhel-7.2-broke-ssl-verification-in-s3cmd/">RHEL 7.2 python-libs broke s3cmd</a>
I've been pondering an age old problem: <em>How do I know if my software works with the
latest upstream dependencies ? How can I pro-actively monitor for new versions
and add them to my test matrix ?</em></p>
<p>Mixing together my previous experience with
<a href="http://atodorov.org/blog/2014/05/06/opensource-dot-com-article-10-steps-to-migrate-your-closed-software-to-open-source/">Difio</a>
and monitoring upstream sources,
and <a href="https://twitter.com/ForbesLindesay">Forbes Lindesay's</a> <em>GitHub Automation</em> talk
at <a href="http://atodorov.org/blog/2015/05/22/devit-conf-2015-impressions/">DEVit Conf</a> I came
together with a plan:</p>
<ul>
<li>Make an application which will execute when new upstream version is available;</li>
<li><a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/">Automatically update <code>.travis.yml</code></a>
for the projects I'm interested in;</li>
<li>Let Travis-CI execute my test suite for all available upstream versions;</li>
<li>Profit!</li>
</ul>
<h2>How Does It Work</h2>
<p>First we need to monitor upstream! RubyGems.org has nice
<a href="http://guides.rubygems.org/rubygems-org-api/#webhook-methods">webhooks interface</a>,
you can even trigger on individual packages. PyPI however doesn't have anything
like this :(. My solution is to run a cron job every hour and parse their RSS
stream for newly released packages. This has been working previously for Difio
so I re-used one function from the code.</p>
<p>After finding anything we're interested in comes the hard part - automatically
updating <code>.travis.yml</code> using the GitHub API. I've described this in more detail
<a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/">here</a>. This time
I've slightly modified the code to update only when needed and accept more
parameters so it can be reused.</p>
<p>Travis-CI has a clean interface to specify environment variables and
<a href="https://docs.travis-ci.com/user/environment-variables/#Defining-Multiple-Variables-per-Item">defining several</a>
of them crates a test matrix. This is exactly what I'm doing.
<code>.travis.yml</code> is updated with a new ENV setting, which determines the upstream
package version. After commit new build is triggered which includes the expanded
test matrix.</p>
<h2>Example</h2>
<p><img alt="Travis-CI build log" src="http://atodorov.org/images/travisci_matrix.png" title="Travis-CI build log"></p>
<p>Imagine that our <em>Project 2501</em> depends on FOO version <em>0.3.1</em>. The
<a href="https://travis-ci.org/atodorov/bztest/builds">build log</a> illustrates what
happened:</p>
<ul>
<li>Build #9 is what we've tested with <em>FOO-0.3.1</em> and released to production.
Test result is PASS!</li>
<li>Build #10 - meanwhile upstream releases <em>FOO-0.3.2</em> which causes our project
to break. We're not aware of this and continue developing new features
while all test results still PASS! When our customers upgrade their systems
<em>Project 2501</em> will break ! Tests didn't catch it because test matrix wasn't
updated. Please
ignore the actual commit message in the example! I've used the same repository
for the dummy dependency package.</li>
<li>Build #11 - the monitoring solution finds <em>FOO-0.3.2</em> and updates the test
matrix automatically. The build immediately breaks! More precisely the
<a href="https://travis-ci.org/atodorov/bztest/builds/94263181">test with version <em>0.3.2</em> fails</a>!</li>
<li>Build #12 - we've alerted FOO.org about their problem and they've released
<em>FOO-0.3.3</em>. Our monitor has found that and updated the test matrix.
However <a href="https://travis-ci.org/atodorov/bztest/builds/94270592">the 0.3.2 test job still fails</a>!</li>
<li>Build #13 - we decide to workaround the 0.3.2 failure or simply handle the
error gracefully. In this example I've removed version 0.3.2 from the test
matrix to simulate that. In reality I wouldn't touch <code>.travis.yml</code> but instead
update my application and tests to check for that particular version.
All test results are PASS again!</li>
</ul>
<p>Btw Build #11 above was triggered manually (./monitor.py) while Build #12
came from OpenShit, my hosting environment.</p>
<p>At present I have this monitoring enabled for my
<a href="http://atodorov.org/blog/2015/11/26/3-new-python-markdown-extensions/">new Markdown extensions</a>
and will also add it to <a href="https://github.com/atodorov/django-s3-cache">django-s3-cache</a>
once it migrates to Travis-CI (it uses drone.io now).</p>
<h2>Enough Talk, Show me the Code</h2>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">httplib</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">xml.dom.minidom</span> <span class="kn">import</span> <span class="n">parseString</span>

<span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">post_data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># GitHub requires a valid UA string</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;User-Agent&#39;</span> <span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (X11; Linux x86_64; rv:10.0.5) Gecko/20120601 Firefox/10.0.5&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># shortcut for GitHub API calls</span>
    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;://&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://api.github.com</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">url</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;api.github.com&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Set the GITHUB_TOKEN variable&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;token </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GITHUB_TOKEN&#39;</span><span class="p">]</span>
            <span class="p">})</span>

    <span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">host_path</span><span class="p">)</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">host_port</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">=</span> <span class="n">host_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPSConnection</span><span class="p">(</span><span class="n">host_port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="n">host_port</span><span class="p">)</span>


    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>
    <span class="k">if</span> <span class="n">post_data</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_data</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">post_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;404 - </span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># not a JSON response</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">post_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">get_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">monitor_rss</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan the PyPI RSS feeds to look for new packages.</span>
<span class="sd">        If name is found in config then execute the specified callback.</span>

<span class="sd">        @config is a dict with keys matching package names and values</span>
<span class="sd">        are lists of dicts</span>
<span class="sd">            {</span>
<span class="sd">                &#39;cb&#39; : a_callback,</span>
<span class="sd">                &#39;args&#39; : dict</span>
<span class="sd">            }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="s2">&quot;https://pypi.python.org/pypi?:action=rss&quot;</span><span class="p">)</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">parseString</span><span class="p">(</span><span class="n">rss</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;item&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pub_date</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;pubDate&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">firstChild</span><span class="o">.</span><span class="n">wholeText</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">released_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">pub_date</span><span class="o">.</span><span class="n">firstChild</span><span class="o">.</span><span class="n">wholeText</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %b %Y %H:%M:%S GMT&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="s2">&quot;found in config&quot;</span>
                <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                            <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                            <span class="s1">&#39;version&#39;</span> <span class="p">:</span> <span class="n">version</span><span class="p">,</span>
                            <span class="s1">&#39;released_on&#39;</span> <span class="p">:</span> <span class="n">released_on</span>
                        <span class="p">})</span>

                        <span class="c1"># execute the call back</span>
                        <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;cb&#39;</span><span class="p">](</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="n">e</span>
                        <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">e</span>
            <span class="k">continue</span>

<span class="k">def</span> <span class="nf">update_travis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">new_version</span><span class="p">):</span>
    <span class="n">travis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="n">new_ver_line</span> <span class="o">=</span> <span class="s2">&quot;  - VERSION=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_version</span>
    <span class="k">if</span> <span class="n">travis</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">new_ver_line</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">travis</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">new_ver_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">travis</span>


<span class="k">def</span> <span class="nf">update_github</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update GitHub via API</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">GITHUB_REPO</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GITHUB_REPO&#39;</span><span class="p">)</span>
    <span class="n">GITHUB_BRANCH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GITHUB_BRANCH&#39;</span><span class="p">)</span>
    <span class="n">GITHUB_FILE</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GITHUB_FILE&#39;</span><span class="p">)</span>

    <span class="c1"># step 1: Get a reference to HEAD</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="s2">&quot;/repos/</span><span class="si">%s</span><span class="s2">/git/refs/heads/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GITHUB_REPO</span><span class="p">,</span> <span class="n">GITHUB_BRANCH</span><span class="p">))</span>
    <span class="n">HEAD</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">],</span>
        <span class="s1">&#39;url&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="c1"># step 2: Grab the commit that HEAD points to</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
    <span class="c1"># remove what we don&#39;t need for clarity</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sha&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;commit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

    <span class="c1"># step 4: Get a hold of the tree that the commit points to</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;commit&#39;</span><span class="p">][</span><span class="s1">&#39;tree&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c1"># intermediate step: get the latest content from GitHub and make an updated version</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">GITHUB_FILE</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span> <span class="c1"># get the blob from the tree</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">])</span>
            <span class="k">break</span>

    <span class="n">old_travis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="n">new_travis</span> <span class="o">=</span> <span class="n">update_travis</span><span class="p">(</span><span class="n">old_travis</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">))</span>

    <span class="c1"># bail out if nothing changed</span>
    <span class="k">if</span> <span class="n">new_travis</span> <span class="o">==</span> <span class="n">old_travis</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;new == old, bailing out&quot;</span><span class="p">,</span> <span class="n">kwargs</span>
        <span class="k">return</span>

    <span class="c1">####</span>
    <span class="c1">#### WARNING WRITE OPERATIONS BELOW</span>
    <span class="c1">####</span>

    <span class="c1"># step 3: Post your new file to the server</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s2">&quot;/repos/</span><span class="si">%s</span><span class="s2">/git/blobs&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s1">&#39;content&#39;</span> <span class="p">:</span> <span class="n">new_travis</span><span class="p">,</span>
                    <span class="s1">&#39;encoding&#39;</span> <span class="p">:</span> <span class="s1">&#39;utf-8&#39;</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c1"># step 5: Create a tree containing your new file</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s2">&quot;/repos/</span><span class="si">%s</span><span class="s2">/git/trees&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;base_tree&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;tree&quot;</span><span class="p">:</span> <span class="p">[{</span>
                        <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">GITHUB_FILE</span><span class="p">,</span>
                        <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;100644&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;blob&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;sha&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span>
                    <span class="p">}]</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c1"># step 6: Create a new commit</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s2">&quot;/repos/</span><span class="si">%s</span><span class="s2">/git/commits&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;New upstream dependency found! Auto update .travis.yml&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;parents&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;commit&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">]],</span>
                    <span class="s2">&quot;tree&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s1">&#39;tree&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s1">&#39;commit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c1"># step 7: Update HEAD, but don&#39;t force it!</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s2">&quot;/repos/</span><span class="si">%s</span><span class="s2">/git/refs/heads/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GITHUB_REPO</span><span class="p">,</span> <span class="n">GITHUB_BRANCH</span><span class="p">),</span>
                <span class="p">{</span>
                    <span class="s2">&quot;sha&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s1">&#39;commit&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">):</span> <span class="c1"># PASS</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># FAIL</span>
        <span class="nb">print</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;atodorov-test&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span> <span class="s1">&#39;atodorov/bztest&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s1">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s2">&quot;Markdown&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span> <span class="s1">&#39;atodorov/Markdown-Bugzilla-Extension&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s1">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span>  <span class="s1">&#39;atodorov/Markdown-No-Lazy-Code-Extension&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s1">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span>  <span class="s1">&#39;atodorov/Markdown-No-Lazy-BlockQuote-Extension&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s1">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="c1"># check the RSS to see if we have something new</span>
    <span class="n">monitor_rss</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 02 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/02/automatic-upstream-dependency-testing/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/01/hosting-multiple-python-wsgi-scripts-on-openshift/" rel="bookmark" title="Permalink to Hosting Multiple Python WSGI Scripts on OpenShift">
                <h2 class="post-title">
                    Hosting Multiple Python WSGI Scripts on OpenShift
                </h2>
            </a>
                <p>With <a href="http://openshift.com">OpenShift</a> you can host WSGI Python
applications. By default the Python cartridge comes with a simple WSGI app
and the following directory layout</p>
<div class="highlight"><pre><span></span><code>./
./.openshift/
./requirements.txt
./setup.py
./wsgi.py
</code></pre></div>

<p>I wanted to add my
<a href="http://atodorov.org/blog/2015/11/24/github-bugzilla-hook/">GitHub Bugzilla Hook</a>
in a subdirectory (git submodule actually) and simply reserve a URL which will
be served by this app. My intention is also to add other small scripts to the
same cartridge in order to better utilize the available resources.</p>
<p>Using <code>WSGIScriptAlias</code> inside <code>.htaccess</code> <strong>DOESN'T WORK</strong>! OpenShift errors
out when <code>WSGIScriptAlias</code> is present. I suspect this to be a known limitation
and I have an open support case with Red Hat to confirm this.</p>
<p>My workaround is to configure the URL paths from the <code>wsgi.py</code> file in the root
directory. For example</p>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/wsgi.py b/wsgi.py</span>
<span class="gh">index c443581..20e2bf5 100644</span>
<span class="gd">--- a/wsgi.py</span>
<span class="gi">+++ b/wsgi.py</span>
<span class="gu">@@ -12,7 +12,12 @@ except IOError:</span>
<span class="w"> </span># line, it&#39;s possible required libraries won&#39;t be in your searchable path
<span class="w"> </span>#
<span class="w"> </span>
<span class="gi">+from github_bugzilla_hook import wsgi as ghbzh</span>
<span class="gi">+</span>
<span class="w"> </span>def application(environ, start_response):
<span class="gi">+    # custom paths</span>
<span class="gi">+    if environ[&#39;PATH_INFO&#39;] == &#39;/github-bugzilla-hook/&#39;:</span>
<span class="gi">+        return ghbzh.application(environ, start_response)</span>
<span class="w"> </span>
<span class="w"> </span>    ctype = &#39;text/plain&#39;
<span class="w"> </span>    if environ[&#39;PATH_INFO&#39;] == &#39;/health&#39;:
</code></pre></div>

<p>This does the job and is almost the same as configuring the path in <code>.htaccess</code>.
I hope it helps you!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 01 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/01/hosting-multiple-python-wsgi-scripts-on-openshift/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/" rel="bookmark" title="Permalink to Commit a file with the GitHub API and Python">
                <h2 class="post-title">
                    Commit a file with the GitHub API and Python
                </h2>
            </a>
                <p>How do you commit changes to a file using the GitHub API ?
I've found
<a href="http://www.levibotelho.com/development/commit-a-file-with-the-github-api/">this post</a>
by Levi Botelho which explains the necessary steps but without any code.
So I've used it and created a
<a href="https://github.com/atodorov/api-commit-test">Python example</a>.</p>
<p>I've rearranged the steps so that all write operations follow after a certain
section in the code and also added an intermediate section which creates the
updated content based on what is available in the repository.</p>
<p>I'm just appending
versions of Markdown to the <code>.travis.yml</code> (I will explain why in my next post)
and this is hard-coded for the sake of example. All content related operations
are also based on the GitHub API because I want to be independent of the source
code being around when I push this script to a hosting provider.</p>
<p>I've tested this script against itself. In the
<a href="https://github.com/atodorov/api-commit-test/commits/master">commits log</a>
you can find the <em>Automatic update to Markdown-X.Y</em> messages. These are
from the script. Also notice the <em>Merge remote-tracking branch 'origin/master'</em>
messages, these appeared when I pulled to my local copy. I believe the
reason for this is that I have some dangling trees and/or commits from
the time I was still experimenting with a broken script. I've tested on another
clean repository and <a href="https://github.com/atodorov/bztest/commits/master">there are</a>
no such merges.</p>
<p><strong>IMPORTANT</strong></p>
<p>For this to work you need to properly authenticate with GitHub. I've crated
a new token at <a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a> with the <em>public_repo</em>
permission and that works for me.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 01 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/11/29/inspecting-method-arguments-in-python/" rel="bookmark" title="Permalink to Inspecting Method Arguments in Python">
                <h2 class="post-title">
                    Inspecting Method Arguments in Python
                </h2>
            </a>
                <p>How do you execute methods from 3rd party classes in a backward compatible
manner when these methods change their arguments ?</p>
<p>s3cmd's <a href="https://github.com/s3tools/s3cmd/pull/668">PR #668</a> is an example
of this behavior, where python-libs's <code>httplib.py</code> added a new parameter
to disable hostname checks. As a result of this
<a href="/blog/2015/11/24/python-libs-in-rhel-7.2-broke-ssl-verification-in-s3cmd/">s3cmd broke</a>.</p>
<p>One solution is to use try-except and nest as much blocks as you need to cover
all of the argument variations. In s3cmd's case we needed two nested try-except
blocks.</p>
<p>Another possibility is to use the
<a href="https://docs.python.org/3/library/inspect.html">inspect</a> module and create the argument
list passed to the method dynamically, based on what parameters are supported.
Depending on the number of parameters this may or may not be more elegant than
using try-except blocks although it looks to me a bit more human readable.</p>
<p>The argument list is a member named <em>co_varnames</em> of the code object. If you
want to get the members for a function then</p>
<div class="highlight"><pre><span></span><code>inspect.getmembers(my_function.__code__)
</code></pre></div>

<p>if you want to get the members for a class method then</p>
<div class="highlight"><pre><span></span><code>inspect.getmembers(MyClass.my_method.__func__.__code__)
</code></pre></div>

<p>Consider the following example</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">inspect</span>

<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">greeting</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">greeting</span><span class="p">,</span> <span class="n">who</span>

<span class="k">class</span> <span class="nc">V1</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Hello World&quot;</span>

    <span class="k">def</span> <span class="nf">do_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span>

<span class="k">class</span> <span class="nc">V2</span><span class="p">(</span><span class="n">V1</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">greeting</span><span class="o">=</span><span class="s2">&quot;Hello&quot;</span><span class="p">):</span>
        <span class="n">V1</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;Hello&#39;</span><span class="p">,</span> <span class="n">greeting</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">V3</span><span class="p">(</span><span class="n">V2</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">greeting</span><span class="o">=</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="s2">&quot;World&quot;</span><span class="p">):</span>
        <span class="n">V2</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">greeting</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;World&#39;</span><span class="p">,</span> <span class="n">who</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="nb">print</span> <span class="s2">&quot;=== Example: call the class directly ===&quot;</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">V1</span><span class="p">()</span>
    <span class="n">v1</span><span class="o">.</span><span class="n">do_print</span><span class="p">()</span>

    <span class="n">v2</span> <span class="o">=</span> <span class="n">V2</span><span class="p">(</span><span class="n">greeting</span><span class="o">=</span><span class="s2">&quot;Good day&quot;</span><span class="p">)</span>
    <span class="n">v2</span><span class="o">.</span><span class="n">do_print</span><span class="p">()</span>

    <span class="n">v3</span> <span class="o">=</span> <span class="n">V3</span><span class="p">(</span><span class="n">greeting</span><span class="o">=</span><span class="s2">&quot;Good evening&quot;</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="s2">&quot;everyone&quot;</span><span class="p">)</span>
    <span class="n">v3</span><span class="o">.</span><span class="n">do_print</span><span class="p">()</span>

    <span class="c1"># uncomment to see the error raised</span>
    <span class="c1">#v4 = V1(greeting=&quot;Good evening&quot;, who=&quot;everyone&quot;)</span>
    <span class="c1">#v4.do_print()</span>

    <span class="nb">print</span> <span class="s2">&quot;=== Example: use try-except ===&quot;</span>
    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="p">[</span><span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">,</span> <span class="n">V3</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">greeting</span><span class="o">=</span><span class="s2">&quot;Good evening&quot;</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="s2">&quot;everyone&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;    error: nested-try-except-1&quot;</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">greeting</span><span class="o">=</span><span class="s2">&quot;Good evening&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="nb">print</span> <span class="s2">&quot;    error: nested-try-except-2&quot;</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">do_print</span><span class="p">()</span>


    <span class="nb">print</span> <span class="s2">&quot;=== Example: using inspect ===&quot;</span>
    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="p">[</span><span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">,</span> <span class="n">V3</span><span class="p">]:</span>
        <span class="n">members</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="fm">__init__</span><span class="o">.</span><span class="vm">__func__</span><span class="o">.</span><span class="vm">__code__</span><span class="p">))</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="n">members</span><span class="p">[</span><span class="s1">&#39;co_varnames&#39;</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s1">&#39;greeting&#39;</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;greeting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Good morning&#39;</span>

        <span class="k">if</span> <span class="s1">&#39;who&#39;</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s1">&#39;who&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;children&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">do_print</span><span class="p">()</span>
</code></pre></div>

<p>The output of the example above is as follows</p>
<div class="highlight"><pre><span></span><code>=== Example: call the class directly ===
Hello World
Good day World
Good evening everyone
=== Example: use try-except ===
    error: nested-try-except-1
    error: nested-try-except-2
Hello World
    error: nested-try-except-1
Good evening World
Good evening everyone
=== Example: using inspect ===
Hello World
Good morning World
Good morning children
</code></pre></div>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Sun 29 November 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/11/29/inspecting-method-arguments-in-python/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/11/26/3-new-python-markdown-extensions/" rel="bookmark" title="Permalink to 3 New Python Markdown extensions">
                <h2 class="post-title">
                    3 New Python Markdown extensions
                </h2>
            </a>
                <p>I've managed to resolve several of my issues with Python-Markdown behaving not
quite as I expect. I have the pleasure to announce three new extensions which
now power this blog.</p>
<h2>No Lazy BlockQuote Extension</h2>
<p><a href="https://github.com/atodorov/Markdown-No-Lazy-BlockQuote-Extension">Markdown-No-Lazy-BlockQuote-Extension</a>
makes it possible blockquotes separated by newline to be rendered separately.
If you want to include empty lines in your blockquotes make sure to prefix
each line with <code>&gt;</code>. The standard behavior can be seen in
<a href="https://github.com/atodorov/atodorov.github.com/blob/source/content/_posts/2014-03-04-how-do-you-test-fonts.markdown">GitHub</a>
while the changed behavior is visible
<a href="/blog/2014/03/04/how-do-you-test-fonts/">in this article</a>. Notice how on
GitHub both quotes are rendered as one big block, while here they are two separate
blocks.</p>
<h2>No Lazy Code Extension</h2>
<p><a href="https://github.com/atodorov/Markdown-No-Lazy-Code-Extension">Markdown-No-Lazy-Code-Extension</a>
allows code blocks separated by newline to be rendered separately. If you want to
include empty lines in your code blocks make sure to
<a href="https://github.com/atodorov/atodorov.github.com/commit/9684875920c6c7926951ce99b6588a9a7007e6f0">indent them as well</a>.
The standard behavior can be seen on
<a href="https://github.com/atodorov/atodorov.github.com/blob/source/content/_posts/2013-02-13-secure-vnc-installation-red-hat-enterprise-linux.markdown">GitHub</a>
while the improved one in this
<a href="/blog/2013/02/13/secure-vnc-installation-red-hat-enterprise-linux/">post</a>.
Notice how GitHub renders the code in the <strong>Warning Bugs Present</strong> section
as one block while in reality these are two separate blocks from two different files.</p>
<h2>Bugzilla Extension</h2>
<p><a href="https://github.com/atodorov/Markdown-Bugzilla-Extension">Markdown-Bugzilla-Extension</a>
allows for easy references to bugs. Strings like <code>[bz#123]</code> and <code>[rhbz#456]</code> will
be converted into links.</p>
<p>All three extensions are available on PyPI!</p>
<h2>Bonus: Codehilite with filenames in Markdown</h2>
<p>The standard Markdown codehilite extension doesn't allow to specify filename
on the <code>:::python</code> shebang line while Octopress did and I've used the syntax
on this blog in a number of articles. The fix is simple, but requires changes in
both Markdown and Pygments. See
<a href="https://github.com/waylan/Python-Markdown/pull/445">PR #445</a> for the initial
version and ongoing discussion. Example of the new <code>:::python settings.py</code> syntax
can be seen
<a href="/blog/2013/03/07/python-twitter-django-social-auth-hello-new-user/">here</a>.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Thu 26 November 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/11/26/3-new-python-markdown-extensions/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/11/24/python-libs-in-rhel-7.2-broke-ssl-verification-in-s3cmd/" rel="bookmark" title="Permalink to python-libs in RHEL 7.2 broke SSL verification in s3cmd">
                <h2 class="post-title">
                    python-libs in RHEL 7.2 broke SSL verification in s3cmd
                </h2>
            </a>
                <p>Today started with <a href="http://planet.sofiavalley.com">Planet Sofia Valley</a> being
broken again. Indeed it's been broken since last Friday when I've upgraded to
the latest RHEL 7.2. I quickly identified that I was hitting
<a href="https://github.com/s3tools/s3cmd/issues/647">Issue #647</a>. Then I tried the
git checkout without any luck. This is when I started to suspect that python-libs
has been updated in an incompatible way.</p>
<p>After series of reported bugs,
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1284916">RHBZ #1284916</a>,
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1284930">RHBZ #1284930</a>,
<a href="http://bugs.python.org/issue25722">Python#25722</a>, it was clear that
<code>ssl.py</code> was working according to RFC6125, that Amazon S3 was not playing
nicely with this same RFC and that my patch proposal was wrong.
This immediately had me looking upper in the stack at <code>httplib.py</code> and <code>s3cmd</code>.</p>
<p>Indeed there was a change in <code>httplib.py</code> which introduced two parameters,
<em>context</em> and <em>check_hostname</em>, to <code>HTTPSConnection.__init__</code>. The change
also supplied the logic which performs SSL hostname validation.</p>
<div class="highlight"><pre><span></span><code>if not self._context.check_hostname and self._check_hostname:
    try:
        ssl.match_hostname(self.sock.getpeercert(), server_hostname)
    except Exception:
        self.sock.shutdown(socket.SHUT_RDWR)
        self.sock.close()
        raise
</code></pre></div>

<p>This looks a bit doggy as I don't quite understand the intention behind
<em>not PREDICATE and PREDICATE</em>. Anyway to disable the validation you need
both parameters set to False, which is
<a href="https://github.com/s3tools/s3cmd/pull/668">PR #668</a>.</p>
<p>Notice the two try-except blocks. This is in case we're running with a
version that has a context but not the check_hostname parameter. I've found
the <em>inspect.getmembers</em> function which can be used to figure out what
parameters are there for the init method but a solution based on it
doesn't appear to be more elegant. I will describe this in more details in
my next post.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 24 November 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/11/24/python-libs-in-rhel-7.2-broke-ssl-verification-in-s3cmd/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2014/11/11/speeding-up-celery-backends-part-3/" rel="bookmark" title="Permalink to Speeding Up Celery Backends, Part 3">
                <h2 class="post-title">
                    Speeding Up Celery Backends, Part 3
                </h2>
            </a>
                <p>In the second part of this article we've seen 
<a href="/blog/2014/11/07/speeding-up-celery-backends-part-2/">how slow Celery actually is</a>.
Now let's explore what happens inside and see if we can't speed things up.</p>
<p>I've used <a href="http://pycallgraph.slowchop.com/en/latest/">pycallgraph</a> to create
call graph visualizations of my application. It has the nice feature to also show
execution time and use different colors for fast and slow operations.</p>
<p>Full command line is:</p>
<div class="highlight"><pre><span></span><code><span class="n">pycallgraph</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">--</span><span class="n">stdlib</span><span class="w"> </span><span class="o">--</span><span class="n">include</span><span class="w"> </span><span class="o">...</span><span class="w"> </span><span class="n">graphviz</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">calls</span><span class="o">.</span><span class="n">png</span><span class="w"> </span><span class="o">--</span><span class="w"> </span><span class="o">./</span><span class="n">manage</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="n">celery_load_test</span>
</code></pre></div>

<p>where the <code>--include</code> is used to limit the graph to a particular Python module(s).</p>
<h2>General findings</h2>
<p><img alt="call graph" src="/images/celery/general.png" title="call graph"></p>
<ul>
<li>The first four calls is where most of the time is spent as seen on the picture. </li>
<li>As it seems most of the slow down comes from Celery itself, not the underlying messaging
transport Kombu (not shown on picture)</li>
<li><code>celery.app.amqp.TaskProducer.publish_task</code> takes half of the execution time of
<code>celery.app.base.Celery.send_task</code></li>
<li><code>celery.app.task.Task.delay</code> directly executes <code>.apply_async</code> and can be skipped if one
rewrites the code.</li>
</ul>
<h2>More findings</h2>
<p>In <code>celery.app.base.Celery.send_task</code> there is this block of code:</p>
<div class="highlight"><pre><span></span><code><span class="mf">349</span><span class="w">         </span><span class="n">with</span><span class="w"> </span><span class="n">self</span><span class="mf">.</span><span class="n">producer_or_acquire</span><span class="p">(</span><span class="n">producer</span><span class="p">)</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">P</span><span class="p">:</span>
<span class="mf">350</span><span class="w">             </span><span class="n">self</span><span class="mf">.</span><span class="n">backend</span><span class="mf">.</span><span class="kr">on</span><span class="n">_task_call</span><span class="p">(</span><span class="n">P</span><span class="p">,</span><span class="w"> </span><span class="n">task_id</span><span class="p">)</span>
<span class="mf">351</span><span class="w">             </span><span class="n">task_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">P</span><span class="mf">.</span><span class="n">publish_task</span><span class="p">(</span>
<span class="mf">352</span><span class="w">                 </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="n">kwargs</span><span class="p">,</span><span class="w"> </span><span class="n">countdown</span><span class="o">=</span><span class="n">countdown</span><span class="p">,</span><span class="w"> </span><span class="n">eta</span><span class="o">=</span><span class="n">eta</span><span class="p">,</span>
<span class="mf">353</span><span class="w">                 </span><span class="n">task_id</span><span class="o">=</span><span class="n">task_id</span><span class="p">,</span><span class="w"> </span><span class="nb">exp</span><span class="n">ires</span><span class="o">=</span><span class="nb">exp</span><span class="n">ires</span><span class="p">,</span>
<span class="mf">354</span><span class="w">                 </span><span class="n">callbacks</span><span class="o">=</span><span class="n">maybe_list</span><span class="p">(</span><span class="n">link</span><span class="p">),</span><span class="w"> </span><span class="n">errbacks</span><span class="o">=</span><span class="n">maybe_list</span><span class="p">(</span><span class="n">link_error</span><span class="p">),</span>
<span class="mf">355</span><span class="w">                 </span><span class="n">reply_to</span><span class="o">=</span><span class="n">reply_to</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">self</span><span class="mf">.</span><span class="n">oid</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">options</span>
<span class="mf">356</span><span class="w">             </span><span class="p">)</span>
</code></pre></div>

<p><code>producer</code> is always None because delay() doesn't pass it as argument.
I've tried passing it explicitly to apply_async() as so:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">djapp.celery</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="o">*</span>

<span class="c1"># app = debug_task._get_app() # if not defined in djapp.celery</span>
<span class="n">producer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">app</span><span class="o">.</span><span class="n">amqp</span><span class="o">.</span><span class="n">producer_pool</span><span class="o">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">debug_task</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">producer</span><span class="o">=</span><span class="n">producer</span><span class="p">)</span>
</code></pre></div>

<p>However this doesn't speedup anything. If we replace the above code block like this:</p>
<div class="highlight"><pre><span></span><code><span class="mf">349</span><span class="w">         </span><span class="n">with</span><span class="w"> </span><span class="n">producer</span><span class="w"> </span><span class="n">as</span><span class="w"> </span><span class="n">P</span><span class="p">:</span>
</code></pre></div>

<p>it blows up on the second iteration because producer and its channel is already None !?!</p>
<p>If you are unfamiliar with the with statement in Python please read
<a href="http://effbot.org/zone/python-with-statement.htm">this article</a>. In short the with statement is
a compact way of writing try/finally. The underlying <code>kombu.messaging.Producer</code> class does a
<code>self.release()</code> on exit of the with statement.</p>
<p>I also tried killing the with statement and using producer directly but with limited success. While
it was not released(was non None) on subsequent iterations the memory usage grew much more and there
wasn't any performance boost.</p>
<h2>Conclusion</h2>
<p>The with statement is used throughout both Celery and Kombu and I'm not at all sure if
there's a mechanism for keep-alive connections. My time constraints are limited and I'll probably
not spend anymore time on this problem soon.</p>
<p>Since my use case involves task producer and consumers on localhost I'll try to workaround the
current limitations by using Kombu directly 
(see <a href="https://gist.github.com/atodorov/2bc1fcd34531ad260ed7">this gist</a>) with a transport that
uses either a UNIX domain socket or a name pipe (FIFO) file.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 11 November 2014
            </p>
<p>There are <a href="http://atodorov.org/blog/2014/11/11/speeding-up-celery-backends-part-3/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2014/11/07/speeding-up-celery-backends-part-2/" rel="bookmark" title="Permalink to Speeding up Celery Backends, Part 2">
                <h2 class="post-title">
                    Speeding up Celery Backends, Part 2
                </h2>
            </a>
                <p>In the <a href="/blog/2014/11/05/speeding-up-celery-backends/">first part</a> of this
post I looked at a few celery backends and discovered they didn't meet my needs.
Why is the Celery stack slow? How slow is it actually?</p>
<h2>How slow is Celery in practice</h2>
<ul>
<li>Queue: 500`000 msg/sec</li>
<li>Kombu:  14`000 msg/sec</li>
<li>Celery:  2`000 msg/sec</li>
</ul>
<h2>Detailed test description</h2>
<p>There are three main components of the Celery stack: </p>
<ul>
<li>Celery itself</li>
<li>Kombu which handles the transport layer</li>
<li>Python Queue()'s underlying everything</li>
</ul>
<p>Using the <a href="https://gist.github.com/atodorov/2bc1fcd34531ad260ed7">Queue and Kombu tests</a>
run for 1 000 000 messages I got the following results:</p>
<ul>
<li>Raw Python Queue: Msgs per sec: 500`000</li>
<li>Raw Kombu without Celery where <code>kombu/utils/__init__.py:uuid()</code> is set to return 0<ul>
<li>with json serializer: Msgs per sec: 5`988</li>
<li>with pickle serializer: Msgs per sec: 12`820</li>
<li>with the custom mem_serializer from <a href="/blog/2014/11/05/speeding-up-celery-backends/">part 1</a>:
Msgs per sec: 14`492</li>
</ul>
</li>
</ul>
<p><strong>Note:</strong> when the test is executed with 100K messages mem_serializer yielded
25`000 msg/sec then the performance is saturated. I've observed similar behavior 
with raw Python Queue()'s. I saw some cache buffers being managed internally to avoid OOM
exceptions. This is probably the main reason performance becomes saturated over a longer
execution.</p>
<ul>
<li>Using <a href="https://gist.github.com/atodorov/0156cc41491a5e1ff953">celery_load_test.py</a> modified to
loop 1 000 000 times I got 1908.0 tasks created per sec.</li>
</ul>
<p>Another interesting this worth outlining - in the kombu test there are these lines:</p>
<div class="highlight"><pre><span></span><code><span class="k">with</span><span class="w"> </span><span class="n">producers</span><span class="o">[</span><span class="n">connection</span><span class="o">]</span><span class="p">.</span><span class="n">acquire</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="k">True</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nl">producer</span><span class="p">:</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="k">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">)</span><span class="err">:</span>
</code></pre></div>

<p>If we swap them the performance drops down to 3875 msg/sec which is comparable with the
Celery results. Indeed inside Celery there's the same <code>with producer.acquire(block=True)</code>
construct which is executed every time a new task is published. Next I will be looking 
into this to figure out exactly where the slowliness comes from.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Fri 07 November 2014
            </p>
<p>There are <a href="http://atodorov.org/blog/2014/11/07/speeding-up-celery-backends-part-2/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2014/11/05/speeding-up-celery-backends/" rel="bookmark" title="Permalink to Speeding up Celery Backends, Part 1">
                <h2 class="post-title">
                    Speeding up Celery Backends, Part 1
                </h2>
            </a>
                <p>I'm working on an application which fires a lot of Celery tasks - the more
the better! Unfortunately Celery backends seem to be rather slow :(.
Using the <a href="https://gist.github.com/atodorov/0156cc41491a5e1ff953">celery_load_test.py</a>
command for Django I was able to capture some metrics:</p>
<ul>
<li>Amazon SQS backend: 2 or 3 tasks/sec</li>
<li>Filesystem backend: 2000 - 2500 tasks/sec</li>
<li>Memory backend: around 3000 tasks/sec</li>
</ul>
<p>Not bad but I need in the order of 10000 tasks created per sec!
The other noticeable thing is that memory backend isn't much faster compared to
the filesystem one! NB: all of these backends actually come from the kombu package.</p>
<h2>Why is Celery slow ?</h2>
<p>Using <code>celery_load_test.py</code> together with 
<a href="/blog/2014/11/05/performance-profiling-in-python-with-cprofile/">cProfile</a> I
was able to pin-point some problematic areas:</p>
<ul>
<li>
<p><code>kombu/transports/virtual/__init__.py</code>: class Channel.basic_publish() - does
self.encode_body() into base64 encoded string. Fixed with custom transport backend
I called fastmemory which redefines the body_encoding property:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@cached_property</span>
<span class="k">def</span> <span class="nf">body_encoding</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

</li>
<li>
<p>Celery uses json or pickle (or other) serializers to serialize the data.
While json yields between 2000-3000 tasks/sec, pickle does around 3500 tasks/sec.
Replacing with a custom serializer which just returns
the objects (since we read/write from/to memory) yields about 4000 tasks/sec tops:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">kombu.serialization</span> <span class="kn">import</span> <span class="n">register</span>

<span class="k">def</span> <span class="nf">loads</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="n">register</span><span class="p">(</span><span class="s1">&#39;mem_serializer&#39;</span><span class="p">,</span> <span class="n">dumps</span><span class="p">,</span> <span class="n">loads</span><span class="p">,</span>
        <span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/x-memory&#39;</span><span class="p">,</span>
        <span class="n">content_encoding</span><span class="o">=</span><span class="s1">&#39;binary&#39;</span><span class="p">)</span>
</code></pre></div>

</li>
<li>
<p><code>kombu/utils/__init__.py</code>: def uuid() - generates random unique identifiers
which is a slow operation. Replacing it with <code>return "00000000"</code> boosts performance
to 7000 tasks/sec.</p>
</li>
</ul>
<p>It's clear that a constant UUID is not of any practical use but serves well to illustrate
how much does this function affect performance. </p>
<p><strong>Note:</strong>
Subsequent executions of <code>celery_load_test</code> seem to report degraded performance even with
the most optimized transport backend. I'm not sure why is this. One possibility is the random
UUID usage in other parts of the Celery/Kombu stack which drains entropy on the system and
generating more random numbers becomes slower. If you know better please tell me!</p>
<p>I will be looking for a better understanding
of these IDs in Celery and hope to be able to produce a faster uuid() function. Then I'll be
exploring the transport stack even more in order to reach the goal of 10000 tasks/sec.
If you have any suggestions or pointers please share them in the comments.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 05 November 2014
            </p>
<p>There are <a href="http://atodorov.org/blog/2014/11/05/speeding-up-celery-backends/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2014/11/05/performance-profiling-in-python-with-cprofile/" rel="bookmark" title="Permalink to Performance Profiling in Python with cProfile">
                <h2 class="post-title">
                    Performance Profiling in Python with cProfile
                </h2>
            </a>
                <p>This is a quick reference on profiling Python applications with
<a href="https://docs.python.org/2/library/profile.html#module-cProfile">cProfile</a>:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>cProfile<span class="w"> </span>-s<span class="w"> </span><span class="nb">time</span><span class="w"> </span>application.py
</code></pre></div>

<p>The output is sorted by execution time <code>-s time</code></p>
<div class="highlight"><pre><span></span><code>     9072842 function calls (8882140 primitive calls) in 9.830 CPU seconds

   Ordered by: internal time

   ncalls  tottime  percall  cumtime  percall filename:lineno(function)
    61868    0.575    0.000    0.861    0.000 abstract.py:28(__init__)
    41250    0.527    0.000    0.660    0.000 uuid.py:101(__init__)
    61863    0.405    0.000    1.054    0.000 abstract.py:40(as_dict)
    41243    0.343    0.000    1.131    0.000 __init__.py:143(uuid4)
   577388    0.338    0.000    0.649    0.000 abstract.py:46(&lt;genexpr&gt;)
    20622    0.289    0.000    8.824    0.000 base.py:331(send_task)
    61907    0.232    0.000    0.477    0.000 datastructures.py:467(__getitem__)
    20622    0.225    0.000    9.298    0.000 task.py:455(apply_async)
    61863    0.218    0.000    2.502    0.000 abstract.py:52(__copy__)
    20621    0.208    0.000    4.766    0.000 amqp.py:208(publish_task)
   462640    0.193    0.000    0.247    0.000 {isinstance}
   515525    0.162    0.000    0.193    0.000 abstract.py:41(f)
    41246    0.153    0.000    0.633    0.000 entity.py:143(__init__)
</code></pre></div>

<p>In the example above (actual application) first line is kombu's
<code>abstract.py: class Object(object).__init__()</code>
and the second one is Python's
<code>uuid.py: class UUID().__init__()</code>.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 05 November 2014
            </p>
<p>There are <a href="http://atodorov.org/blog/2014/11/05/performance-profiling-in-python-with-cprofile/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2014/02/21/skip-or-render-specific-blocks-from-jinja2-templates/" rel="bookmark" title="Permalink to Skip or Render Specific Blocks from Jinja2 Templates">
                <h2 class="post-title">
                    Skip or Render Specific Blocks from Jinja2 Templates
                </h2>
            </a>
                <p>I wasn't able to find detailed information on how to skip rendering
or only render specific blocks from Jinja2 templates so here's my solution.
Hopefully you find it useful too.</p>
<p>With below template I want to be able to render <strong>only</strong> <em>kernel_options</em> block
as a single line and then render the rest of the template <strong>excluding</strong> <em>kernel_options</em>.</p>
<div class="highlight"><pre><span></span><code><span class="cp">{%</span> <span class="k">block</span> <span class="nv">kernel_options</span> <span class="cp">%}</span>
<span class="x">console=tty0</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">debug</span> <span class="cp">%}</span>
<span class="x">        debug=1</span>
<span class="x">    </span><span class="cp">{%</span> <span class="k">endblock</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">kernel_options</span> <span class="cp">%}</span>

<span class="cp">{%</span> <span class="k">if</span> <span class="nv">OS_MAJOR</span> <span class="o">==</span> <span class="m">5</span> <span class="cp">%}</span>
<span class="x">key --skip</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="x">%packages</span>
<span class="x">@base</span>
<span class="cp">{%</span> <span class="k">if</span> <span class="nv">OS_MAJOR</span> <span class="o">&gt;</span> <span class="m">5</span> <span class="cp">%}</span>
<span class="x">%end</span>
<span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>
</code></pre></div>

<p>To render a particular block you have to use the low level Jinja API
<em><a href="http://jinja.pocoo.org/docs/api/#jinja2.Template.blocks">template.blocks</a></em>.
This will return a dict of block rendering functions which need a <em>Context</em> to work with.</p>
<p>The second part is trickier. To remove a block we have to create an extension
which will filter it out. The provided <em>SkipBlockExtension</em> class does
exactly this.</p>
<p>Last but not least - if you'd like to use both together you have to disable
caching in the <em>Environment</em> (so you get a fresh template every time), render
your blocks first, configure <em>env.skip_blocks</em> and render the entire template
without the specified blocks.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">jinja2.ext</span> <span class="kn">import</span> <span class="n">Extension</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">FileSystemLoader</span>


<span class="k">class</span> <span class="nc">SkipBlockExtension</span><span class="p">(</span><span class="n">Extension</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SkipBlockExtension</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">environment</span><span class="p">)</span>
        <span class="n">environment</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">skip_blocks</span><span class="o">=</span><span class="p">[])</span>

    <span class="k">def</span> <span class="nf">filter_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream</span><span class="p">):</span>
        <span class="n">block_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">skip_level</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">in_endblock</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">stream</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;block_begin&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">current</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;block&#39;</span><span class="p">):</span>
                    <span class="n">block_level</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">.</span><span class="n">look</span><span class="p">()</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">environment</span><span class="o">.</span><span class="n">skip_blocks</span><span class="p">):</span>
                        <span class="n">skip_level</span> <span class="o">=</span> <span class="n">block_level</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;endblock&#39;</span> <span class="p">):</span>
                <span class="n">in_endblock</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">skip_level</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">token</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">token</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;block_end&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">in_endblock</span><span class="p">:</span>
                    <span class="n">in_endblock</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">block_level</span> <span class="o">-=</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="n">skip_level</span> <span class="o">==</span> <span class="n">block_level</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">skip_level</span> <span class="o">=</span> <span class="mi">0</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;OS_MAJOR&#39;</span> <span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s1">&#39;ARCH&#39;</span> <span class="p">:</span> <span class="s1">&#39;x86_64&#39;</span><span class="p">}</span>

    <span class="n">abs_path</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dir_name</span>  <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>
    <span class="n">base_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">abs_path</span><span class="p">)</span>

    <span class="n">env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span>
                <span class="n">loader</span> <span class="o">=</span> <span class="n">FileSystemLoader</span><span class="p">(</span><span class="n">dir_name</span><span class="p">),</span>
                <span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">SkipBlockExtension</span><span class="p">],</span>
                <span class="n">cache_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="c1"># disable cache b/c we do 2 get_template()</span>
            <span class="p">)</span>

    <span class="c1"># first render only the block we want</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">template</span><span class="o">.</span><span class="n">blocks</span><span class="p">[</span><span class="s1">&#39;kernel_options&#39;</span><span class="p">](</span><span class="n">template</span><span class="o">.</span><span class="n">new_context</span><span class="p">(</span><span class="n">context</span><span class="p">)):</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
    <span class="nb">print</span> <span class="s2">&quot;Boot Args:&quot;</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;---------------------------&quot;</span>

    <span class="c1"># now instruct SkipBlockExtension which blocks we don&#39;t want</span>
    <span class="c1"># and get a new instance of the template with these blocks removed</span>
    <span class="n">env</span><span class="o">.</span><span class="n">skip_blocks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;kernel_options&#39;</span><span class="p">)</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="nb">print</span> <span class="s2">&quot;---------------------------&quot;</span>
</code></pre></div>

<p>The above code results in the following output:</p>
<div class="highlight"><pre><span></span><code><span class="n">$</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">jinja2</span><span class="o">-</span><span class="n">render</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">base</span><span class="p">.</span><span class="n">j2</span><span class="w"> </span>
<span class="n">Boot</span><span class="w"> </span><span class="n">Args</span><span class="o">:</span><span class="w"> </span><span class="n">console</span><span class="o">=</span><span class="n">tty0</span><span class="w"> </span><span class="n">debug</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span>
<span class="o">---------------------------</span>

<span class="n">key</span><span class="w"> </span><span class="o">--</span><span class="n">skip</span>

<span class="nf">%packages</span>
<span class="err">@</span><span class="n">base</span>
<span class="o">---------------------------</span>
</code></pre></div>

<p>Teaser: this is part of my effort to replace SNAKE with a client side
kickstart template engine for
<a href="/blog/2013/11/19/open-source-quality-assurance-infrastructure-for-fedora-qa/">Beaker</a>
so stay tuned!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Fri 21 February 2014
            </p>
<p>There are <a href="http://atodorov.org/blog/2014/02/21/skip-or-render-specific-blocks-from-jinja2-templates/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2014/02/03/fosdem-2014-report-day-1-python-stands-lightning-talks/" rel="bookmark" title="Permalink to FOSDEM 2014 Report - Day #1 Python, Stands and Lightning Talks">
                <h2 class="post-title">
                    FOSDEM 2014 Report - Day #1 Python, Stands and Lightning Talks
                </h2>
            </a>
                <p>As promised I'm starting catching up on blogging after being sick and traveling.
Here's my report of what I saw and found interesting at this year's
<a href="https://fosdem.org/2014/">FOSDEM</a> which was held the last weekend in Brussels.</p>
<p>On Friday evening I've tried to attend the FOSDEM beer event at Delirium Cafe but
had a bad luck. At 21:30 the place was already packed with people. I managed to get
access to only one of the rooms but it looked like the wrong one :(. I think the space
is definitely small for all who are willing to attend.</p>
<p>During Saturday morning I did a quick sight-seeing most notably 
<a href="www.migsworldwines.be/">Mig's wine shop</a> and the area around it since I've never
been to this part of the city before. Then I took off to FOSDEM arriving at noon
(IOW not too late).</p>
<p>I've spent most of my day at building K where project stands were and I stayed quite
a long time around the Python and Perl stands meeting new people and talking to them
about their upgrade practices and how they manage package dependencies
(aka promoting <a href="http://www.dif.io">Difio</a>).</p>
<p><img alt="Fedora Octopus" src="/images/fosdem/2014/fedora_octopus.jpg" title="Fedora Octopus"></p>
<p>Fedora stand was busy with 3D printing this year. I've seen 3D printing
before but here I was amazed of the fine-grained quality of the pieces produced.
This is definitely something to have in mind if you are building physical products.</p>
<p>Red Hat's presence was very strong this year. In addition to the numerous talks they
gave there were also oVirt and OpenShift Origin stands which were packed with people.
I couldn't even get close to say hi or take a picture. </p>
<p><img src="/images/fosdem/2014/doudou_linux.png" alt="DoudouLinux" style="float:left;margin-right:10px;"/></p>
<p>Near the end of the day I went to listen to some of the lightning talks. The ones that
I liked the most were MATE Desktop and DoudouLinux. </p>
<p>The thing about MATE which I liked
is that they have a <a href="https://github.com/mate-desktop/mate-university">MATE University</a>
initiative which is targeting developers who want to learn how to develop MATE extensions.
This is pretty cool with respect to community and developers on-boarding. </p>
<p><a href="http://www.doudoulinux.org">DoudouLinux</a> is a Debian based distribution targeted at
small children (2 or 3 years old) based on simple desktop and educational activities.
I've met project leader and founder Jean-Michel Philippe who gave the talk. We chatted for
a while when Alejandro Simon from <a href="http://www.kano.me/">Kano</a> came around and showed us a prototype
of their computer for children. I will definitely give DoudouLinux a try and maybe pre-order Kano as well.</p>
<p>In the evening there was a Python beer event at Delirium and after that dinner at
Chez Leon where I had snails and rabbit with cherries in cherry beer sauce.
I've had a few beers with Marc-Andre from <a href="http://egenix.com">eGenix</a>
and Charlie from <a href="http://www.clark-consulting.eu/">Clark Consulting</a> and the talk
was mostly about non-technical stuff which was nice.</p>
<p>After that we went back to Delirium and
re-united with <a href="http://akurtakov.blogspot.com">Alexander Kurtakov</a> and other folks from
Red Hat for more cherry beer!</p>
<p>Report of the second day of FOSDEM'14 on Sunday is
<a href="/blog/2014/02/03/fosdem-2014-report-day-2-testing-and-automation/">here</a>.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Mon 03 February 2014
            </p>
<p>There are <a href="http://atodorov.org/blog/2014/02/03/fosdem-2014-report-day-1-python-stands-lightning-talks/#disqus_thread">comments</a>.</p>        </div>

    <hr>
    <!-- Pager -->
    <ul class="pager">
        <li class="next">
                <a href="http://atodorov.org/blog/categories/python/index2.html">Older Posts &rarr;</a>
        </li>
    </ul>
    Page 1 / 2
    <hr>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://twitter.com/atodorov_">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/atodorov">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://bg.linkedin.com/in/alextodorov">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="http://feeds.feedburner.com/atodorov">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.youtube.com/playlist?list=PLFjlI7p-h1hxBP3cIjEqePSeoBDHud5Db">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-youtube fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://amzn.to/4aHmlLD">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-amazon fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="http://mrsenko.com/?utm_source=atodorov.org&utm_medium=blog&utm_campaign=social_icon">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-user-secret fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<section>
    <p>
        I am the project lead for
        <a href="http://kiwitcms.org/?utm_source=atodorov.org&utm_medium=blog&utm_campaign=footer">Kiwi TCMS</a>
        and the current maintainer of <a href="http://MrSenko.com/pylint-workshop/">pylint-django</a>!
    </p>
    <p>
        <small>
            <em>
                Some of the links contained within this site have my referral id (e.g.,
                <a target="_blank" href="http://www.amazon.com/ref=as_li_ss_tl?_encoding=UTF8&camp=1789&creative=390957&linkCode=ur2&tag=atodorovorg-20&linkId=L6Q34XAXQS5RDMOY">Amazon</a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=atodorovorg-20&l=ur2&o=1" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />),
                which provides me with a small commission for each sale. Thank you for your support.
            </em>
        </small>
    </p>
</section>

<form action="http://google.com/search" method="get" style="width:300px;margin:0 auto;">
    <fieldset role="search">
        <input type="hidden" name="sitesearch" value="http://atodorov.org" />
        <input class="search" type="text" name="q" placeholder="Search" style="width:100%"/>
    </fieldset>
</form>

<p class="copyright text-muted">
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">CC-BY-SA</a> &amp;
    <a rel="license" href="http://opensource.org/licenses/MIT">MIT</a>
    2011-2018 &diams; Alexander Todorov
</p>

<script type='text/javascript'>
window.__lo_site_id = 55936;
    (function() {
        var wa = document.createElement('script'); wa.type = 'text/javascript'; wa.async = true;
        wa.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://cdn') + '.luckyorange.com/w.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(wa, s);
      })();
</script>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://atodorov.org/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://atodorov.org/theme/js/bootstrap.min.js"></script>


    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37979549-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'atodorov';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>