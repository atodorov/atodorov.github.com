<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

            <meta name="google-site-verification" content="XynqZtldWNBbmsynVQZremIxaaO8Wgs6AGR8UZ7KIkM">

        <title>atodorov.org - Tag Ruby</title>

            <link href="http://feeds.feedburner.com/atodorov" type="application/atom+xml" rel="alternate" title="atodorov.org Full Atom Feed" />
            <link href="http://atodorov.org/blog/categories/ruby/atom.xml" type="application/atom+xml" rel="alternate" title="atodorov.org Tags Atom Feed" />

        <!-- Bootstrap Core CSS -->
        <link href="http://atodorov.org/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://atodorov.org/theme/css/clean-blog.min.css" rel="stylesheet">
        <link href="http://atodorov.org/override.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://atodorov.org/theme/css/code_blocks/github.css" rel="stylesheet">

            <!-- CSS specified by the user -->
            <link href="http://atodorov.org/override.css" rel="stylesheet">

        <!-- Custom Fonts -->
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

                <meta property="fb:admins" content="1616937247" />
                    <meta property="og:locale" content="en_US">
		<meta property="og:site_name" content="atodorov.org">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://atodorov.org/">atodorov.org</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

        <header class="intro-header" style="background-image: url('/images/header_02.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="page-heading">
                        <h1>Tag Ruby</h1>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/23/interesting-ruby-resources/" rel="bookmark" title="Permalink to Interesting Ruby Resources">
                <h2 class="post-title">
                    Interesting Ruby Resources
                </h2>
            </a>
            <p>During my quest for
<a href="http://atodorov.org/blog/2015/12/23/speeding-up-rspec-and-postgresql-tests/">faster RSpec tests</a>
I've come across several interesting posts about Ruby. Being new to the language
they've helped me understand a bit more about the internals. Posting them here
so they don't get lost.</p>
<h2>Garbage Collection</h2>
<p><a href="https://signalvnoise.com/posts/2742-the-road-to-faster-tests">The road to faster tests</a>
- a story about tests and garbage collection.</p>
<p><a href="http://labs.clio.com/tuning-ruby-garbage-collection-for-rspec/">Tuning Ruby garbage collection for RSpec</a>
- practical explanation of Ruby's garbage collector and how to adjust its
performance for RSpec</p>
<p><a href="http://samsaffron.com/archive/2013/11/22/demystifying-the-ruby-gc">Demystifying the Ruby GC</a></p>
<p>Probably the very first posts I found referencing slow RSpec tests. It turned out
this was not the issue but I've nevertheless tried running GC manually. I can clearly
see (using <code>puts GC.count</code> in after()) GC invoked less frequently, memory usage rising
but the overall execution time wasn't affected. The profiler said 2% speed increase
to be honest.</p>
<h2>Profiling</h2>
<p>Not being very clear about the different profiling tools available and how to
interpret their results I've found these articles:</p>
<p><a href="https://www.igvita.com/2009/06/13/profiling-ruby-with-googles-perftools/">Profiling Ruby With Google's Perftools</a>
- practical example for using perftools.rb</p>
<p><a href="http://stackoverflow.com/questions/32212970/how-to-read-ruby-profilers-output">How to read ruby profiler's output</a> -
also see the <a href="http://ruby-doc.org/stdlib-2.1.0/libdoc/profiler/rdoc/Profiler__.html">Profiler__ module</a></p>
<p><a href="http://stackoverflow.com/questions/4856500/show-runtime-for-each-rspec-example">Show runtime for each rspec example</a>
- using <code>rspec --profile</code></p>
<h2>Suggestions for Faster Tests</h2>
<p>Several general best practices for faster tests:</p>
<p><a href="https://www.netguru.co/blog/9-ways-to-speed-up-your-rspec-tests">9 ways to speed up your RSpec tests</a></p>
<p><a href="https://infinum.co/the-capsized-eight/articles/run-faster-ruby-on-rails-tests">Run faster Ruby on Rails tests</a></p>
<p><a href="http://blog.plataformatec.com.br/2011/12/three-tips-to-improve-the-performance-of-your-test-suite/">Three tips to improve the performance of your test suite</a></p>
<h2>RubyGems related</h2>
<p>I've noticed Bundler loading tons of requirements (nearly 3000 unique modules)
and for some particular specs this wasn't necessary (for example running Rubocop).
I've found the following articles below which sound very reasonable to me:</p>
<p><a href="http://anti-pattern.com/use-bundler-setup-instead-of-bundler-require">Use Bundler.setup Instead of Bundler.require</a></p>
<p><a href="http://myronmars.to/n/dev-blog/2012/12/5-reasons-to-avoid-bundler-require">5 Reasons to Avoid Bundler.require</a></p>
<p><a href="http://2ndscale.com/rtomayko/2009/require-rubygems-antipattern">Why "require 'rubygems'" Is Wrong</a></p>
<h2>Weird</h2>
<p>Finally (or more precisely first of all) I've seen this
<a href="https://www.ruby-forum.com/topic/184516 suggests broken rubygems">Weird performance issue</a>.</p>
<p>During my initial profiling I've seen (and still see) a similar issue.
When calling require it goes through lots of hoops before finally loading
the module. My profiling results show this taking a lot of time but this time
is likely measured with profiling enabled and doesn't represent the real deal.</p>
<p>On my
<a href="http://atodorov.org/blog/2015/04/26/installing-red-hat-enterprise-linux-7-on-macbook-air-2015/">MacBook Air with Red Hat Enterprise Linux 7</a>
this happens when using Ruby 2.2.2 from Software Collections. If using Ruby
installed from source with rbenv the profiling profile is completely different.</p>
<p>I will be examining this one in more details. I'm interested to know what is
the difference and if that affects performance somehow so stay tuned!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 23 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/23/interesting-ruby-resources/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/23/speeding-up-rspec-and-postgresql-tests/" rel="bookmark" title="Permalink to Speeding up RSpec and PostgreSQL tests">
                <h2 class="post-title">
                    Speeding up RSpec and PostgreSQL tests
                </h2>
            </a>
            <p>I've been working with <a class="wikilink" href="http://tradeo.com">Tradeo</a> on testing one of their applications. The app
is standard Ruby on Rails application with over 1200 tests written with RSpec.
And they were horribly slow. On my <a class="wikilink" href="http://amzn.to/1RdviyD">MacBook Air</a> the entire test suite
took 27 minutes to execute. On the Jenkins slaves it took over an hour.
After a few changes Jenkins now takes 15 minutes to execute the test suite.
Locally it takes around 11 minutes!</p>
<h2>The Problem</h2>
<p>I've measured the speed (with Time.now) at which individual examples execute
and it was quickly apparent they were taking a lot of time cleaning the DB. The
offending code in question was:</p>
<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">clean_with</span> <span class="ss">:truncation</span>
<span class="k">end</span>
</pre></div>


<p>This is truncating the tables quite often but it turns out this is a very
expensive operation on tables with small number of records. I've measured it
locally around 2.5 seconds. Check out this
<a href="http://stackoverflow.com/questions/11419536/postgresql-truncation-speed/">SO thread</a>
which describes pretty much the same symptoms:</p>
<div class="highlight"><pre>Right now, locally (on a Macbook Air) a full test suite takes 28 minutes....
Tailing the logs on our CI server (Ubuntu 10.04 LTS) .... a build takes 84 minutes.
</pre></div>


<p>This
<a href="http://stackoverflow.com/questions/11419536/postgresql-truncation-speed/11423886#11423886">excellent answer</a>
explains why this is happening:</p>
<div class="highlight"><pre>(a) The bigger shared_buffers may be why TRUNCATE is slower on the CI server.
    Different fsync configuration or the use of rotational media instead of
    SSDs could also be at fault.

(b) TRUNCATE has a fixed cost, but not necessarily slower than DELETE,
    plus it does more work.
</pre></div>


<h2>The Fix</h2>
<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:suite</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">clean_with</span> <span class="ss">:truncation</span>
<span class="k">end</span>

<span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">clean_with</span> <span class="ss">:deletion</span>
<span class="k">end</span>
</pre></div>


<p><code>before(:suite)</code> will truncate tables every time we run rspec, which is when we
launch the entire test suite. This is to account for the possible side effects
of DELETE in the future (see the SO thread). Then <code>before(:all)</code> aka
<code>before(:context)</code> simply deletes the records which is significantly faster!</p>
<p>Also updated the CI servers <code>postgresql.conf</code> to</p>
<div class="highlight"><pre>fsync=off
full_page_writes=off
</pre></div>


<p>The entire build/test process now takes only 15 minutes! Only one test broke
due to PostgreSQL returning records in a different order, but it's the test
case fault not handling this in the first place!</p>
<p><strong>NOTE:</strong> Using fsync=off with rotational media pretty much hides any improvements
introduced by updating the DatabaseCleaner strategy.</p>
<h2>What's Next</h2>
<p>There are several other things worth trying:</p>
<ul>
<li>Use UNIX domain sockets instead of TCP/IP (localhost) to connect to PostgreSQL;</li>
<li>Load the entire
<a href="http://magazine.redhat.com/2007/12/12/tip-from-an-rhce-memory-storage-on-postgresql/">PostgreSQL partition in memory</a>;</li>
<li>Don't delete anything from the database, except once in <code>before(:suite)</code>.
If any tests need a particular DB state they have to set this up on their own
instead of relying on a global cleanup process. I expect this to break quite
a few examples.</li>
</ul>
<p>After the changes and with my crude measurements I have individual examples
taking 0.31 seconds to execute. Interestingly before and after take less than
a second while the example code takes around 0.15 seconds. I have no idea where
the rest 0.15 seconds are spent. My current speculation is probably RSpec.
This is 50% of the execution time and is also worth looking into!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 23 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/23/speeding-up-rspec-and-postgresql-tests/#disqus_thread">comments</a>.</p>        </div>

    <hr>
    <!-- Pager -->
    <ul class="pager">
        <li class="next">
        </li>
    </ul>
    Page 1 / 1
    <hr>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://twitter.com/atodorov_">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/atodorov">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://bg.linkedin.com/in/alextodorov">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>


                    <section>
                        <p>
                            I am a QA contractor at Red Hat responsible for finding over
                            <a href="/blog/2014/02/19/7-years-1400-bugs-red-hat-qa/">1500 bugs</a>,
                            a general purpose open source developer, Red Hat Certified professional,
                            cloud hacker and an entrepreneur! My latest start-up is
                            <a href="http://mrsenko.com/?utm_source=atodorov.org&utm_medium=blog&utm_campaign=footer">Mr. Senko</a>!
                        </p>

                        <p>
                            I am living in the <a href="http://planet.sofiavalley.com">Sofia Valley</a>
                            which is emerging as a busy place for start-up founders and tech enthusiasts
                            in Eastern Europe! You can find more about me <a href="/blog/2013/01/25/about-me/">here</a>.
                        </p>

                        <p>
                            <small>
                                <em>
                                    Some of the links contained within this site have my referral id (e.g.,
                                    <a target="_blank" href="http://www.amazon.com/ref=as_li_ss_tl?_encoding=UTF8&camp=1789&creative=390957&linkCode=ur2&tag=atodorovorg-20&linkId=L6Q34XAXQS5RDMOY">Amazon</a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=atodorovorg-20&l=ur2&o=1" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />),
                                    which provides me with a small commission for each sale. Thank you for your support.
                                </em>
                            </small>
                        </p>
                    </section>

                    <form action="http://google.com/search" method="get" style="width:300px;margin:0 auto;">
                        <fieldset role="search">
                            <input type="hidden" name="sitesearch" value="http://atodorov.org" />
                            <input class="search" type="text" name="q" placeholder="Search" style="width:100%"/>
                        </fieldset>
                    </form>

                    <p class="copyright text-muted">
                        <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">CC-BY-SA</a> &amp;
                        <a rel="license" href="http://opensource.org/licenses/MIT">MIT</a>
                        2011-2015 &diams; Alexander Todorov &diams;
                        <a href="http://planet.sofiavalley.com">SofiaValley Blog</a>
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://atodorov.org/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://atodorov.org/theme/js/bootstrap.min.js"></script>


    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37979549-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'atodorov';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>