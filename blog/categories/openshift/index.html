<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

            <meta name="google-site-verification" content="XynqZtldWNBbmsynVQZremIxaaO8Wgs6AGR8UZ7KIkM">

        <title>atodorov.org - Tag OpenShift</title>

        <link href="http://feeds.feedburner.com/atodorov" type="application/atom+xml" rel="alternate" title="atodorov.org Full Atom Feed" />
        <!-- Bootstrap Core CSS -->
        <link href="http://atodorov.org/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://atodorov.org/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://atodorov.org/theme/css/code_blocks/github.css" rel="stylesheet">

            <!-- CSS specified by the user -->
            <link href="http://atodorov.org/override.css" rel="stylesheet">

        <!-- Custom Fonts -->
        <link href="http://atodorov.org/theme/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

                <meta property="fb:admins" content="1616937247" >
                <meta property="og:locale" content="en_US">
		<meta property="og:site_name" content="atodorov.org">
            <meta name="twitter:card" content="summary_large_image">
            <meta name="twitter:site" content="@atodorov_">
            <meta name="twitter:title" content="atodorov.org">
            <meta name="twitter:description" content="you can logoff, but you can never leave">
                <meta name="twitter:image" content="http://atodorov.org//images/header_02.jpg">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://atodorov.org/">atodorov.org</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                        <li><a href="http://mrsenko.com/pylint-workshop/">Pylint Workshop</a></li>

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

        <header class="intro-header" style="background-image: url('/images/header_02.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="page-heading">
                        <h1>Tag OpenShift</h1>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/02/automatic-upstream-dependency-testing/" rel="bookmark" title="Permalink to Automatic Upstream Dependency Testing">
                <h2 class="post-title">
                    Automatic Upstream Dependency Testing
                </h2>
            </a>
                <p>Ever since
<a href="http://atodorov.org/blog/2015/11/24/python-libs-in-rhel-7.2-broke-ssl-verification-in-s3cmd/">RHEL 7.2 python-libs broke s3cmd</a>
I've been pondering an age old problem: <em>How do I know if my software works with the
latest upstream dependencies ? How can I pro-actively monitor for new versions
and add them to my test matrix ?</em></p>
<p>Mixing together my previous experience with
<a href="http://atodorov.org/blog/2014/05/06/opensource-dot-com-article-10-steps-to-migrate-your-closed-software-to-open-source/">Difio</a>
and monitoring upstream sources,
and <a href="https://twitter.com/ForbesLindesay">Forbes Lindesay's</a> <em>GitHub Automation</em> talk
at <a href="http://atodorov.org/blog/2015/05/22/devit-conf-2015-impressions/">DEVit Conf</a> I came
together with a plan:</p>
<ul>
<li>Make an application which will execute when new upstream version is available;</li>
<li><a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/">Automatically update <code>.travis.yml</code></a>
for the projects I'm interested in;</li>
<li>Let Travis-CI execute my test suite for all available upstream versions;</li>
<li>Profit!</li>
</ul>
<h2>How Does It Work</h2>
<p>First we need to monitor upstream! RubyGems.org has nice
<a href="http://guides.rubygems.org/rubygems-org-api/#webhook-methods">webhooks interface</a>,
you can even trigger on individual packages. PyPI however doesn't have anything
like this :(. My solution is to run a cron job every hour and parse their RSS
stream for newly released packages. This has been working previously for Difio
so I re-used one function from the code.</p>
<p>After finding anything we're interested in comes the hard part - automatically
updating <code>.travis.yml</code> using the GitHub API. I've described this in more detail
<a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/">here</a>. This time
I've slightly modified the code to update only when needed and accept more
parameters so it can be reused.</p>
<p>Travis-CI has a clean interface to specify environment variables and
<a href="https://docs.travis-ci.com/user/environment-variables/#Defining-Multiple-Variables-per-Item">defining several</a>
of them crates a test matrix. This is exactly what I'm doing.
<code>.travis.yml</code> is updated with a new ENV setting, which determines the upstream
package version. After commit new build is triggered which includes the expanded
test matrix.</p>
<h2>Example</h2>
<p><img alt="Travis-CI build log" src="http://atodorov.org/images/travisci_matrix.png" title="Travis-CI build log"></p>
<p>Imagine that our <em>Project 2501</em> depends on FOO version <em>0.3.1</em>. The
<a href="https://travis-ci.org/atodorov/bztest/builds">build log</a> illustrates what
happened:</p>
<ul>
<li>Build #9 is what we've tested with <em>FOO-0.3.1</em> and released to production.
Test result is PASS!</li>
<li>Build #10 - meanwhile upstream releases <em>FOO-0.3.2</em> which causes our project
to break. We're not aware of this and continue developing new features
while all test results still PASS! When our customers upgrade their systems
<em>Project 2501</em> will break ! Tests didn't catch it because test matrix wasn't
updated. Please
ignore the actual commit message in the example! I've used the same repository
for the dummy dependency package.</li>
<li>Build #11 - the monitoring solution finds <em>FOO-0.3.2</em> and updates the test
matrix automatically. The build immediately breaks! More precisely the
<a href="https://travis-ci.org/atodorov/bztest/builds/94263181">test with version <em>0.3.2</em> fails</a>!</li>
<li>Build #12 - we've alerted FOO.org about their problem and they've released
<em>FOO-0.3.3</em>. Our monitor has found that and updated the test matrix.
However <a href="https://travis-ci.org/atodorov/bztest/builds/94270592">the 0.3.2 test job still fails</a>!</li>
<li>Build #13 - we decide to workaround the 0.3.2 failure or simply handle the
error gracefully. In this example I've removed version 0.3.2 from the test
matrix to simulate that. In reality I wouldn't touch <code>.travis.yml</code> but instead
update my application and tests to check for that particular version.
All test results are PASS again!</li>
</ul>
<p>Btw Build #11 above was triggered manually (./monitor.py) while Build #12
came from OpenShit, my hosting environment.</p>
<p>At present I have this monitoring enabled for my
<a href="http://atodorov.org/blog/2015/11/26/3-new-python-markdown-extensions/">new Markdown extensions</a>
and will also add it to <a href="https://github.com/atodorov/django-s3-cache">django-s3-cache</a>
once it migrates to Travis-CI (it uses drone.io now).</p>
<h2>Enough Talk, Show me the Code</h2>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">httplib</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">xml.dom.minidom</span> <span class="kn">import</span> <span class="n">parseString</span>

<span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">post_data</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    <span class="c1"># GitHub requires a valid UA string</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;User-Agent&#39;</span> <span class="p">:</span> <span class="s1">&#39;Mozilla/5.0 (X11; Linux x86_64; rv:10.0.5) Gecko/20120601 Firefox/10.0.5&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># shortcut for GitHub API calls</span>
    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;://&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;https://api.github.com</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">url</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;api.github.com&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s2">&quot;GITHUB_TOKEN&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Set the GITHUB_TOKEN variable&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s1">&#39;token </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;GITHUB_TOKEN&#39;</span><span class="p">]</span>
            <span class="p">})</span>

    <span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">host_path</span><span class="p">)</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;//&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">host_port</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">=</span> <span class="n">host_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPSConnection</span><span class="p">(</span><span class="n">host_port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="n">host_port</span><span class="p">)</span>


    <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;GET&#39;</span>
    <span class="k">if</span> <span class="n">post_data</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s1">&#39;POST&#39;</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_data</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">post_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;404 - </span><span class="si">%s</span><span class="s2"> not found&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="s1">&#39;replace&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c1"># not a JSON response</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">post_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">get_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">monitor_rss</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan the PyPI RSS feeds to look for new packages.</span>
<span class="sd">        If name is found in config then execute the specified callback.</span>

<span class="sd">        @config is a dict with keys matching package names and values</span>
<span class="sd">        are lists of dicts</span>
<span class="sd">            {</span>
<span class="sd">                &#39;cb&#39; : a_callback,</span>
<span class="sd">                &#39;args&#39; : dict</span>
<span class="sd">            }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="s2">&quot;https://pypi.python.org/pypi?:action=rss&quot;</span><span class="p">)</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">parseString</span><span class="p">(</span><span class="n">rss</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;item&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pub_date</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s2">&quot;pubDate&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">firstChild</span><span class="o">.</span><span class="n">wholeText</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span>
            <span class="n">released_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">pub_date</span><span class="o">.</span><span class="n">firstChild</span><span class="o">.</span><span class="n">wholeText</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%d</span><span class="s1"> %b %Y %H:%M:%S GMT&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="nb">print</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="s2">&quot;found in config&quot;</span>
                <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">]</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                            <span class="s1">&#39;name&#39;</span> <span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                            <span class="s1">&#39;version&#39;</span> <span class="p">:</span> <span class="n">version</span><span class="p">,</span>
                            <span class="s1">&#39;released_on&#39;</span> <span class="p">:</span> <span class="n">released_on</span>
                        <span class="p">})</span>

                        <span class="c1"># execute the call back</span>
                        <span class="n">cfg</span><span class="p">[</span><span class="s1">&#39;cb&#39;</span><span class="p">](</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span> <span class="n">e</span>
                        <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span> <span class="n">e</span>
            <span class="k">continue</span>

<span class="k">def</span> <span class="nf">update_travis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">new_version</span><span class="p">):</span>
    <span class="n">travis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="n">new_ver_line</span> <span class="o">=</span> <span class="s2">&quot;  - VERSION=</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">new_version</span>
    <span class="k">if</span> <span class="n">travis</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">new_ver_line</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">travis</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">new_ver_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">travis</span>


<span class="k">def</span> <span class="nf">update_github</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update GitHub via API</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">GITHUB_REPO</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GITHUB_REPO&#39;</span><span class="p">)</span>
    <span class="n">GITHUB_BRANCH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GITHUB_BRANCH&#39;</span><span class="p">)</span>
    <span class="n">GITHUB_FILE</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;GITHUB_FILE&#39;</span><span class="p">)</span>

    <span class="c1"># step 1: Get a reference to HEAD</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="s2">&quot;/repos/</span><span class="si">%s</span><span class="s2">/git/refs/heads/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GITHUB_REPO</span><span class="p">,</span> <span class="n">GITHUB_BRANCH</span><span class="p">))</span>
    <span class="n">HEAD</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">],</span>
        <span class="s1">&#39;url&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;object&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="c1"># step 2: Grab the commit that HEAD points to</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
    <span class="c1"># remove what we don&#39;t need for clarity</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sha&#39;</span><span class="p">,</span> <span class="s1">&#39;tree&#39;</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;commit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

    <span class="c1"># step 4: Get a hold of the tree that the commit points to</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;commit&#39;</span><span class="p">][</span><span class="s1">&#39;tree&#39;</span><span class="p">][</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c1"># intermediate step: get the latest content from GitHub and make an updated version</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s1">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">GITHUB_FILE</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span> <span class="c1"># get the blob from the tree</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">])</span>
            <span class="k">break</span>

    <span class="n">old_travis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="n">new_travis</span> <span class="o">=</span> <span class="n">update_travis</span><span class="p">(</span><span class="n">old_travis</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;version&#39;</span><span class="p">))</span>

    <span class="c1"># bail out if nothing changed</span>
    <span class="k">if</span> <span class="n">new_travis</span> <span class="o">==</span> <span class="n">old_travis</span><span class="p">:</span>
        <span class="nb">print</span> <span class="s2">&quot;new == old, bailing out&quot;</span><span class="p">,</span> <span class="n">kwargs</span>
        <span class="k">return</span>

    <span class="c1">####</span>
    <span class="c1">#### WARNING WRITE OPERATIONS BELOW</span>
    <span class="c1">####</span>

    <span class="c1"># step 3: Post your new file to the server</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s2">&quot;/repos/</span><span class="si">%s</span><span class="s2">/git/blobs&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s1">&#39;content&#39;</span> <span class="p">:</span> <span class="n">new_travis</span><span class="p">,</span>
                    <span class="s1">&#39;encoding&#39;</span> <span class="p">:</span> <span class="s1">&#39;utf-8&#39;</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c1"># step 5: Create a tree containing your new file</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s2">&quot;/repos/</span><span class="si">%s</span><span class="s2">/git/trees&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;base_tree&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;tree&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">],</span>
                    <span class="s2">&quot;tree&quot;</span><span class="p">:</span> <span class="p">[{</span>
                        <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">GITHUB_FILE</span><span class="p">,</span>
                        <span class="s2">&quot;mode&quot;</span><span class="p">:</span> <span class="s2">&quot;100644&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;blob&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;sha&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span>
                    <span class="p">}]</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s1">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c1"># step 6: Create a new commit</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s2">&quot;/repos/</span><span class="si">%s</span><span class="s2">/git/commits&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="s2">&quot;New upstream dependency found! Auto update .travis.yml&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;parents&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;commit&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">]],</span>
                    <span class="s2">&quot;tree&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s1">&#39;tree&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s1">&#39;commit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c1"># step 7: Update HEAD, but don&#39;t force it!</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s2">&quot;/repos/</span><span class="si">%s</span><span class="s2">/git/refs/heads/</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GITHUB_REPO</span><span class="p">,</span> <span class="n">GITHUB_BRANCH</span><span class="p">),</span>
                <span class="p">{</span>
                    <span class="s2">&quot;sha&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s1">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s1">&#39;commit&#39;</span><span class="p">][</span><span class="s1">&#39;sha&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">):</span> <span class="c1"># PASS</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span> <span class="c1"># FAIL</span>
        <span class="nb">print</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;message&#39;</span><span class="p">]</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;atodorov-test&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span> <span class="s1">&#39;atodorov/bztest&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s1">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s2">&quot;Markdown&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s1">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span> <span class="s1">&#39;atodorov/Markdown-Bugzilla-Extension&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s1">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span>  <span class="s1">&#39;atodorov/Markdown-No-Lazy-Code-Extension&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s1">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s1">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span>  <span class="s1">&#39;atodorov/Markdown-No-Lazy-BlockQuote-Extension&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s1">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s1">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="c1"># check the RSS to see if we have something new</span>
    <span class="n">monitor_rss</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 02 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/02/automatic-upstream-dependency-testing/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/01/hosting-multiple-python-wsgi-scripts-on-openshift/" rel="bookmark" title="Permalink to Hosting Multiple Python WSGI Scripts on OpenShift">
                <h2 class="post-title">
                    Hosting Multiple Python WSGI Scripts on OpenShift
                </h2>
            </a>
                <p>With <a href="http://openshift.com">OpenShift</a> you can host WSGI Python
applications. By default the Python cartridge comes with a simple WSGI app
and the following directory layout</p>
<div class="highlight"><pre><span></span><code>./
./.openshift/
./requirements.txt
./setup.py
./wsgi.py
</code></pre></div>

<p>I wanted to add my
<a href="http://atodorov.org/blog/2015/11/24/github-bugzilla-hook/">GitHub Bugzilla Hook</a>
in a subdirectory (git submodule actually) and simply reserve a URL which will
be served by this app. My intention is also to add other small scripts to the
same cartridge in order to better utilize the available resources.</p>
<p>Using <code>WSGIScriptAlias</code> inside <code>.htaccess</code> <strong>DOESN'T WORK</strong>! OpenShift errors
out when <code>WSGIScriptAlias</code> is present. I suspect this to be a known limitation
and I have an open support case with Red Hat to confirm this.</p>
<p>My workaround is to configure the URL paths from the <code>wsgi.py</code> file in the root
directory. For example</p>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/wsgi.py b/wsgi.py</span>
<span class="gh">index c443581..20e2bf5 100644</span>
<span class="gd">--- a/wsgi.py</span>
<span class="gi">+++ b/wsgi.py</span>
<span class="gu">@@ -12,7 +12,12 @@ except IOError:</span>
<span class="w"> </span># line, it&#39;s possible required libraries won&#39;t be in your searchable path
<span class="w"> </span>#
<span class="w"> </span>
<span class="gi">+from github_bugzilla_hook import wsgi as ghbzh</span>
<span class="gi">+</span>
<span class="w"> </span>def application(environ, start_response):
<span class="gi">+    # custom paths</span>
<span class="gi">+    if environ[&#39;PATH_INFO&#39;] == &#39;/github-bugzilla-hook/&#39;:</span>
<span class="gi">+        return ghbzh.application(environ, start_response)</span>
<span class="w"> </span>
<span class="w"> </span>    ctype = &#39;text/plain&#39;
<span class="w"> </span>    if environ[&#39;PATH_INFO&#39;] == &#39;/health&#39;:
</code></pre></div>

<p>This does the job and is almost the same as configuring the path in <code>.htaccess</code>.
I hope it helps you!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 01 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/01/hosting-multiple-python-wsgi-scripts-on-openshift/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2013/10/11/this-week-python-chris-dibona-openshift/" rel="bookmark" title="Permalink to This Week: Python Testing, Chris DiBona on Open Source and OpenShift ENV Variables">
                <h2 class="post-title">
                    This Week: Python Testing, Chris DiBona on Open Source and OpenShift ENV Variables
                </h2>
            </a>
                <p>Here is a random collection of links I came across this week which
appear interesting to me but I don't have time to blog about in details.</p>
<h2>Making a Multi-branch Test Server for Python Apps</h2>
<p>If you are wondering how to test different feature branches of your Python
application but don't have the resources to create separate test servers this
is for you: 
<a href="http://depressedoptimism.com/blog/2013/10/8/making-a-multi-branch-test-server">http://depressedoptimism.com/blog/2013/10/8/making-a-multi-branch-test-server</a>!</p>
<p><em>Kudos to the python-django-bulgaria Google group for finding this link!</em></p>
<h2>OpenSource.com Interview with Chris DiBona</h2>
<p>Just read it at
<a href="http://opensource.com/business/13/10/interview-chris-dibona">http://opensource.com/business/13/10/interview-chris-dibona</a>.</p>
<p>I particularly like the part where he called open source "brutal".</p>
<blockquote>
<p>You once called open source “brutal”. What did you mean by that?</p>
<p>...</p>
<p>I think that it is because open source projects are able to only work with the
productive people and ignore everyone else. That behavior can come across as
very harsh or exclusionary, and that's because it is that: brutally harsh and
exclusionary of anyone who isn't contributing.</p>
<p>...</p>
<p>So, I guess what I'm saying is that survival of the fittest as practiced in the
open source world is a pretty brutal mechanism, but it works very very well for
producing quality software. Boy is it hard on newcomers though...</p>
</blockquote>
<h2>OpenShift Finally Introduces Environment Variables</h2>
<p>Yes! Finally! </p>
<div class="highlight"><pre><span></span><code>    rhc set-env VARIABLE1=VALUE1 -a myapp
</code></pre></div>

<p>No need for 
<a href="/blog/2013/07/08/tip-setting-secure-env-variables-on-red-hat-openshift/">my work around</a>
anymore! I will give the new feature a go very soon. </p>
<p>Read more about it at the OpenShift blog:
<a href="https://www.openshift.com/blogs/taking-advantage-of-environment-variables-in-openshift-php-apps">https://www.openshift.com/blogs/taking-advantage-of-environment-variables-in-openshift-php-apps</a>.</p>
<p>Have you found anything interesting this week? Please share in the comments below! Thanks!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Fri 11 October 2013
            </p>
<p>There are <a href="http://atodorov.org/blog/2013/10/11/this-week-python-chris-dibona-openshift/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2013/07/08/tip-setting-secure-env-variables-on-red-hat-openshift/" rel="bookmark" title="Permalink to Tip: Setting Secure ENV variables on Red Hat OpenShift">
                <h2 class="post-title">
                    Tip: Setting Secure ENV variables on Red Hat OpenShift
                </h2>
            </a>
                <p>OpenShift is
<a href="https://www.openshift.com/content/custom-environment-variables">still missing</a>
the client side tools to set environment variables without exposing the values
in source code but there is a way to do it. Here is how.</p>
<p>First ssh into your application and navigate to the <code>$OPENSHIFT_DATA_DIR</code>.
Create a file to define your environment. </p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>rhc<span class="w"> </span>ssh<span class="w"> </span>-a<span class="w"> </span>difio
Password:<span class="w"> </span>***

<span class="o">[</span>difio-otb.rhcloud.com<span class="w"> </span>51d32a854382ecf7a9000116<span class="o">]</span><span class="se">\&gt;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$OPENSHIFT_DATA_DIR</span>
<span class="o">[</span>difio-otb.rhcloud.com<span class="w"> </span>data<span class="o">]</span><span class="se">\&gt;</span><span class="w"> </span>vi<span class="w"> </span>myenv.sh
<span class="o">[</span>difio-otb.rhcloud.com<span class="w"> </span>data<span class="o">]</span><span class="se">\&gt;</span><span class="w"> </span>cat<span class="w"> </span>myenv.sh
<span class="c1">#!/bin/bash</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">MYENV</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span>

<span class="o">[</span>difio-otb.rhcloud.com<span class="w"> </span>data<span class="o">]</span><span class="se">\&gt;</span><span class="w"> </span>chmod<span class="w"> </span>a+x<span class="w"> </span>myenv.sh<span class="w"> </span>
<span class="o">[</span>difio-otb.rhcloud.com<span class="w"> </span>data<span class="o">]</span><span class="se">\&gt;</span><span class="w"> </span><span class="nb">exit</span>
Connection<span class="w"> </span>to<span class="w"> </span>difio-otb.rhcloud.com<span class="w"> </span>closed.
</code></pre></div>

<p>Now modify your code and git push to OpenShift. Then ssh into the app once
again to verify that your configuration is still in place. </p>
<div class="highlight"><pre><span></span><code><span class="o">[</span>atodorov@redbull<span class="w"> </span>difio<span class="o">]</span>$<span class="w"> </span>rhc<span class="w"> </span>ssh<span class="w"> </span>-a<span class="w"> </span>difio
Password:<span class="w"> </span>***

<span class="o">[</span>difio-otb.rhcloud.com<span class="w"> </span>51d32a854382ecf7a9000116<span class="o">]</span><span class="se">\&gt;</span><span class="w"> </span><span class="nb">cd</span><span class="w"> </span><span class="nv">$OPENSHIFT_DATA_DIR</span>
<span class="o">[</span>difio-otb.rhcloud.com<span class="w"> </span>data<span class="o">]</span><span class="se">\&gt;</span><span class="w"> </span>ls<span class="w"> </span>-l
total<span class="w"> </span><span class="m">4</span>
-rwxr-xr-x.<span class="w"> </span><span class="m">1</span><span class="w"> </span>51d32a854382ecf7a9000116<span class="w"> </span>51d32a854382ecf7a9000116<span class="w"> </span><span class="m">34</span><span class="w">  </span><span class="m">8</span><span class="w"> </span>jul<span class="w"> </span><span class="m">14</span>,33<span class="w"> </span>myenv.sh
<span class="o">[</span>difio-otb.rhcloud.com<span class="w"> </span>data<span class="o">]</span><span class="se">\&gt;</span>
</code></pre></div>

<p>Use the defined variables as you wish.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Mon 08 July 2013
            </p>
<p>There are <a href="http://atodorov.org/blog/2013/07/08/tip-setting-secure-env-variables-on-red-hat-openshift/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2013/04/24/how-to-deploy-python-hotfix-on-redhat-openshift-cloud/" rel="bookmark" title="Permalink to How to Deploy Python Hotfix on RedHat OpenShift Cloud">
                <h2 class="post-title">
                    How to Deploy Python Hotfix on RedHat OpenShift Cloud
                </h2>
            </a>
                <p>In this article I will show you how to deploy hotfix versions for
Python packages on the RedHat <a href="http://openshift.com">OpenShift</a> PaaS cloud.</p>
<h2>Background</h2>
<p>You are already running a Python application on your OpenShift instance.
You are using some 3rd party dependencies when you find a bug in one of them.
You go forward, fix the bug and submit a
<a href="https://github.com/ahupp/python-magic/pull/31">pull request</a>.
You don't want to wait for upstream to release a new version but rather
build a hotfix package yourself and deploy to production immediately.</p>
<h2>Solution</h2>
<p>There are two basic approaches to solving this problem: </p>
<ol>
<li>Include the hotfix package source code in your application, i.e.
add it to your git tree or;</li>
<li>Build the hotfix separately and deploy as a dependency. Don't
include it in your git tree, just add a requirement on the hotfix version. </li>
</ol>
<p>I will talk about the later. The tricky part here is to instruct the cloud environment
to use your package (including the proper location) and not upstream or their local
mirror.</p>
<p>Python applications hosted at <a href="http://openshift.com">OpenShift</a> don't support
<code>requirements.txt</code> which can point to various package sources and even install
packages directly from GitHub. They support <code>setup.py</code> which fetches packages
from <a href="http://pypi.python.org">http://pypi.python.org</a> but it is flexible enough to support other locations.</p>
<h2>Building the hotfix</h2>
<p>First of all we'd like to build a hotfix package. This will be the upstream
version that we are currently using plus the patch for our critical issue:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>wget<span class="w"> </span>https://pypi.python.org/packages/source/p/python-magic/python-magic-0.4.3.tar.gz
$<span class="w"> </span>tar<span class="w"> </span>-xzvf<span class="w"> </span>python-magic-0.4.3.tar.gz<span class="w"> </span>
$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>python-magic-0.4.3
$<span class="w"> </span>curl<span class="w"> </span>https://github.com/ahupp/python-magic/pull/31.patch<span class="w"> </span><span class="p">|</span><span class="w"> </span>patch
</code></pre></div>

<p>Verify the patch has been applied correctly and then modify <code>setup.py</code> to
increase the version string. In this case I will set it to <code>version='0.4.3.1'</code>.</p>
<p>Then build the new package using <code>python setup.py sdist</code> and upload it to a web server.</p>
<h2>Deploying to OpenShift</h2>
<p>Modify <code>setup.py</code> and specify the hotfix version. Because this version is not on PyPI
and will not be on OpenShift's local mirror you need to provide the location where it can
be found. This is done with the <code>dependency_links</code> parameter to <code>setup()</code>. Here's how it looks:</p>
<div class="highlight"><pre><span></span><code><span class="gh">diff --git a/setup.py b/setup.py</span>
<span class="gh">index c6e837c..2daa2a9 100644</span>
<span class="gd">--- a/setup.py</span>
<span class="gi">+++ b/setup.py</span>
<span class="gu">@@ -6,5 +6,6 @@ setup(name=&#39;YourAppName&#39;,</span>
<span class="w"> </span>      author=&#39;Your Name&#39;,
<span class="w"> </span>      author_email=&#39;example@example.com&#39;,
<span class="w"> </span>      url=&#39;http://www.python.org/sigs/distutils-sig/&#39;,
<span class="gd">-      install_requires=[&#39;python-magic==0.4.3&#39;],</span>
<span class="gi">+      dependency_links=[&#39;https://s3.amazonaws.com/atodorov/blog/python-magic-0.4.3.1.tar.gz&#39;],</span>
<span class="gi">+      install_requires=[&#39;python-magic==0.4.3.1&#39;],</span>
<span class="w"> </span>     )
</code></pre></div>

<p>Now just git push to OpenShift and observe the console output:</p>
<div class="highlight"><pre><span></span><code><span class="k">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Processing</span><span class="w"> </span><span class="n">dependencies</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">YourAppName</span><span class="o">==</span><span class="mf">1.0</span>
<span class="k">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Searching</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">magic</span><span class="o">==</span><span class="mf">0.4</span><span class="o">.</span><span class="mf">3.1</span>
<span class="k">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Best</span><span class="w"> </span><span class="k">match</span><span class="p">:</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">magic</span><span class="w"> </span><span class="mf">0.4</span><span class="o">.</span><span class="mf">3.1</span>
<span class="k">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Downloading</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">s3</span><span class="o">.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">atodorov</span><span class="o">/</span><span class="n">blog</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">magic</span><span class="o">-</span><span class="mf">0.4</span><span class="o">.</span><span class="mf">3.1</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="k">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Processing</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">magic</span><span class="o">-</span><span class="mf">0.4</span><span class="o">.</span><span class="mf">3.1</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="k">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Running</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">magic</span><span class="o">-</span><span class="mf">0.4</span><span class="o">.</span><span class="mf">3.1</span><span class="o">/</span><span class="n">setup</span><span class="o">.</span><span class="n">py</span><span class="w"> </span><span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="n">bdist_egg</span><span class="w"> </span><span class="o">--</span><span class="n">dist</span><span class="o">-</span><span class="n">dir</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">easy_install</span><span class="o">-</span><span class="n">ZRVMBg</span><span class="o">/</span><span class="n">python</span><span class="o">-</span><span class="n">magic</span><span class="o">-</span><span class="mf">0.4</span><span class="o">.</span><span class="mf">3.1</span><span class="o">/</span><span class="n">egg</span><span class="o">-</span><span class="n">dist</span><span class="o">-</span><span class="n">tmp</span><span class="o">-</span><span class="n">R_Nxie</span>
<span class="k">remote</span><span class="p">:</span><span class="w"> </span><span class="n">zip_safe</span><span class="w"> </span><span class="n">flag</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">set</span><span class="p">;</span><span class="w"> </span><span class="n">analyzing</span><span class="w"> </span><span class="n">archive</span><span class="w"> </span><span class="n">contents</span><span class="o">...</span>
<span class="k">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Removing</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">magic</span><span class="w"> </span><span class="mf">0.4</span><span class="o">.</span><span class="mi">3</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">easy</span><span class="o">-</span><span class="n">install</span><span class="o">.</span><span class="n">pth</span><span class="w"> </span><span class="n">file</span>
<span class="k">remote</span><span class="p">:</span><span class="w"> </span><span class="n">Adding</span><span class="w"> </span><span class="n">python</span><span class="o">-</span><span class="n">magic</span><span class="w"> </span><span class="mf">0.4</span><span class="o">.</span><span class="mf">3.1</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">easy</span><span class="o">-</span><span class="n">install</span><span class="o">.</span><span class="n">pth</span><span class="w"> </span><span class="n">file</span>
</code></pre></div>

<p>Congratulations! Your hotfix package has just been deployed.</p>
<p>This approach should work for other cloud providers and other programming languages
as well. Let me know if you have any experience with that.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 24 April 2013
            </p>
<p>There are <a href="http://atodorov.org/blog/2013/04/24/how-to-deploy-python-hotfix-on-redhat-openshift-cloud/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2013/02/28/email-logging-django-redhat-openshift-amazon-ses/" rel="bookmark" title="Permalink to Email Logging for Django on RedHat OpenShift with Amazon SES">
                <h2 class="post-title">
                    Email Logging for Django on RedHat OpenShift with Amazon SES
                </h2>
            </a>
                <p>Sending email in the cloud can be tricky. IPs of cloud providers are blacklisted
because of frequent abuse. For that reason I use
<a href="http://aws.amazon.com/ses/">Amazon SES</a> as my email backend. Here is how to
configure <a href="https://www.djangoproject.com/">Django</a> to send emails to site admins
when something goes wrong.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Valid addresses only.</span>
<span class="n">ADMINS</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;Alexander Todorov&#39;</span><span class="p">,</span> <span class="s1">&#39;atodorov@example.com&#39;</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">LOGGING</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s1">&#39;disable_existing_loggers&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;mail_admins&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;class&#39;</span><span class="p">:</span> <span class="s1">&#39;django.utils.log.AdminEmailHandler&#39;</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="s1">&#39;loggers&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;django.request&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;mail_admins&#39;</span><span class="p">],</span>
            <span class="s1">&#39;level&#39;</span><span class="p">:</span> <span class="s1">&#39;ERROR&#39;</span><span class="p">,</span>
            <span class="s1">&#39;propagate&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">}</span>
<span class="p">}</span>
 
<span class="c1"># Used as the From: address when reporting errors to admins</span>
<span class="c1"># Needs to be verified in Amazon SES as a valid sender</span>
<span class="n">SERVER_EMAIL</span> <span class="o">=</span> <span class="s1">&#39;django@example.com&#39;</span>

<span class="c1"># Amazon Simple Email Service settings</span>
<span class="n">AWS_SES_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxxxxxx&#39;</span>
<span class="n">AWS_SES_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="s1">&#39;xxxxxxxx&#39;</span>
<span class="n">EMAIL_BACKEND</span> <span class="o">=</span> <span class="s1">&#39;django_ses.SESBackend&#39;</span>
</code></pre></div>

<p>You also need the <a href="https://github.com/hmarr/django-ses">django-ses</a>
dependency.</p>
<p>See <a href="http://docs.djangoproject.com/en/dev/topics/logging">http://docs.djangoproject.com/en/dev/topics/logging</a> for
more details on how to customize your logging configuration.</p>
<p>I am using this configuration successfully at RedHat's OpenShift PaaS environment.
Other users have
<a href="https://openshift.redhat.com/community/forums/express/missing-email-on-500-ise-w-django">reported</a>
it works for them too. Should work with any other PaaS provider.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Thu 28 February 2013
            </p>
<p>There are <a href="http://atodorov.org/blog/2013/02/28/email-logging-django-redhat-openshift-amazon-ses/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2012/04/17/using-openshift-as-amazon-cloudfront-origin-server/" rel="bookmark" title="Permalink to Using OpenShift as Amazon CloudFront Origin Server">
                <h2 class="post-title">
                    Using OpenShift as Amazon CloudFront Origin Server
                </h2>
            </a>
                <p>It's been several months after the start of <a href="http://www.dif.io"><em>Difio</em></a> and I started
migrating various parts of the platform to CDN. The first to go are static files like
CSS, JavaScript, images and such. In this article I will show you how to get started with 
<em>Amazon CloudFront</em> and <em>OpenShift</em>. It is very easy once you understand how it works.</p>
<h2>Why CloudFront and OpenShift</h2>
<p><em>Amazon CloudFront</em> is cheap and easy to setup with virtually no maintenance.
The most important feature is that it can fetch content from any public website.
Integrating it together with <em>OpenShift</em> gives some nice benefits:</p>
<ul>
<li>All static assets are managed with Git and stored in the same place where the application
code and HTML is - easy to develop and deploy;</li>
<li>No need for external service to host the static files;</li>
<li><em>CloudFront</em> will be serving the files so network load on <em>OpenShift</em> is minimal;</li>
<li>Easy to manage versioned URLs because HTML and static assets are in the same repo - more on this later;</li>
</ul>
<h2>Object expiration</h2>
<p><em>CloudFront</em> will cache your objects for a certain period and then expire them. Frequently
used objects are expired less often. Depending on the content you may want to update the cache
more or less frequently. In my case CSS and JavaScript files change rarely so I wanted to tell
CloudFront to not expire the files quickly. I did this by telling <em>Apache</em> to send a custom value for
the Expires header.</p>
<div class="highlight"><pre><span></span><code>    $ curl http://d71ktrt2emu2j.cloudfront.net/static/v1/css/style.css -D headers.txt
    $ cat headers.txt 
    HTTP/1.0 200 OK
    Date: Mon, 16 Apr 2012 19:02:16 GMT
    Server: Apache/2.2.15 (Red Hat)
    Last-Modified: Mon, 16 Apr 2012 19:00:33 GMT
    ETag: &quot;120577-1b2d-4bdd06fc6f640&quot;
    Accept-Ranges: bytes
    Content-Length: 6957
    Cache-Control: max-age=31536000
    Expires: Tue, 16 Apr 2013 19:02:16 GMT
    Content-Type: text/css
    Strict-Transport-Security: max-age=15768000, includeSubDomains
    Age: 73090
    X-Cache: Hit from cloudfront
    X-Amz-Cf-Id: X558vcEOsQkVQn5V9fbrWNTdo543v8VStxdb7LXIcUWAIbLKuIvp-w==,e8Dipk5FSNej3e0Y7c5ro-9mmn7OK8kWfbaRGwi1ww8ihwVzSab24A==
    Via: 1.0 d6343f267c91f2f0e78ef0a7d0b7921d.cloudfront.net (CloudFront)
    Connection: close
</code></pre></div>

<p>All headers before Strict-Transport-Security come from the origin server.</p>
<h2>Versioning</h2>
<p>Sometimes however you need to update the files and force <em>CloudFront</em> to update the content. 
The recommended way to do this is to use URL versioning and update the path to the files
which changed. This will force <em>CloudFront</em> to cache and serve the content under the new path
while keeping the old content available until it expires. This way your visitors will not be
viewing your site with the new CSS and old JavaScript. </p>
<p>There are many ways to do this and there are some nice frameworks as well. For Python there is <em>webassets</em>.
I don't have many static files so I opted for no additional dependencies. Instead I will be updating the
versions by hand.</p>
<p>What comes to mind is using <em>mod_rewrite</em> to redirect the versioned URLs back to non versioned ones.
However there's a catch. If you do this <em>CloudFront</em> will cache the redirect itself, not the content.
The next time visitors hit <em>CloudFront</em> they will receive the cached redirect and follow it back to your
origin server, which is defeating the purpose of having CDN.</p>
<p>To do it properly you have to rewrite the URLs but still return a 200 response code and the
content which needs to be cached. This is done with <em>mod_proxy</em>: </p>
<div class="highlight"><pre><span></span><code>    RewriteEngine on
    RewriteRule ^VERSION-(\d+)/(.*)$ http://%{ENV:OPENSHIFT_INTERNAL_IP}:%{ENV:OPENSHIFT_INTERNAL_PORT}/static/$2 [P,L]
</code></pre></div>

<p>This .htaccess trick doesn't work on <em>OpenShift</em> though. <em>mod_proxy</em> is not enabled at the moment.
See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=812389">bug 812389</a> for more info.</p>
<p>Luckily I was able to use symlinks to point to the content. Here's how it looks:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="err">$</span><span class="w"> </span><span class="nx">pwd</span>
<span class="w">    </span><span class="o">/</span><span class="nx">home</span><span class="o">/</span><span class="nx">atodorov</span><span class="o">/</span><span class="nx">difio</span><span class="o">/</span><span class="nx">wsgi</span><span class="o">/</span><span class="nx">static</span>
<span class="w">    </span>
<span class="w">    </span><span class="err">$</span><span class="w"> </span><span class="nx">cat</span><span class="w"> </span><span class="p">.</span><span class="nx">htaccess</span>
<span class="w">    </span><span class="nx">ExpiresActive</span><span class="w"> </span><span class="nx">On</span>
<span class="w">    </span><span class="nx">ExpiresDefault</span><span class="w"> </span><span class="s">&quot;access plus 1 year&quot;</span>
<span class="w">    </span>
<span class="w">    </span><span class="err">$</span><span class="w"> </span><span class="nx">ls</span><span class="w"> </span><span class="o">-</span><span class="nx">l</span>
<span class="w">    </span><span class="nx">drwxrwxr</span><span class="o">-</span><span class="nx">x</span><span class="p">.</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="nx">atodorov</span><span class="w"> </span><span class="nx">atodorov</span><span class="w"> </span><span class="mi">4096</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="nx">Apr</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="mi">31</span><span class="w"> </span><span class="nx">o</span>
<span class="w">    </span><span class="nx">lrwxrwxrwx</span><span class="p">.</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="nx">atodorov</span><span class="w"> </span><span class="nx">atodorov</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="mi">16</span><span class="w"> </span><span class="nx">Apr</span><span class="w"> </span><span class="mi">21</span><span class="p">,</span><span class="mi">47</span><span class="w"> </span><span class="nx">v1</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">o</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">settings</span><span class="p">.</span><span class="nx">py</span><span class="p">:</span>
<span class="w">    </span><span class="nx">STATIC_URL</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="err">&#39;</span><span class="c1">//d71ktrt2emu2j.cloudfront.net/static/v1/&#39;</span>
<span class="w">    </span>
<span class="w">    </span><span class="nx">HTML</span><span class="w"> </span><span class="nx">template</span><span class="p">:</span>
<span class="w">    </span><span class="p">&lt;</span><span class="nx">link</span><span class="w"> </span><span class="k">type</span><span class="p">=</span><span class="s">&quot;text/css&quot;</span><span class="w"> </span><span class="nx">rel</span><span class="p">=</span><span class="s">&quot;stylesheet&quot;</span><span class="w"> </span><span class="nx">media</span><span class="p">=</span><span class="s">&quot;screen&quot;</span><span class="w"> </span><span class="nx">href</span><span class="p">=</span><span class="s">&quot;{{ STATIC_URL }}css/style.css&quot;</span><span class="w"> </span><span class="o">/</span><span class="p">&gt;</span>
</code></pre></div>

<h2>How to implement it</h2>
<p>First you need to split all CSS and JavaScript from your HTML if you haven't done so already. </p>
<p>Then place everything under your git repo so that <em>OpenShift</em> will serve the files. For Python applications
place the files under wsgi/static/ directory in your git repo.</p>
<p>Point all of your HTML templates to the static location on <em>OpenShift</em> and test if everything works as expected. 
This is best done if you're using some sort of template language and store the location
in a single variable which you can change later.
<em>Difio</em> uses <em>Django</em> and the <em>STATIC_URL</em> variable of course.</p>
<p>Create your <em>CloudFront</em> distribution - don't use <em>Amazon S3</em>, instead configure a custom origin server. Write down
your <em>CloudFront</em> URL. It will be something like <strong>1234xyz.cludfront.net</strong>.</p>
<p>Every time a request hits <em>CloudFront</em> it will check if the object is present in the cache. If not present
<em>CloudFront</em> will fetch the object from the origin server and populate the cache. Then the object is sent
to the user.</p>
<p>Update your templates to point to the new cloudfront.net URL and redeploy your website!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 17 April 2012
            </p>
<p>There are <a href="http://atodorov.org/blog/2012/04/17/using-openshift-as-amazon-cloudfront-origin-server/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2012/03/14/openshift-cron-takes-over-celerybeat/" rel="bookmark" title="Permalink to OpenShift Cron Takes Over Celerybeat">
                <h2 class="post-title">
                    OpenShift Cron Takes Over Celerybeat
                </h2>
            </a>
                <p><a href="http://celeryproject.org/"><em>Celery</em></a> is an asynchronous task queue/job queue
based on distributed message passing. You can define tasks as Python functions,
execute them in the background and in a periodic fashion.
<a href="http://www.dif.io"><em>Difio</em></a> uses <em>Celery</em> for virtually everything.
Some of the tasks are scheduled after some event takes place (like user pressed a button)
or scheduled periodically.</p>
<p><em>Celery</em> provides several components of which <em>celerybeat</em> is the periodic task scheduler.
When combined with <a href="http://djangoproject.com"><em>Django</em></a> it gives you a very nice admin interface
which allows periodic tasks to be added to the scheduler.</p>
<h2>Why change</h2>
<p><em>Difio</em> has relied on <em>celerybeat</em> for a couple of months. Back then, when <em>Difio</em> launched,
there was no cron support for OpenShift so running <em>celerybeat</em> sounded reasonable.
It used to run on a dedicated virtual server and for most of the time that was fine. </p>
<p>There were a number of issues which <em>Difio</em> faced during its first months:</p>
<ul>
<li>
<p><em>celerybeat</em> would sometime die due to no free memory on the virtual instance.
When that happened no new tasks were scheduled and data was left unprocessed.
Let alone that higher memory instance and the processing power which comes with it
cost extra money.</p>
</li>
<li>
<p><em>Difio</em> is split into several components which need to have the same code base
locally - the most important are database settings and the periodic tasks
code. At least in one occasion <em>celerybeat</em> failed to start because of a buggy 
task code. The offending code was fixed in the application server on OpenShift but
not properly synced to the <em>celerybeat</em> instance. Keeping code in sync is a priority
for distributed projects which rely on <em>Celery</em>.</p>
</li>
<li>
<p><em>Celery</em> and <em>django-celery</em> seem to be updated quite often. This poses a significant risk
of ending up with different versions on the scheduler, worker nodes and the app server. This will
bring the whole application to a halt if at some point a backward incompatible change is introduced
and not properly tested and updated. Keeping infrastructure components in sync can be a big challenge
and I try to minimize this effort as much as possible.</p>
</li>
<li>
<p>Having to navigate to the admin pages every time I add a new task or want to change the execution
frequency doesn't feel very natural for a console user like myself and IMHO is less productive.
For the record I primarily use <em>mcedit</em>. I wanted to have something more close to the
write, commit and push work-flow.</p>
</li>
</ul>
<h2>The take over</h2>
<p>It's been some time since OpenShift
<a href="https://www.redhat.com/openshift/community/blogs/getting-started-with-cron-jobs-on-openshift">introduced</a>
the cron cartridge and I decided to give it a try.</p>
<p>The first thing I did is to write a simple script which can execute any task from the difio.tasks module
by piping it to the Django shell (a Python shell actually).</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1">#</span>
<span class="c1"># Copyright (c) 2012, Alexander Todorov &lt;atodorov@nospam.otb.bg&gt;</span>
<span class="c1">#</span>
<span class="c1"># This script is symlinked to from the hourly/minutely, etc. directories</span>
<span class="c1">#</span>
<span class="c1"># SYNOPSIS</span>
<span class="c1">#</span>
<span class="c1"># ./run_celery_task cron_search_dates</span>
<span class="c1">#</span>
<span class="c1"># OR</span>
<span class="c1">#</span>
<span class="c1"># ln -s run_celery_task cron_search_dates</span>
<span class="c1"># ./cron_search_dates</span>
<span class="c1">#</span>

<span class="nv">TASK_NAME</span><span class="o">=</span><span class="nv">$1</span>
<span class="o">[</span><span class="w"> </span>-z<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$TASK_NAME</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nv">TASK_NAME</span><span class="o">=</span><span class="k">$(</span>basename<span class="w"> </span><span class="nv">$0</span><span class="k">)</span>

<span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span>-n<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$OPENSHIFT_APP_DIR</span><span class="s2">&quot;</span><span class="w"> </span><span class="o">]</span><span class="p">;</span><span class="w"> </span><span class="k">then</span>
<span class="w">    </span><span class="nb">source</span><span class="w"> </span><span class="nv">$OPENSHIFT_APP_DIR</span>/virtenv/bin/activate
<span class="w">    </span><span class="nb">export</span><span class="w"> </span><span class="nv">PYTHON_EGG_CACHE</span><span class="o">=</span><span class="nv">$OPENSHIFT_DATA_DIR</span>/.python-eggs
<span class="w">    </span><span class="nv">REPO_DIR</span><span class="o">=</span><span class="nv">$OPENSHIFT_REPO_DIR</span>
<span class="k">else</span>
<span class="w">    </span><span class="nv">REPO_DIR</span><span class="o">=</span><span class="k">$(</span>dirname<span class="w"> </span><span class="nv">$0</span><span class="k">)</span><span class="s2">&quot;/../../..&quot;</span>
<span class="k">fi</span>

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;import difio.tasks; difio.tasks.</span><span class="nv">$TASK_NAME</span><span class="s2">.delay()&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="nv">$REPO_DIR</span>/wsgi/difio/manage.py<span class="w"> </span>shell
</code></pre></div>

<p>This is a multicall script which allows symlinks with different names to point to it. 
Thus to add a new task to cron I just need to make a symlink to the script from one of the
hourly/, minutely/, daily/, etc. directories under cron/.</p>
<p>The script accepts a parameter as well which allows me to execute it locally for debugging purposes
or to schedule some tasks out of band.
This is how it looks like on the file system:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ls<span class="w"> </span>-l<span class="w"> </span>.openshift/cron/hourly/
some_task_name<span class="w"> </span>-&gt;<span class="w"> </span>../tasks/run_celery_task
another_task<span class="w"> </span>-&gt;<span class="w"> </span>../tasks/run_celery_task
</code></pre></div>

<p>After having done these preparations I only had to embed the cron cartridge and git push to OpenShift:</p>
<div class="highlight"><pre><span></span><code>rhc-ctl-app -a difio -e add-cron-1.4 &amp;&amp; git push
</code></pre></div>

<h2>What's next</h2>
<p>At present OpenShift can schedule your jobs every minute, hour, day, week or month and does so using the
<em>run-parts</em> script. You can't schedule a script to execute at 4:30 every Monday or every 45 minutes for example.
See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=803485">rhbz #803485</a> if you want to follow the
progress. Luckily <em>Difio</em> doesn't use this sort of job scheduling for the moment.</p>
<p><em>Difio</em> is scheduling periodic tasks from OpenShift cron for a few days already. 
It seems to work reliably and with no issues. One less component to maintain and worry about.
More time to write code.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 14 March 2012
            </p>
<p>There are <a href="http://atodorov.org/blog/2012/03/14/openshift-cron-takes-over-celerybeat/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2012/03/09/how-to-get-to-the-openshift-shell/" rel="bookmark" title="Permalink to Tip: How to Get to the OpenShift Shell">
                <h2 class="post-title">
                    Tip: How to Get to the OpenShift Shell
                </h2>
            </a>
                <p>I wanted to examine the Perl environment on OpenShift and got tired of making snapshots,
unzipping the archive and poking through the files. I wanted a shell. Here's how to get one.</p>
<ol>
<li>
<p>Get the application info first</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>rhc-domain-info<span class="w"> </span>
Password:<span class="w"> </span>
Application<span class="w"> </span><span class="nv">Info</span>
<span class="o">================</span>
myapp
<span class="w">    </span>Framework:<span class="w"> </span>perl-5.10
<span class="w">     </span>Creation:<span class="w"> </span><span class="m">2012</span>-03-08T13:34:46-04:00
<span class="w">         </span>UUID:<span class="w"> </span>8946b976ad284cf5b2401caf736186bd
<span class="w">      </span>Git<span class="w"> </span>URL:<span class="w"> </span>ssh://8946b976ad284cf5b2401caf736186bd@myapp-mydomain.rhcloud.com/~/git/myapp.git/
<span class="w">   </span>Public<span class="w"> </span>URL:<span class="w"> </span>http://myapp-mydomain.rhcloud.com/

<span class="w"> </span>Embedded:<span class="w"> </span>
<span class="w">      </span>None
</code></pre></div>

</li>
<li>
<p>The Git URL has your username and host</p>
</li>
<li>
<p>Now just ssh into the application</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>ssh<span class="w"> </span>8946b976ad284cf5b2401caf736186bd@myapp-mydomain.rhcloud.com

<span class="w">    </span>Welcome<span class="w"> </span>to<span class="w"> </span>OpenShift<span class="w"> </span>shell

<span class="w">    </span>This<span class="w"> </span>shell<span class="w"> </span>will<span class="w"> </span>assist<span class="w"> </span>you<span class="w"> </span><span class="k">in</span><span class="w"> </span>managing<span class="w"> </span>OpenShift<span class="w"> </span>applications.

<span class="w">    </span>!!!<span class="w"> </span>IMPORTANT<span class="w"> </span>!!!<span class="w"> </span>IMPORTANT<span class="w"> </span>!!!<span class="w"> </span>IMPORTANT<span class="w"> </span>!!!
<span class="w">    </span>Shell<span class="w"> </span>access<span class="w"> </span>is<span class="w"> </span>quite<span class="w"> </span>powerful<span class="w"> </span>and<span class="w"> </span>it<span class="w"> </span>is<span class="w"> </span>possible<span class="w"> </span><span class="k">for</span><span class="w"> </span>you<span class="w"> </span>to
<span class="w">    </span>accidentally<span class="w"> </span>damage<span class="w"> </span>your<span class="w"> </span>application.<span class="w">  </span>Proceed<span class="w"> </span>with<span class="w"> </span>care!
<span class="w">    </span>If<span class="w"> </span>worse<span class="w"> </span>comes<span class="w"> </span>to<span class="w"> </span>worst,<span class="w"> </span>destroy<span class="w"> </span>your<span class="w"> </span>application<span class="w"> </span>with<span class="w"> </span><span class="s1">&#39;rhc app destroy&#39;</span>
<span class="w">    </span>and<span class="w"> </span>recreate<span class="w"> </span>it
<span class="w">    </span>!!!<span class="w"> </span>IMPORTANT<span class="w"> </span>!!!<span class="w"> </span>IMPORTANT<span class="w"> </span>!!!<span class="w"> </span>IMPORTANT<span class="w"> </span>!!!

<span class="w">    </span>Type<span class="w"> </span><span class="s2">&quot;help&quot;</span><span class="w"> </span><span class="k">for</span><span class="w"> </span>more<span class="w"> </span>info.

<span class="o">[</span>myapp-mydomain.rhcloud.com<span class="w"> </span>~<span class="o">]</span><span class="se">\&gt;</span>
</code></pre></div>

</li>
</ol>
<p><strong>Voila!</strong></p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Fri 09 March 2012
            </p>
<p>There are <a href="http://atodorov.org/blog/2012/03/09/how-to-get-to-the-openshift-shell/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2012/02/18/how-to-update-dependencies-on-openshift/" rel="bookmark" title="Permalink to How to Update Dependencies on OpenShift">
                <h2 class="post-title">
                    How to Update Dependencies on OpenShift
                </h2>
            </a>
                <p>If you are already running some cool application on <a href="http://openshift.redhat.com">OpenShift</a>
it could be the case that you have to update some of the packages installed as dependencies.
Here is an example for an application using the python-2.6 cartridge.</p>
<h2>Pull latest upstream packages</h2>
<p>The most simple method is to update everything to the latest upstream versions. </p>
<ol>
<li>
<p>Backup! Backup! Backup!</p>
<div class="highlight"><pre><span></span><code>rhc-snapshot -a mycoolapp
mv mycoolapp.tar.gz mycoolapp-backup-before-update.tar.gz
</code></pre></div>

</li>
<li>
<p>If you haven't specified any particular version in <code>setup.py</code> it will
look like this:</p>
<div class="highlight"><pre><span></span><code><span class="o">...</span>
<span class="n">install_requires</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;difio-openshift-python&#39;</span><span class="p">,</span>
                <span class="s1">&#39;MySQL-python&#39;</span><span class="p">,</span>
                <span class="s1">&#39;Markdown&#39;</span><span class="p">,</span>
               <span class="p">],</span>
<span class="o">...</span>
</code></pre></div>

</li>
<li>
<p>To update simply push to OpenShift instructing it to rebuild your virtualenv:</p>
<div class="highlight"><pre><span></span><code>cd mycoolapp/
touch .openshift/markers/force_clean_build
git add .openshift/markers/force_clean_build
git commit -m &quot;update to latest upstream&quot;
git push
</code></pre></div>

</li>
</ol>
<p>Voila! The environment hosting your application is rebuilt from scratch.</p>
<h2>Keeping some packages unchanged</h2>
<p>Suppose that before the update you have <code>Markdown-2.0.1</code> and you want to keep it!
This is easily solved by adding versioned dependency to <code>setup.py</code></p>
<div class="highlight"><pre><span></span><code><span class="gd">-       &#39;Markdown&#39;,</span>
<span class="gi">+       &#39;Markdown==2.0.1&#39;,</span>
</code></pre></div>

<p>If you do that OpenShift will install the same <code>Markdown</code> version when rebuilding your
application. Everything else will use the latest available versions.</p>
<p><strong>Note:</strong> after the update it's recommended that you remove the 
<code>.openshift/markers/force_clean_build</code> file. This will speed up the push/build process
and will not surprise you with unwanted changes.</p>
<h2>Update only selected packages</h2>
<p>Unless your application is really simple or you have tested the updates, I suspect that
you want to update only selected packages. This can be done without rebuilding the whole
virtualenv. Use versioned dependencies in <code>setup.py</code> :</p>
<div class="highlight"><pre><span></span><code><span class="gd">-       &#39;Markdown==2.0.1&#39;,</span>
<span class="gd">-       &#39;django-countries&#39;,</span>
<span class="gi">+       &#39;Markdown&gt;=2.1&#39;,</span>
<span class="gi">+       &#39;django-countries&gt;=1.1.2&#39;,</span>
</code></pre></div>

<p>No need for <code>force_clean_build</code> this time. Just</p>
<div class="highlight"><pre><span></span><code>    git commit &amp;&amp; git push
</code></pre></div>

<p>At the time of writing my application was using <code>Markdown-2.0.1</code> and <code>django-countries-1.0.5</code>.
Then it updated to <code>Markdown-2.1.1</code> and <code>django-countires-1.1.2</code> which also happened to be
the latest versions.</p>
<p><strong>Note:</strong> this will not work without <code>force_clean_build</code></p>
<div class="highlight"><pre><span></span><code><span class="gd">-       &#39;django-countries==1.0.5&#39;,</span>
<span class="gi">+       &#39;django-countries&#39;,</span>
</code></pre></div>

<h2>Warning</h2>
<p>OpenShift uses a local mirror of <a href="http://pypi.python.org">Python Package Index</a>.
It seems to be updated every 24 hours or so. Have this in mind if you want to update
to a package that was just released. It will not work! See
<a href="/blog/2013/04/24/how-to-deploy-python-hotfix-on-redhat-openshift-cloud/">How to Deploy Python Hotfix on OpenShift</a>
if you wish to work around this limitation.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Sat 18 February 2012
            </p>
<p>There are <a href="http://atodorov.org/blog/2012/02/18/how-to-update-dependencies-on-openshift/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2012/02/10/spinning-up-a-development-instance-on-openshift/" rel="bookmark" title="Permalink to Spinning-up a Development Instance on OpenShift">
                <h2 class="post-title">
                    Spinning-up a Development Instance on OpenShift
                </h2>
            </a>
                <p><a href="http://www.dif.io">Difio</a> is hosted on <a href="http://openshift.redhat.com">OpenShift</a>.
During development I often need to spin-up another copy of Difio to use for testing and development.
With OpenShift this is easy and fast. Here's how:</p>
<ol>
<li>
<p>Create another application on OpenShift. This will be your development instance.</p>
<div class="highlight"><pre><span></span><code>rhc-create-app -a myappdevel -t python-2.6
</code></pre></div>

</li>
<li>
<p>Find out the git URL for the production application:</p>
<div class="highlight"><pre><span></span><code>$<span class="w"> </span>rhc-user-info
Application<span class="w"> </span><span class="nv">Info</span>
<span class="o">================</span>
myapp
<span class="w">    </span>Framework:<span class="w"> </span>python-2.6
<span class="w">     </span>Creation:<span class="w"> </span><span class="m">2012</span>-02-10T12:39:53-05:00
<span class="w">         </span>UUID:<span class="w"> </span>723f0331e17041e8b34228f87a6cf1f5
<span class="w">      </span>Git<span class="w"> </span>URL:<span class="w"> </span>ssh://723f0331e17041e8b34228f87a6cf1f5@myapp-mydomain.rhcloud.com/~/git/myapp.git/
<span class="w">   </span>Public<span class="w"> </span>URL:<span class="w"> </span>http://myapp-mydomain.rhcloud.com/
</code></pre></div>

</li>
<li>
<p>Push the current code base from the production instance to devel instance:</p>
<div class="highlight"><pre><span></span><code><span class="n">cd</span><span class="w"> </span><span class="n">myappdevel</span>
<span class="n">git</span><span class="w"> </span><span class="n">remote</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="n">production</span><span class="w"> </span><span class="o">-</span><span class="n">m</span><span class="w"> </span><span class="n">master</span><span class="w"> </span><span class="nl">ssh</span><span class="p">:</span><span class="o">//</span><span class="mi">723</span><span class="n">f0331e17041e8b34228f87a6cf1f5</span><span class="nv">@myapp</span><span class="o">-</span><span class="n">mydomain</span><span class="p">.</span><span class="n">rhcloud</span><span class="p">.</span><span class="n">com</span><span class="o">/~/</span><span class="n">git</span><span class="o">/</span><span class="n">myapp</span><span class="p">.</span><span class="n">git</span><span class="o">/</span>
<span class="n">git</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="k">recursive</span><span class="w"> </span><span class="o">-</span><span class="n">X</span><span class="w"> </span><span class="n">theirs</span><span class="w"> </span><span class="n">production</span><span class="w"> </span><span class="n">master</span>
<span class="n">git</span><span class="w"> </span><span class="n">push</span>
</code></pre></div>

</li>
<li>
<p>Now your <code>myappdevel</code> is the same as your production instance. You will probably want to
modify your database connection settings at this point and start adding new features.</p>
</li>
</ol>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Fri 10 February 2012
            </p>
<p>There are <a href="http://atodorov.org/blog/2012/02/10/spinning-up-a-development-instance-on-openshift/#disqus_thread">comments</a>.</p>        </div>

    <hr>
    <!-- Pager -->
    <ul class="pager">
        <li class="next">
        </li>
    </ul>
    Page 1 / 1
    <hr>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://twitter.com/atodorov_">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/atodorov">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://bg.linkedin.com/in/alextodorov">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="http://feeds.feedburner.com/atodorov">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.youtube.com/playlist?list=PLFjlI7p-h1hxBP3cIjEqePSeoBDHud5Db">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-youtube fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://amzn.to/4aHmlLD">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-amazon fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="http://mrsenko.com/?utm_source=atodorov.org&utm_medium=blog&utm_campaign=social_icon">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-user-secret fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<section>
    <p>
        I am the project lead for
        <a href="http://kiwitcms.org/?utm_source=atodorov.org&utm_medium=blog&utm_campaign=footer">Kiwi TCMS</a>
        and the current maintainer of <a href="http://MrSenko.com/pylint-workshop/">pylint-django</a>!
    </p>
    <p>
        <small>
            <em>
                Some of the links contained within this site have my referral id (e.g.,
                <a target="_blank" href="http://www.amazon.com/ref=as_li_ss_tl?_encoding=UTF8&camp=1789&creative=390957&linkCode=ur2&tag=atodorovorg-20&linkId=L6Q34XAXQS5RDMOY">Amazon</a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=atodorovorg-20&l=ur2&o=1" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />),
                which provides me with a small commission for each sale. Thank you for your support.
            </em>
        </small>
    </p>
</section>

<form action="http://google.com/search" method="get" style="width:300px;margin:0 auto;">
    <fieldset role="search">
        <input type="hidden" name="sitesearch" value="http://atodorov.org" />
        <input class="search" type="text" name="q" placeholder="Search" style="width:100%"/>
    </fieldset>
</form>

<p class="copyright text-muted">
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">CC-BY-SA</a> &amp;
    <a rel="license" href="http://opensource.org/licenses/MIT">MIT</a>
    2011-2018 &diams; Alexander Todorov
</p>

<script type='text/javascript'>
window.__lo_site_id = 55936;
    (function() {
        var wa = document.createElement('script'); wa.type = 'text/javascript'; wa.async = true;
        wa.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://cdn') + '.luckyorange.com/w.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(wa, s);
      })();
</script>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://atodorov.org/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://atodorov.org/theme/js/bootstrap.min.js"></script>


    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37979549-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'atodorov';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>