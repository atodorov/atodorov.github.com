<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: OpenShift | atodorov.org]]></title>
  <link href="http://atodorov.org/blog/categories/openshift/atom.xml" rel="self"/>
  <link href="http://atodorov.org/"/>
  <updated>2013-10-07T10:36:50+03:00</updated>
  <id>http://atodorov.org/</id>
  <author>
    <name><![CDATA[Alexander Todorov]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Tip: Setting Secure ENV variables on Red Hat OpenShift]]></title>
    <link href="http://atodorov.org/blog/2013/07/08/tip-setting-secure-env-variables-on-red-hat-openshift/"/>
    <updated>2013-07-08T21:39:00+03:00</updated>
    <id>http://atodorov.org/blog/2013/07/08/tip-setting-secure-env-variables-on-red-hat-openshift</id>
    <content type="html"><![CDATA[<p>OpenShift is
<a href="https://www.openshift.com/content/custom-environment-variables">still missing</a>
the client side tools to set environment variables without exposing the values
in source code but there is a way to do it. Here is how.</p>

<p>First ssh into your application and navigate to the <code>$OPENSHIFT_DATA_DIR</code>.
Create a file to define your environment.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">$ </span>rhc ssh -a difio
</span><span class='line'>Password: ***&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">[</span>difio-otb.rhcloud.com 51d32a854382ecf7a9000116<span class="o">]</span>&gt; <span class="nb">cd</span> <span class="nv">$OPENSHIFT_DATA_DIR</span>
</span><span class='line'><span class="o">[</span>difio-otb.rhcloud.com data<span class="o">]</span>&gt; vi myenv.sh
</span><span class='line'><span class="o">[</span>difio-otb.rhcloud.com data<span class="o">]</span>&gt; cat myenv.sh&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;!/bin/bash&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;export <span class="nv">MYENV</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">[</span>difio-otb.rhcloud.com data<span class="o">]</span>&gt; chmod a+x myenv.sh
</span><span class='line'><span class="o">[</span>difio-otb.rhcloud.com data<span class="o">]</span>&gt; <span class="nb">exit</span>
</span><span class='line'>Connection to difio-otb.rhcloud.com closed.
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Now modify your code and git push to OpenShift. Then ssh into the app once
again to verify that your configuration is still in place.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>atodorov@redbull difio<span class="o">]</span><span class="nv">$ </span>rhc ssh -a difio
</span><span class='line'>Password: ***&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">[</span>difio-otb.rhcloud.com 51d32a854382ecf7a9000116<span class="o">]</span>&gt; <span class="nb">cd</span> <span class="nv">$OPENSHIFT_DATA_DIR</span>
</span><span class='line'><span class="o">[</span>difio-otb.rhcloud.com data<span class="o">]</span>&gt; ls -l
</span><span class='line'>total 4
</span><span class='line'>-rwxr-xr-x. 1 51d32a854382ecf7a9000116 51d32a854382ecf7a9000116 34  8 jul 14,33 myenv.sh
</span><span class='line'><span class="o">[</span>difio-otb.rhcloud.com data<span class="o">]</span>&gt;&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>Use the defined variables as you wish.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to Deploy Python Hotfix on RedHat OpenShift Cloud]]></title>
    <link href="http://atodorov.org/blog/2013/04/24/how-to-deploy-python-hotfix-on-redhat-openshift-cloud/"/>
    <updated>2013-04-24T11:58:00+03:00</updated>
    <id>http://atodorov.org/blog/2013/04/24/how-to-deploy-python-hotfix-on-redhat-openshift-cloud</id>
    <content type="html"><![CDATA[<p>In this article I will show you how to deploy hotfix versions for
Python packages on the RedHat <a href="http://openshift.com">OpenShift</a> PaaS cloud.</p>

<h2>Background</h2>

<p>You are already running a Python application on your OpenShift instance.
You are using some 3rd party dependencies when you find a bug in one of them.
You go forward, fix the bug and submit a
<a href="https://github.com/ahupp/python-magic/pull/31">pull request</a>.
You don't want to wait for upstream to release a new version but rather
build a hotfix package yourself and deploy to production immediately.</p>

<h2>Solution</h2>

<p>There are two basic approaches to solving this problem:</p>

<ol>
<li>Include the hotfix package source code in your application, i.e.
add it to your git tree or;</li>
<li>Build the hotfix separately and deploy as a dependency. Don't
include it in your git tree, just add a requirement on the hotfix version.</li>
</ol>


<p>I will talk about the later. The tricky part here is to instruct the cloud environment
to use your package (including the proper location) and not upstream or their local
mirror.</p>

<p>Python applications hosted at <a href="http://openshift.com">OpenShift</a> don't support
<code>requirements.txt</code> which can point to various package sources and even install
packages directly from GitHub. They support <code>setup.py</code> which fetches packages
from <a href="http://pypi.python.org">http://pypi.python.org</a> but it is flexible enough to support other locations.</p>

<h2>Building the hotfix</h2>

<p>First of all we'd like to build a hotfix package. This will be the upstream
version that we are currently using plus the patch for our critical issue:</p>

<pre><code>$ wget https://pypi.python.org/packages/source/p/python-magic/python-magic-0.4.3.tar.gz
$ tar -xzvf python-magic-0.4.3.tar.gz 
$ cd python-magic-0.4.3
$ curl https://github.com/ahupp/python-magic/pull/31.patch | patch 
</code></pre>

<p>Verify the patch has been applied correctly and then modify <code>setup.py</code> to
increase the version string. In this case I will set it to <code>version='0.4.3.1'</code>.</p>

<p>Then build the new package using <code>python setup.py sdist</code> and upload it to a web server.</p>

<h2>Deploying to OpenShift</h2>

<p>Modify <code>setup.py</code> and specify the hotfix version. Because this version is not on PyPI
and will not be on OpenShift's local mirror you need to provide the location where it can
be found. This is done with the <code>dependency_links</code> parameter to <code>setup()</code>. Here's how it looks:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='diff'><span class='line'><span class="gh">diff --git a/setup.py b/setup.py</span>
</span><span class='line'><span class="gh">index c6e837c..2daa2a9 100644</span>
</span><span class='line'><span class="gd">--- a/setup.py</span>
</span><span class='line'><span class="gi">+++ b/setup.py</span>
</span><span class='line'><span class="gu">@@ -6,5 +6,6 @@ setup(name=&#39;YourAppName&#39;,&lt;/p&gt;</span>
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;   author=&#39;Your Name&#39;,
</span><span class='line'>   author_email=&#39;example@example.com&#39;,
</span><span class='line'>   url=&#39;http://www.python.org/sigs/distutils-sig/&#39;,
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;ul&gt;
</span><span class='line'>&lt;li&gt;   install_requires=[&#39;python-magic==0.4.3&#39;],&lt;/li&gt;
</span><span class='line'>&lt;li&gt;   dependency_links=[&#39;https://s3.amazonaws.com/atodorov/blog/python-magic-0.4.3.1.tar.gz&#39;],&lt;/li&gt;
</span><span class='line'>&lt;li&gt;   install_requires=[&#39;python-magic==0.4.3.1&#39;],
</span><span class='line'>  )
</span></code></pre></td></tr></table></div></figure></notextile></div></li>
</ul>


<p>Now just git push to OpenShift and observe the console output:</p>

<pre><code>remote: Processing dependencies for YourAppName==1.0
remote: Searching for python-magic==0.4.3.1
remote: Best match: python-magic 0.4.3.1
remote: Downloading https://s3.amazonaws.com/atodorov/blog/python-magic-0.4.3.1.tar.gz
remote: Processing python-magic-0.4.3.1.tar.gz
remote: Running python-magic-0.4.3.1/setup.py -q bdist_egg --dist-dir /tmp/easy_install-ZRVMBg/python-magic-0.4.3.1/egg-dist-tmp-R_Nxie
remote: zip_safe flag not set; analyzing archive contents...
remote: Removing python-magic 0.4.3 from easy-install.pth file
remote: Adding python-magic 0.4.3.1 to easy-install.pth file
</code></pre>

<p>Congratulations! Your hotfix package has just been deployed.</p>

<p>This approach should work for other cloud providers and other programming languages
as well. Let me know if you have any experience with that.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Email Logging for Django on RedHat OpenShift with Amazon SES]]></title>
    <link href="http://atodorov.org/blog/2013/02/28/email-logging-django-redhat-openshift-amazon-ses/"/>
    <updated>2013-02-28T23:19:00+02:00</updated>
    <id>http://atodorov.org/blog/2013/02/28/email-logging-django-redhat-openshift-amazon-ses</id>
    <content type="html"><![CDATA[<p>Sending email in the cloud can be tricky. IPs of cloud providers are blacklisted
because of frequent abuse. For that reason I use
<a href="http://aws.amazon.com/ses/">Amazon SES</a> as my email backend. Here is how to
configure <a href="https://www.djangoproject.com/">Django</a> to send emails to site admins
when something goes wrong.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>settings.py  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Valid</span> <span class="n">addresses</span> <span class="n">only</span><span class="o">.&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">ADMINS</span> <span class="o">=</span> <span class="p">(</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&#39;Alexander Todorov&#39;</span><span class="p">,</span> <span class="s">&#39;atodorov@example.com&#39;</span><span class="p">),</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">)</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">LOGGING</span> <span class="o">=</span> <span class="p">{</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">pre</span><span class="o">&gt;&lt;</span><span class="n">code</span><span class="o">&gt;</span><span class="s">&#39;version&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'><span class="s">&#39;disable_existing_loggers&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
</span><span class='line'><span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&#39;mail_admins&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;ERROR&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;class&#39;</span><span class="p">:</span> <span class="s">&#39;django.utils.log.AdminEmailHandler&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">},</span>
</span><span class='line'><span class="s">&#39;loggers&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&#39;django.request&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>        <span class="s">&#39;handlers&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s">&#39;mail_admins&#39;</span><span class="p">],</span>
</span><span class='line'>        <span class="s">&#39;level&#39;</span><span class="p">:</span> <span class="s">&#39;ERROR&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s">&#39;propagate&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="o">&lt;/</span><span class="n">code</span><span class="o">&gt;&lt;/</span><span class="n">pre</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Used</span> <span class="k">as</span> <span class="n">the</span> <span class="n">From</span><span class="p">:</span> <span class="n">address</span> <span class="n">when</span> <span class="n">reporting</span> <span class="n">errors</span> <span class="n">to</span> <span class="n">admins</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Needs</span> <span class="n">to</span> <span class="n">be</span> <span class="n">verified</span> <span class="ow">in</span> <span class="n">Amazon</span> <span class="n">SES</span> <span class="k">as</span> <span class="n">a</span> <span class="n">valid</span> <span class="n">sender</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">SERVER_EMAIL</span> <span class="o">=</span> <span class="s">&#39;django@example.com&#39;</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">Amazon</span> <span class="n">Simple</span> <span class="n">Email</span> <span class="n">Service</span> <span class="n">settings</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">AWS_SES_ACCESS_KEY_ID</span> <span class="o">=</span> <span class="s">&#39;xxxxxxxxxxxx&#39;</span>
</span><span class='line'><span class="n">AWS_SES_SECRET_ACCESS_KEY</span> <span class="o">=</span> <span class="s">&#39;xxxxxxxx&#39;</span>
</span><span class='line'><span class="n">EMAIL_BACKEND</span> <span class="o">=</span> <span class="s">&#39;django_ses.SESBackend&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>You also need the <a href="https://github.com/hmarr/django-ses">django-ses</a>
dependency.</p>

<p>See <a href="http://docs.djangoproject.com/en/dev/topics/logging">http://docs.djangoproject.com/en/dev/topics/logging</a> for
more details on how to customize your logging configuration.</p>

<p>I am using this configuration successfully at RedHat's OpenShift PaaS environment.
Other users have
<a href="https://openshift.redhat.com/community/forums/express/missing-email-on-500-ise-w-django">reported</a>
it works for them too. Should work with any other PaaS provider.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using OpenShift as Amazon CloudFront Origin Server]]></title>
    <link href="http://atodorov.org/blog/2012/04/17/using-openshift-as-amazon-cloudfront-origin-server/"/>
    <updated>2012-04-17T17:30:00+03:00</updated>
    <id>http://atodorov.org/blog/2012/04/17/using-openshift-as-amazon-cloudfront-origin-server</id>
    <content type="html"><![CDATA[<p>It's been several months after the start of <a href="http://www.dif.io"><em>Difio</em></a> and I started
migrating various parts of the platform to CDN. The first to go are static files like
CSS, JavaScript, images and such. In this article I will show you how to get started with
<em>Amazon CloudFront</em> and <em>OpenShift</em>. It is very easy once you understand how it works.</p>

<h2>Why CloudFront and OpenShift</h2>

<p><em>Amazon CloudFront</em> is cheap and easy to setup with virtually no maintenance.
The most important feature is that it can fetch content from any public website.
Integrating it together with <em>OpenShift</em> gives some nice benefits:</p>

<ul>
<li>All static assets are managed with Git and stored in the same place where the application
code and HTML is - easy to develop and deploy;</li>
<li>No need for external service to host the static files;</li>
<li><em>CloudFront</em> will be serving the files so network load on <em>OpenShift</em> is minimal;</li>
<li>Easy to manage versioned URLs because HTML and static assets are in the same repo - more on this later;</li>
</ul>


<h2>Object expiration</h2>

<p><em>CloudFront</em> will cache your objects for a certain period and then expire them. Frequently
used objects are expired less often. Depending on the content you may want to update the cache
more or less frequently. In my case CSS and JavaScript files change rarely so I wanted to tell
CloudFront to not expire the files quickly. I did this by telling <em>Apache</em> to send a custom value for
the Expires header.</p>

<pre><code>    $ curl http://d71ktrt2emu2j.cloudfront.net/static/v1/css/style.css -D headers.txt
    $ cat headers.txt 
    HTTP/1.0 200 OK
    Date: Mon, 16 Apr 2012 19:02:16 GMT
    Server: Apache/2.2.15 (Red Hat)
    Last-Modified: Mon, 16 Apr 2012 19:00:33 GMT
    ETag: "120577-1b2d-4bdd06fc6f640"
    Accept-Ranges: bytes
    Content-Length: 6957
    Cache-Control: max-age=31536000
    Expires: Tue, 16 Apr 2013 19:02:16 GMT
    Content-Type: text/css
    Strict-Transport-Security: max-age=15768000, includeSubDomains
    Age: 73090
    X-Cache: Hit from cloudfront
    X-Amz-Cf-Id: X558vcEOsQkVQn5V9fbrWNTdo543v8VStxdb7LXIcUWAIbLKuIvp-w==,e8Dipk5FSNej3e0Y7c5ro-9mmn7OK8kWfbaRGwi1ww8ihwVzSab24A==
    Via: 1.0 d6343f267c91f2f0e78ef0a7d0b7921d.cloudfront.net (CloudFront)
    Connection: close
</code></pre>

<p>All headers before Strict-Transport-Security come from the origin server.</p>

<h2>Versioning</h2>

<p>Sometimes however you need to update the files and force <em>CloudFront</em> to update the content.
The recommended way to do this is to use URL versioning and update the path to the files
which changed. This will force <em>CloudFront</em> to cache and serve the content under the new path
while keeping the old content available until it expires. This way your visitors will not be
viewing your site with the new CSS and old JavaScript.</p>

<p>There are many ways to do this and there are some nice frameworks as well. For Python there is <em>webassets</em>.
I don't have many static files so I opted for no additional dependencies. Instead I will be updating the
versions by hand.</p>

<p>What comes to mind is using <em>mod_rewrite</em> to redirect the versioned URLs back to non versioned ones.
However there's a catch. If you do this <em>CloudFront</em> will cache the redirect itself, not the content.
The next time visitors hit <em>CloudFront</em> they will receive the cached redirect and follow it back to your
origin server, which is defeating the purpose of having CDN.</p>

<p>To do it properly you have to rewrite the URLs but still return a 200 response code and the
content which needs to be cached. This is done with <em>mod_proxy</em>:</p>

<pre><code>    RewriteEngine on
    RewriteRule ^VERSION-(\d+)/(.*)$ http://%{ENV:OPENSHIFT_INTERNAL_IP}:%{ENV:OPENSHIFT_INTERNAL_PORT}/static/$2 [P,L]
</code></pre>

<p>This .htaccess trick doesn't work on <em>OpenShift</em> though. <em>mod_proxy</em> is not enabled at the moment.
See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=812389">bug 812389</a> for more info.</p>

<p>Luckily I was able to use symlinks to point to the content. Here's how it looks:</p>

<pre><code>    $ pwd
    /home/atodorov/difio/wsgi/static

    $ cat .htaccess
    ExpiresActive On
    ExpiresDefault "access plus 1 year"

    $ ls -l
    drwxrwxr-x. 6 atodorov atodorov 4096 16 Apr 21,31 o
    lrwxrwxrwx. 1 atodorov atodorov    1 16 Apr 21,47 v1 -&gt; o

    settings.py:
    STATIC_URL = '//d71ktrt2emu2j.cloudfront.net/static/v1/'

    HTML template:
    &lt;link type="text/css" rel="stylesheet" media="screen" href="{{ STATIC_URL }}css/style.css" /&gt;
</code></pre>

<h2>How to implement it</h2>

<p>First you need to split all CSS and JavaScript from your HTML if you haven't done so already.</p>

<p>Then place everything under your git repo so that <em>OpenShift</em> will serve the files. For Python applications
place the files under wsgi/static/ directory in your git repo.</p>

<p>Point all of your HTML templates to the static location on <em>OpenShift</em> and test if everything works as expected.
This is best done if you're using some sort of template language and store the location
in a single variable which you can change later.
<em>Difio</em> uses <em>Django</em> and the <em>STATIC_URL</em> variable of course.</p>

<p>Create your <em>CloudFront</em> distribution - don't use <em>Amazon S3</em>, instead configure a custom origin server. Write down
your <em>CloudFront</em> URL. It will be something like <strong>1234xyz.cludfront.net</strong>.</p>

<p>Every time a request hits <em>CloudFront</em> it will check if the object is present in the cache. If not present
<em>CloudFront</em> will fetch the object from the origin server and populate the cache. Then the object is sent
to the user.</p>

<p>Update your templates to point to the new cloudfront.net URL and redeploy your website!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[OpenShift Cron Takes Over Celerybeat]]></title>
    <link href="http://atodorov.org/blog/2012/03/14/openshift-cron-takes-over-celerybeat/"/>
    <updated>2012-03-14T20:48:00+02:00</updated>
    <id>http://atodorov.org/blog/2012/03/14/openshift-cron-takes-over-celerybeat</id>
    <content type="html"><![CDATA[<p><a href="http://celeryproject.org/"><em>Celery</em></a> is an asynchronous task queue/job queue
based on distributed message passing. You can define tasks as Python functions,
execute them in the background and in a periodic fashion.
<a href="http://www.dif.io"><em>Difio</em></a> uses <em>Celery</em> for virtually everything.
Some of the tasks are scheduled after some event takes place (like user pressed a button)
or scheduled periodically.</p>

<p><em>Celery</em> provides several components of which <em>celerybeat</em> is the periodic task scheduler.
When combined with <a href="http://djangoproject.com"><em>Django</em></a> it gives you a very nice admin interface
which allows periodic tasks to be added to the scheduler.</p>

<h2>Why change</h2>

<p><em>Difio</em> has relied on <em>celerybeat</em> for a couple of months. Back then, when <em>Difio</em> launched,
there was no cron support for OpenShift so running <em>celerybeat</em> sounded reasonable.
It used to run on a dedicated virtual server and for most of the time that was fine.</p>

<p>There were a number of issues which <em>Difio</em> faced during its first months:</p>

<ul>
<li><p><em>celerybeat</em> would sometime die due to no free memory on the virtual instance.
When that happened no new tasks were scheduled and data was left unprocessed.
Let alone that higher memory instance and the processing power which comes with it
cost extra money.</p></li>
<li><p><em>Difio</em> is split into several components which need to have the same code base
locally - the most important are database settings and the periodic tasks
code. At least in one occasion <em>celerybeat</em> failed to start because of a buggy
task code. The offending code was fixed in the application server on OpenShift but
not properly synced to the <em>celerybeat</em> instance. Keeping code in sync is a priority
for distributed projects which rely on <em>Celery</em>.</p></li>
<li><p><em>Celery</em> and <em>django-celery</em> seem to be updated quite often. This poses a significant risk
of ending up with different versions on the scheduler, worker nodes and the app server. This will
bring the whole application to a halt if at some point a backward incompatible change is introduced
and not properly tested and updated. Keeping infrastructure components in sync can be a big challenge
and I try to minimize this effort as much as possible.</p></li>
<li><p>Having to navigate to the admin pages every time I add a new task or want to change the execution
frequency doesn't feel very natural for a console user like myself and IMHO is less productive.
For the record I primarily use <em>mcedit</em>. I wanted to have something more close to the
write, commit and push work-flow.</p></li>
</ul>


<h2>The take over</h2>

<p>It's been some time since OpenShift
<a href="https://www.redhat.com/openshift/community/blogs/getting-started-with-cron-jobs-on-openshift">introduced</a>
the cron cartridge and I decided to give it a try.</p>

<p>The first thing I did is to write a simple script which can execute any task from the difio.tasks module
by piping it to the Django shell (a Python shell actually).</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>run_celery_task </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;!/bin/bash&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;#&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;Copyright <span class="o">(</span>c<span class="o">)</span> 2012, Alexander Todorov &lt;a <span class="nv">href</span><span class="o">=</span><span class="s2">&quot;&amp;#109;&amp;#97;&amp;#x69;&amp;#108;&amp;#116;&amp;#x6f;&amp;#x3a;&amp;#x61;&amp;#116;&amp;#x6f;&amp;#100;&amp;#x6f;&amp;#114;&amp;#111;&amp;#x76;&amp;#64;&amp;#110;&amp;#x6f;&amp;#x73;&amp;#112;&amp;#97;&amp;#109;&amp;#x2e;&amp;#111;&amp;#x74;&amp;#x62;&amp;#x2e;&amp;#98;&amp;#x67;&quot;</span>&gt;&amp;#x61;&amp;#116;&amp;#x6f;&amp;#100;&amp;#x6f;&amp;#114;&amp;#111;&amp;#118;&amp;#x40;&amp;#110;&amp;#111;&amp;#115;&amp;#112;&amp;#x61;&amp;#109;&amp;#x2e;&amp;#x6f;&amp;#x74;&amp;#x62;&amp;#46;&amp;#98;&amp;#x67;&lt;/a&gt;&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;#&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;This script is symlinked to from the hourly/minutely, etc. directories&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;#&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;SYNOPSIS&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;#&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;./run_celery_task cron_search_dates&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;#&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;OR&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;#&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;ln -s run_celery_task cron_search_dates&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;./cron_search_dates&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;#&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;TASK_NAME<span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="o">[</span> -z <span class="s2">&quot;$TASK_NAME&quot;</span> <span class="o">]</span> &amp;amp;&amp;amp; <span class="nv">TASK_NAME</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$0</span><span class="k">)</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;if <span class="o">[</span> -n <span class="s2">&quot;$OPENSHIFT_APP_DIR&quot;</span> <span class="o">]</span>; <span class="k">then</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;source <span class="nv">$OPENSHIFT_APP_DIR</span>/virtenv/bin/activate
</span><span class='line'><span class="nb">export </span><span class="nv">PYTHON_EGG_CACHE</span><span class="o">=</span><span class="nv">$OPENSHIFT_DATA_DIR</span>/.python-eggs
</span><span class='line'><span class="nv">REPO_DIR</span><span class="o">=</span><span class="nv">$OPENSHIFT_REPO_DIR</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;else&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;REPO_DIR<span class="o">=</span><span class="k">$(</span>dirname <span class="nv">$0</span><span class="k">)</span><span class="s2">&quot;/../../..&quot;</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;fi&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;echo <span class="s2">&quot;import difio.tasks; difio.tasks.$TASK_NAME.delay()&quot;</span> | <span class="nv">$REPO_DIR</span>/wsgi/difio/manage.py shell
</span></code></pre></td></tr></table></div></figure></notextile></div></p>

<p>This is a multicall script which allows symlinks with different names to point to it.
Thus to add a new task to cron I just need to make a symlink to the script from one of the
hourly/, minutely/, daily/, etc. directories under cron/.</p>

<p>The script accepts a parameter as well which allows me to execute it locally for debugging purposes
or to schedule some tasks out of band.
This is how it looks like on the file system:</p>

<pre><code>$ ls -l .openshift/cron/hourly/
some_task_name -&gt; ../tasks/run_celery_task
another_task -&gt; ../tasks/run_celery_task
</code></pre>

<p>After having done these preparations I only had to embed the cron cartridge and git push to OpenShift:</p>

<pre><code>rhc-ctl-app -a difio -e add-cron-1.4 &amp;&amp; git push
</code></pre>

<h2>What's next</h2>

<p>At present OpenShift can schedule your jobs every minute, hour, day, week or month and does so using the
<em>run-parts</em> script. You can't schedule a script to execute at 4:30 every Monday or every 45 minutes for example.
See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=803485">rhbz #803485</a> if you want to follow the
progress. Luckily <em>Difio</em> doesn't use this sort of job scheduling for the moment.</p>

<p><em>Difio</em> is scheduling periodic tasks from OpenShift cron for a few days already.
It seems to work reliably and with no issues. One less component to maintain and worry about.
More time to write code.</p>
]]></content>
  </entry>
  
</feed>
