<!DOCTYPE html>
<html lang="en">

<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

            <meta name="google-site-verification" content="XynqZtldWNBbmsynVQZremIxaaO8Wgs6AGR8UZ7KIkM">

        <title>atodorov.org - Articles in the _posts category</title>

        <link href="http://feeds.feedburner.com/atodorov" type="application/atom+xml" rel="alternate" title="atodorov.org Full Atom Feed" />
        <!-- Bootstrap Core CSS -->
        <link href="http://atodorov.org/theme/css/bootstrap.min.css" rel="stylesheet">

        <!-- Custom CSS -->
        <link href="http://atodorov.org/theme/css/clean-blog.min.css" rel="stylesheet">

        <!-- Code highlight color scheme -->
            <link href="http://atodorov.org/theme/css/code_blocks/github.css" rel="stylesheet">

            <!-- CSS specified by the user -->
            <link href="http://atodorov.org/override.css" rel="stylesheet">

        <!-- Custom Fonts -->
        <link href="http://atodorov.org/theme/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

                <meta property="fb:admins" content="1616937247" >
                <meta property="og:locale" content="en_US">
		<meta property="og:site_name" content="atodorov.org">
            <meta name="twitter:card" content="summary_large_image">
            <meta name="twitter:site" content="@atodorov_">
            <meta name="twitter:title" content="atodorov.org">
            <meta name="twitter:description" content="you can logoff, but you can never leave">
                <meta name="twitter:image" content="http://atodorov.org//images/header_02.jpg">
</head>

<body>

    <!-- Navigation -->
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="http://atodorov.org/">atodorov.org</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                        <li><a href="http://mrsenko.com/?utm_source=atodorov.org&utm_medium=blog&utm_campaign=menu">Mr. Senko</a></li>

                </ul>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <!-- Page Header -->
        <header class="intro-header" style="background-image: url('/images/header_02.jpg')">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Articles in the _posts category</h1>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2016/01/15/tesla-needs-more-qa/" rel="bookmark" title="Permalink to Tesla Needs More QA">
                <h2 class="post-title">
                    Tesla Needs More QA
                </h2>
            </a>
                <p><img alt="Tesla email" src="/images/tesla_qa_bug.png" title="Tesla email" /></p>
<p>A nice way for Tesla Motors to tell me they won't consider my interest in their
QA positions - by sending me an email with a bug! It only goes to show that
everything coming out of an IT system needs to be tested.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Fri 15 January 2016
            </p>
<p>There are <a href="http://atodorov.org/blog/2016/01/15/tesla-needs-more-qa/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2016/01/14/controlling-interactive-terminal-programs/" rel="bookmark" title="Permalink to Controlling Interactive Terminal Programs">
                <h2 class="post-title">
                    Controlling Interactive Terminal Programs
                </h2>
            </a>
                <p>Building on my previous experience about
<a href="http://atodorov.org/blog/2015/12/25/capture-terminal-output-from-other-processes/">capturing terminal output from other processes</a>
I wanted to create an automated test case for the initial-setup-text service
which would control <code>stdin</code>. Something like
<a href="https://fedorahosted.org/dogtail/">Dogtail</a> but for text mode applications.</p>
<p>What you have to do is attach <code>gdb</code> to the process. Then you can <code>write</code> to
any file descriptor that is already opened. <strong>WARNING:</strong> writing directly to
stdin didn't quite work! Because (I assume) stdin is a tty the text was shown on
the console but the return character wasn't interpreted and the application wasn't
accepting the input string. What I had to do is replace the tty with a pipe and
it worked. However the input is not duplicated on the console this way!</p>
<p>Another drawback is that I couldn't use <code>strace</code> to log the output in combination
with <code>gdb</code>. Once a process is under trace you can't trace it a second time! For this
simple test I was able to live with this by not inspecting the actual text printed
by initial-setup. Instead I'm validating the state of the system after setup is
complete. I've tried to <code>read</code> from <code>stdout</code> in gdb but that didn't work either.
If there's a way to make this happen I can convert this script to a mini-framework.</p>
<p>Another unknown is interacting with <code>passwd</code>. Probably for security reasons
it doesn't allow to mess around with its stdin but I didn't investigate deeper.</p>
<p>I've used the
<a href="https://github.com/ticpu/tools/blob/master/fdmanage.py">fdmanage.py</a>
script which does most of the work for me. I've removed the extra bits
that I didn't need, added the <code>write()</code> method and removed the original call to
<code>fcntl</code> which puts gdb.stdout into non-blocking mode (that didn't work for me).</p>
<div class="highlight"><span class="filename">initial_setup_driver.py</span><pre><span class="c">#!/usr/bin/env python</span>
<span class="c"># -*- coding: utf-8 -*-</span>
<span class="c">#</span>
<span class="c"># fdmanage.py is a program to manage file descriptors of running programs</span>
<span class="c"># by using GDB to modify the running program.</span>
<span class="c"># https://github.com/ticpu/tools/blob/master/fdmanage.py</span>
<span class="c"># Copyright (C) 2015 Jérôme Poulin &lt;jeromepoulin@gmail.com&gt;</span>
<span class="c">#</span>
<span class="c"># This program is free software: you can redistribute it and/or modify</span>
<span class="c"># it under the terms of the GNU General Public License as published by</span>
<span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
<span class="c"># (at your option) any later version.</span>
<span class="c">#</span>
<span class="c"># This program is distributed in the hope that it will be useful,</span>
<span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c"># GNU General Public License for more details.</span>
<span class="c">#</span>
<span class="c"># You should have received a copy of the GNU General Public License</span>
<span class="c"># along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<span class="c">#</span>
<span class="c"># Copyright (c) 2016 Alexander Todorov &lt;atodorov@redhat.com&gt;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">unicode_literals</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">select</span>
<span class="kn">import</span> <span class="nn">subprocess</span>


<span class="k">class</span> <span class="nc">Gdb</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">pid</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gdb</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="p">[</span><span class="s">&quot;gdb&quot;</span><span class="p">,</span> <span class="s">&quot;-q&quot;</span><span class="p">,</span> <span class="s">&quot;-p&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">],</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
            <span class="n">close_fds</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">del</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s">&quot;detach&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s">&quot;quit&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gdb</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gdb</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gdb</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">Program terminated.&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gdb</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">command</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gdb</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">send_command_expect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gdb</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;utf8&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
                <span class="k">if</span> <span class="s">&quot; = &quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="n">select</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">gdb</span><span class="o">.</span><span class="n">stdout</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="mf">0.1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">close_fd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s">&quot;call close(</span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="nb">int</span><span class="p">(</span><span class="n">fd</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">dup2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_fd</span><span class="p">,</span> <span class="n">new_fd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s">&quot;call dup2(</span><span class="si">%d</span><span class="s">, </span><span class="si">%d</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">old_fd</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_fd</span><span class="p">)))</span>

    <span class="k">def</span> <span class="nf">open_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="mi">66</span><span class="p">):</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">send_command_expect</span><span class="p">(</span><span class="s">&#39;call open(&quot;</span><span class="si">%s</span><span class="s">&quot;, </span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">fd</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">txt</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s">&#39;call write(</span><span class="si">%d</span><span class="s">, &quot;</span><span class="si">%s</span><span class="s">&quot;, </span><span class="si">%d</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">txt</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="kn">import</span> <span class="nn">tempfile</span>

    <span class="c"># these are specific to initial-setup-text</span>
    <span class="n">steps</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&quot;1</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">,</span> <span class="c"># License information</span>
        <span class="s">&quot;2</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">,</span> <span class="c"># Accept license</span>
        <span class="s">&quot;c</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">,</span> <span class="c"># Continue back to the main hub</span>

        <span class="s">&quot;3</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">,</span>  <span class="c"># Timezone settings</span>
        <span class="s">&quot;8</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">,</span>  <span class="c"># Europe</span>
        <span class="s">&quot;43</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">,</span> <span class="c"># Sofia</span>

<span class="c"># passwd doesn&#39;t allow us to overwrite its file descriptors</span>
<span class="c"># either aborts or simply doesn&#39;t work</span>
<span class="c">#        &quot;4\\n&quot;,      # Root password</span>
<span class="c">#        &quot;redhat\\n&quot;,</span>
<span class="c">#        &quot;redhat\\n&quot;,</span>
<span class="c">#        &quot;no\\n&quot;,     # password is weak</span>
<span class="c">#        &quot;123\\n&quot;,</span>
<span class="c">#        &quot;123\\n&quot;,</span>
<span class="c">#        &quot;no\\n&quot;,     # password is too short</span>
<span class="c">#        &quot;Th1s-Is-a-Str0ng-Password!\\n&quot;,</span>
<span class="c">#        &quot;Th1s-Is-a-Str0ng-Password!\\n&quot;,</span>

        <span class="s">&quot;c</span><span class="se">\\</span><span class="s">n&quot;</span><span class="p">,</span> <span class="c"># Continue to exit</span>
    <span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;USAGE: </span><span class="si">%s</span><span class="s"> &lt;PID&gt;&quot;</span> <span class="o">%</span> <span class="n">__file__</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">tmp_dir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>
    <span class="n">pipe</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">,</span> <span class="s">&quot;pipe&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">mkfifo</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">Gdb</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">gdb</span><span class="p">:</span>
        <span class="n">fd</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">open_file</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c"># O_RDWR</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c"># replace STDIN with a PIPE</span>
        <span class="n">gdb</span><span class="o">.</span><span class="n">close_fd</span><span class="p">(</span><span class="n">fd</span><span class="p">)</span>

        <span class="c"># set a breakpoint before continuing</span>
        <span class="n">break_point_num</span> <span class="o">=</span> <span class="n">gdb</span><span class="o">.</span><span class="n">send_command_expect</span><span class="p">(</span><span class="s">&quot;break read&quot;</span><span class="p">)</span>

        <span class="c"># now execute the process step-by-step</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">len_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">steps</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">txt</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
            <span class="n">gdb</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">txt</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">len_steps</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">gdb</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s">&quot;delete </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">break_point_num</span><span class="p">)</span>
            <span class="n">gdb</span><span class="o">.</span><span class="n">send_command</span><span class="p">(</span><span class="s">&quot;continue&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c"># clean up</span>
    <span class="n">os</span><span class="o">.</span><span class="n">unlink</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="n">tmp_dir</span><span class="p">)</span>
</pre></div>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Thu 14 January 2016
            </p>
<p>There are <a href="http://atodorov.org/blog/2016/01/14/controlling-interactive-terminal-programs/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/25/capture-terminal-output-from-other-processes/" rel="bookmark" title="Permalink to Capture Terminal Output From Other Processes">
                <h2 class="post-title">
                    Capture Terminal Output From Other Processes
                </h2>
            </a>
                <p>I've been working on a test case to verify that Anaconda will print its EULA
notice at the end of a text mode installation. The problem is how do you capture
all the text which is printed to the terminal from processes outside your control ?
The answer is surprisingly simple - using strace! </p>
<div class="highlight"><pre><span class="nf">%post</span> <span class="o">--</span><span class="n">nochroot</span>
<span class="n">PID</span><span class="o">=</span><span class="err">`</span><span class="n">ps</span> <span class="n">aux</span> <span class="o">|</span> <span class="n">grep</span> <span class="s">&quot;/usr/bin/python /sbin/anaconda&quot;</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="s">&quot;grep&quot;</span> <span class="o">|</span> <span class="n">tr</span> <span class="o">-</span><span class="n">s</span> <span class="sc">&#39; &#39;</span> <span class="o">|</span> <span class="n">cut</span> <span class="o">-</span><span class="n">f2</span> <span class="o">-</span><span class="n">d</span><span class="sc">&#39; &#39;</span><span class="err">`</span>
<span class="n">STRACE_LOG</span><span class="o">=</span><span class="s">&quot;/mnt/sysimage/root/anaconda.strace&quot;</span>

<span class="cp"># see https:</span><span class="c1">//fedoraproject.org/wiki/Features/SELinuxDenyPtrace</span>
<span class="n">setsebool</span> <span class="n">deny_ptrace</span> <span class="mi">0</span>

<span class="cp"># EULA notice is printed after post-scripts are run</span>
<span class="n">strace</span> <span class="o">-</span><span class="n">e</span> <span class="n">read</span><span class="p">,</span><span class="n">write</span> <span class="o">-</span><span class="n">s16384</span> <span class="o">-</span><span class="n">q</span> <span class="o">-</span><span class="n">x</span> <span class="o">-</span><span class="n">o</span> <span class="n">$STRACE_LOG</span> <span class="o">-</span><span class="n">p</span> <span class="n">$PID</span> <span class="o">-</span><span class="n">f</span> <span class="o">&gt;/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">&amp;</span>
</pre></div>


<p>strace is tracing only read and write events (we really only need write) and
extending the maximum string size printed in the log file. For a simple grep
this is sufficient. If you need to pretty-print the strace output have a look
at the <a href="http://search.cpan.org/~bbb/ttylog/ttylog">ttylog</a> utility.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Fri 25 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/25/capture-terminal-output-from-other-processes/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/23/insert-key-on-macbook-keyboard/" rel="bookmark" title="Permalink to Insert Key on MacBook Keyboard">
                <h2 class="post-title">
                    Insert Key on MacBook Keyboard
                </h2>
            </a>
                <p>For some reason my terminal doesn't always accept Ctrl+V for paste. Instead
it needs the Shift+Ins key combo. On the <a class="wikilink" href="http://amzn.to/1RdviyD">MacBook Air</a> keyboard the Ins key
is simulated by pressing Fn+Return together. So the paste combo becomes
Shift+Fn+Return!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 23 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/23/insert-key-on-macbook-keyboard/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/23/interesting-ruby-resources/" rel="bookmark" title="Permalink to Interesting Ruby Resources">
                <h2 class="post-title">
                    Interesting Ruby Resources
                </h2>
            </a>
                <p>During my quest for
<a href="http://atodorov.org/blog/2015/12/23/speeding-up-rspec-and-postgresql-tests/">faster RSpec tests</a>
I've come across several interesting posts about Ruby. Being new to the language
they've helped me understand a bit more about the internals. Posting them here
so they don't get lost.</p>
<h2>Garbage Collection</h2>
<p><a href="https://signalvnoise.com/posts/2742-the-road-to-faster-tests">The road to faster tests</a>
- a story about tests and garbage collection.</p>
<p><a href="http://labs.clio.com/tuning-ruby-garbage-collection-for-rspec/">Tuning Ruby garbage collection for RSpec</a>
- practical explanation of Ruby's garbage collector and how to adjust its
performance for RSpec</p>
<p><a href="http://samsaffron.com/archive/2013/11/22/demystifying-the-ruby-gc">Demystifying the Ruby GC</a></p>
<p>Probably the very first posts I found referencing slow RSpec tests. It turned out
this was not the issue but I've nevertheless tried running GC manually. I can clearly
see (using <code>puts GC.count</code> in after()) GC invoked less frequently, memory usage rising
but the overall execution time wasn't affected. The profiler said 2% speed increase
to be honest.</p>
<h2>Profiling</h2>
<p>Not being very clear about the different profiling tools available and how to
interpret their results I've found these articles:</p>
<p><a href="https://www.igvita.com/2009/06/13/profiling-ruby-with-googles-perftools/">Profiling Ruby With Google's Perftools</a>
- practical example for using perftools.rb</p>
<p><a href="http://stackoverflow.com/questions/32212970/how-to-read-ruby-profilers-output">How to read ruby profiler's output</a> -
also see the <a href="http://ruby-doc.org/stdlib-2.1.0/libdoc/profiler/rdoc/Profiler__.html">Profiler__ module</a></p>
<p><a href="http://stackoverflow.com/questions/4856500/show-runtime-for-each-rspec-example">Show runtime for each rspec example</a>
- using <code>rspec --profile</code></p>
<h2>Suggestions for Faster Tests</h2>
<p>Several general best practices for faster tests:</p>
<p><a href="https://www.netguru.co/blog/9-ways-to-speed-up-your-rspec-tests">9 ways to speed up your RSpec tests</a></p>
<p><a href="https://infinum.co/the-capsized-eight/articles/run-faster-ruby-on-rails-tests">Run faster Ruby on Rails tests</a></p>
<p><a href="http://blog.plataformatec.com.br/2011/12/three-tips-to-improve-the-performance-of-your-test-suite/">Three tips to improve the performance of your test suite</a></p>
<h2>RubyGems related</h2>
<p>I've noticed Bundler loading tons of requirements (nearly 3000 unique modules)
and for some particular specs this wasn't necessary (for example running Rubocop).
I've found the following articles below which sound very reasonable to me:</p>
<p><a href="http://anti-pattern.com/use-bundler-setup-instead-of-bundler-require">Use Bundler.setup Instead of Bundler.require</a></p>
<p><a href="http://myronmars.to/n/dev-blog/2012/12/5-reasons-to-avoid-bundler-require">5 Reasons to Avoid Bundler.require</a></p>
<p><a href="http://2ndscale.com/rtomayko/2009/require-rubygems-antipattern">Why "require 'rubygems'" Is Wrong</a></p>
<h2>Weird</h2>
<p>Finally (or more precisely first of all) I've seen this
<a href="https://www.ruby-forum.com/topic/184516 suggests broken rubygems">Weird performance issue</a>.</p>
<p>During my initial profiling I've seen (and still see) a similar issue.
When calling require it goes through lots of hoops before finally loading
the module. My profiling results show this taking a lot of time but this time
is likely measured with profiling enabled and doesn't represent the real deal.</p>
<p>On my
<a href="http://atodorov.org/blog/2015/04/26/installing-red-hat-enterprise-linux-7-on-macbook-air-2015/">MacBook Air with Red Hat Enterprise Linux 7</a>
this happens when using Ruby 2.2.2 from Software Collections. If using Ruby
installed from source with rbenv the profiling profile is completely different.</p>
<p>I will be examining this one in more details. I'm interested to know what is
the difference and if that affects performance somehow so stay tuned!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 23 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/23/interesting-ruby-resources/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/23/speeding-up-rspec-and-postgresql-tests/" rel="bookmark" title="Permalink to Speeding up RSpec and PostgreSQL tests">
                <h2 class="post-title">
                    Speeding up RSpec and PostgreSQL tests
                </h2>
            </a>
                <p>I've been working with <a class="wikilink" href="http://tradeo.com">Tradeo</a> on testing one of their applications. The app
is standard Ruby on Rails application with over 1200 tests written with RSpec.
And they were horribly slow. On my <a class="wikilink" href="http://amzn.to/1RdviyD">MacBook Air</a> the entire test suite
took 27 minutes to execute. On the Jenkins slaves it took over an hour.
After a few changes Jenkins now takes 15 minutes to execute the test suite.
Locally it takes around 11 minutes!</p>
<h2>The Problem</h2>
<p>I've measured the speed (with Time.now) at which individual examples execute
and it was quickly apparent they were taking a lot of time cleaning the DB. The
offending code in question was:</p>
<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">clean_with</span> <span class="ss">:truncation</span>
<span class="k">end</span>
</pre></div>


<p>This is truncating the tables quite often but it turns out this is a very
expensive operation on tables with small number of records. I've measured it
locally around 2.5 seconds. Check out this
<a href="http://stackoverflow.com/questions/11419536/postgresql-truncation-speed/">SO thread</a>
which describes pretty much the same symptoms:</p>
<div class="highlight"><pre>Right now, locally (on a Macbook Air) a full test suite takes 28 minutes....
Tailing the logs on our CI server (Ubuntu 10.04 LTS) .... a build takes 84 minutes.
</pre></div>


<p>This
<a href="http://stackoverflow.com/questions/11419536/postgresql-truncation-speed/11423886#11423886">excellent answer</a>
explains why this is happening:</p>
<div class="highlight"><pre>(a) The bigger shared_buffers may be why TRUNCATE is slower on the CI server.
    Different fsync configuration or the use of rotational media instead of
    SSDs could also be at fault.

(b) TRUNCATE has a fixed cost, but not necessarily slower than DELETE,
    plus it does more work.
</pre></div>


<h2>The Fix</h2>
<div class="highlight"><pre><span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:suite</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">clean_with</span> <span class="ss">:truncation</span>
<span class="k">end</span>

<span class="n">config</span><span class="o">.</span><span class="n">before</span><span class="p">(</span><span class="ss">:all</span><span class="p">)</span> <span class="k">do</span>
  <span class="no">DatabaseCleaner</span><span class="o">.</span><span class="n">clean_with</span> <span class="ss">:deletion</span>
<span class="k">end</span>
</pre></div>


<p><code>before(:suite)</code> will truncate tables every time we run rspec, which is when we
launch the entire test suite. This is to account for the possible side effects
of DELETE in the future (see the SO thread). Then <code>before(:all)</code> aka
<code>before(:context)</code> simply deletes the records which is significantly faster!</p>
<p>Also updated the CI servers <code>postgresql.conf</code> to</p>
<div class="highlight"><pre>fsync=off
full_page_writes=off
</pre></div>


<p>The entire build/test process now takes only 15 minutes! Only one test broke
due to PostgreSQL returning records in a different order, but it's the test
case fault not handling this in the first place!</p>
<p><strong>NOTE:</strong> Using fsync=off with rotational media pretty much hides any improvements
introduced by updating the DatabaseCleaner strategy.</p>
<h2>What's Next</h2>
<p>There are several other things worth trying:</p>
<ul>
<li>Use UNIX domain sockets instead of TCP/IP (localhost) to connect to PostgreSQL;</li>
<li>Load the entire
<a href="http://magazine.redhat.com/2007/12/12/tip-from-an-rhce-memory-storage-on-postgresql/">PostgreSQL partition in memory</a>;</li>
<li>Don't delete anything from the database, except once in <code>before(:suite)</code>.
If any tests need a particular DB state they have to set this up on their own
instead of relying on a global cleanup process. I expect this to break quite
a few examples.</li>
</ul>
<p>After the changes and with my crude measurements I have individual examples
taking 0.31 seconds to execute. Interestingly before and after take less than
a second while the example code takes around 0.15 seconds. I have no idea where
the rest 0.15 seconds are spent. My current speculation is probably RSpec.
This is 50% of the execution time and is also worth looking into!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 23 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/23/speeding-up-rspec-and-postgresql-tests/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/17/logging-vm-installation-to-stdout/" rel="bookmark" title="Permalink to Logging VM installation to stdout">
                <h2 class="post-title">
                    Logging VM installation to stdout
                </h2>
            </a>
                <p>Recently I've been using virt-install to create virtual machines inside some
automated tests and then ssh'ing to the VM guest and inspecting the results.
What's been bothering me is that while the VM is installing I can't see what's
going on. The solution is to log everything to stdout which is then collected
by my test harness and archived on the file server. To do this</p>
<div class="highlight"><pre>setenforce 0
virt-install ... -x &quot;console=ttyS0&quot; --serial dev,path=/dev/pts/1
</pre></div>


<p>This puts SELinux into Permissive mode, instructs the VM guest to use a serial
console and then redirects the serial console to stdout on the host. If you have
SELinux in Enforcing mode then you get the following error:</p>
<div class="highlight"><pre>unable to set security context &#39;system_u:object_r:svirt_image_t:s0:c43,c440&#39; on &#39;/dev/pts/1&#39;: Permission denied
</pre></div>


<p><strong>NOTE:</strong> if you execute this from a script and there is no controlly tty it will
fail. The next best thing you can do is log to a file with
<code>--serial file,path=guest.log</code> and collect this file for later!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Thu 17 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/17/logging-vm-installation-to-stdout/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/17/facebook-is-bugging-me/" rel="bookmark" title="Permalink to Facebook is Bugging me">
                <h2 class="post-title">
                    Facebook is Bugging me
                </h2>
            </a>
                <p><img alt="Facebook icon" src="/images/facebook_android_icon_small.png" title="Facebook icon" /></p>
<p>Facebook for Android version 55.0.0.18.66 broke the home screen icon title.
It reads <code>false</code> instead of <code>Facebook</code>. This is now fixed in version 58.0.0.28.70.
I wonder how they managed to get this slip through. Also isn't Google
supposed to review the apps coming into the Play Store and not publish them
if there are such visible issues ? I guess this wasn't the case here.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Thu 17 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/17/facebook-is-bugging-me/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/16/virtio-vs-rtl8139/" rel="bookmark" title="Permalink to virtio vs. rtl8139">
                <h2 class="post-title">
                    virtio vs. rtl8139
                </h2>
            </a>
                <p>I've been doing some tests with KVM virtual machines and been launching them
with virt-install. For some reason the VM wasn't activating its NIC.
Changing the interface model from virtio to rtl8139 made it work again:</p>
<div class="highlight"><pre>         virt-install --name $VM_NAME --ram 1024 --os-type=linux --os-variant=rhel7 \
<span class="gd">-                    --disk none --network bridge=virbr0,model=virtio,mac=$VM_MAC \</span>
<span class="gi">+                    --disk none --network bridge=virbr0,model=rtl8139,mac=$VM_MAC \</span>
                     --noreboot --graphics vnc \
                     --cdrom /var/tmp/tmp*/images/boot.iso --boot cdrom &amp;
</pre></div>


<p>virt-install(1) says:</p>
<div class="highlight"><pre>model
    Network device model as seen by the guest. Value can be any nic model supported by the hypervisor, e.g.: &#39;e1000&#39;,
    &#39;rtl8139&#39;, &#39;virtio&#39;, ...
</pre></div>


<p>I'm not clear if this configures what drivers to be used for the NIC inside the
guest or what is the driver of the host NIC. At this moment I don't know why
changing the value causes networking in the guest to fail. If you do know please
comment below. Thanks!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 16 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/16/virtio-vs-rtl8139/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/02/automatic-upstream-dependency-testing/" rel="bookmark" title="Permalink to Automatic Upstream Dependency Testing">
                <h2 class="post-title">
                    Automatic Upstream Dependency Testing
                </h2>
            </a>
                <p>Ever since
<a href="http://atodorov.org/blog/2015/11/24/python-libs-in-rhel-7.2-broke-ssl-verification-in-s3cmd/">RHEL 7.2 python-libs broke s3cmd</a>
I've been pondering an age old problem: <em>How do I know if my software works with the
latest upstream dependencies ? How can I pro-actively monitor for new versions
and add them to my test matrix ?</em></p>
<p>Mixing together my previous experience with
<a href="http://atodorov.org/blog/2014/05/06/opensource-dot-com-article-10-steps-to-migrate-your-closed-software-to-open-source/">Difio</a>
and monitoring upstream sources,
and <a href="https://twitter.com/ForbesLindesay">Forbes Lindesay's</a> <em>GitHub Automation</em> talk
at <a href="http://atodorov.org/blog/2015/05/22/devit-conf-2015-impressions/">DEVit Conf</a> I came
together with a plan:</p>
<ul>
<li>Make an application which will execute when new upstream version is available;</li>
<li><a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/">Automatically update <code>.travis.yml</code></a>
for the projects I'm interested in;</li>
<li>Let Travis-CI execute my test suite for all available upstream versions;</li>
<li>Profit!</li>
</ul>
<h2>How Does It Work</h2>
<p>First we need to monitor upstream! RubyGems.org has nice
<a href="http://guides.rubygems.org/rubygems-org-api/#webhook-methods">webhooks interface</a>,
you can even trigger on individual packages. PyPI however doesn't have anything
like this :(. My solution is to run a cron job every hour and parse their RSS
stream for newly released packages. This has been working previously for Difio
so I re-used one function from the code.</p>
<p>After finding anything we're interested in comes the hard part - automatically
updating <code>.travis.yml</code> using the GitHub API. I've described this in more detail
<a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/">here</a>. This time
I've slightly modified the code to update only when needed and accept more
parameters so it can be reused.</p>
<p>Travis-CI has a clean interface to specify environment variables and
<a href="https://docs.travis-ci.com/user/environment-variables/#Defining-Multiple-Variables-per-Item">defining several</a>
of them crates a test matrix. This is exactly what I'm doing.
<code>.travis.yml</code> is updated with a new ENV setting, which determines the upstream
package version. After commit new build is triggered which includes the expanded
test matrix.</p>
<h2>Example</h2>
<p><img alt="Travis-CI build log" src="http://atodorov.org/images/travisci_matrix.png" title="Travis-CI build log" /></p>
<p>Imagine that our <em>Project 2501</em> depends on FOO version <em>0.3.1</em>. The
<a href="https://travis-ci.org/atodorov/bztest/builds">build log</a> illustrates what
happened:</p>
<ul>
<li>Build #9 is what we've tested with <em>FOO-0.3.1</em> and released to production.
Test result is PASS!</li>
<li>Build #10 - meanwhile upstream releases <em>FOO-0.3.2</em> which causes our project
to break. We're not aware of this and continue developing new features
while all test results still PASS! When our customers upgrade their systems
<em>Project 2501</em> will break ! Tests didn't catch it because test matrix wasn't
updated. Please
ignore the actual commit message in the example! I've used the same repository
for the dummy dependency package.</li>
<li>Build #11 - the monitoring solution finds <em>FOO-0.3.2</em> and updates the test
matrix automatically. The build immediately breaks! More precisely the
<a href="https://travis-ci.org/atodorov/bztest/builds/94263181">test with version <em>0.3.2</em> fails</a>!</li>
<li>Build #12 - we've alerted FOO.org about their problem and they've released
<em>FOO-0.3.3</em>. Our monitor has found that and updated the test matrix.
However <a href="https://travis-ci.org/atodorov/bztest/builds/94270592">the 0.3.2 test job still fails</a>!</li>
<li>Build #13 - we decide to workaround the 0.3.2 failure or simply handle the
error gracefully. In this example I've removed version 0.3.2 from the test
matrix to simulate that. In reality I wouldn't touch <code>.travis.yml</code> but instead
update my application and tests to check for that particular version.
All test results are PASS again!</li>
</ul>
<p>Btw Build #11 above was triggered manually (./monitor.py) while Build #12
came from OpenShit, my hosting environment.</p>
<p>At present I have this monitoring enabled for my
<a href="http://atodorov.org/blog/2015/11/26/3-new-python-markdown-extensions/">new Markdown extensions</a>
and will also add it to <a href="https://github.com/atodorov/django-s3-cache">django-s3-cache</a>
once it migrates to Travis-CI (it uses drone.io now).</p>
<h2>Enough Talk, Show me the Code</h2>
<div class="highlight"><span class="filename">monitor.py</span><pre><span class="c">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">base64</span>
<span class="kn">import</span> <span class="nn">httplib</span>
<span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">xml.dom.minidom</span> <span class="kn">import</span> <span class="n">parseString</span>

<span class="k">def</span> <span class="nf">get_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">post_data</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
    <span class="c"># GitHub requires a valid UA string</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;User-Agent&#39;</span> <span class="p">:</span> <span class="s">&#39;Mozilla/5.0 (X11; Linux x86_64; rv:10.0.5) Gecko/20120601 Firefox/10.0.5&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c"># shortcut for GitHub API calls</span>
    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;://&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s">&quot;https://api.github.com</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">url</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;api.github.com&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;GITHUB_TOKEN&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;Set the GITHUB_TOKEN variable&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">headers</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s">&#39;Authorization&#39;</span><span class="p">:</span> <span class="s">&#39;token </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;GITHUB_TOKEN&#39;</span><span class="p">]</span>
            <span class="p">})</span>

    <span class="p">(</span><span class="n">proto</span><span class="p">,</span> <span class="n">host_path</span><span class="p">)</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;//&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">host_port</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span> <span class="o">=</span> <span class="n">host_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">path</span>

    <span class="k">if</span> <span class="n">url</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;https&#39;</span><span class="p">):</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPSConnection</span><span class="p">(</span><span class="n">host_port</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="n">host_port</span><span class="p">)</span>


    <span class="n">method</span> <span class="o">=</span> <span class="s">&#39;GET&#39;</span>
    <span class="k">if</span> <span class="n">post_data</span><span class="p">:</span>
        <span class="n">method</span> <span class="o">=</span> <span class="s">&#39;POST&#39;</span>
        <span class="n">post_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">post_data</span><span class="p">)</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="n">post_data</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">404</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;404 - </span><span class="si">%s</span><span class="s"> not found&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;UTF-8&#39;</span><span class="p">,</span> <span class="s">&#39;replace&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="c"># not a JSON response</span>
        <span class="k">return</span> <span class="n">result</span>

<span class="k">def</span> <span class="nf">post_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">get_url</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">monitor_rss</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Scan the PyPI RSS feeds to look for new packages.</span>
<span class="sd">        If name is found in config then execute the specified callback.</span>

<span class="sd">        @config is a dict with keys matching package names and values</span>
<span class="sd">        are lists of dicts</span>
<span class="sd">            {</span>
<span class="sd">                &#39;cb&#39; : a_callback,</span>
<span class="sd">                &#39;args&#39; : dict</span>
<span class="sd">            }</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rss</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="s">&quot;https://pypi.python.org/pypi?:action=rss&quot;</span><span class="p">)</span>
    <span class="n">dom</span> <span class="o">=</span> <span class="n">parseString</span><span class="p">(</span><span class="n">rss</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">dom</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&quot;item&quot;</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&quot;title&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pub_date</span> <span class="o">=</span> <span class="n">item</span><span class="o">.</span><span class="n">getElementsByTagName</span><span class="p">(</span><span class="s">&quot;pubDate&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span> <span class="o">=</span> <span class="n">title</span><span class="o">.</span><span class="n">firstChild</span><span class="o">.</span><span class="n">wholeText</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
            <span class="n">released_on</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">pub_date</span><span class="o">.</span><span class="n">firstChild</span><span class="o">.</span><span class="n">wholeText</span><span class="p">,</span> <span class="s">&#39;</span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S GMT&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="k">print</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="s">&quot;found in config&quot;</span>
                <span class="k">for</span> <span class="n">cfg</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="n">name</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">args</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;args&#39;</span><span class="p">]</span>
                        <span class="n">args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                            <span class="s">&#39;name&#39;</span> <span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                            <span class="s">&#39;version&#39;</span> <span class="p">:</span> <span class="n">version</span><span class="p">,</span>
                            <span class="s">&#39;released_on&#39;</span> <span class="p">:</span> <span class="n">released_on</span>
                        <span class="p">})</span>

                        <span class="c"># execute the call back</span>
                        <span class="n">cfg</span><span class="p">[</span><span class="s">&#39;cb&#39;</span><span class="p">](</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">print</span> <span class="n">e</span>
                        <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span> <span class="n">e</span>
            <span class="k">continue</span>

<span class="k">def</span> <span class="nf">update_travis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">new_version</span><span class="p">):</span>
    <span class="n">travis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="n">new_ver_line</span> <span class="o">=</span> <span class="s">&quot;  - VERSION=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">new_version</span>
    <span class="k">if</span> <span class="n">travis</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">new_ver_line</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">travis</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">new_ver_line</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">return</span> <span class="n">travis</span>


<span class="k">def</span> <span class="nf">update_github</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update GitHub via API</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">GITHUB_REPO</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;GITHUB_REPO&#39;</span><span class="p">)</span>
    <span class="n">GITHUB_BRANCH</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;GITHUB_BRANCH&#39;</span><span class="p">)</span>
    <span class="n">GITHUB_FILE</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;GITHUB_FILE&#39;</span><span class="p">)</span>

    <span class="c"># step 1: Get a reference to HEAD</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="s">&quot;/repos/</span><span class="si">%s</span><span class="s">/git/refs/heads/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GITHUB_REPO</span><span class="p">,</span> <span class="n">GITHUB_BRANCH</span><span class="p">))</span>
    <span class="n">HEAD</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">],</span>
        <span class="s">&#39;url&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;object&#39;</span><span class="p">][</span><span class="s">&#39;url&#39;</span><span class="p">],</span>
    <span class="p">}</span>

    <span class="c"># step 2: Grab the commit that HEAD points to</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">])</span>
    <span class="c"># remove what we don&#39;t need for clarity</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;sha&#39;</span><span class="p">,</span> <span class="s">&#39;tree&#39;</span><span class="p">]:</span>
            <span class="k">del</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;commit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>

    <span class="c"># step 4: Get a hold of the tree that the commit points to</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;commit&#39;</span><span class="p">][</span><span class="s">&#39;tree&#39;</span><span class="p">][</span><span class="s">&#39;url&#39;</span><span class="p">])</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c"># intermediate step: get the latest content from GitHub and make an updated version</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;tree&#39;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">obj</span><span class="p">[</span><span class="s">&#39;path&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">GITHUB_FILE</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">get_url</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="s">&#39;url&#39;</span><span class="p">])</span> <span class="c"># get the blob from the tree</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s">&#39;content&#39;</span><span class="p">])</span>
            <span class="k">break</span>

    <span class="n">old_travis</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="n">new_travis</span> <span class="o">=</span> <span class="n">update_travis</span><span class="p">(</span><span class="n">old_travis</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;version&#39;</span><span class="p">))</span>

    <span class="c"># bail out if nothing changed</span>
    <span class="k">if</span> <span class="n">new_travis</span> <span class="o">==</span> <span class="n">old_travis</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;new == old, bailing out&quot;</span><span class="p">,</span> <span class="n">kwargs</span>
        <span class="k">return</span>

    <span class="c">####</span>
    <span class="c">#### WARNING WRITE OPERATIONS BELOW</span>
    <span class="c">####</span>

    <span class="c"># step 3: Post your new file to the server</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s">&quot;/repos/</span><span class="si">%s</span><span class="s">/git/blobs&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s">&#39;content&#39;</span> <span class="p">:</span> <span class="n">new_travis</span><span class="p">,</span>
                    <span class="s">&#39;encoding&#39;</span> <span class="p">:</span> <span class="s">&#39;utf-8&#39;</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c"># step 5: Create a tree containing your new file</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s">&quot;/repos/</span><span class="si">%s</span><span class="s">/git/trees&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s">&quot;base_tree&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;tree&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">],</span>
                    <span class="s">&quot;tree&quot;</span><span class="p">:</span> <span class="p">[{</span>
                        <span class="s">&quot;path&quot;</span><span class="p">:</span> <span class="n">GITHUB_FILE</span><span class="p">,</span>
                        <span class="s">&quot;mode&quot;</span><span class="p">:</span> <span class="s">&quot;100644&quot;</span><span class="p">,</span>
                        <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;blob&quot;</span><span class="p">,</span>
                        <span class="s">&quot;sha&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">]</span>
                    <span class="p">}]</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s">&#39;tree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c"># step 6: Create a new commit</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s">&quot;/repos/</span><span class="si">%s</span><span class="s">/git/commits&quot;</span> <span class="o">%</span> <span class="n">GITHUB_REPO</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s">&quot;message&quot;</span><span class="p">:</span> <span class="s">&quot;New upstream dependency found! Auto update .travis.yml&quot;</span><span class="p">,</span>
                    <span class="s">&quot;parents&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;commit&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">]],</span>
                    <span class="s">&quot;tree&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s">&#39;tree&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>
    <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s">&#39;commit&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&#39;sha&#39;</span> <span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;sha&#39;</span><span class="p">]</span> <span class="p">}</span>

    <span class="c"># step 7: Update HEAD, but don&#39;t force it!</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">post_url</span><span class="p">(</span>
                <span class="s">&quot;/repos/</span><span class="si">%s</span><span class="s">/git/refs/heads/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">GITHUB_REPO</span><span class="p">,</span> <span class="n">GITHUB_BRANCH</span><span class="p">),</span>
                <span class="p">{</span>
                    <span class="s">&quot;sha&quot;</span><span class="p">:</span> <span class="n">HEAD</span><span class="p">[</span><span class="s">&#39;UPDATE&#39;</span><span class="p">][</span><span class="s">&#39;commit&#39;</span><span class="p">][</span><span class="s">&#39;sha&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&#39;object&#39;</span><span class="p">):</span> <span class="c"># PASS</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span> <span class="c"># FAIL</span>
        <span class="k">print</span> <span class="n">data</span><span class="p">[</span><span class="s">&#39;message&#39;</span><span class="p">]</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&quot;atodorov-test&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span> <span class="s">&#39;atodorov/bztest&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">],</span>
        <span class="s">&quot;Markdown&quot;</span> <span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span> <span class="s">&#39;atodorov/Markdown-Bugzilla-Extension&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span>  <span class="s">&#39;atodorov/Markdown-No-Lazy-Code-Extension&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
            <span class="p">{</span>
                <span class="s">&#39;cb&#39;</span> <span class="p">:</span> <span class="n">update_github</span><span class="p">,</span>
                <span class="s">&#39;args&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s">&#39;GITHUB_REPO&#39;</span> <span class="p">:</span>  <span class="s">&#39;atodorov/Markdown-No-Lazy-BlockQuote-Extension&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_BRANCH&#39;</span> <span class="p">:</span> <span class="s">&#39;master&#39;</span><span class="p">,</span>
                    <span class="s">&#39;GITHUB_FILE&#39;</span> <span class="p">:</span> <span class="s">&#39;.travis.yml&#39;</span>
                <span class="p">}</span>
            <span class="p">},</span>
        <span class="p">],</span>
    <span class="p">}</span>

    <span class="c"># check the RSS to see if we have something new</span>
    <span class="n">monitor_rss</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</pre></div>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 02 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/02/automatic-upstream-dependency-testing/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/01/hosting-multiple-python-wsgi-scripts-on-openshift/" rel="bookmark" title="Permalink to Hosting Multiple Python WSGI Scripts on OpenShift">
                <h2 class="post-title">
                    Hosting Multiple Python WSGI Scripts on OpenShift
                </h2>
            </a>
                <p>With <a href="http://openshift.com">OpenShift</a> you can host WSGI Python
applications. By default the Python cartridge comes with a simple WSGI app
and the following directory layout</p>
<div class="highlight"><pre>./
./.openshift/
./requirements.txt
./setup.py
./wsgi.py
</pre></div>


<p>I wanted to add my
<a href="http://atodorov.org/blog/2015/11/24/github-bugzilla-hook/">GitHub Bugzilla Hook</a>
in a subdirectory (git submodule actually) and simply reserve a URL which will
be served by this app. My intention is also to add other small scripts to the
same cartridge in order to better utilize the available resources.</p>
<p>Using <code>WSGIScriptAlias</code> inside <code>.htaccess</code> <strong>DOESN'T WORK</strong>! OpenShift errors
out when <code>WSGIScriptAlias</code> is present. I suspect this to be a known limitation
and I have an open support case with Red Hat to confirm this.</p>
<p>My workaround is to configure the URL paths from the <code>wsgi.py</code> file in the root
directory. For example</p>
<div class="highlight"><pre><span class="gh">diff --git a/wsgi.py b/wsgi.py</span>
<span class="gh">index c443581..20e2bf5 100644</span>
<span class="gd">--- a/wsgi.py</span>
<span class="gi">+++ b/wsgi.py</span>
<span class="gu">@@ -12,7 +12,12 @@ except IOError:</span>
 # line, it&#39;s possible required libraries won&#39;t be in your searchable path
 #
 
<span class="gi">+from github_bugzilla_hook import wsgi as ghbzh</span>
<span class="gi">+</span>
 def application(environ, start_response):
<span class="gi">+    # custom paths</span>
<span class="gi">+    if environ[&#39;PATH_INFO&#39;] == &#39;/github-bugzilla-hook/&#39;:</span>
<span class="gi">+        return ghbzh.application(environ, start_response)</span>
 
     ctype = &#39;text/plain&#39;
     if environ[&#39;PATH_INFO&#39;] == &#39;/health&#39;:
</pre></div>


<p>This does the job and is almost the same as configuring the path in <code>.htaccess</code>.
I hope it helps you!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 01 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/01/hosting-multiple-python-wsgi-scripts-on-openshift/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/" rel="bookmark" title="Permalink to Commit a file with the GitHub API and Python">
                <h2 class="post-title">
                    Commit a file with the GitHub API and Python
                </h2>
            </a>
                <p>How do you commit changes to a file using the GitHub API ?
I've found
<a href="http://www.levibotelho.com/development/commit-a-file-with-the-github-api/">this post</a>
by Levi Botelho which explains the necessary steps but without any code.
So I've used it and created a
<a href="https://github.com/atodorov/api-commit-test">Python example</a>.</p>
<p>I've rearranged the steps so that all write operations follow after a certain
section in the code and also added an intermediate section which creates the
updated content based on what is available in the repository.</p>
<p>I'm just appending
versions of Markdown to the <code>.travis.yml</code> (I will explain why in my next post)
and this is hard-coded for the sake of example. All content related operations
are also based on the GitHub API because I want to be independent of the source
code being around when I push this script to a hosting provider.</p>
<p>I've tested this script against itself. In the
<a href="https://github.com/atodorov/api-commit-test/commits/master">commits log</a>
you can find the <em>Automatic update to Markdown-X.Y</em> messages. These are
from the script. Also notice the <em>Merge remote-tracking branch 'origin/master'</em>
messages, these appeared when I pulled to my local copy. I believe the
reason for this is that I have some dangling trees and/or commits from
the time I was still experimenting with a broken script. I've tested on another
clean repository and <a href="https://github.com/atodorov/bztest/commits/master">there are</a>
no such merges.</p>
<p><strong>IMPORTANT</strong></p>
<p>For this to work you need to properly authenticate with GitHub. I've crated
a new token at <a href="https://github.com/settings/tokens">https://github.com/settings/tokens</a> with the <em>public_repo</em>
permission and that works for me.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 01 December 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/12/01/commit-a-file-with-the-github-api-and-python/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/11/29/inspecting-method-arguments-in-python/" rel="bookmark" title="Permalink to Inspecting Method Arguments in Python">
                <h2 class="post-title">
                    Inspecting Method Arguments in Python
                </h2>
            </a>
                <p>How do you execute methods from 3rd party classes in a backward compatible
manner when these methods change their arguments ?</p>
<p>s3cmd's <a href="https://github.com/s3tools/s3cmd/pull/668">PR #668</a> is an example
of this behavior, where python-libs's <code>httplib.py</code> added a new parameter
to disable hostname checks. As a result of this
<a href="/blog/2015/11/24/python-libs-in-rhel-7.2-broke-ssl-verification-in-s3cmd/">s3cmd broke</a>.</p>
<p>One solution is to use try-except and nest as much blocks as you need to cover
all of the argument variations. In s3cmd's case we needed two nested try-except
blocks.</p>
<p>Another possibility is to use the
<a href="https://docs.python.org/3/library/inspect.html">inspect</a> module and create the argument
list passed to the method dynamically, based on what parameters are supported.
Depending on the number of parameters this may or may not be more elegant than
using try-except blocks although it looks to me a bit more human readable.</p>
<p>The argument list is a member named <em>co_varnames</em> of the code object. If you
want to get the members for a function then</p>
<div class="highlight"><pre><span class="nx">inspect</span><span class="p">.</span><span class="nx">getmembers</span><span class="p">(</span><span class="nx">my_function</span><span class="p">.</span><span class="nx">__code__</span><span class="p">)</span>
</pre></div>


<p>if you want to get the members for a class method then</p>
<div class="highlight"><pre>inspect.getmembers(MyClass.my_method.__func__.__code__)
</pre></div>


<p>Consider the following example</p>
<div class="highlight"><span class="filename">test.py</span><pre><span class="kn">import</span> <span class="nn">inspect</span>

<span class="k">def</span> <span class="nf">hello_world</span><span class="p">(</span><span class="n">greeting</span><span class="p">,</span> <span class="n">who</span><span class="p">):</span>
    <span class="k">print</span> <span class="n">greeting</span><span class="p">,</span> <span class="n">who</span>

<span class="k">class</span> <span class="nc">V1</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s">&quot;Hello World&quot;</span>

    <span class="k">def</span> <span class="nf">do_print</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span>

<span class="k">class</span> <span class="nc">V2</span><span class="p">(</span><span class="n">V1</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">greeting</span><span class="o">=</span><span class="s">&quot;Hello&quot;</span><span class="p">):</span>
        <span class="n">V1</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;Hello&#39;</span><span class="p">,</span> <span class="n">greeting</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">V3</span><span class="p">(</span><span class="n">V2</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">greeting</span><span class="o">=</span><span class="s">&quot;Hello&quot;</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="s">&quot;World&quot;</span><span class="p">):</span>
        <span class="n">V2</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">greeting</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;World&#39;</span><span class="p">,</span> <span class="n">who</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;=== Example: call the class directly ===&quot;</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">V1</span><span class="p">()</span>
    <span class="n">v1</span><span class="o">.</span><span class="n">do_print</span><span class="p">()</span>

    <span class="n">v2</span> <span class="o">=</span> <span class="n">V2</span><span class="p">(</span><span class="n">greeting</span><span class="o">=</span><span class="s">&quot;Good day&quot;</span><span class="p">)</span>
    <span class="n">v2</span><span class="o">.</span><span class="n">do_print</span><span class="p">()</span>

    <span class="n">v3</span> <span class="o">=</span> <span class="n">V3</span><span class="p">(</span><span class="n">greeting</span><span class="o">=</span><span class="s">&quot;Good evening&quot;</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="s">&quot;everyone&quot;</span><span class="p">)</span>
    <span class="n">v3</span><span class="o">.</span><span class="n">do_print</span><span class="p">()</span>

    <span class="c"># uncomment to see the error raised</span>
    <span class="c">#v4 = V1(greeting=&quot;Good evening&quot;, who=&quot;everyone&quot;)</span>
    <span class="c">#v4.do_print()</span>

    <span class="k">print</span> <span class="s">&quot;=== Example: use try-except ===&quot;</span>
    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="p">[</span><span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">,</span> <span class="n">V3</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">greeting</span><span class="o">=</span><span class="s">&quot;Good evening&quot;</span><span class="p">,</span> <span class="n">who</span><span class="o">=</span><span class="s">&quot;everyone&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;    error: nested-try-except-1&quot;</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="n">greeting</span><span class="o">=</span><span class="s">&quot;Good evening&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">print</span> <span class="s">&quot;    error: nested-try-except-2&quot;</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">()</span>

        <span class="n">c</span><span class="o">.</span><span class="n">do_print</span><span class="p">()</span>


    <span class="k">print</span> <span class="s">&quot;=== Example: using inspect ===&quot;</span>
    <span class="k">for</span> <span class="n">C</span> <span class="ow">in</span> <span class="p">[</span><span class="n">V1</span><span class="p">,</span> <span class="n">V2</span><span class="p">,</span> <span class="n">V3</span><span class="p">]:</span>
        <span class="n">members</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getmembers</span><span class="p">(</span><span class="n">C</span><span class="o">.</span><span class="n">__init__</span><span class="o">.</span><span class="n">__func__</span><span class="o">.</span><span class="n">__code__</span><span class="p">))</span>
        <span class="n">var_names</span> <span class="o">=</span> <span class="n">members</span><span class="p">[</span><span class="s">&#39;co_varnames&#39;</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="s">&#39;greeting&#39;</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s">&#39;greeting&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;Good morning&#39;</span>

        <span class="k">if</span> <span class="s">&#39;who&#39;</span> <span class="ow">in</span> <span class="n">var_names</span><span class="p">:</span>
            <span class="n">args</span><span class="p">[</span><span class="s">&#39;who&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;children&#39;</span>

        <span class="n">c</span> <span class="o">=</span> <span class="n">C</span><span class="p">(</span><span class="o">**</span><span class="n">args</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">do_print</span><span class="p">()</span>
</pre></div>


<p>The output of the example above is as follows</p>
<div class="highlight"><pre>=== Example: call the class directly ===
Hello World
Good day World
Good evening everyone
=== Example: use try-except ===
    error: nested-try-except-1
    error: nested-try-except-2
Hello World
    error: nested-try-except-1
Good evening World
Good evening everyone
=== Example: using inspect ===
Hello World
Good morning World
Good morning children
</pre></div>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Sun 29 November 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/11/29/inspecting-method-arguments-in-python/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/11/26/3-new-python-markdown-extensions/" rel="bookmark" title="Permalink to 3 New Python Markdown extensions">
                <h2 class="post-title">
                    3 New Python Markdown extensions
                </h2>
            </a>
                <p>I've managed to resolve several of my issues with Python-Markdown behaving not
quite as I expect. I have the pleasure to announce three new extensions which
now power this blog.</p>
<h2>No Lazy BlockQuote Extension</h2>
<p><a href="https://github.com/atodorov/Markdown-No-Lazy-BlockQuote-Extension">Markdown-No-Lazy-BlockQuote-Extension</a>
makes it possible blockquotes separated by newline to be rendered separately.
If you want to include empty lines in your blockquotes make sure to prefix
each line with <code>&gt;</code>. The standard behavior can be seen in
<a href="https://github.com/atodorov/atodorov.github.com/blob/source/content/_posts/2014-03-04-how-do-you-test-fonts.markdown">GitHub</a>
while the changed behavior is visible
<a href="/blog/2014/03/04/how-do-you-test-fonts/">in this article</a>. Notice how on
GitHub both quotes are rendered as one big block, while here they are two separate
blocks.</p>
<h2>No Lazy Code Extension</h2>
<p><a href="https://github.com/atodorov/Markdown-No-Lazy-Code-Extension">Markdown-No-Lazy-Code-Extension</a>
allows code blocks separated by newline to be rendered separately. If you want to
include empty lines in your code blocks make sure to
<a href="https://github.com/atodorov/atodorov.github.com/commit/9684875920c6c7926951ce99b6588a9a7007e6f0">indent them as well</a>.
The standard behavior can be seen on
<a href="https://github.com/atodorov/atodorov.github.com/blob/source/content/_posts/2013-02-13-secure-vnc-installation-red-hat-enterprise-linux.markdown">GitHub</a>
while the improved one in this
<a href="/blog/2013/02/13/secure-vnc-installation-red-hat-enterprise-linux/">post</a>.
Notice how GitHub renders the code in the <strong>Warning Bugs Present</strong> section
as one block while in reality these are two separate blocks from two different files.</p>
<h2>Bugzilla Extension</h2>
<p><a href="https://github.com/atodorov/Markdown-Bugzilla-Extension">Markdown-Bugzilla-Extension</a>
allows for easy references to bugs. Strings like <code>[bz#123]</code> and <code>[rhbz#456]</code> will
be converted into links.</p>
<p>All three extensions are available on PyPI!</p>
<h2>Bonus: Codehilite with filenames in Markdown</h2>
<p>The standard Markdown codehilite extension doesn't allow to specify filename
on the <code>:::python</code> shebang line while Octopress did and I've used the syntax
on this blog in a number of articles. The fix is simple, but requires changes in
both Markdown and Pygments. See
<a href="https://github.com/waylan/Python-Markdown/pull/445">PR #445</a> for the initial
version and ongoing discussion. Example of the new <code>:::python settings.py</code> syntax
can be seen
<a href="/blog/2013/03/07/python-twitter-django-social-auth-hello-new-user/">here</a>.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Thu 26 November 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/11/26/3-new-python-markdown-extensions/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/11/25/blog-migration-from-octopress-to-pelican/" rel="bookmark" title="Permalink to Blog Migration: from Octopress to Pelican">
                <h2 class="post-title">
                    Blog Migration: from Octopress to Pelican
                </h2>
            </a>
                <p>Finally I have migrated this blog from <a href="http://octopress.org">Octopress</a> to
<a href="https://github.com/getpelican/pelican">Pelican</a>. I am using the
<a href="https://github.com/gilsondev/pelican-clean-blog/">clean-blog</a> theme with
<a href="https://github.com/gilsondev/pelican-clean-blog/pull/3">modifications</a>.</p>
<p>See the
<a href="https://github.com/atodorov/atodorov.github.com/commits/pelican_migration">pelican_migration</a>
branch for technical details. Here's the summary:</p>
<ul>
<li>I removed pretty much everything that Octopress uses, only left the content files;</li>
<li>I've added my own CSS overrides;</li>
<li>I had several Octopress pages, these were merged and converted into blog posts;</li>
<li>In Octopress all titles had quotes, which were removed using sed;</li>
<li>Octopress categories were converted to Pelican tags and removed quotes around them,
again using sed;</li>
<li>Manually updated Octopress's <code>{% codeblock %}</code> and <code>{% blockquote %}</code> tags to
match Pelican syntax. This is the biggest content change;</li>
<li>I was trying to keep as much as the original URLs as possible. <code>ARTICLE_URL</code>,
<code>ARTICLE_SAVE_AS</code>, <code>TAG_URL</code>, <code>TAG_SAVE_AS</code>, <code>FEED_ALL_ATOM</code> and <code>TAG_FEED_ATOM</code>
are the relevant settings. For 50+ posts I had to manually specify the <code>Slug:</code>
variable so that they match existing Octopress URLs. Verifying the resulting names
was as simple as diffing the file listings from both Octopress and Pelican.
<strong>NOTE:</strong> The <em>fedora.planet</em> tag changed its URL because there's no way
to assign slugs for tags in Pelican. The new URL is missing the dot! Luckily
I make use of this only in one place which was manually updated!</li>
</ul>
<p>I've also found a few bugs and missing functionality:</p>
<ul>
<li>There's no <code>rake new_post</code> counterpart in Pelican. See
<a href="https://github.com/getpelican/pelican/issues/1410">Issue 1410</a> and 
<a href="https://github.com/Kdecherf/blog.kdecherf.com/commit/6552f6f02e6c501a6cc13816cd9bb2cd6c601f9c">commit 6552f6f</a>.
Thanks Kevin Decherf;</li>
<li><strike>As far as I can tell the preview server doesn't regenerate files automatically.</strike>
Do <code>make regenerate</code> and <code>make serve</code> in two separate shells. Thanks Kevin Decherf;</li>
<li><strike>Pelican will merge code blocks and quotes which follow one after another
but are separated with a newline in Markdown. This makes it visually impossible
to distinguish code from two files, or quotes from two people, which are published
without any other comments in between.</strike> See
<a href="https://github.com/atodorov/Markdown-No-Lazy-BlockQuote-Extension">Markdown-No-Lazy-BlockQuote-Extension</a>
and <a href="https://github.com/atodorov/Markdown-No-Lazy-Code-Extension">Markdown-No-Lazy-Code-Extension</a>;</li>
<li><strike>The syntax doesn't allow to specify filename or a quote title when publishing
code blocks and quotes. Octopress did that easily. I will be happy with something
like <code>:::python settings.py</code>.</strike>
See <a href="https://github.com/waylan/Python-Markdown/pull/445">PR #445</a>;</li>
<li>There's no way to specify slugs for tag URLs in order to keep compatibility
with existing URLs, see <a href="https://github.com/getpelican/pelican/issues/1873">Issue 1873</a>.</li>
</ul>
<p>I will be filling Issues and pull requests for both Pelican and the clear-blog theme
in the next few days so stay tuned!</p>
<p><strong>UPDATED 2015-11-26:</strong> added links to issues, pull requests and custom extensions.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Wed 25 November 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/11/25/blog-migration-from-octopress-to-pelican/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/11/24/python-libs-in-rhel-7.2-broke-ssl-verification-in-s3cmd/" rel="bookmark" title="Permalink to python-libs in RHEL 7.2 broke SSL verification in s3cmd">
                <h2 class="post-title">
                    python-libs in RHEL 7.2 broke SSL verification in s3cmd
                </h2>
            </a>
                <p>Today started with <a href="http://planet.sofiavalley.com">Planet Sofia Valley</a> being
broken again. Indeed it's been broken since last Friday when I've upgraded to
the latest RHEL 7.2. I quickly identified that I was hitting
<a href="https://github.com/s3tools/s3cmd/issues/647">Issue #647</a>. Then I tried the
git checkout without any luck. This is when I started to suspect that python-libs
has been updated in an incompatible way.</p>
<p>After series of reported bugs,
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1284916">rhbz#1284916</a>,
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1284930">rhbz#1284930</a>,
<a href="http://bugs.python.org/issue25722">Python#25722</a>, it was clear that
<code>ssl.py</code> was working according to RFC6125, that Amazon S3 was not playing
nicely with this same RFC and that my patch proposal was wrong.
This immediately had me looking upper in the stack at <code>httplib.py</code> and <code>s3cmd</code>.</p>
<p>Indeed there was a change in <code>httplib.py</code> which introduced two parameters,
<em>context</em> and <em>check_hostname</em>, to <code>HTTPSConnection.__init__</code>. The change
also supplied the logic which performs SSL hostname validation.</p>
<div class="highlight"><pre>if not self._context.check_hostname and self._check_hostname:
    try:
        ssl.match_hostname(self.sock.getpeercert(), server_hostname)
    except Exception:
        self.sock.shutdown(socket.SHUT_RDWR)
        self.sock.close()
        raise
</pre></div>


<p>This looks a bit doggy as I don't quite understand the intention behind
<em>not PREDICATE and PREDICATE</em>. Anyway to disable the validation you need
both parameters set to False, which is
<a href="https://github.com/s3tools/s3cmd/pull/668">PR #668</a>.</p>
<p>Notice the two try-except blocks. This is in case we're running with a
version that has a context but not the check_hostname parameter. I've found
the <em>inspect.getmembers</em> function which can be used to figure out what
parameters are there for the init method but a solution based on it
doesn't appear to be more elegant. I will describe this in more details in
my next post.</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 24 November 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/11/24/python-libs-in-rhel-7.2-broke-ssl-verification-in-s3cmd/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/11/24/github-bugzilla-hook/" rel="bookmark" title="Permalink to GitHub Bugzilla Hook">
                <h2 class="post-title">
                    GitHub Bugzilla Hook
                </h2>
            </a>
                <p>Last month I've created a tool which adds comments to Bugzilla when a commit
message references a bug number. It was done as a proof of concept and didn't
receive much attention at the time. Today I'm happy to announce the existence
of <a href="https://github.com/atodorov/github-bugzilla-hook">GitHub Bugzilla Hook</a>.</p>
<p>I've used David Shea's
<a href="https://github.com/rhinstaller/github-email-hook/">GitHub Email Hook</a> as my
starting template and only modified it where needed. GitHub Bugzilla Hook will
examine push data and post comments for every unique bug+branch combination.
Once a comment for that particular bug+branch combination is made, new ones
will not be posted, even if later commits reference the same bug.
My main assumption is commits which are related to a bug will be pushed together
most of the times so there shouldn't be lots of noise in Bugzilla.</p>
<p>See <a href="https://bugzilla.redhat.com/show_bug.cgi?id=1274703">rhbz#1274703</a> for
example of how the comments look. The parser behavior is taken from anaconda
and conforms to the style the Red Hat Installer Engineering Team uses.
Hopefully you find it useful as well.</p>
<p>My next step is to find a hosting place for this script and hook it up
with the rhinstaller GitHub repos!</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Tue 24 November 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/11/24/github-bugzilla-hook/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/11/23/bad-stub-design-in-dnf/" rel="bookmark" title="Permalink to Bad Stub Design in DNF, Pt.2">
                <h2 class="post-title">
                    Bad Stub Design in DNF, Pt.2
                </h2>
            </a>
                <p>Do you remember my example of a
<a href="/blog/2015/09/25/unit-testing-bad-stub-design-in-dnf/">bad stub design in DNF</a> ?
At that time I didn't have a good example of why this is a bad design and what are the
consequences of it. Today I have!</p>
<p>From my comment on
<a href="https://github.com/rpm-software-management/dnf-plugins-core/pull/118">PR #118</a></p>
<blockquote>
<p>Note: the benefit of this patch are quite subtle.
I've played around with creating a few more tests and the benefit I see affect
only a few lines of code.</p>
<p>For #114 there doesn't seem to be any need to test _get_query directly,
although we call</p>
<div class="highlight"><pre>   q = self.base.sack.query()
   q = q.available()
</pre></div>


<p>which will benefit from this PR b/c we're stubbing out the entire Sack object.
I will work on a test later today/tomorrow to see how it looks.</p>
<p>OTOH for #113 where we modify _get_query the test can look something like this:</p>
<div class="highlight"><pre>def test_get_query_with_local_rpm(self):
    try:
        (fs, rpm_path) = tempfile.mkstemp(&#39;foobar-99.99-1.x86_64.rpm&#39;)
        # b/c self.cmd.cli.base is a mock object add_remote_rpm
        # will not update the available packages while testing.
        # it is expected to hit an exception
        with self.assertRaises(dnf.exceptions.PackageNotFoundError):
            self.cmd._get_query(rpm_path)
        self.cmd.cli.base.add_remote_rpm.assert_called_with(rpm_path)
    finally:
        os.remove(rpm_path)
</pre></div>


<p>Note the comment above the with block. If we leave out <code>_get_query</code> as before
(a simple stub function) we're not going to be able to use <code>assert_called_with</code>
later.</p>
</blockquote>
<p>Now a more practical example. See 
<a href="https://github.com/rpm-software-management/dnf-plugins-core/commit/fe130669ffc4c1d6eba8f10cda35ab4d803d5a3d">commit fe13066</a>
- in case the package is not found we log the error. In case configuration is
<code>strict=True</code> then the plugin will raise another exception. With the initial version
of the stubs this change in behavior is silently ignored. If there was an error
in the newly introduced lines it would go straight into production because the
existing tests passed.</p>
<p>What happens is that <code>test_get_packages()</code> calls <code>_get_packages(['notfound'])</code>,
which is not the real code but a test stub and returns an empty list in this case.
The empty list is expected from the test and it will not fail!</p>
<p>With my new stub design the test will execute the actual <code>_get_packages()</code>
method from <code>download.py</code> and choke on the exception. The test itself needs
to be modified, which is done in
<a href="https://github.com/atodorov/dnf-plugins-core/commit/2c2b34237c99cbf32e23bde43027d22873f4e8b7">commit 2c2b34</a>
and no further errors were found.</p>
<p>So let me summarize:
<strong>
When using mocks, stubs and fake objects we should be replacing external
dependencies of the software under test, not internal methods from the SUT!
</strong></p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Mon 23 November 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/11/23/bad-stub-design-in-dnf/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/11/23/tip-running-dnf-plugins-from-git/" rel="bookmark" title="Permalink to Tip: Running DNF Plugins from git">
                <h2 class="post-title">
                    Tip: Running DNF Plugins from git
                </h2>
            </a>
                <p>This is mostly for self reference because it is not currently documented
in the code. To use dnf plugins from a local git checkout modify your
<code>/etc/dnf/dnf.conf</code> and add the following line under the <code>[main]</code> section:</p>
<div class="highlight"><pre>pluginpath=/path/to/dnf-plugins-core/plugins
</pre></div>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Mon 23 November 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/11/23/tip-running-dnf-plugins-from-git/#disqus_thread">comments</a>.</p>        </div>
        <div class="post-preview">
            <a href="http://atodorov.org/blog/2015/11/21/updated-macbook-air-drivers-for-rhel-7.2/" rel="bookmark" title="Permalink to Updated MacBook Air Drivers for RHEL 7.2">
                <h2 class="post-title">
                    Updated MacBook Air Drivers for RHEL 7.2
                </h2>
            </a>
                <p>Yesterday I've upgraded to
<a href="https://access.redhat.com/announcements/2058583">Red Hat Enterprise Linux 7.2</a>
on my <a class="wikilink" href="http://amzn.to/1RdviyD">MacBook Air</a> and I decided to rebuild the wifi and backlight drivers.
Wifi broke immediately but I was able to fix the build with a
<a href="https://github.com/atodorov/wl-kmod-for-rhel7/commit/88d678a25eb702ce36f7c39471edefb65de57ad5">simple patch</a>.
I'm now using the newly built <em>kmod-wl-3.10.0-327.el7.x86_64-6.30.223.248-7.el7.x86_64</em>
and it appears to work as expected.</p>
<p>The <em>mba6x_bl</em> driver built without problems however I'm having problems when
closing the laptop lid. The screen stays on and (I think) the computer doesn't
suspend. My battery was drained as I left the computer as-is overnight. Suspending
from the Desktop menu however appears to work. See
<a href="https://github.com/patjak/mba6x_bl/issues/41">Issue #41</a>. I'd love to get some
help in debugging what's going wrong and trying to fix it. At this point I have
no idea where to look and if it's the driver to blame or something else on the system.</p>
<p><strong>UPDATE 2015-11-25:</strong>
After the upgrade to RHEL 7.2 I also started seeing
<a href="https://bugzilla.redhat.com/show_bug.cgi?id=1284851">rhbz#1284851</a>
- Mate power manager doesn't detect AC/DC changes on <a class="wikilink" href="http://amzn.to/1RdviyD">MacBook Air</a> with RHEL 7.2</p>
            <p class="post-meta">Posted by
                    <a href="http://atodorov.org/author/alexander-todorov.html">Alexander Todorov</a>
                 on Sat 21 November 2015
            </p>
<p>There are <a href="http://atodorov.org/blog/2015/11/21/updated-macbook-air-drivers-for-rhel-7.2/#disqus_thread">comments</a>.</p>        </div>

    <hr>
    <!-- Pager -->
    <ul class="pager">
        <li class="next">
                <a href="http://atodorov.org/category/_posts4.html">Older Posts &rarr;</a>
                <a href="http://atodorov.org/category/_posts2.html"> &larr; Newest Posts</a>
        </li>
    </ul>
    Page 3 / 14
    <hr>
            </div>
        </div>
    </div>

    <hr>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <ul class="list-inline text-center">
                            <li>
                                <a href="https://twitter.com/atodorov_">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://github.com/atodorov">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://bg.linkedin.com/in/alextodorov">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="http://feeds.feedburner.com/atodorov">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="https://www.youtube.com/playlist?list=PLFjlI7p-h1hxBP3cIjEqePSeoBDHud5Db">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-youtube fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="http://amzn.to/1ivu2q4">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-amazon fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                            <li>
                                <a href="http://mrsenko.com/?utm_source=atodorov.org&utm_medium=blog&utm_campaign=social_icon">
                                    <span class="fa-stack fa-lg">
                                        <i class="fa fa-circle fa-stack-2x"></i>
                                        <i class="fa fa-user-secret fa-stack-1x fa-inverse"></i>
                                    </span>
                                </a>
                            </li>
                    </ul>
<section>
    <p>
        I am a Senior QA contractor at Red Hat responsible for finding over
        <a href="/blog/2014/02/19/7-years-1400-bugs-red-hat-qa/">1600 bugs</a>,
        a general purpose open source developer, Red Hat Certified professional,
        cloud hacker and an entrepreneur! My latest start-up is
        <a href="http://mrsenko.com/?utm_source=atodorov.org&utm_medium=blog&utm_campaign=footer">Mr. Senko</a>!
    </p>
    <p>
        I am living in the <a href="http://planet.sofiavalley.com">Sofia Valley</a>
        which is emerging as a busy place for start-up founders and tech enthusiasts
        in Eastern Europe! You can find more about me <a href="/blog/2013/01/25/about-me/">here</a>.
    </p>
    <p>
        <small>
            <em>
                Some of the links contained within this site have my referral id (e.g.,
                <a target="_blank" href="http://www.amazon.com/ref=as_li_ss_tl?_encoding=UTF8&camp=1789&creative=390957&linkCode=ur2&tag=atodorovorg-20&linkId=L6Q34XAXQS5RDMOY">Amazon</a><img src="https://ir-na.amazon-adsystem.com/e/ir?t=atodorovorg-20&l=ur2&o=1" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" />),
                which provides me with a small commission for each sale. Thank you for your support.
            </em>
        </small>
    </p>
</section>

<form action="http://google.com/search" method="get" style="width:300px;margin:0 auto;">
    <fieldset role="search">
        <input type="hidden" name="sitesearch" value="http://atodorov.org" />
        <input class="search" type="text" name="q" placeholder="Search" style="width:100%"/>
    </fieldset>
</form>

<p class="copyright text-muted">
    <a rel="license" href="http://creativecommons.org/licenses/by-sa/3.0/deed.en_US">CC-BY-SA</a> &amp;
    <a rel="license" href="http://opensource.org/licenses/MIT">MIT</a>
    2011-2016 &diams; Alexander Todorov &diams;
    <a href="http://planet.sofiavalley.com">SofiaValley Blog</a>
</p>

<script type='text/javascript'>
window.__lo_site_id = 55936;
    (function() {
        var wa = document.createElement('script'); wa.type = 'text/javascript'; wa.async = true;
        wa.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://cdn') + '.luckyorange.com/w.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(wa, s);
      })();
</script>
                </div>
            </div>
        </div>
    </footer>

    <!-- jQuery -->
    <script src="http://atodorov.org/theme/js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="http://atodorov.org/theme/js/bootstrap.min.js"></script>


    <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-37979549-1']);
    _gaq.push(['_trackPageview']);
    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
    </script>
<script type="text/javascript">
    var disqus_shortname = 'atodorov';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>

</html>